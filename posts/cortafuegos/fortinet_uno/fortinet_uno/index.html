<!doctype html><html lang=es><head><title>Implementación de un cortafuegos perimetral con Fortinet I</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.8f653c5cdc3487a0905aa14b6d0a342357c516425b652a78403ca27965d085f5.css integrity="sha256-j2U8XNw0h6CQWqFLbQo0I1fFFkJbZSp4QDyieWXQhfU="><link rel=icon type=image/png href=/images/site/avatar_hud72a20250efce9adf5aa46631dba75d3_2990_42x0_resize_q75_box.jpg><meta property="og:url" content="https://www.javiercd.es/posts/cortafuegos/fortinet_uno/fortinet_uno/"><meta property="og:site_name" content="Atlas"><meta property="og:title" content="Implementación de un cortafuegos perimetral con Fortinet I"><meta property="og:description" content="Implementación de un cortafuegos perimetral con Fortinet I"><meta property="og:locale" content="es"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-28T10:00:00+00:00"><meta property="article:modified_time" content="2024-03-28T10:00:00+00:00"><meta property="article:tag" content="FIREWALL"><meta property="article:tag" content="LINUX"><meta property="article:tag" content="DEBIAN"><meta property="article:tag" content="FORTINET"><meta name=twitter:card content="summary"><meta name=twitter:title content="Implementación de un cortafuegos perimetral con Fortinet I"><meta name=twitter:description content="Implementación de un cortafuegos perimetral con Fortinet I"><meta name=description content="Implementación de un cortafuegos perimetral con Fortinet I"><script>theme=localStorage.getItem("darkmode:color-scheme")||"system",theme=="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/masthead_hud72a20250efce9adf5aa46631dba75d3_2990_42x0_resize_box_3.png id=logo alt=Logo>
Atlas</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>Inicio</a></li><li class=nav-item><a class=nav-link href=/#about>Sobre mi</a></li><li class=nav-item><a class=nav-link href=/#skills>Competencias</a></li><li class=nav-item><a class=nav-link href=/#education>Educación</a></li><li class=nav-item><a class=nav-link href=/#recent-posts>Últimas publicaciones</a></li><li class=nav-item><a class=nav-link href=/#accomplishments>Certificaciones</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/masthead_hud72a20250efce9adf5aa46631dba75d3_2990_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/masthead_hud72a20250efce9adf5aa46631dba75d3_2990_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Búsqueda data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/posts/iaw/> Aplicaciones webs</a><ul><li><a class=list-link href=/posts/iaw/lamp/ title="Instalación pila LAMP">Instalación pila LAMP</a></li><li><a class=list-link href=/posts/iaw/lemp/ title="Instalación pila LEMP">Instalación pila LEMP</a></li><li><a class=list-link href=/posts/iaw/wordpress/ title="Wordpress LAMP">Wordpress LAMP</a></li><li><a class=list-link href=/posts/iaw/wordpress_lemp/ title="Wordpress LEMP">Wordpress LEMP</a></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/posts/cortafuegos/> Cortafuegos</a><ul class=active><li><a class=list-link href=/posts/cortafuegos/fortinet_cli/ title="Fortinet CLI">Fortinet CLI</a></li><li><a class="active list-link" href=/posts/cortafuegos/fortinet_uno/ title="Perimetral con Fortinet I">Perimetral con Fortinet I</a></li><li><a class=list-link href=/posts/cortafuegos/fortinet_dos/ title="Perimetral con Fortinet II">Perimetral con Fortinet II</a></li><li><a class=list-link href=/posts/cortafuegos/nftables_uno/ title="Perimetral con Nftables I">Perimetral con Nftables I</a></li><li><a class=list-link href=/posts/cortafuegos/nftables_dos/ title="Perimetral con Nftables II">Perimetral con Nftables II</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/redes/> Redes</a><ul><li><a class=list-link href=/posts/redes/android_gns3/ title="Android GNS3-KVM">Android GNS3-KVM</a></li><li><a class=list-link href=/posts/redes/comandos_de_supervision_de_redes/ title="Comandos de supervisión de redes">Comandos de supervisión de redes</a></li><li><a class=list-link href=/posts/redes/switches_gns3/ title="Configuración de switches en GNS3">Configuración de switches en GNS3</a></li><li><a class=list-link href=/posts/redes/enroutamiento_openstack/ title="Enrutamiento en OpenStack">Enrutamiento en OpenStack</a></li><li><a class=list-link href=/posts/redes/escenario_ipv6_basico/ title="Escenario IPv6 Básico">Escenario IPv6 Básico</a></li><li><a class=list-link href=/posts/redes/instalacion_wireshark_gns3/ title="Instalacion GNS y Wireshark">Instalacion GNS y Wireshark</a></li><li><a class=list-link href=/posts/redes/configuracion_de_nat/ title="NAT en Cisco y Linux">NAT en Cisco y Linux</a></li><li><a class=list-link href=/posts/redes/arp/ title="Protocolo ARP">Protocolo ARP</a></li><li><a class=list-link href=/posts/redes/tuneles_ipv6/ title="Túneles IPV6">Túneles IPV6</a></li><li><a class=list-link href=/posts/redes/underworld/ title=Underworld>Underworld</a></li><li><a class=list-link href=/posts/redes/underworld_evolution/ title="Underworld evolution">Underworld evolution</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/servicios/> Servicios</a><ul><li><a class=list-link href=/posts/servicios/apache/ title=Apache>Apache</a></li><li><a class=list-link href=/posts/servicios/dhcp/ title=DHCP>DHCP</a></li><li><a class=list-link href=/posts/servicios/dns/ title=DNS>DNS</a></li><li><a class=list-link href=/posts/servicios/ftp/ title=FTP>FTP</a></li><li><a class=list-link href=/posts/servicios/nat_iptables/ title="NAT con iptables">NAT con iptables</a></li><li><a class=list-link href=/posts/servicios/ssh/ title=SSH>SSH</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/> Sistemas</a><ul><li><a class=list-link href=/posts/sistemas/ad_ubuntu/ title="Active Directory en Ubuntu">Active Directory en Ubuntu</a></li><li><a class=list-link href=/posts/sistemas/comparticion_de_directorios_en_windows/ title="Compartir recursos en Windows">Compartir recursos en Windows</a></li><li><a class=list-link href=/posts/sistemas/nvidia/ title="Drivers Nvidia">Drivers Nvidia</a></li><li><a class=list-link href=/posts/sistemas/empaquetadores_compresores/ title="Empaquetadores y compresores">Empaquetadores y compresores</a></li><li><a class=list-link href=/posts/sistemas/samba_debian/ title="Instalar y configurar samba en Debian">Instalar y configurar samba en Debian</a></li><li><a class=list-link href=/posts/sistemas/nfs_debian/ title="NFS en Debian">NFS en Debian</a></li><li><a class=list-link href=/posts/sistemas/comandos_procesos/ title="Procesos en Linux">Procesos en Linux</a></li><li><a class=list-link href=/posts/sistemas/programacion_tareas/ title="Programación de tareas">Programación de tareas</a></li><li><a class=list-link href=/posts/sistemas/ssh_windows/ title="Servicio ssh en Windows">Servicio ssh en Windows</a></li><li><a class=list-link href=/posts/sistemas/migracion_sistema_de_ficheros/ title="Sistema de ficheros">Sistema de ficheros</a></li><li><a class=list-link href=/posts/sistemas/almacenamiento_servidor_independiente/ title="Storage Spaces en Windows Server">Storage Spaces en Windows Server</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/vpn/> VPN</a><ul><li><a class=list-link href=/posts/vpn/acceso_remoto_strongswang/ title="Acceso remoto Ipsec StrongSwan">Acceso remoto Ipsec StrongSwan</a></li><li><a class=list-link href=/posts/vpn/acceso_remoto_openvpn/ title="Acceso remoto OpenVPN">Acceso remoto OpenVPN</a></li><li><a class=list-link href=/posts/vpn/acceso_remoto_wireguard/ title="Acceso remoto Wireguard">Acceso remoto Wireguard</a></li><li><a class=list-link href=/posts/vpn/comparativa_ovpn_wire/ title="Comparativa OpenVPN y Wireguard">Comparativa OpenVPN y Wireguard</a></li><li><a class=list-link href=/posts/vpn/ipsec_cisco/ title="Site-to-Site IPsec Cisco">Site-to-Site IPsec Cisco</a></li><li><a class=list-link href=/posts/vpn/site_to_site_fortinet/ title="Site-to-Site IPsec Fortinet">Site-to-Site IPsec Fortinet</a></li><li><a class=list-link href=/posts/vpn/site_to_site_openvpn/ title="Site-to-Site OpenVPN">Site-to-Site OpenVPN</a></li><li><a class=list-link href=/posts/vpn/site_to_site_wireguard/ title="Site-to-Site Wireguard">Site-to-Site Wireguard</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/cortafuegos/fortinet.png)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/john_hud72a20250efce9adf5aa46631dba75d3_2990_120x120_fit_box_3.png alt="Author Image"><h5 class=author-name>Francisco Javier Cruces Doval</h5><p class=text-muted>jueves, 28 de marzo de 2024 | 10 minutos</p></div><div class=title><h1>Implementación de un cortafuegos perimetral con Fortinet I</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/tags/firewall/ class="btn btn-sm btn-info">FIREWALL</a></li><li class=rounded><a href=/tags/linux/ class="btn btn-sm btn-info">LINUX</a></li><li class=rounded><a href=/tags/debian/ class="btn btn-sm btn-info">DEBIAN</a></li><li class=rounded><a href=/tags/fortinet/ class="btn btn-sm btn-info">FORTINET</a></li></ul></div><div class=post-content id=post-content><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")</script><p>Antes de comenzar la practica , el escenario que ves en la practica es lo mas parecido que puedo montar a la practica original . He utilizado la versión 7.0.9-1 de FortiGate , ya que las versiones superiores traen algunas restricciones . Puedes descargarte la imagen desde este <a href=https://drive.google.com/drive/folders/1VGmeLN5inkWoNNUsIvq9ewGUzJLTLkiM target=_blank rel=noopener>link</a> .</p><p><img src=../img/Pastedimage20240320223139.png></p><h2 id=puesta-en-marcha-del-cortafuegos>Puesta en marcha del cortafuegos</h2><p>Los dispositivos FortiGate vienen configurados de fabrica con la IP 192.168.1.99/24 , como estoy desde GNS3 no es necesario que me conecte a esta interfaz con un dispositivo y cambie la configuración . Ya que puedo hacerlo desde la consola .</p><p>Por defecto a través de ese puerto esta habilitada la administración por http , https , ssh y telnet .</p><p>En mi caso me conectare desde la consola , le cambiare el hostname y configurare el puerto 1 para que coja IP por DHCP .</p><p>El usuario por defecto es admin y la contraseña en blanco . Cuando iniciemos sesión por primera vez nos obligara a cambiarla :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>FortiGate-VM64-KVM login: admin
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span>You are forced to change your password. Please input a new password.
</span></span><span style=display:flex><span>New Password: 
</span></span><span style=display:flex><span>Confirm Password: 
</span></span><span style=display:flex><span>Welcome!
</span></span></code></pre></div><p>Lo primero que haré sera cambiarle el hostname , como ves es similar a cisco ya que tenemos un modo de configuración :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>FortiGate-VM64-KVM <span style=color:#75715e># conf sys global</span>
</span></span><span style=display:flex><span>FortiGate-VM64-KVM <span style=color:#f92672>(</span>global<span style=color:#f92672>)</span> <span style=color:#75715e># set hostname FGT</span>
</span></span><span style=display:flex><span>FortiGate-VM64-KVM <span style=color:#f92672>(</span>global<span style=color:#f92672>)</span> <span style=color:#75715e># end</span>
</span></span></code></pre></div><p>Ahora vamos a configurar el puerto 1 por DHCP para que así desde el cliente 2 lo pueda configurar sin tener que manualmente cambiar la IP del mismo . Ademas voy a configurar el acceso por http y https para poder configurarlo desde un navegador :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>FGT <span style=color:#75715e># show system interface port1</span>
</span></span><span style=display:flex><span>config system interface
</span></span><span style=display:flex><span>    edit <span style=color:#e6db74>&#34;port1&#34;</span>
</span></span><span style=display:flex><span>        set vdom <span style=color:#e6db74>&#34;root&#34;</span>
</span></span><span style=display:flex><span>        set mode dhcp
</span></span><span style=display:flex><span>        set allowaccess ping https ssh http fgfm
</span></span><span style=display:flex><span>        set type physical
</span></span><span style=display:flex><span>        set snmp-index <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    next
</span></span><span style=display:flex><span>end
</span></span></code></pre></div><p>Ahora vamos a ver la IP que el DHCP le ha asignado con el siguiente comando :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>FGT <span style=color:#75715e># get system interface </span>
</span></span><span style=display:flex><span><span style=color:#f92672>==</span> <span style=color:#f92672>[</span> port1 <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>name: port1   mode: dhcp    ip: 192.168.122.77 255.255.255.0   status: up    netbios-forward: disable    type: physical   ring-rx: <span style=color:#ae81ff>0</span>   ring-tx: <span style=color:#ae81ff>0</span>   netflow-sampler: disable    sflow-sampler: disable    src-check: enable    explicit-web-proxy: disable    explicit-ftp-proxy: disable    proxy-captive-portal: disable    mtu-override: disable    wccp: disable    drop-overlapped-fragment: disable    drop-fragment: disable  
</span></span></code></pre></div><p>Ahora desde cualquier maquina que tenga acceso a la red &rsquo;externa&rsquo; podremos conectarnos al FW :</p><p><img src=../img/Pastedimage20240320225245.png></p><p>Cuando te inicies sesión veras un panel con información general sobre el estado dispositivo :</p><p><img src=../img/Pastedimage20240320225435.png></p><h3 id=configuración-de-la-red-lan>Configuración de la red LAN</h3><p>Como has visto en la imagen de la topología, la red LAN está conectada al puerto 2. Por lo tanto, procederemos a configurarlo.</p><p>Vamos a dirigirnos a Network > Interfaces , selecciona el puerto 2 y pulsa en editar en la barra superior :</p><p><img src=../img/Pastedimage20240320230138.png></p><p>Una vez dentro de la pantalla de configuración de la interfaz, puedes personalizar el puerto asignándole un alias. Además, para facilitar la gestión futura, le he asignado el rol LAN al puerto2, indicando que será utilizado para una red local. Posteriormente, he configurado la dirección IP del mismo, asignándole la 192.168.100.1/24. Además, he creado un objeto con esa IP, lo que facilitará la referencia a esta dirección IP en futuras configuraciones, eliminando la necesidad de recordar la IP .</p><p><img src=../img/Pastedimage20240320230527.png></p><p>Sigamos con la configuración de la interfaz. Desde la red LAN, donde estaremos la mayor parte del tiempo, permitiré el acceso vía HTTPS y SSH para configurar el FortiGate. También dejaré que respondan a los pings para asegurarme la conectividad con el mismo. Además, cada interfaz puede ser un servidor DHCP, así que le configurare uno para la LAN. Por último, activaré la opción para detectar dispositivos, así tendré control sobre quién se conecta a la red.</p><p><img src=../img/Pastedimage20240320231025.png></p><p>Una vez configurado el acceso administrativo desde la LAN , voy a quitar el acceso administrativo desde la interfaz puerto 1 ya que esta seria Internet (WAN).</p><p>Así que le cambiare el ROL a WAN y le quitare el acceso administrativo :</p><p><img src=../img/Pastedimage20240320231953.png></p><p>Si recuerdas anteriormente marcamos en la interfaz LAN la casilla Device connection , si queremos ver los dispositivos conectados a esta red accedemos a Security Fabric > Asset Identify Center :</p><p><img src=../img/Pastedimage20240320232223.png></p><p>Para apartados posteriores , como voy a realizar la practica de cortafuegos de nodo , es interesante crear un objeto con ese host . Así no sera necesario que recuerde su IP :</p><p><img src=../img/add_object_cliente1.png></p><p>Aunque no he mencionado nada anteriormente , la política por defecto de estos dispositivos es DROP en todas las direcciones :</p><p><img src=../img/Pastedimage20240320232353.png></p><p>Ahora vamos a crear una nueva política que permita el tráfico desde la LAN hacia Internet (WAN) en cualquier dirección. Esta política sería similar a las que tenemos en casa, donde podemos acceder a cualquier sitio web. Además, desde aquí podemos decir que haga SNAT, lo que nos permitirá navegar acceder a Internet. También podremos configurar hacia qué interfaz se realizará este SNAT.</p><p><img src=../img/Pastedimage20240320232648.png></p><p>Para acabar con la configuración inicial , crearemos la ruta por defecto para salir a Internet . Para ello nos iremos a Network > Static Routes :</p><p><img src=../img/Pastedimage20240320233928.png></p><p>Una vez aplicada esta política ya podremos comenzar a realizar la practica , ademas podemos acceder a Internet desde el cliente 1 :</p><p><img src=../img/Pastedimage20240320233557.png></p><h2 id=reglas-del-cortafuegos>Reglas del cortafuegos</h2><p>Para comenzar desactivare la política anterior , la editare y al final de esta le quitare el tic que la activa :</p><p><img src=../img/Pastedimage20240320234721.png></p><p>Quedando así inactiva :</p><p><img src=../img/Pastedimage20240320234740.png></p><h4 id=los-equipos-de-la-red-local-deben-poder-tener-conexión-al-exterior>Los equipos de la red local deben poder tener conexión al exterior.</h4><p>Para configurar el SNAT en dispositivos FortiGate , es un poco distinto ya que en cada regla que vayamos a permitir tendremos que marcar la casilla si queremos hacer NAT .</p><p>Ademas podemos especificar todas las opciones posibles que se nos ocurra , en mi caso dejare este apartado sin activar y lo iré haciendo en las reglas siguientes . La imagen que ves a continuación es para indicarte donde se activaría . Ademas podemos indicar porque interfaz queremos que salga el trafico . Esto es útil si tenemos dos o mas salidas de Internet para hacer un balanceador de carga .</p><p>Una vez aquí dentro de la configuración de la interfaz le decimos que la interfaz es de tipo NAT , ademas podemos indicarle que no haga PAT .</p><p><img src=../img/fw_1_a.png></p><h4 id=permitimos-hacer-ping-desde-la-lan-a-la-máquina-cortafuegos>Permitimos hacer ping desde la LAN a la máquina cortafuegos.</h4><p>En estos dispositivos no seria una regla como tal , si no que esta opción en concreto se indica desde la opción de acceso administrativo de la interfaz :</p><p><img src=../img/fw_2_a.png></p><p>Una vez aplicado , si nos vamos al cliente 1 podremos hacerle ping al cortafuegos :</p><p><img src=../img/cliente1_ping_fw.png></p><h4 id=permite-realizar-conexiones-ssh-desde-los-equipos-de-la-lan>Permite realizar conexiones ssh desde los equipos de la LAN</h4><p>Crearemos la regla que permite el trafico SSH , aqui en el origen podemos poner o el cliente1 (creamos el objeto en la preparación del escenario) o directamente poner all en el origen :</p><p><img src=../img/fw_3_a.png></p><p>Aunque actualmente en mi esquema solo tenga un cliente , ceñiendome al enunciado si quiero que TODOS los cliente de la red LAN puedan hacer ssh en origen tengo que permitir todos :</p><p><img src=../img/fw_3_a_2.png></p><p>Como te explique en el apartado a de la practica , en este tipos de dispositivo tenemos que indicarle si queremos que la regla sea de tipo NAT para que haga SNAT o no .</p><p>Una vez aplicada la regla podremos conectarnos por ssh desde el cliente1:</p><p><img src=../img/cliente1_ssh_atlas.png></p><p>Vamos a asegurarnos de que la regla tiene hits :</p><p><img src=../img/fw_3_a_hits.png></p><h4 id=permite-la-navegación-en-la-red-lan>Permite la navegación en la red LAN</h4><p>Para ello vamos a crear 2 reglas para la red LAN . Una que permita hacer consultas DNS y otra para permitir el trafico HTTPS y HTTP , ademas en ambas reglas sera necesario indicar que se haga NAT .</p><p><img src=../img/fw_4_a_dns.png></p><p><img src=../img/fw_4_a_https.png></p><p>Como te has fijado no he indicado el numero de puerto , si no que estos dispositivos tienen unos objetos llamados servicios en los cuales se almacenan los números de puerto de los mismos . Podemos crear los objetos que queramos y personalizar los existentes según nuestras necesidades .</p><p>Vamos a comprobar que podemos navegar en el cliente 1 :</p><p><img src=../img/Pastedimage20240322192235.png></p><p>Ni que decir tiene que por supuesto que podemos hacer un dig , con la regla actual lo podemos hacer a cualquier servidor DNS :</p><p><img src=../img/Pastedimage20240322192456.png></p><p>Vamos a comprobar que tenemos hits en las reglas :</p><p><img src=../img/Pastedimage20240322192318.png></p><h4 id=instala-un-servidor-de-correos-en-la-máquina-de-la-lan-permite-el-acceso-desde-el-exterior-y-desde-el-cortafuegos-al-servidor-de-correos-para-probarlo-puedes-ejecutar-un-telnet-al-puerto-25-tcp>Instala un servidor de correos en la máquina de la LAN. Permite el acceso desde el exterior y desde el cortafuegos al servidor de correos. Para probarlo puedes ejecutar un telnet al puerto 25 tcp.</h4><p>Como actualmente tenemos permitido la navegación solo por https es fundamental que los repositorios de la maquina estén configurados podremos instalar paquetes en nuestro cliente , asi que vamos a instalar postfix :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update <span style=color:#f92672>&amp;&amp;</span> sudo apt install postfix -y
</span></span></code></pre></div><p>Ahora vamos a configurar la primera regla de DNAT que vamos a tener en el escenario . Para ello tendremos que crear una IP virtual y decirle cual es la IP externa (WAN) y la IP donde vamos a hacer el DNAT (LAN) .</p><p><img src=../img/Pastedimage20240322202326.png></p><p>Ahora vamos a añadir la regla en nuestra política , en el destino de la regla indicaremos la IP virtual que acabamos de crear y indicamos el servicio SMTP que tiene configurado el puerto 25 TCP :</p><p><img src=../img/Pastedimage20240322203152.png></p><p>Y vamos a comprobar que desde un cliente externo , como es Cliente 2 podemos acceder a Cliente 1 :</p><p><img src=../img/Pastedimage20240322202558.png></p><p>Vamos a comprobar que la regla que acabamos de crear tiene hits :</p><p><img src=../img/Pastedimage20240322203530.png></p><h4 id=permite-hacer-conexiones-ssh-desde-exterior-a-la-lan>Permite hacer conexiones ssh desde exterior a la LAN</h4><p>Para realizar esto volveremos a hacer un DNAT , tendremos que volver a crear una nueva IP virtual ya que anteriormente especifique que esa IP solo se utilizaba para el protocolo SMTP . Así que voy a crear una nueva :</p><p><img src=../img/Pastedimage20240322204310.png></p><p>Una vez creada la nueva IP virtual para el ssh , crearemos la regla de DNAT :</p><p><img src=../img/Pastedimage20240322204626.png></p><p>Vamos a probar nuestra nueva regla desde el cliente 2 :</p><p><img src=../img/Pastedimage20240322204918.png></p><p>Vamos a comprobar los hits de nuestra nueva regla :</p><p><img src=../img/Pastedimage20240322205046.png></p><h4 id=modifica-la-regla-anterior-para-que-al-acceder-desde-el-exterior-por-ssh-tengamos-que-conectar-al-puerto-2222-aunque-el-servidor-ssh-este-configurado-para-acceder-por-el-puerto-22>Modifica la regla anterior, para que al acceder desde el exterior por ssh tengamos que conectar al puerto 2222, aunque el servidor ssh este configurado para acceder por el puerto 22.</h4><p>Para realizar esto tendremos que generar un nuevo servicio que este en el puerto 2222 :</p><p><img src=../img/Pastedimage20240322205327.png></p><p>Ahora vamos a modificar nuestra IP virtual modificando el servicio por el nuevo que hemos creado con el puerto 2222 y haremos un port forwarding al puerto 22 :</p><p><img src=../img/Pastedimage20240322205425.png></p><p>Una vez hecho esto podremos acceder por ssh utilizando el puerto 2222 y que nos redirija al 22 . No es necesario que modifiquemos las reglas , solo con esto ya podremos acceder :</p><p><img src=../img/Pastedimage20240322205611.png></p><p>Vamos a comprobar los hits de las reglas , ademas en el apartado de Virtual IP también tenemos un contador de hits :</p><p><img src=../img/Pastedimage20240322205747.png></p><p><img src=../img/Pastedimage20240322205954.png></p><h4 id=permite-hacer-consultas-dns-desde-la-lan-sólo-al-servidor-8888-comprueba-que-no-puedes-hacer-un-dig-1111>Permite hacer consultas DNS desde la LAN sólo al servidor 8.8.8.8. Comprueba que no puedes hacer un dig @1.1.1.1.</h4><p>Para esto vamos a modificar la regla que permite las consultas DNS y vamos a indicar que el destino solo sea 8.8.8.8 .</p><p>Primero necesitaremos crear un nuevo objeto con la IP del servidor DNS de Google :</p><p><img src=../img/Pastedimage20240322210309.png></p><p>Ahora modificamos la regla y pondremos este objeto como destino :</p><p><img src=../img/Pastedimage20240322210344.png></p><p>Vamos a comprobar la modificación de la regla , para que solo podamos hacer consultas dns a 8.8.8.8 :</p><p><img src=../img/Pastedimage20240322210423.png></p><p>Podemos comprobar que los hits han subido :</p><p><img src=../img/Pastedimage20240322210549.png></p><h4 id=permite-que-los-equipos-de-la-lan-puedan-navegar-por-internet-excepto-a-la-página-wwwrealbetisbalompiees>Permite que los equipos de la LAN puedan navegar por internet, excepto a la página <a href=https://www.realbetisbalompie.es target=_blank rel=noopener>www.realbetisbalompie.es</a></h4><p>Estos cortafuegos de nueva generación traen una serie de servicios que nos filtran en el nivel de aplicación que nos permite detectar palabras clave para filtrar el contenido (drogas , pornografía , armas &mldr; ) , en este cortafuegos el filtrar por palabras clave es un servicio de pago , hay que pagar una licencia . Ademas nos permite crear filtros para bloquear ciertas paginas web , que en este caso es gratuito.</p><p>Lo primero sera crear nuestra política de filtro_web :</p><p><img src=../img/Pastedimage20240322211146.png></p><p>Y añadimos en la misma un nuevo filtro por URL :</p><p><img src=../img/Pastedimage20240322211118.png></p><p>Ahora nos dirigimos a la regla que nos permite el trafico https y en seguridad le añadimos el filtro web que acabamos de crear :</p><p><img src=../img/Pastedimage20240322211227.png></p><p>A la izquierda accederé desde el navegador de mi maquina física y puedo acceder a la pagina del maligno , sin embargo si accedo desde el cliente 1 el firewall no nos deja acceder :</p><p><img src=../img/Pastedimage20240322211357.png></p><p>Si accedemos a FortiView Destinations podremos ver las paginas que ha bloqueado nuestro filtro :</p><p><img src=../img/Pastedimage20240322211950.png></p></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Compartir en:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_uno%2ffortinet_uno%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_uno%2ffortinet_uno%2f&text=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Fortinet%20I&via=Atlas" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_uno%2ffortinet_uno%2f&title=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Fortinet%20I" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_uno%2ffortinet_uno%2f&title=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Fortinet%20I" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Fortinet%20I https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_uno%2ffortinet_uno%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Fortinet%20I&body=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_uno%2ffortinet_uno%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/javierasping/sentinel/edit/main/content/posts/cortafuegos/fortinet_uno/fortinet_uno.md title="Mejorar esta página" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Mejorar esta página</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Contenido</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#puesta-en-marcha-del-cortafuegos>Puesta en marcha del cortafuegos</a><ul><li><a href=#configuración-de-la-red-lan>Configuración de la red LAN</a></li></ul></li><li><a href=#reglas-del-cortafuegos>Reglas del cortafuegos</a><ul><li><ul><li><a href=#los-equipos-de-la-red-local-deben-poder-tener-conexión-al-exterior>Los equipos de la red local deben poder tener conexión al exterior.</a></li><li><a href=#permitimos-hacer-ping-desde-la-lan-a-la-máquina-cortafuegos>Permitimos hacer ping desde la LAN a la máquina cortafuegos.</a></li><li><a href=#permite-realizar-conexiones-ssh-desde-los-equipos-de-la-lan>Permite realizar conexiones ssh desde los equipos de la LAN</a></li><li><a href=#permite-la-navegación-en-la-red-lan>Permite la navegación en la red LAN</a></li><li><a href=#instala-un-servidor-de-correos-en-la-máquina-de-la-lan-permite-el-acceso-desde-el-exterior-y-desde-el-cortafuegos-al-servidor-de-correos-para-probarlo-puedes-ejecutar-un-telnet-al-puerto-25-tcp>Instala un servidor de correos en la máquina de la LAN. Permite el acceso desde el exterior y desde el cortafuegos al servidor de correos. Para probarlo puedes ejecutar un telnet al puerto 25 tcp.</a></li><li><a href=#permite-hacer-conexiones-ssh-desde-exterior-a-la-lan>Permite hacer conexiones ssh desde exterior a la LAN</a></li><li><a href=#modifica-la-regla-anterior-para-que-al-acceder-desde-el-exterior-por-ssh-tengamos-que-conectar-al-puerto-2222-aunque-el-servidor-ssh-este-configurado-para-acceder-por-el-puerto-22>Modifica la regla anterior, para que al acceder desde el exterior por ssh tengamos que conectar al puerto 2222, aunque el servidor ssh este configurado para acceder por el puerto 22.</a></li><li><a href=#permite-hacer-consultas-dns-desde-la-lan-sólo-al-servidor-8888-comprueba-que-no-puedes-hacer-un-dig-1111>Permite hacer consultas DNS desde la LAN sólo al servidor 8.8.8.8. Comprueba que no puedes hacer un dig @1.1.1.1.</a></li><li><a href=#permite-que-los-equipos-de-la-lan-puedan-navegar-por-internet-excepto-a-la-página-wwwrealbetisbalompiees>Permite que los equipos de la LAN puedan navegar por internet, excepto a la página <a href=http://www.realbetisbalompie.es>www.realbetisbalompie.es</a></a></li></ul></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navegación</h5><ul><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#about>Sobre mi</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#skills>Competencias</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#education>Educación</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#recent-posts>Últimas publicaciones</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#accomplishments>Certificaciones</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contacto</h5><ul><li><a href=mailto:contacto@javiercd.es target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>contacto@javiercd.es</span></a></li><li><a href=https://github.com/javierasping target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>javierasping</span></a></li><li><a href=https://www.linkedin.com/in/javiercd target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Francisco Javier Cruces Doval</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>Aviso de responsabilidad:</strong> This theme is under MIT license. So, you can use it for non-commercial, commercial, or private uses. You can modify or distribute the theme without requiring any permission from the theme author. However, the theme author does not provide any warranty or takes any liability for any issue with the theme.</p></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2023 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Funcionando con
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.56b3322973c3dd1822b04ec8721319a1bec1ace05069cda4c18909131b786c30.js integrity="sha256-VrMyKXPD3RgisE7IchMZob7BrOBQac2kwYkJExt4bDA=" defer></script></body></html>