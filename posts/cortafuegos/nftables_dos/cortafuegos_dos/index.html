<!doctype html><html lang=es><head><title>Implementación de un cortafuegos perimetral con Nftables II</title><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.ddf4c4775d35e5bc3dd64c797b179f99eaf85cf9811e64bd08f8c44a68d0b229.css integrity="sha256-3fTEd1015bw91kx5exefmer4XPmBHmS9CPjESmjQsik="><link rel=icon type=image/png href=/images/site/avatar_hu_f10227dc088ad43a.jpg><meta property="og:title" content="Atlas"><meta property="og:type" content="website"><meta property="og:description" content="Portafolio y blog personal de Francisco Javier Cruces Doval"><meta property="og:image" content="/images/author/john.png"><meta property="og:url" content="https://www.javiercd.es"><meta name=description content="Implementación de un cortafuegos perimetral con Nftables II"><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/masthead_hu_f10227dc088ad43a.png id=logo alt=Logo>
Atlas</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>Inicio</a></li><li class=nav-item><a class=nav-link href=/#about>Sobre mi</a></li><li class=nav-item><a class=nav-link href=/#skills>Competencias</a></li><li class=nav-item><a class=nav-link href=/#education>Educación</a></li><li class=nav-item><a class=nav-link href=/#recent-posts>Últimas publicaciones</a></li><li class=nav-item><a class=nav-link href=/#accomplishments>Certificaciones</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=languageSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><span class="fi fi-es"></span>
Español</a><div class=dropdown-menu aria-labelledby=languageSelector><a class="dropdown-item nav-link languages-item" href=/posts/cortafuegos/nftables_dos/cortafuegos_dos><span class="fi fi-es"></span>
Español
</a><a class="dropdown-item nav-link languages-item" href=/en/posts/cortafuegos/nftables_dos/cortafuegos_dos><span class="fi fi-gb"></span>
English</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Búsqueda data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/posts/iaw/> Aplicaciones webs</a><ul><li><a class=list-link href=/posts/iaw/lamp/ title="Instalación pila LAMP">Instalación pila LAMP</a></li><li><a class=list-link href=/posts/iaw/lemp/ title="Instalación pila LEMP">Instalación pila LEMP</a></li><li><a class=list-link href=/posts/iaw/wordpress/ title="Wordpress LAMP">Wordpress LAMP</a></li><li><a class=list-link href=/posts/iaw/wordpress_lemp/ title="Wordpress LEMP">Wordpress LEMP</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/base_de_datos/> Base de datos</a><ul><li><a class=list-link href=/posts/base_de_datos/acceso_remoto_mariadb/ title="Acceso remoto en MariaDB">Acceso remoto en MariaDB</a></li><li><a class=list-link href=/posts/base_de_datos/oracle_acceso_remoto/ title="Configuración de acceso remoto en Oracle">Configuración de acceso remoto en Oracle</a></li><li><a class=list-link href=/posts/base_de_datos/instalacion_oracle_19c_debian12/ title="Instalación de Oracle 19c bajo Debian 12">Instalación de Oracle 19c bajo Debian 12</a></li><li><a class=list-link href=/posts/base_de_datos/instalar_postgresql/ title="Instalación de PostgreSQL en Debian 12">Instalación de PostgreSQL en Debian 12</a></li><li><a class=list-link href=/posts/base_de_datos/instalar_mariadb/ title="Instalar MariaDB en Debian">Instalar MariaDB en Debian</a></li><li><a class=list-link href=/posts/base_de_datos/interconexion_de_servidores/ title="Interconexión de servidores de bases de datos">Interconexión de servidores de bases de datos</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/ci_cd/> CI/CD Jenkins</a><ul><li><a class=list-link href=/posts/ci_cd/practica_jenkins/ title="Práctica CI/CD con Jenkins">Práctica CI/CD con Jenkins</a></li><li><a class=list-link href=/posts/ci_cd/taller1_jenkins/ title="Taller 1 Corrector ortográfico de documentos markdown (test)">Taller 1 Corrector ortográfico de documentos markdown (test)</a></li><li><a class=list-link href=/posts/ci_cd/taller2_jenkins/ title="Taller 2 Comprobación de HTML5 válido y despliegue en surge.sh (test y deploy)">Taller 2 Comprobación de HTML5 válido y despliegue en surge.sh (test y deploy)</a></li><li><a class=list-link href=/posts/ci_cd/taller3_jenkins/ title="Taller 3 Integración continua de aplicación django (Test)">Taller 3 Integración continua de aplicación django (Test)</a></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/posts/cortafuegos/> Cortafuegos</a><ul class=active><li><a class=list-link href=/posts/cortafuegos/fortinet_cli/ title="Fortinet CLI">Fortinet CLI</a></li><li><a class=list-link href=/posts/cortafuegos/fortinet_uno/ title="Perimetral con Fortinet I">Perimetral con Fortinet I</a></li><li><a class=list-link href=/posts/cortafuegos/fortinet_dos/ title="Perimetral con Fortinet II">Perimetral con Fortinet II</a></li><li><a class=list-link href=/posts/cortafuegos/nftables_uno/ title="Perimetral con Nftables I">Perimetral con Nftables I</a></li><li><a class="active list-link" href=/posts/cortafuegos/nftables_dos/ title="Perimetral con Nftables II">Perimetral con Nftables II</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/docker/> Docker</a><ul><li><a class=list-link href=/posts/docker/instalar_docker_compose/ title="Instalación de Docker Compose en Ubuntu 24">Instalación de Docker Compose en Ubuntu 24</a></li><li><a class=list-link href=/posts/docker/instalar_docker_ubuntu24/ title="Instalación de Docker en Ubuntu 24">Instalación de Docker en Ubuntu 24</a></li><li><a class=list-link href=/posts/docker/taller1/ title="Taller 1 Almacenamiento y redes en Docker">Taller 1 Almacenamiento y redes en Docker</a></li><li><a class=list-link href=/posts/docker/taller2/ title="Taller 2 Escenarios multicontenedor en Docker">Taller 2 Escenarios multicontenedor en Docker</a></li><li><a class=list-link href=/posts/docker/taller3/ title="Taller 3 Creación de imágenes Docker">Taller 3 Creación de imágenes Docker</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/drivers/> Drivers Linux</a><ul><li><a class=list-link href=/posts/drivers/nvidia_optimus/ title="Como elegir que gráfica usar en mi portátil con Linux">Como elegir que gráfica usar en mi portátil con Linux</a></li><li><a class=list-link href=/posts/drivers/nvidia_driver/ title="Drivers Nvidia">Drivers Nvidia</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/observabilidad/> Observabilidad</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/posts/observabilidad/metricas/> Métricas</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/posts/observabilidad/metricas/prometheus/> Prometheus</a><ul><li><a class=list-link href=/posts/observabilidad/metricas/prometheus/instalacion_basica_docker_compose/ title="Instalación de Prometheus con docker-compose y Node Exporter en Debian 12">Instalación de Prometheus con docker-compose y Node Exporter en Debian 12</a></li></ul></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/redes/> Redes</a><ul><li><a class=list-link href=/posts/redes/android_gns3/ title="Android GNS3-KVM">Android GNS3-KVM</a></li><li><a class=list-link href=/posts/redes/comandos_de_supervision_de_redes/ title="Comandos de supervisión de redes">Comandos de supervisión de redes</a></li><li><a class=list-link href=/posts/redes/switches_gns3/ title="Configuración de switches en GNS3">Configuración de switches en GNS3</a></li><li><a class=list-link href=/posts/redes/enroutamiento_openstack/ title="Enrutamiento en OpenStack">Enrutamiento en OpenStack</a></li><li><a class=list-link href=/posts/redes/escenario_ipv6_basico/ title="Escenario IPv6 Básico">Escenario IPv6 Básico</a></li><li><a class=list-link href=/posts/redes/instalar_gns3_debian12/ title="Instalacion GNS3 en Debian 12">Instalacion GNS3 en Debian 12</a></li><li><a class=list-link href=/posts/redes/instalacion_wireshark_gns3/ title="Instalacion GNS3 y Wireshark">Instalacion GNS3 y Wireshark</a></li><li><a class=list-link href=/posts/redes/configuracion_de_nat/ title="NAT en Cisco y Linux">NAT en Cisco y Linux</a></li><li><a class=list-link href=/posts/redes/arp/ title="Protocolo ARP">Protocolo ARP</a></li><li><a class=list-link href=/posts/redes/tuneles_ipv6/ title="Túneles IPV6">Túneles IPV6</a></li><li><a class=list-link href=/posts/redes/underworld/ title=Underworld>Underworld</a></li><li><a class=list-link href=/posts/redes/underworld_evolution/ title="Underworld evolution">Underworld evolution</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/seguridad/> Seguridad</a><ul><li><a class=list-link href=/posts/seguridad/https_autofirmado/ title=HTTPS>HTTPS</a></li><li><a class=list-link href=/posts/seguridad/forense/ title="Informática forense">Informática forense</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/servicios/> Servicios</a><ul><li><a class=list-link href=/posts/servicios/apache/ title=Apache>Apache</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/servicios/dhcp/> DHCP</a><ul><li><a class=list-link href=/posts/servicios/dhcp/instalacion_y_configuracion_de_un_servidor_dhcp_en_linux/ title="Instalación y configuración de un servidor DHCP en Linux">Instalación y configuración de un servidor DHCP en Linux</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/servicios/dns/> DNS</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/posts/servicios/dns/bind9/> BIND9</a><ul><li><a class=list-link href=/posts/servicios/dns/bind9/dns_esclavo/ title="Configuring a Slave DNS Server with BIND9">Configuring a Slave DNS Server with BIND9</a></li><li><a class=list-link href=/posts/servicios/dns/bind9/instalacion_basica/ title="Instalación y configuración de BIND9 en Linux">Instalación y configuración de BIND9 en Linux</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/servicios/dns/dnsmasq/> DNSMASQ</a><ul><li><a class=list-link href=/posts/servicios/dns/dnsmasq/instalacion_basica/ title="Servidor local con DNSMasq">Servidor local con DNSMasq</a></li></ul></li></ul></li><li><a class=list-link href=/posts/servicios/ftp/ title=FTP>FTP</a></li><li><a class=list-link href=/posts/servicios/nat_iptables/ title="NAT con iptables">NAT con iptables</a></li><li><a class=list-link href=/posts/servicios/ssh/ title=SSH>SSH</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/> Sistemas</a><ul><li><a class=list-link href=/posts/sistemas/ad_ubuntu/ title="Active Directory en Ubuntu">Active Directory en Ubuntu</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/comandos_linux/> Comandos en Linux</a><ul><li><a class=list-link href=/posts/sistemas/comandos_linux/ejercicios_de_manejo_de_modulos/ title="Ejercicios de manejo de módulos">Ejercicios de manejo de módulos</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/ejercicios_de_modificacion_de_parametros_del_kernel/ title="Ejercicios de modificación de parámetros del kernel">Ejercicios de modificación de parámetros del kernel</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/ejercicios_gestion_de_paqueteria/ title="Ejercicios gestión de paquetería">Ejercicios gestión de paquetería</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/empaquetadores_compresores/ title="Empaquetadores y compresores">Empaquetadores y compresores</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/gestion_de_paquetes/ title="Gestión de paquetes">Gestión de paquetes</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/comandos_procesos/ title="Procesos en Linux">Procesos en Linux</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/programacion_tareas/ title="Programación de tareas">Programación de tareas</a></li></ul></li><li><a class=list-link href=/posts/sistemas/comparticion_de_directorios_en_windows/ title="Compartir recursos en Windows">Compartir recursos en Windows</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/compilaciones_linux/> Compilaciones en Linnux</a><ul><li><a class=list-link href=/posts/sistemas/compilaciones_linux/compilacion_de_un_kernel/ title="Compilación de un kernel">Compilación de un kernel</a></li><li><a class=list-link href=/posts/sistemas/compilaciones_linux/compilacion_de_un_programa_en_c_utilizando_un_makefile/ title="Compilación de un programa en C utilizando un Makefile">Compilación de un programa en C utilizando un Makefile</a></li></ul></li><li><a class=list-link href=/posts/sistemas/activacion_selinux/ title="Configuración activación de SELinux">Configuración activación de SELinux</a></li><li><a class=list-link href=/posts/sistemas/creacion_de_un_sistema_automatizado_de_instalacion/ title="Creación de un sistema automatizado de instalación">Creación de un sistema automatizado de instalación</a></li><li><a class=list-link href=/posts/sistemas/samba_debian/ title="Instalar y configurar samba en Debian">Instalar y configurar samba en Debian</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/migraciones/> Migraciones en Linnux</a><ul><li><a class=list-link href=/posts/sistemas/migraciones/eliminacion_systemd/ title="Eliminación de systemd">Eliminación de systemd</a></li><li><a class=list-link href=/posts/sistemas/migraciones/paso_de_centos_stream_8_a_centos_stream_9/ title="Paso de CentOS stream 8 a CentOS stream 9">Paso de CentOS stream 8 a CentOS stream 9</a></li><li><a class=list-link href=/posts/sistemas/migraciones/migracion_sistema_de_ficheros/ title="Sistema de ficheros">Sistema de ficheros</a></li><li><a class=list-link href=/posts/sistemas/migraciones/transformacion_instancia_cloud/ title="Transformación instancia cloud">Transformación instancia cloud</a></li></ul></li><li><a class=list-link href=/posts/sistemas/nfs_debian/ title="NFS en Debian">NFS en Debian</a></li><li><a class=list-link href=/posts/sistemas/recoleccion_logs_journald/ title="Recolección centralizada de logs journald">Recolección centralizada de logs journald</a></li><li><a class=list-link href=/posts/sistemas/ssh_windows/ title="Servicio ssh en Windows">Servicio ssh en Windows</a></li><li><a class=list-link href=/posts/sistemas/almacenamiento_servidor_independiente/ title="Storage Spaces en Windows Server">Storage Spaces en Windows Server</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/vpn/> VPN</a><ul><li><a class=list-link href=/posts/vpn/acceso_remoto_strongswang/ title="Acceso remoto Ipsec StrongSwan">Acceso remoto Ipsec StrongSwan</a></li><li><a class=list-link href=/posts/vpn/acceso_remoto_openvpn/ title="Acceso remoto OpenVPN">Acceso remoto OpenVPN</a></li><li><a class=list-link href=/posts/vpn/acceso_remoto_wireguard/ title="Acceso remoto Wireguard">Acceso remoto Wireguard</a></li><li><a class=list-link href=/posts/vpn/comparativa_ovpn_wire/ title="Comparativa OpenVPN y Wireguard">Comparativa OpenVPN y Wireguard</a></li><li><a class=list-link href=/posts/vpn/ipsec_cisco/ title="Site-to-Site IPsec Cisco">Site-to-Site IPsec Cisco</a></li><li><a class=list-link href=/posts/vpn/site_to_site_fortinet/ title="Site-to-Site IPsec Fortinet">Site-to-Site IPsec Fortinet</a></li><li><a class=list-link href=/posts/vpn/site_to_site_openvpn/ title="Site-to-Site OpenVPN">Site-to-Site OpenVPN</a></li><li><a class=list-link href=/posts/vpn/site_to_site_wireguard/ title="Site-to-Site Wireguard">Site-to-Site Wireguard</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/cortafuegos/nftables2.png)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/john_hu_2aff0fda0501496d.png alt="Author Image"><h5 class=author-name>Francisco Javier Cruces Doval</h5><p class=text-muted>jueves, 28 de marzo de 2024 | 43 minutos</p></div><div class=title><h1>Implementación de un cortafuegos perimetral con Nftables II</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/tags/firewall/ class="btn btn-sm btn-info">FIREWALL</a></li><li class=rounded><a href=/tags/linux/ class="btn btn-sm btn-info">LINUX</a></li><li class=rounded><a href=/tags/debian/ class="btn btn-sm btn-info">DEBIAN</a></li><li class=rounded><a href=/tags/nftables/ class="btn btn-sm btn-info">NFTABLES</a></li></ul></div><div class=post-content id=post-content><p>Sobre el escenario creado en el módulo de servicios con las máquinas Odin (Router), Hela (DMZ), Loki y Thor (LAN) y empleando nftables, configura un cortafuegos perimetral en la máquina Odin de forma que el escenario siga funcionando completamente teniendo en cuenta los siguientes puntos:</p><pre><code>• Se valorará la creación de cadenas diferentes para cada flujo de tráfico (de LAN al exterior, de LAN a DMZ, etc…).
• Política por defecto DROP para todas las cadenas.
• Se pueden usar las extensiones que creamos adecuadas, pero al menos debe implementarse seguimiento de la conexión cuando sea necesario.
• Debemos implementar que el cortafuegos funcione después de un reinicio de la máquina.
• Debes mostrar pruebas de funcionamiento de todas las reglas.
</code></pre><p>Para no hacer demasiado larga la practica , voy a mostrarte los hits de las reglas al final , así como el script completo de las reglas . Ya que solo te pondré en cada ejercicio las reglas que intervienen y una comprobación del mismo .</p><h2 id=montar-el-escenario-con-nftables>Montar el escenario con Nftables</h2><p>Voy a eliminar iptables y vamos a pasar a Nftables para que no perdamos ninguna funcionalidad del escenario .</p><p>Lo primero sera crear las tablas y cadenas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft add table inet filter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter input <span style=color:#f92672>{</span> type filter hook input priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter output <span style=color:#f92672>{</span> type filter hook output priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter WAN_LAN <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter WAN_DMZ <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter LAN_WAN <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter LAN_DMZ <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter DMZ_LAN <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter DMZ_WAN <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Así quedarían nuestras cadenas creadas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft list chains
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain WAN_LAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain WAN_DMZ <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain LAN_WAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain DMZ_LAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain LAN_DMZ <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain DMZ_WAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>La red LAN corresponde a la red de los contenedores 192.168.0.0/24 .
La red DMZ corresponde a la red de hela 172.16.0.0/16 .</p><p>Continuamos creando la tabla de NAT para poder configurar el SNAT y el DNAT , estas ya que suelen ser un numero reducido de reglas no voy a crear distintas cadenas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Creamos la tabla NAT</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add table nat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Cadena para el DNAT</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain nat prerouting <span style=color:#f92672>{</span> type nat hook prerouting priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Cadena para el SNAT</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain nat postrouting <span style=color:#f92672>{</span> type nat hook postrouting priority <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=reglas-snat>Reglas SNAT</h3><p>Una vez hecho esto voy a crear las reglas de SNAT para que nuestros clientes puedan salir a Internet en la red LAN y DMZ :</p><p>Mi tarjeta de red que esta de cara al exterior es la ens4 .</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Regla SNAT para LAN</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter masquerade
</span></span><span style=display:flex><span><span style=color:#75715e># Regla SNAT para DMZ</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> iffname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.0/16 counter masquerade
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter snat to 172.22.200.47
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.0/16 counter snat to 172.22.200.47
</span></span></code></pre></div><p>Vamos a comprobar que en los clientes ya pueden acceder a Internet , actualmente la política por defecto es ACCEPT.</p><p>Comprobación de SNAT en Hela :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ ping www.javiercd.es -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING javierasping.github.io <span style=color:#f92672>(</span>185.199.109.153<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from cdn-185-199-109-153.github.com <span style=color:#f92672>(</span>185.199.109.153<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span> time<span style=color:#f92672>=</span>39.4 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- javierasping.github.io ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 39.439/39.439/39.439/0.000 ms
</span></span></code></pre></div><p>Comprobación de SNAT en Thor :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@thor:~$ ping www.javiercd.es -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING javierasping.github.io <span style=color:#f92672>(</span>185.199.108.153<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from cdn-185-199-108-153.github.com <span style=color:#f92672>(</span>185.199.108.153<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span> time<span style=color:#f92672>=</span>38.1 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- javierasping.github.io ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 38.138/38.138/38.138/0.000 ms
</span></span></code></pre></div><p>Comprobación de SNAT en Loki :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@loki:~$ ping www.javiercd.es -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING javierasping.github.io <span style=color:#f92672>(</span>185.199.111.153<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from cdn-185-199-111-153.github.com <span style=color:#f92672>(</span>185.199.111.153<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span> time<span style=color:#f92672>=</span>37.7 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- javierasping.github.io ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 37.667/37.667/37.667/0.000 ms
</span></span></code></pre></div><p>Por ultimo nos aseguraremos de que la regla recibe hits :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft list ruleset
</span></span><span style=display:flex><span><span style=color:#75715e># Salida del comando recortada</span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.0/16 counter packets <span style=color:#ae81ff>11</span> bytes <span style=color:#ae81ff>868</span> masquerade
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter packets <span style=color:#ae81ff>122</span> bytes <span style=color:#ae81ff>10594</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=reglas-de-dnat>Reglas de DNAT</h3><p>Las reglas anteriores que teníamos eran las siguientes :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo iptables -L -t nat
</span></span><span style=display:flex><span>Chain PREROUTING <span style=color:#f92672>(</span>policy ACCEPT<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>target     prot opt source               destination         
</span></span><span style=display:flex><span>DNAT       tcp  --  anywhere             anywhere             tcp dpt:http to:172.16.0.200
</span></span><span style=display:flex><span>DNAT       udp  --  anywhere             anywhere             udp dpt:domain to:192.168.0.2
</span></span><span style=display:flex><span>DNAT       tcp  --  anywhere             anywhere             tcp dpt:smtp to:192.168.0.3
</span></span><span style=display:flex><span>DNAT       tcp  --  anywhere             anywhere             tcp dpt:mysql to:192.168.0.3
</span></span></code></pre></div><p>Así que vamos a pasarlas a nftables :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Para un wordpress que hay en hela</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>80</span> counter dnat to 172.16.0.200
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Para hacer consultas DNS a thor</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting udp dport <span style=color:#ae81ff>53</span> counter dnat to 192.168.0.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Para poder recibir correos en loki</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>25</span> counter dnat to 192.168.0.3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Para acceder desde fuera a un mysql que hay en loki</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>3306</span> counter dnat to 192.168.0.3
</span></span></code></pre></div><p>Ahora vamos a añadir una series de reglas para permitir el trafico anterior y el resto de la preparacion del escenario :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># PERMITIR USO DE ODIN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Permitir consultas DNS de odin a thor (DNSSERVER)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Permitir tráfico HTTP y HTTPS en odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp dport <span style=color:#f92672>{</span> 80,443 <span style=color:#f92672>}</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp sport <span style=color:#f92672>{</span> 80,443 <span style=color:#f92672>}</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Permitir conexiones SSH por el puerto 2222</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter dnat to 192.168.0.1:22
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Permitir conexiones SSH de odin a hela</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.0/16 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.0/16 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Permitir conexiones ssh de odin a thor y loki</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.0/24 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Reglas perimetrales</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Permitir consultas DNS desde br-intra hacia ens4 , necesario para el forward del dns (ESTA REGLA SOLO ME FUNCIONA SI ESTA EN LA MISMA CADENA)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_WAN iifname &#34;br-intra2&#34; oifname &#34;ens4&#34; udp dport 53 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_DMZ iifname &#34;ens4&#34; oifname &#34;br-intra2&#34; udp sport 53 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Permitir consultas dns desde LAN a DMZ (hela --&gt; thor) (ESTA REGLA SOLO ME FUNCIONA SI ESTA EN LA MISMA CADENA)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; udp dport 53 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; udp sport 53 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Reglas para permitir trafico a wordpress en hela</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Regla para hacer consultas DNS a thor (Permitir DNAT)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 udp dport <span style=color:#ae81ff>53</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.2 udp sport <span style=color:#ae81ff>53</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Regla para recibir e enviar correos en loki</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Permitir a hela usar el servidor LDAP</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter LAN_DMZ iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> tcp dport <span style=color:#ae81ff>389</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_LAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>389</span> counter accept
</span></span></code></pre></div><h2 id=ejercicios>Ejercicios</h2><p>El cortafuegos debe cumplir al menos estas reglas:</p><h3 id=la-máquina-odin-tiene-un-servidor-ssh-escuchando-por-el-puerto-22-pero-al-acceder-desde-el-exterior-habrá-que-conectar-al-puerto-2222>La máquina Odin tiene un servidor ssh escuchando por el puerto 22, pero al acceder desde el exterior habrá que conectar al puerto 2222.</h3><p>Para realizar este ejercicio voy a hacer un DNAT a la interfaz de DMZ de odin que es la 192.168.0.1 , asi me conectare a esa interfaz por ssh . Posteriomente hay que permitir este trafico que va desde la ens4 a la ens3 .</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Permitimos el trafico que ahora &#34;cambiamos&#34; el puerto con la regla DNAT de 2222 a 22 hacia odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span><span style=color:#75715e># Regla DNAT</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter dnat to 192.168.0.1:22
</span></span></code></pre></div><p>Pondré la política por defecto DROP una vez llegado a este punto :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nft chain inet filter input <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter output <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter WAN_LAN <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter WAN_DMZ <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter LAN_WAN <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter DMZ_LAN <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter LAN_DMZ <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter DMZ_WAN <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Y vamos a comprobar que la conexión funciona por el puerto 2222 :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~$ ssh 172.22.200.47 -p <span style=color:#ae81ff>2222</span>
</span></span><span style=display:flex><span>Linux odin.javiercd.gonzalonazareno.org 6.1.0-18-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Sat Mar  <span style=color:#ae81ff>9</span> 13:49:09 <span style=color:#ae81ff>2024</span> from 172.29.0.58
</span></span><span style=display:flex><span>javiercruces@odin:~$ 
</span></span></code></pre></div><p>Comprobamos los hits en las reglas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft list ruleset
</span></span><span style=display:flex><span><span style=color:#75715e># IMPUT</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>241918</span> bytes <span style=color:#ae81ff>13788652</span> accept
</span></span><span style=display:flex><span><span style=color:#75715e>#OUTPUT</span>
</span></span><span style=display:flex><span>oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>355383</span> bytes <span style=color:#ae81ff>210012030</span> accept
</span></span><span style=display:flex><span><span style=color:#75715e>#DNAT</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter packets <span style=color:#ae81ff>5</span> bytes <span style=color:#ae81ff>300</span> dnat to 192.168.0.1:22
</span></span></code></pre></div><h3 id=desde-thor-y-hela-se-debe-permitir-la-conexión-ssh-por-el-puerto-22-a-la-máquina-odin>Desde Thor y Hela se debe permitir la conexión ssh por el puerto 22 a la máquina Odin.</h3><p>Para poder comprobar estas reglas voy a permitir las conexiones ssh desde Odin a ambas redes DMZ y LAN</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Permitir conexiones ssh de odin a hela</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.0/16 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.0/16 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Permitir conexiones ssh de odin a thor y loki</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.0/24 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Permitir conexion ssh desde hela a odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Permitir conexion ssh desde thor a odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.2 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span></code></pre></div><p>Vamos a comprobar las 2 reglas anteriores conectándonos a Odin por ssh desde estos dos clientes :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Hela --&gt; Odin</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ ssh 172.16.0.200 -A
</span></span><span style=display:flex><span>Last login: Sat Mar  <span style=color:#ae81ff>9</span> 19:02:49 <span style=color:#ae81ff>2024</span> from 172.16.0.1
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ ssh 172.16.0.1
</span></span><span style=display:flex><span>Linux odin.javiercd.gonzalonazareno.org 6.1.0-18-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Sat Mar  <span style=color:#ae81ff>9</span> 19:49:28 <span style=color:#ae81ff>2024</span> from 192.168.0.2
</span></span><span style=display:flex><span>javiercruces@odin:~$ 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Thor --&gt; Odin</span>
</span></span><span style=display:flex><span>javiercruces@thor:~$ ssh 192.168.0.1
</span></span><span style=display:flex><span>Linux odin.javiercd.gonzalonazareno.org 6.1.0-18-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Sat Mar  <span style=color:#ae81ff>9</span> 19:46:12 <span style=color:#ae81ff>2024</span> from 192.168.0.2
</span></span><span style=display:flex><span>javiercruces@odin:~$ 
</span></span></code></pre></div><p>Te dejare los hits de las reglas al final de la practica .</p><h3 id=la-máquina-odin-debe-tener-permitido-el-tráfico-para-la-interfaz-loopback>La máquina Odin debe tener permitido el tráfico para la interfaz loopback.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept    
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept
</span></span></code></pre></div><p>Comprobación :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ ping 127.0.0.1 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 127.0.0.1 <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 127.0.0.1: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.100 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 127.0.0.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.100/0.100/0.100/0.000 ms
</span></span></code></pre></div><h3 id=a-la-máquina-odin-se-le-puede-hacer-ping-desde-la-dmz-pero-desde-la-lan-se-le-debe-rechazar-la-conexión-reject-y-desde-el-exterior-se-rechazará-de-manera-silenciosa>A la máquina Odin se le puede hacer ping desde la DMZ, pero desde la LAN se le debe rechazar la conexión (REJECT) y desde el exterior se rechazará de manera silenciosa.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># DMZ</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol icmp icmp type echo-reply counter accept
</span></span><span style=display:flex><span><span style=color:#75715e># Las siguientes 2 reglas , no funcionaran como esperamos ya que hacen lo mismo que la politica por defecto , ademas no se permite este trafico .</span>
</span></span><span style=display:flex><span><span style=color:#75715e># LAN </span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp counter reject
</span></span><span style=display:flex><span><span style=color:#75715e># Exterior</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp counter drop
</span></span></code></pre></div><p>Vamos a comprobar estas reglas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># LAN Thor a odin</span>
</span></span><span style=display:flex><span>javiercruces@thor:~$ ping 192.168.0.1
</span></span><span style=display:flex><span>PING 192.168.0.1 <span style=color:#f92672>(</span>192.168.0.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>From 192.168.0.1 icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Destination Port Unreachable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># DMZ , Hela --&gt; Odin</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ ping 172.16.0.1 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 172.16.0.1 <span style=color:#f92672>(</span>172.16.0.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 172.16.0.1: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.471 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 172.16.0.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.471/0.471/0.471/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Exterior a odin</span>
</span></span><span style=display:flex><span>javiercruces@HPOMEN15:~$ ping 172.22.200.47
</span></span><span style=display:flex><span>PING 172.22.200.47 <span style=color:#f92672>(</span>172.22.200.47<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 172.22.200.47 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>419</span> packets transmitted, <span style=color:#ae81ff>0</span> received, 100% packet loss, time 428036ms
</span></span></code></pre></div><p>Al final de la practica te dejare todos los hits de las reglas .</p><h3 id=la-máquina-odin-puede-hacer-ping-a-la-lan-la-dmz-y-al-exterior>La máquina Odin puede hacer ping a la LAN, la DMZ y al exterior.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># PERMITIR PING A DMZ</span>
</span></span><span style=display:flex><span>sudo nft insert rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft insert rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># PERMITIR PING A EXTERIOR</span>
</span></span><span style=display:flex><span>sudo nft insert rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft insert rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># PERMITIR PING A LAN</span>
</span></span><span style=display:flex><span>sudo nft insert rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft insert rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-reply counter accept
</span></span></code></pre></div><p>Comprobación :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ ping 8.8.8.8 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 8.8.8.8 <span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 8.8.8.8: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>116</span> time<span style=color:#f92672>=</span>8.70 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 8.8.8.8 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 8.701/8.701/8.701/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ ping 192.168.0.2 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.0.2 <span style=color:#f92672>(</span>192.168.0.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>6.030 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.030/0.030/0.030/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ ping 172.16.0.200 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 172.16.0.200 <span style=color:#f92672>(</span>172.16.0.200<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 172.16.0.200: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>59.1 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 172.16.0.200 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 59.052/59.052/59.052/0.000 ms
</span></span></code></pre></div><h3 id=desde-la-máquina-hela-se-puede-hacer-ping-y-conexión-ssh-a-las-máquinas-de-la-lan>Desde la máquina Hela se puede hacer ping y conexión ssh a las máquinas de la LAN.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>## Si no estan en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 ip protocol icmp icmp type echo-request counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 ip protocol icmp icmp type echo-reply counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp dport 22 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp sport 22 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 ip protocol icmp icmp type echo-reply counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter accept
</span></span></code></pre></div><p>Comprobación :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ ping 192.168.0.2
</span></span><span style=display:flex><span>PING 192.168.0.2 <span style=color:#f92672>(</span>192.168.0.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>0.596 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 192.168.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.596/0.596/0.596/0.000 ms
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ ssh  192.168.0.2
</span></span><span style=display:flex><span>Welcome to Ubuntu 22.04.3 LTS <span style=color:#f92672>(</span>GNU/Linux 6.1.0-18-amd64 x86_64<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> * Documentation:  https://help.ubuntu.com
</span></span><span style=display:flex><span> * Management:     https://landscape.canonical.com
</span></span><span style=display:flex><span> * Support:        https://ubuntu.com/advantage
</span></span><span style=display:flex><span>Last login: Sun Mar <span style=color:#ae81ff>10</span> 14:52:57 <span style=color:#ae81ff>2024</span> from 192.168.0.1
</span></span><span style=display:flex><span>javiercruces@thor:~$ 
</span></span></code></pre></div><h3 id=desde-cualquier-máquina-de-la-lan-se-puede-conectar-por-ssh-a-la-máquina-hela>Desde cualquier máquina de la LAN se puede conectar por ssh a la máquina Hela.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>## Si no esta en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 22 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 22 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter accept
</span></span></code></pre></div><p>Comprobación :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@thor:~$ ssh 172.16.0.200
</span></span><span style=display:flex><span>Last login: Sun Mar <span style=color:#ae81ff>10</span> 14:53:12 <span style=color:#ae81ff>2024</span> from 192.168.0.2
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ 
</span></span></code></pre></div><h3 id=configura-la-máquina-odin-para-que-las-máquinas-de-lan-y-dmz-puedan-acceder-al-exterior>Configura la máquina Odin para que las máquinas de LAN y DMZ puedan acceder al exterior.</h3><p>Estas reglas ya estaban indicadas previamente .</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter masquerade
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.0/16 counter masquerade
</span></span></code></pre></div><h3 id=las-máquinas-de-la-lan-pueden-hacer-ping-al-exterior-y-navegar>Las máquinas de la LAN pueden hacer ping al exterior y navegar.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Las máquinas de la LAN pueden hacer ping al exterior y navegar. </span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Si no estan en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_WAN iifname &#34;br-intra2&#34; oifname &#34;ens4&#34; ip protocol icmp icmp type echo-request counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_LAN iifname &#34;ens4&#34; oifname &#34;br-intra2&#34; ip protocol icmp icmp type echo-reply counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp icmp type echo-reply counter accept
</span></span></code></pre></div><p>Comprobación :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@thor:~$ curl -I https://www.javiercd.es
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span> 
</span></span><span style=display:flex><span>server: GitHub.com
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>last-modified: Sat, <span style=color:#ae81ff>02</span> Mar <span style=color:#ae81ff>2024</span> 10:17:01 GMT
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>31556952</span>
</span></span><span style=display:flex><span>etag: <span style=color:#e6db74>&#34;65e2fc9d-675b&#34;</span>
</span></span><span style=display:flex><span>expires: Sun, <span style=color:#ae81ff>10</span> Mar <span style=color:#ae81ff>2024</span> 15:35:43 GMT
</span></span><span style=display:flex><span>cache-control: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>x-proxy-cache: MISS
</span></span><span style=display:flex><span>x-github-request-id: E24C:3800B1:1881E48:18E9A93:65EDD0F7
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>date: Sun, <span style=color:#ae81ff>10</span> Mar <span style=color:#ae81ff>2024</span> 19:14:10 GMT
</span></span><span style=display:flex><span>via: 1.1 varnish
</span></span><span style=display:flex><span>age: <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>x-served-by: cache-mad22083-MAD
</span></span><span style=display:flex><span>x-cache: HIT
</span></span><span style=display:flex><span>x-cache-hits: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>x-timer: S1710098050.166466,VS0,VE2
</span></span><span style=display:flex><span>vary: Accept-Encoding
</span></span><span style=display:flex><span>x-fastly-request-id: 0c6c80bbef19370976aadfc6988441c5a36beccc
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>26459</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@thor:~$ ping 8.8.8.8
</span></span><span style=display:flex><span>PING 8.8.8.8 <span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 8.8.8.8: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>110</span> time<span style=color:#f92672>=</span>38.5 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 8.8.8.8 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 38.451/38.451/38.451/0.000 ms
</span></span></code></pre></div><h3 id=la-máquina-hela-puede-navegar-instala-un-servidor-web-un-servidor-ftp-y-un-servidor-de-correos-si-no-los-tienes-aún>La máquina Hela puede navegar. Instala un servidor web, un servidor ftp y un servidor de correos si no los tienes aún.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># La máquina Hela puede navegar. Instala un servidor web, un servidor ftp y un servidor de correos si no los tienes aún. </span>
</span></span><span style=display:flex><span><span style=color:#75715e># Hela ya tiene permitido hacer consultas dns a thor</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span></code></pre></div><p>Compruebo que puedo navegar :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@hela javiercruces<span style=color:#f92672>]</span><span style=color:#75715e># curl -I https://www.javiercd.es/</span>
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span> 
</span></span><span style=display:flex><span>server: GitHub.com
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>last-modified: Sat, <span style=color:#ae81ff>02</span> Mar <span style=color:#ae81ff>2024</span> 10:17:01 GMT
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>31556952</span>
</span></span><span style=display:flex><span>etag: <span style=color:#e6db74>&#34;65e2fc9d-675b&#34;</span>
</span></span><span style=display:flex><span>expires: Sun, <span style=color:#ae81ff>10</span> Mar <span style=color:#ae81ff>2024</span> 15:35:43 GMT
</span></span><span style=display:flex><span>cache-control: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>x-proxy-cache: MISS
</span></span><span style=display:flex><span>x-github-request-id: E24C:3800B1:1881E48:18E9A93:65EDD0F7
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>date: Sun, <span style=color:#ae81ff>10</span> Mar <span style=color:#ae81ff>2024</span> 19:13:17 GMT
</span></span><span style=display:flex><span>via: 1.1 varnish
</span></span><span style=display:flex><span>age: <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>x-served-by: cache-mad22067-MAD
</span></span><span style=display:flex><span>x-cache: HIT
</span></span><span style=display:flex><span>x-cache-hits: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>x-timer: S1710097997.474757,VS0,VE2
</span></span><span style=display:flex><span>vary: Accept-Encoding
</span></span><span style=display:flex><span>x-fastly-request-id: 2d2811893898abf05bebd96c6bd5a09ed7abfe5b
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>26459</span>
</span></span></code></pre></div><p>Entiendo que quieres que instale estos 3 servicios en hela . En nuestro escenario son las otras maquinas quien alberga estos servicios .</p><h3 id=configura-la-máquina-odin-para-que-los-servicios-web-y-ftp-sean-accesibles-desde-el-exterior>Configura la máquina Odin para que los servicios web y ftp sean accesibles desde el exterior.</h3><p>El servidor web ya esta configurado previamente en la migración del escenario .</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>21</span> counter dnat to 172.16.0.200
</span></span><span style=display:flex><span><span style=color:#75715e># No funcionan en cadenas separadas </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_DMZ iifname &#34;ens4&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 21 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_WAN iifname &#34;ens3&#34; oifname &#34;ens4&#34; ip saddr 172.16.0.200 tcp sport 21 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter accept
</span></span></code></pre></div><h3 id=el-servidor-web-y-el-servidor-ftp-deben-ser-accesibles-desde-la-lan-y-desde-el-exterior>El servidor web y el servidor ftp deben ser accesibles desde la LAN y desde el exterior.</h3><p>El servidor FTP esta en la LAN así que ya es accesible , voy a hacer que sea accesible desde la DMZ . Desde el exterior ambos , ya son accesibles.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>## No funcionan las reglass en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 21 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 21 ct state established,related counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 80 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 80 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter accept
</span></span></code></pre></div><p>Acceso desde la DMZ a LAN :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@thor:~$ curl 172.16.0.200
</span></span><span style=display:flex><span>&lt;!DOCTYPE html&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@thor:~$ ftp 172.16.0.200
</span></span><span style=display:flex><span>Connected to 172.16.0.200.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> <span style=color:#f92672>(</span>vsFTPd 3.0.5<span style=color:#f92672>)</span>
</span></span></code></pre></div><h3 id=el-servidor-de-correos-sólo-debe-ser-accesible-desde-la-lan>El servidor de correos sólo debe ser accesible desde la LAN.</h3><p>Comentamos las lineas de la preparación del escenario que permito el acceso a este y añadimos :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># No funciona en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip daddr 192.168.0.3 tcp dport 25 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip saddr 192.168.0.3 tcp sport 25 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter accept
</span></span></code></pre></div><p>Accedemos a el :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@hela javiercruces<span style=color:#f92672>]</span><span style=color:#75715e># telnet 192.168.0.3 25</span>
</span></span><span style=display:flex><span>Trying 192.168.0.3...
</span></span><span style=display:flex><span>Connected to 192.168.0.3.
</span></span><span style=display:flex><span>Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> loki.javiercd.gonzalonazareno.org ESMTP Postfix <span style=color:#f92672>(</span>Ubuntu<span style=color:#f92672>)</span>
</span></span></code></pre></div><h3 id=en-la-máquina-loki-instala-un-servidor-postgres-si-no-lo-tiene-aún-a-este-servidor-se-puede-acceder-desde-la-dmz-pero-no-desde-el-exterior>En la máquina Loki instala un servidor Postgres si no lo tiene aún. A este servidor se puede acceder desde la DMZ, pero no desde el exterior.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># no funciona en cadenas distintas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip daddr 192.168.0.3 tcp dport 5432 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip saddr 192.168.0.3 tcp sport 5432 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>5432</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>5432</span> ct state established,related counter accept
</span></span></code></pre></div><p>Accedemos al servidor postgree desde hela :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@hela javiercruces<span style=color:#f92672>]</span><span style=color:#75715e># psql -h 192.168.0.3 -U postgres</span>
</span></span><span style=display:flex><span>Password <span style=color:#66d9ef>for</span> user postgres: 
</span></span><span style=display:flex><span>psql <span style=color:#f92672>(</span>13.14, server 14.11 <span style=color:#f92672>(</span>Ubuntu 14.11-0ubuntu0.22.04.1<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>WARNING: psql major version 13, server major version 14.
</span></span><span style=display:flex><span>         Some psql features might not work.
</span></span><span style=display:flex><span>SSL connection <span style=color:#f92672>(</span>protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> help.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres<span style=color:#f92672>=</span><span style=color:#75715e># </span>
</span></span></code></pre></div><h3 id=evita-ataques-dos-por-icmp-flood-limitando-a-4-el-número-de-peticiones-por-segundo-desde-una-misma-ip>Evita ataques DoS por ICMP Flood, limitando a 4 el número de peticiones por segundo desde una misma IP.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nft insert rule inet filter input icmp type echo-request limit rate 1/second burst <span style=color:#ae81ff>4</span> packets counter drop
</span></span></code></pre></div><p>Si le hacemos un ataque de flood , este cortara el trafico :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@hela javiercruces<span style=color:#f92672>]</span><span style=color:#75715e># hping3 --icmp --flood --rand-source 172.16.0.1 </span>
</span></span><span style=display:flex><span>HPING 172.16.0.1 <span style=color:#f92672>(</span>eth0 172.16.0.1<span style=color:#f92672>)</span>: icmp mode set, <span style=color:#ae81ff>28</span> headers + <span style=color:#ae81ff>0</span> data bytes
</span></span><span style=display:flex><span>hping in flood mode, no replies will be shown
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>icmp type echo-request limit rate 1/second burst <span style=color:#ae81ff>4</span> packets counter packets <span style=color:#ae81ff>46</span> bytes <span style=color:#ae81ff>2128</span> drop
</span></span></code></pre></div><h3 id=evita-ataques-dos-por-syn-flood>Evita ataques DoS por SYN Flood.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Evita ataques DoS por SYN Flood.</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input tcp flags <span style=color:#ae81ff>\&amp;</span> <span style=color:#e6db74>&#39;(fin|syn|rst|ack) == syn&#39;</span> counter limit rate over 25/second drop
</span></span></code></pre></div><p>Si probamos el ataque :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@hela javiercruces<span style=color:#f92672>]</span><span style=color:#75715e># hping3  --flood --rand-source 172.16.0.1 </span>
</span></span><span style=display:flex><span>HPING 172.16.0.1 <span style=color:#f92672>(</span>eth0 172.16.0.1<span style=color:#f92672>)</span>: NO FLAGS are set, <span style=color:#ae81ff>40</span> headers + <span style=color:#ae81ff>0</span> data bytes
</span></span><span style=display:flex><span>hping in flood mode, no replies will be shown
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 172.16.0.1 hping statistic ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1267916</span> packets transmitted, <span style=color:#ae81ff>0</span> packets received, 100% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max <span style=color:#f92672>=</span> 0.0/0.0/0.0 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>icmp type echo-request limit rate 1/second burst <span style=color:#ae81ff>4</span> packets counter packets <span style=color:#ae81ff>31</span> bytes <span style=color:#ae81ff>2492</span> drop
</span></span></code></pre></div><h2 id=script-con-todas-las-reglas>Script con todas las reglas</h2><p>Te dejo aquí el script que he utilizado durante la practica .</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Crear estructura de tablas</span>
</span></span><span style=display:flex><span>sudo nft delete table inet filter
</span></span><span style=display:flex><span>sudo nft delete table ip nat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Añadir tabla filter y sus cadenas</span>
</span></span><span style=display:flex><span>sudo nft add table inet filter
</span></span><span style=display:flex><span>sudo nft add chain inet filter forward <span style=color:#f92672>{</span> type filter hook forward priority 10<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy drop<span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter input <span style=color:#f92672>{</span> type filter hook input priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter output <span style=color:#f92672>{</span> type filter hook output priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter WAN_LAN <span style=color:#f92672>{</span> type filter hook forward priority 1<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter WAN_DMZ <span style=color:#f92672>{</span> type filter hook forward priority 2<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter LAN_WAN <span style=color:#f92672>{</span> type filter hook forward priority 3<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter LAN_DMZ <span style=color:#f92672>{</span> type filter hook forward priority 4<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter DMZ_LAN <span style=color:#f92672>{</span> type filter hook forward priority 5<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter DMZ_WAN <span style=color:#f92672>{</span> type filter hook forward priority 6<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##  Añadir Tabla NAT y sus cadenas :</span>
</span></span><span style=display:flex><span>sudo nft add table ip nat
</span></span><span style=display:flex><span>sudo nft add chain ip nat prerouting <span style=color:#f92672>{</span> type nat hook prerouting priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain ip nat postrouting <span style=color:#f92672>{</span> type nat hook postrouting priority <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Reglas para mantener el escenario de clase anterior con IPTABLES</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Reglas SNAT</span>
</span></span><span style=display:flex><span><span style=color:#75715e>### Regla SNAT para LAN</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter masquerade
</span></span><span style=display:flex><span><span style=color:#75715e>### Regla SNAT para DMZ</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.0/16 counter masquerade
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Reglas DNAT</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Para un wordpress que hay en hela</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>80</span> counter dnat to 172.16.0.200
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Para hacer consultas DNS a thor</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule ip nat prerouting udp dport 53 counter dnat to 192.168.0.2</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr <span style=color:#f92672>{</span> 172.22.0.0/16, 172.19.0.0/16 <span style=color:#f92672>}</span> udp dport <span style=color:#ae81ff>53</span> counter dnat to 192.168.0.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Para poder recibir correos en loki</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>25</span> counter dnat to 192.168.0.3
</span></span><span style=display:flex><span><span style=color:#75715e># Para acceder desde fuera a un mysql que hay en loki</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>3306</span> counter dnat to 192.168.0.3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># PERMITIR USO DE ODIN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Permitir consultas DNS de odin a thor (DNSSERVER)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Permitir tráfico HTTP y HTTPS en odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp dport <span style=color:#f92672>{</span> 80,443 <span style=color:#f92672>}</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp sport <span style=color:#f92672>{</span> 80,443 <span style=color:#f92672>}</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Permitir conexiones SSH por el puerto 2222</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter dnat to 192.168.0.1:22
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Permitir conexiones SSH de odin a hela</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.0/16 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.0/16 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Permitir conexiones ssh de odin a thor y loki</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.0/24 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Reglas perimetrales</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Permitir consultas DNS desde br-intra hacia ens4 , necesario para el forward del dns (ESTA REGLA SOLO ME FUNCIONA SI ESTA EN LA MISMA CADENA)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Permitir consultas dns desde LAN a DMZ (hela --&gt; thor) (ESTA REGLA SOLO ME FUNCIONA SI ESTA EN LA MISMA CADENA)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter LAN_DMZ iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_LAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Reglas para permitir trafico a wordpress en hela</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Regla para hacer consultas DNS a thor (Permitir DNAT)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 udp dport <span style=color:#ae81ff>53</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.2 udp sport <span style=color:#ae81ff>53</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Regla para recibir e enviar correos en loki</span>
</span></span><span style=display:flex><span><span style=color:#75715e># No funcionan en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_DMZ iifname &#34;ens4&#34; oifname &#34;br-intra2&#34; ip daddr 192.168.0.3 tcp dport 25 ct state new,established counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_WAN iifname &#34;br-intra2&#34; oifname &#34;ens4&#34; ip saddr 192.168.0.3 tcp sport 25 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Permitir a hela usar el servidor LDAP</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter LAN_DMZ iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> tcp dport <span style=color:#ae81ff>389</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_LAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>389</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Ejercicios practica</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Permitir conexiones SSH por el puerto 2222</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule ip nat prerouting iifname &#34;ens4&#34; tcp dport 2222 counter dnat to 192.168.0.1:22</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter output oifname &#34;ens4&#34; tcp sport 22 ct state established counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter input iifname &#34;ens4&#34; tcp dport 22 ct state new,established counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Desde Thor y Hela se debe permitir la conexión ssh por el puerto 22 a la máquina Odin.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Permitir conexion ssh desde hela a odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span><span style=color:#75715e>## Permitir conexion ssh desde thor a odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.2 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#La máquina Odin debe tener permitido el tráfico para la interfaz loopback.</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># A la máquina Odin se le puede hacer ping desde la DMZ, pero desde la LAN se le debe rechazar la conexión (REJECT) y desde el exterior se rechazará de manera silenciosa. </span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp icmp type echo-reply counter accept
</span></span><span style=display:flex><span><span style=color:#75715e>## Denegar la conexion desde LAN REJECT</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp counter reject
</span></span><span style=display:flex><span><span style=color:#75715e>## Denegar de manera silenciosa desde EXTERIOR</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp counter drop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># La máquina Odin puede hacer ping a la LAN, la DMZ y al exterior.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## LAN</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span><span style=color:#75715e>## EXTERIOR</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span><span style=color:#75715e>## DMZ</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#### Desde la máquina Hela se puede hacer ping y conexión ssh a las máquinas de la LAN.</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 ip protocol icmp icmp type echo-reply counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Si no estan en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 ip protocol icmp icmp type echo-request counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 ip protocol icmp icmp type echo-reply counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp dport 22 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp sport 22 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Desde cualquier máquina de la LAN se puede conectar por ssh a la máquina Hela. </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Si no esta en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 22 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 22 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Configura la máquina Odin para que las máquinas de LAN y DMZ puedan acceder al exterior.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## SNAT hecho anteriormente</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Las máquinas de la LAN pueden hacer ping al exterior y navegar. </span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Si no estan en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_WAN iifname &#34;br-intra2&#34; oifname &#34;ens4&#34; ip protocol icmp icmp type echo-request counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_LAN iifname &#34;ens4&#34; oifname &#34;br-intra2&#34; ip protocol icmp icmp type echo-reply counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp icmp type echo-reply counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> tcp sport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># La máquina Hela puede navegar. Instala un servidor web, un servidor ftp y un servidor de correos si no los tienes aún. </span>
</span></span><span style=display:flex><span><span style=color:#75715e># Hela ya tiene permitido hacer consultas dns a thor</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ### Configura la máquina Odin para que los servicios web y ftp sean accesibles desde el exterior. </span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>21</span> counter dnat to 172.16.0.200
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># No funcionan en cadenas separadas </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_DMZ iifname &#34;ens4&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 21 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_WAN iifname &#34;ens3&#34; oifname &#34;ens4&#34; ip saddr 172.16.0.200 tcp sport 21 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ### El servidor web y el servidor ftp deben ser accesibles desde la LAN y desde el exterior. </span>
</span></span><span style=display:flex><span><span style=color:#75715e>## No funcionan las reglass en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 21 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 21 ct state established,related counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 80 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 80 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ### El servidor de correos sólo debe ser accesible desde la LAN. </span>
</span></span><span style=display:flex><span><span style=color:#75715e># no funciona en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip daddr 192.168.0.3 tcp dport 25 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip saddr 192.168.0.3 tcp sport 25 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ### En la máquina Loki instala un servidor Postgres si no lo tiene aún. A este servidor se puede acceder desde la DMZ, pero no desde el exterior.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># no funciona en cadenas distintas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip daddr 192.168.0.3 tcp dport 5432 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip saddr 192.168.0.3 tcp sport 5432 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>5432</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>5432</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ### Evita ataques DoS por ICMP Flood, limitando a 4 el número de peticiones por segundo desde una misma IP.</span>
</span></span><span style=display:flex><span>sudo nft insert rule inet filter input icmp type echo-request limit rate 1/second burst <span style=color:#ae81ff>4</span> packets counter drop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ### Evita ataques DoS por SYN Flood.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft insert rule inet filter input tcp flags \&amp; &#39;(fin|syn|rst|ack) == syn&#39; counter limit rate over 25/second drop</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#### Evita que realicen escaneos de puertos a Odin.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft insert rule inet filter input tcp flags &amp; (fin|syn|rst|ack) == (syn) counter drop</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter output udp dport 53 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter input udp sport 53 counter accept</span>
</span></span></code></pre></div><h2 id=hits-de-las-reglas>Hits de las reglas</h2><p>Cada vez que he ejecutado el script las reglas pierden los contadores pero así seria el esquema con todas las reglas al finalizar la practica :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft list ruleset  
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 10; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>107</span> bytes <span style=color:#ae81ff>8505</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>107</span> bytes <span style=color:#ae81ff>93423</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>11</span> bytes <span style=color:#ae81ff>758</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>11</span> bytes <span style=color:#ae81ff>1818</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state established,new counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 ip protocol icmp icmp type echo-request counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 ip protocol icmp icmp type echo-reply counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>160</span> bytes <span style=color:#ae81ff>16502</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>100</span> bytes <span style=color:#ae81ff>15086</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>30</span> bytes <span style=color:#ae81ff>6041</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>23</span> bytes <span style=color:#ae81ff>5213</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol icmp icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp icmp type echo-reply counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>16</span> bytes <span style=color:#ae81ff>1666</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> tcp sport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>17</span> bytes <span style=color:#ae81ff>4947</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>3332</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>34</span> bytes <span style=color:#ae81ff>9903</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>18</span> bytes <span style=color:#ae81ff>1064</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter packets <span style=color:#ae81ff>14</span> bytes <span style=color:#ae81ff>1348</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>5432</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>5432</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		icmp type echo-request limit rate 1/second burst <span style=color:#ae81ff>4</span> packets counter packets <span style=color:#ae81ff>13</span> bytes <span style=color:#ae81ff>1092</span> drop
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>1490</span> bytes <span style=color:#ae81ff>141906</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>18</span> bytes <span style=color:#ae81ff>2352</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp sport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established counter packets <span style=color:#ae81ff>17</span> bytes <span style=color:#ae81ff>13286</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>965</span> bytes <span style=color:#ae81ff>70084</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.0/16 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter packets <span style=color:#ae81ff>356</span> bytes <span style=color:#ae81ff>39980</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter packets <span style=color:#ae81ff>131</span> bytes <span style=color:#ae81ff>15952</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.2 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp icmp type echo-request counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> reject with icmp port-unreachable
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> drop
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>1404</span> bytes <span style=color:#ae81ff>207511</span>
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>18</span> bytes <span style=color:#ae81ff>1304</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established,new counter packets <span style=color:#ae81ff>19</span> bytes <span style=color:#ae81ff>7331</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>577</span> bytes <span style=color:#ae81ff>142596</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.0/16 tcp dport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>547</span> bytes <span style=color:#ae81ff>38208</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.0/24 tcp dport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>194</span> bytes <span style=color:#ae81ff>14400</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>12</span> bytes <span style=color:#ae81ff>1008</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp icmp type echo-reply counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain WAN_LAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 1; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain WAN_DMZ <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 2; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>107</span> bytes <span style=color:#ae81ff>93423</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain LAN_WAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 3; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain LAN_DMZ <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 4; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>11</span> bytes <span style=color:#ae81ff>758</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> tcp dport <span style=color:#ae81ff>389</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain DMZ_LAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 5; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>11</span> bytes <span style=color:#ae81ff>1818</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>389</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain DMZ_WAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 6; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>107</span> bytes <span style=color:#ae81ff>8505</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.2 udp sport <span style=color:#ae81ff>53</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>table ip nat <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain prerouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook prerouting priority filter; policy accept;
</span></span><span style=display:flex><span>		tcp dport <span style=color:#ae81ff>80</span> counter packets <span style=color:#ae81ff>8</span> bytes <span style=color:#ae81ff>480</span> dnat to 172.16.0.200
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr <span style=color:#f92672>{</span> 172.19.0.0/16, 172.22.0.0/16 <span style=color:#f92672>}</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> dnat to 192.168.0.2
</span></span><span style=display:flex><span>		tcp dport <span style=color:#ae81ff>25</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> dnat to 192.168.0.3
</span></span><span style=display:flex><span>		tcp dport <span style=color:#ae81ff>3306</span> counter packets <span style=color:#ae81ff>12</span> bytes <span style=color:#ae81ff>720</span> dnat to 192.168.0.3
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> dnat to 192.168.0.1:22
</span></span><span style=display:flex><span>		tcp dport <span style=color:#ae81ff>21</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> dnat to 172.16.0.200
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter packets <span style=color:#ae81ff>109</span> bytes <span style=color:#ae81ff>8649</span> masquerade
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.0/16 counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>120</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=hacer-las-reglas-persistentes>Hacer las reglas persistentes</h2><p>Vamos a guardar las reglas con :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@odin:/home/javiercruces# nft list ruleset &gt; /etc/nftables.conf
</span></span></code></pre></div><p>Si las queremos restaurar :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft -f /etc/nftables.conf
</span></span></code></pre></div><p>Para hacer que al reiniciar las reglas se restauren solas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Creamos la unidad de systemd</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo cat /etc/systemd/system/nftables-persistent.service
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Unit<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Description<span style=color:#f92672>=</span>Cargar reglas de nftables al iniciar el sistema
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Service<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Type<span style=color:#f92672>=</span>oneshot
</span></span><span style=display:flex><span>ExecStart<span style=color:#f92672>=</span>/usr/sbin/nft -f /etc/nftables/nftables.rules
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Install<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>WantedBy<span style=color:#f92672>=</span>multi-user.target
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Activa el servicio para que al reiniciar se apliquen los cambios </span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo systemctl enable nftables-persistent.service
</span></span></code></pre></div></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Compartir en:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f&text=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Nftables%20II&via=Atlas" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f&title=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Nftables%20II" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f&title=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Nftables%20II" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Nftables%20II https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Nftables%20II&body=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/javierasping/sentinel/edit/main/content/posts/cortafuegos/nftables_dos/cortafuegos_dos.md title="Mejorar esta página" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Mejorar esta página</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Contenido</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#montar-el-escenario-con-nftables>Montar el escenario con Nftables</a><ul><li><a href=#reglas-snat>Reglas SNAT</a></li><li><a href=#reglas-de-dnat>Reglas de DNAT</a></li></ul></li><li><a href=#ejercicios>Ejercicios</a><ul><li><a href=#la-máquina-odin-tiene-un-servidor-ssh-escuchando-por-el-puerto-22-pero-al-acceder-desde-el-exterior-habrá-que-conectar-al-puerto-2222>La máquina Odin tiene un servidor ssh escuchando por el puerto 22, pero al acceder desde el exterior habrá que conectar al puerto 2222.</a></li><li><a href=#desde-thor-y-hela-se-debe-permitir-la-conexión-ssh-por-el-puerto-22-a-la-máquina-odin>Desde Thor y Hela se debe permitir la conexión ssh por el puerto 22 a la máquina Odin.</a></li><li><a href=#la-máquina-odin-debe-tener-permitido-el-tráfico-para-la-interfaz-loopback>La máquina Odin debe tener permitido el tráfico para la interfaz loopback.</a></li><li><a href=#a-la-máquina-odin-se-le-puede-hacer-ping-desde-la-dmz-pero-desde-la-lan-se-le-debe-rechazar-la-conexión-reject-y-desde-el-exterior-se-rechazará-de-manera-silenciosa>A la máquina Odin se le puede hacer ping desde la DMZ, pero desde la LAN se le debe rechazar la conexión (REJECT) y desde el exterior se rechazará de manera silenciosa.</a></li><li><a href=#la-máquina-odin-puede-hacer-ping-a-la-lan-la-dmz-y-al-exterior>La máquina Odin puede hacer ping a la LAN, la DMZ y al exterior.</a></li><li><a href=#desde-la-máquina-hela-se-puede-hacer-ping-y-conexión-ssh-a-las-máquinas-de-la-lan>Desde la máquina Hela se puede hacer ping y conexión ssh a las máquinas de la LAN.</a></li><li><a href=#desde-cualquier-máquina-de-la-lan-se-puede-conectar-por-ssh-a-la-máquina-hela>Desde cualquier máquina de la LAN se puede conectar por ssh a la máquina Hela.</a></li><li><a href=#configura-la-máquina-odin-para-que-las-máquinas-de-lan-y-dmz-puedan-acceder-al-exterior>Configura la máquina Odin para que las máquinas de LAN y DMZ puedan acceder al exterior.</a></li><li><a href=#las-máquinas-de-la-lan-pueden-hacer-ping-al-exterior-y-navegar>Las máquinas de la LAN pueden hacer ping al exterior y navegar.</a></li><li><a href=#la-máquina-hela-puede-navegar-instala-un-servidor-web-un-servidor-ftp-y-un-servidor-de-correos-si-no-los-tienes-aún>La máquina Hela puede navegar. Instala un servidor web, un servidor ftp y un servidor de correos si no los tienes aún.</a></li><li><a href=#configura-la-máquina-odin-para-que-los-servicios-web-y-ftp-sean-accesibles-desde-el-exterior>Configura la máquina Odin para que los servicios web y ftp sean accesibles desde el exterior.</a></li><li><a href=#el-servidor-web-y-el-servidor-ftp-deben-ser-accesibles-desde-la-lan-y-desde-el-exterior>El servidor web y el servidor ftp deben ser accesibles desde la LAN y desde el exterior.</a></li><li><a href=#el-servidor-de-correos-sólo-debe-ser-accesible-desde-la-lan>El servidor de correos sólo debe ser accesible desde la LAN.</a></li><li><a href=#en-la-máquina-loki-instala-un-servidor-postgres-si-no-lo-tiene-aún-a-este-servidor-se-puede-acceder-desde-la-dmz-pero-no-desde-el-exterior>En la máquina Loki instala un servidor Postgres si no lo tiene aún. A este servidor se puede acceder desde la DMZ, pero no desde el exterior.</a></li><li><a href=#evita-ataques-dos-por-icmp-flood-limitando-a-4-el-número-de-peticiones-por-segundo-desde-una-misma-ip>Evita ataques DoS por ICMP Flood, limitando a 4 el número de peticiones por segundo desde una misma IP.</a></li><li><a href=#evita-ataques-dos-por-syn-flood>Evita ataques DoS por SYN Flood.</a></li></ul></li><li><a href=#script-con-todas-las-reglas>Script con todas las reglas</a></li><li><a href=#hits-de-las-reglas>Hits de las reglas</a></li><li><a href=#hacer-las-reglas-persistentes>Hacer las reglas persistentes</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navegación</h5><ul><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#about>Sobre mi</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#skills>Competencias</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#education>Educación</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#recent-posts>Últimas publicaciones</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#accomplishments>Certificaciones</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contacto</h5><ul><li><a href=mailto:contacto@javiercd.es target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>contacto@javiercd.es</span></a></li><li><a href=https://github.com/javierasping target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>javierasping</span></a></li><li><a href=https://www.linkedin.com/in/javiercd target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Francisco Javier Cruces Doval</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>Aviso de responsabilidad:</strong> This theme is under MIT license. So, you can use it for non-commercial, commercial, or private uses. You can modify or distribute the theme without requiring any permission from the theme author. However, the theme author does not provide any warranty or takes any liability for any issue with the theme.</p></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu_b3360284c55cf72d.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2023 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Funcionando con
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.29119cfdb8d2f06f4caaea7b9908096b5c109c5174eab5fca7e4e0efb0ffcaa0.js integrity="sha256-KRGc/bjS8G9Mqup7mQgJa1wQnFF06rX8p+Tg77D/yqA=" defer></script></body></html>