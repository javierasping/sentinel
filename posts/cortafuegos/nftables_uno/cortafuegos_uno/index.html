<!doctype html><html lang=es><head><title>Implementación de un cortafuegos perimetral con Nftables I</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.ddf4c4775d35e5bc3dd64c797b179f99eaf85cf9811e64bd08f8c44a68d0b229.css integrity="sha256-3fTEd1015bw91kx5exefmer4XPmBHmS9CPjESmjQsik="><link rel=icon type=image/png href=/images/site/avatar_hu_f10227dc088ad43a.jpg><meta property="og:title" content="Atlas"><meta property="og:type" content="website"><meta property="og:description" content="Portafolio y blog personal de Francisco Javier Cruces Doval"><meta property="og:image" content="/images/author/john.png"><meta property="og:url" content="https://www.javiercd.es"><meta name=description content="Implementación de un cortafuegos perimetral con Nftables"><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/masthead_hu_f10227dc088ad43a.png id=logo alt=Logo>
Atlas</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>Inicio</a></li><li class=nav-item><a class=nav-link href=/#about>Sobre mi</a></li><li class=nav-item><a class=nav-link href=/#skills>Competencias</a></li><li class=nav-item><a class=nav-link href=/#education>Educación</a></li><li class=nav-item><a class=nav-link href=/#recent-posts>Últimas publicaciones</a></li><li class=nav-item><a class=nav-link href=/#accomplishments>Certificaciones</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=languageSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><span class="fi fi-es"></span>
Español</a><div class=dropdown-menu aria-labelledby=languageSelector><a class="dropdown-item nav-link languages-item" href=/posts/cortafuegos/nftables_uno/cortafuegos_uno><span class="fi fi-es"></span>
Español
</a><a class="dropdown-item nav-link languages-item" href=/en/posts/cortafuegos/nftables_uno/cortafuegos_uno><span class="fi fi-gb"></span>
English</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Búsqueda data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/posts/iaw/> Aplicaciones webs</a><ul><li><a class=list-link href=/posts/iaw/lamp/ title="Instalación pila LAMP">Instalación pila LAMP</a></li><li><a class=list-link href=/posts/iaw/lemp/ title="Instalación pila LEMP">Instalación pila LEMP</a></li><li><a class=list-link href=/posts/iaw/wordpress/ title="Wordpress LAMP">Wordpress LAMP</a></li><li><a class=list-link href=/posts/iaw/wordpress_lemp/ title="Wordpress LEMP">Wordpress LEMP</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/base_de_datos/> Base de datos</a><ul><li><a class=list-link href=/posts/base_de_datos/acceso_remoto_mariadb/ title="Acceso remoto en MariaDB">Acceso remoto en MariaDB</a></li><li><a class=list-link href=/posts/base_de_datos/oracle_acceso_remoto/ title="Configuración de acceso remoto en Oracle">Configuración de acceso remoto en Oracle</a></li><li><a class=list-link href=/posts/base_de_datos/instalacion_oracle_19c_debian12/ title="Instalación de Oracle 19c bajo Debian 12">Instalación de Oracle 19c bajo Debian 12</a></li><li><a class=list-link href=/posts/base_de_datos/instalar_postgresql/ title="Instalación de PostgreSQL en Debian 12">Instalación de PostgreSQL en Debian 12</a></li><li><a class=list-link href=/posts/base_de_datos/instalar_mariadb/ title="Instalar MariaDB en Debian">Instalar MariaDB en Debian</a></li><li><a class=list-link href=/posts/base_de_datos/interconexion_de_servidores/ title="Interconexión de servidores de bases de datos">Interconexión de servidores de bases de datos</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/ci_cd/> CI/CD Jenkins</a><ul><li><a class=list-link href=/posts/ci_cd/practica_jenkins/ title="Práctica CI/CD con Jenkins">Práctica CI/CD con Jenkins</a></li><li><a class=list-link href=/posts/ci_cd/taller1_jenkins/ title="Taller 1 Corrector ortográfico de documentos markdown (test)">Taller 1 Corrector ortográfico de documentos markdown (test)</a></li><li><a class=list-link href=/posts/ci_cd/taller2_jenkins/ title="Taller 2 Comprobación de HTML5 válido y despliegue en surge.sh (test y deploy)">Taller 2 Comprobación de HTML5 válido y despliegue en surge.sh (test y deploy)</a></li><li><a class=list-link href=/posts/ci_cd/taller3_jenkins/ title="Taller 3 Integración continua de aplicación django (Test)">Taller 3 Integración continua de aplicación django (Test)</a></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/posts/cortafuegos/> Cortafuegos</a><ul class=active><li><a class=list-link href=/posts/cortafuegos/fortinet_cli/ title="Fortinet CLI">Fortinet CLI</a></li><li><a class=list-link href=/posts/cortafuegos/fortinet_uno/ title="Perimetral con Fortinet I">Perimetral con Fortinet I</a></li><li><a class=list-link href=/posts/cortafuegos/fortinet_dos/ title="Perimetral con Fortinet II">Perimetral con Fortinet II</a></li><li><a class="active list-link" href=/posts/cortafuegos/nftables_uno/ title="Perimetral con Nftables I">Perimetral con Nftables I</a></li><li><a class=list-link href=/posts/cortafuegos/nftables_dos/ title="Perimetral con Nftables II">Perimetral con Nftables II</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/docker/> Docker</a><ul><li><a class=list-link href=/posts/docker/instalar_docker_compose/ title="Instalación de Docker Compose en Ubuntu 24">Instalación de Docker Compose en Ubuntu 24</a></li><li><a class=list-link href=/posts/docker/instalar_docker_ubuntu24/ title="Instalación de Docker en Ubuntu 24">Instalación de Docker en Ubuntu 24</a></li><li><a class=list-link href=/posts/docker/taller1/ title="Taller 1 Almacenamiento y redes en Docker">Taller 1 Almacenamiento y redes en Docker</a></li><li><a class=list-link href=/posts/docker/taller2/ title="Taller 2 Escenarios multicontenedor en Docker">Taller 2 Escenarios multicontenedor en Docker</a></li><li><a class=list-link href=/posts/docker/taller3/ title="Taller 3 Creación de imágenes Docker">Taller 3 Creación de imágenes Docker</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/drivers/> Drivers Linux</a><ul><li><a class=list-link href=/posts/drivers/nvidia_optimus/ title="Como elegir que gráfica usar en mi portátil con Linux">Como elegir que gráfica usar en mi portátil con Linux</a></li><li><a class=list-link href=/posts/drivers/nvidia_driver/ title="Drivers Nvidia">Drivers Nvidia</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/redes/> Redes</a><ul><li><a class=list-link href=/posts/redes/android_gns3/ title="Android GNS3-KVM">Android GNS3-KVM</a></li><li><a class=list-link href=/posts/redes/comandos_de_supervision_de_redes/ title="Comandos de supervisión de redes">Comandos de supervisión de redes</a></li><li><a class=list-link href=/posts/redes/switches_gns3/ title="Configuración de switches en GNS3">Configuración de switches en GNS3</a></li><li><a class=list-link href=/posts/redes/enroutamiento_openstack/ title="Enrutamiento en OpenStack">Enrutamiento en OpenStack</a></li><li><a class=list-link href=/posts/redes/escenario_ipv6_basico/ title="Escenario IPv6 Básico">Escenario IPv6 Básico</a></li><li><a class=list-link href=/posts/redes/instalar_gns3_debian12/ title="Instalacion GNS3 en Debian 12">Instalacion GNS3 en Debian 12</a></li><li><a class=list-link href=/posts/redes/instalacion_wireshark_gns3/ title="Instalacion GNS3 y Wireshark">Instalacion GNS3 y Wireshark</a></li><li><a class=list-link href=/posts/redes/configuracion_de_nat/ title="NAT en Cisco y Linux">NAT en Cisco y Linux</a></li><li><a class=list-link href=/posts/redes/arp/ title="Protocolo ARP">Protocolo ARP</a></li><li><a class=list-link href=/posts/redes/tuneles_ipv6/ title="Túneles IPV6">Túneles IPV6</a></li><li><a class=list-link href=/posts/redes/underworld/ title=Underworld>Underworld</a></li><li><a class=list-link href=/posts/redes/underworld_evolution/ title="Underworld evolution">Underworld evolution</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/seguridad/> Seguridad</a><ul><li><a class=list-link href=/posts/seguridad/https_autofirmado/ title=HTTPS>HTTPS</a></li><li><a class=list-link href=/posts/seguridad/forense/ title="Informática forense">Informática forense</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/servicios/> Servicios</a><ul><li><a class=list-link href=/posts/servicios/apache/ title=Apache>Apache</a></li><li><a class=list-link href=/posts/servicios/dhcp/ title=DHCP>DHCP</a></li><li><a class=list-link href=/posts/servicios/dns/ title=DNS>DNS</a></li><li><a class=list-link href=/posts/servicios/ftp/ title=FTP>FTP</a></li><li><a class=list-link href=/posts/servicios/nat_iptables/ title="NAT con iptables">NAT con iptables</a></li><li><a class=list-link href=/posts/servicios/ssh/ title=SSH>SSH</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/> Sistemas</a><ul><li><a class=list-link href=/posts/sistemas/ad_ubuntu/ title="Active Directory en Ubuntu">Active Directory en Ubuntu</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/comandos_linux/> Comandos en Linux</a><ul><li><a class=list-link href=/posts/sistemas/comandos_linux/ejercicios_de_manejo_de_modulos/ title="Ejercicios de manejo de módulos">Ejercicios de manejo de módulos</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/ejercicios_de_modificacion_de_parametros_del_kernel/ title="Ejercicios de modificación de parámetros del kernel">Ejercicios de modificación de parámetros del kernel</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/ejercicios_gestion_de_paqueteria/ title="Ejercicios gestión de paquetería">Ejercicios gestión de paquetería</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/empaquetadores_compresores/ title="Empaquetadores y compresores">Empaquetadores y compresores</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/gestion_de_paquetes/ title="Gestión de paquetes">Gestión de paquetes</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/comandos_procesos/ title="Procesos en Linux">Procesos en Linux</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/programacion_tareas/ title="Programación de tareas">Programación de tareas</a></li></ul></li><li><a class=list-link href=/posts/sistemas/comparticion_de_directorios_en_windows/ title="Compartir recursos en Windows">Compartir recursos en Windows</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/compilaciones_linux/> Compilaciones en Linnux</a><ul><li><a class=list-link href=/posts/sistemas/compilaciones_linux/compilacion_de_un_kernel/ title="Compilación de un kernel">Compilación de un kernel</a></li><li><a class=list-link href=/posts/sistemas/compilaciones_linux/compilacion_de_un_programa_en_c_utilizando_un_makefile/ title="Compilación de un programa en C utilizando un Makefile">Compilación de un programa en C utilizando un Makefile</a></li></ul></li><li><a class=list-link href=/posts/sistemas/activacion_selinux/ title="Configuración activación de SELinux">Configuración activación de SELinux</a></li><li><a class=list-link href=/posts/sistemas/creacion_de_un_sistema_automatizado_de_instalacion/ title="Creación de un sistema automatizado de instalación">Creación de un sistema automatizado de instalación</a></li><li><a class=list-link href=/posts/sistemas/samba_debian/ title="Instalar y configurar samba en Debian">Instalar y configurar samba en Debian</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/migraciones/> Migraciones en Linnux</a><ul><li><a class=list-link href=/posts/sistemas/migraciones/eliminacion_systemd/ title="Eliminación de systemd">Eliminación de systemd</a></li><li><a class=list-link href=/posts/sistemas/migraciones/paso_de_centos_stream_8_a_centos_stream_9/ title="Paso de CentOS stream 8 a CentOS stream 9">Paso de CentOS stream 8 a CentOS stream 9</a></li><li><a class=list-link href=/posts/sistemas/migraciones/migracion_sistema_de_ficheros/ title="Sistema de ficheros">Sistema de ficheros</a></li><li><a class=list-link href=/posts/sistemas/migraciones/transformacion_instancia_cloud/ title="Transformación instancia cloud">Transformación instancia cloud</a></li></ul></li><li><a class=list-link href=/posts/sistemas/nfs_debian/ title="NFS en Debian">NFS en Debian</a></li><li><a class=list-link href=/posts/sistemas/recoleccion_logs_journald/ title="Recolección centralizada de logs journald">Recolección centralizada de logs journald</a></li><li><a class=list-link href=/posts/sistemas/ssh_windows/ title="Servicio ssh en Windows">Servicio ssh en Windows</a></li><li><a class=list-link href=/posts/sistemas/almacenamiento_servidor_independiente/ title="Storage Spaces en Windows Server">Storage Spaces en Windows Server</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/vpn/> VPN</a><ul><li><a class=list-link href=/posts/vpn/acceso_remoto_strongswang/ title="Acceso remoto Ipsec StrongSwan">Acceso remoto Ipsec StrongSwan</a></li><li><a class=list-link href=/posts/vpn/acceso_remoto_openvpn/ title="Acceso remoto OpenVPN">Acceso remoto OpenVPN</a></li><li><a class=list-link href=/posts/vpn/acceso_remoto_wireguard/ title="Acceso remoto Wireguard">Acceso remoto Wireguard</a></li><li><a class=list-link href=/posts/vpn/comparativa_ovpn_wire/ title="Comparativa OpenVPN y Wireguard">Comparativa OpenVPN y Wireguard</a></li><li><a class=list-link href=/posts/vpn/ipsec_cisco/ title="Site-to-Site IPsec Cisco">Site-to-Site IPsec Cisco</a></li><li><a class=list-link href=/posts/vpn/site_to_site_fortinet/ title="Site-to-Site IPsec Fortinet">Site-to-Site IPsec Fortinet</a></li><li><a class=list-link href=/posts/vpn/site_to_site_openvpn/ title="Site-to-Site OpenVPN">Site-to-Site OpenVPN</a></li><li><a class=list-link href=/posts/vpn/site_to_site_wireguard/ title="Site-to-Site Wireguard">Site-to-Site Wireguard</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/cortafuegos/nftables1.png)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/john_hu_2aff0fda0501496d.png alt="Author Image"><h5 class=author-name>Francisco Javier Cruces Doval</h5><p class=text-muted>jueves, 28 de marzo de 2024 | 27 minutos</p></div><div class=title><h1>Implementación de un cortafuegos perimetral con Nftables I</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/tags/firewall/ class="btn btn-sm btn-info">FIREWALL</a></li><li class=rounded><a href=/tags/linux/ class="btn btn-sm btn-info">LINUX</a></li><li class=rounded><a href=/tags/debian/ class="btn btn-sm btn-info">DEBIAN</a></li><li class=rounded><a href=/tags/nftables/ class="btn btn-sm btn-info">NFTABLES</a></li></ul></div><div class=post-content id=post-content><p>En este post sobre un escenario con maquinas Debian , aplicaremos reglas con Nftables para conrtrolar el trafico que entra y sale en nuestra red , intentando imitar un escenario.</p><blockquote><p>[!NOTE]<br>Para desplegar el escenario para realizar estos ejercicios necesitaras desplegar el fichero .yaml que encontraras en el enlace del párrafo siguiente . Este se encargara de desplegar 2 maquinas una que hará de cortafuegos y otra que simulara un cliente que estará conectado a la primera maquina para simular una red local .</p></blockquote><p>Realiza con NFTABLES el ejercicio de la página <a href=https://fp.josedomingo.org/seguridadgs/u03/perimetral_iptables.html target=_blank rel=noopener>https://fp.josedomingo.org/seguridadgs/u03/perimetral_iptables.html</a> documentando las pruebas de funcionamiento realizadas.</p><h2 id=preparación-del-escenario>Preparación del escenario</h2><p>Lo primero que haremos es activar el bit de forwarding. Para ello, editaremos el archivo <code>/etc/sysctl.conf</code> utilizando el siguiente comando :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nano /etc/sysctl.conf 
</span></span><span style=display:flex><span><span style=color:#75715e># Descomentamos la linea</span>
</span></span><span style=display:flex><span>net.ipv4.ip_forward<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>A continuación, aplicaremos los cambios utilizando el siguiente comando:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo sysctl -p
</span></span><span style=display:flex><span>net.ipv4.ip_forward <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Ahora añadiremos la tabla filter :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add table inet filter
</span></span></code></pre></div><p>Podemos ver las tablas creadas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list tables
</span></span><span style=display:flex><span>table inet filter
</span></span></code></pre></div><p>Crear las cadenas para la entrada y salida :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Cadena de &#34;entrada&#34;</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add chain inet filter input <span style=color:#f92672>{</span> type filter hook input priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Cadena de &#34;salida&#34;</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add chain inet filter output <span style=color:#f92672>{</span> type filter hook output priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Cadena forward , peticiones que atraviesen :</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add chain inet filter forward <span style=color:#f92672>{</span> type filter hook forward priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Ahora comprobaremos que se han creado estas tres cadenas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list chains
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=reglas-del-cortafuegos>Reglas del cortafuegos</h2><h3 id=permitir-ssh-hacia-el-cortafuegos>Permitir ssh hacia el cortafuegos</h3><p>Ahora vamos a permitir el ssh hacia la maquina router-fw :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iif ens3 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oif ens3 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span></code></pre></div><h3 id=política-por-defecto-drop>Política por defecto DROP</h3><p>Ahora vamos a poner la política por defecto DROP:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft chain inet filter input <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft chain inet filter output <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft chain inet filter forward <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Comprobaremos que con la nueva política podemos conectarnos por ssh y no hemos perdido la conexión , viendo que tenemos hits en las reglas .</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>174</span> bytes <span style=color:#ae81ff>11824</span>
</span></span><span style=display:flex><span>		iif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>129</span> bytes <span style=color:#ae81ff>8252</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>169</span> bytes <span style=color:#ae81ff>31232</span>
</span></span><span style=display:flex><span>		oif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>85</span> bytes <span style=color:#ae81ff>22632</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=snat>SNAT</h3><p>Hacemos SNAT para que los equipos de la LAN puedan acceder al exterior.</p><p>Para ello sera necesario que creemos la tabla NAT y sus cadenas . Como podemos observar hemos indicado menos prioridad en la cadena postrouting (mientras menor sea el número, mayor es su prioridad) para que las reglas de dicha cadena se ejecuten después de las reglas de prerouting.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Creamos la tabla NAT</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add table nat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Cadena para el DNAT</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add chain nat prerouting <span style=color:#f92672>{</span> type nat hook prerouting priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Cadena para el SNAT</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add chain nat postrouting <span style=color:#f92672>{</span> type nat hook postrouting priority <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Ahora vamos a permitir hacer SNAT a la red LAN :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 counter masquerade
</span></span></code></pre></div><h3 id=permitimos-el-ssh-desde-el-cortafuego-a-la-lan>Permitimos el ssh desde el cortafuego a la LAN</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span></code></pre></div><p>Ahora que podemos conectarnos por ssh a nuestra maquina LAN , vamos a comprobar las 2 reglas anteriores . Conectarnos por ssh y el SNAT :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ ssh debian@192.168.100.10
</span></span><span style=display:flex><span>Linux lan 6.1.0-12-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.52-1 (2023-09-07) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Tue Feb <span style=color:#ae81ff>27</span> 18:31:10 <span style=color:#ae81ff>2024</span> from 192.168.100.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>debian@lan:~$ ping 1.1.1.1
</span></span><span style=display:flex><span>PING 1.1.1.1 <span style=color:#f92672>(</span>1.1.1.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 1.1.1.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> packets transmitted, <span style=color:#ae81ff>0</span> received, 100% packet loss, time 1002ms
</span></span></code></pre></div><p>Veremos que podemos conectarnos por ssh , sin embargo el ping no esta permitido pero lo he realizado para que la regla de SNAT tenga hits.</p><p>Vamos a ver que las reglas tienen hits :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>621</span> bytes <span style=color:#ae81ff>63636</span>
</span></span><span style=display:flex><span>		iif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>493</span> bytes <span style=color:#ae81ff>41948</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>81</span> bytes <span style=color:#ae81ff>17628</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>1231</span> bytes <span style=color:#ae81ff>141120</span>
</span></span><span style=display:flex><span>		oif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>349</span> bytes <span style=color:#ae81ff>68222</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>103</span> bytes <span style=color:#ae81ff>17420</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>4</span> bytes <span style=color:#ae81ff>336</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>table ip nat <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain prerouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook prerouting priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Como podemos ver el SNAT tiene hits , así que la regla esta funcionando , pero como no dejamos que atraviese el firewall estas no saldrán .</p><h3 id=permitimos-tráfico-para-la-interfaz-loopback>Permitimos tráfico para la interfaz loopback</h3><p>Añadimos las reglas , para permitir el trafico hacia la interfaz loopback :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept    
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept
</span></span></code></pre></div><p>Comprobamos que tenemos conectividad :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ ping 127.0.0.1
</span></span><span style=display:flex><span>PING 127.0.0.1 <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 127.0.0.1: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.205 ms
</span></span></code></pre></div><p>Vamos a ver los hits de la regla :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset | grep lo
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span></code></pre></div><h3 id=peticiones-y-respuestas-protocolo-icmp>Peticiones y respuestas protocolo ICMP</h3><p>Vamos a permitir a la maquina router-fw aceptar peticiones ICMP y que envié la respuesta :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter accept
</span></span></code></pre></div><p>Le hago ping desde mi maquina :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~/Documentos/2ºASIR/SAD/cortafuegos1$ ping 172.22.201.120 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 172.22.201.120 <span style=color:#f92672>(</span>172.22.201.120<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 172.22.201.120: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>61</span> time<span style=color:#f92672>=</span>85.4 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 172.22.201.120 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 85.403/85.403/85.403/0.000 ms
</span></span></code></pre></div><h3 id=permitir-hacer-ping-desde-la-lan>Permitir hacer ping desde la LAN</h3><p>Vamos a permitir que se pueda hacer ping desde la LAN :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 icmp type echo-request counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 icmp type echo-reply counter accept
</span></span></code></pre></div><p>Vamos a comprobarlo :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ ping 1.1.1.1
</span></span><span style=display:flex><span>PING 1.1.1.1 <span style=color:#f92672>(</span>1.1.1.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 1.1.1.1: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span> time<span style=color:#f92672>=</span>40.8 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 1.1.1.1: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span> time<span style=color:#f92672>=</span>40.8 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 1.1.1.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> packets transmitted, <span style=color:#ae81ff>2</span> received, 0% packet loss, time 1002ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 40.821/40.834/40.848/0.013 ms
</span></span></code></pre></div><p>Vamos a ver los hits de la regla , ademas con esta podemos comprobar la regla del SNAT :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>2637</span> bytes <span style=color:#ae81ff>213636</span>
</span></span><span style=display:flex><span>		iif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>2346</span> bytes <span style=color:#ae81ff>172928</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>225</span> bytes <span style=color:#ae81ff>32812</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>4656</span> bytes <span style=color:#ae81ff>697080</span>
</span></span><span style=display:flex><span>		oif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>1618</span> bytes <span style=color:#ae81ff>477018</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>291</span> bytes <span style=color:#ae81ff>30252</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>31</span> bytes <span style=color:#ae81ff>2604</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 icmp type echo-request counter packets <span style=color:#ae81ff>12</span> bytes <span style=color:#ae81ff>1008</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 icmp type echo-reply counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>table ip nat <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain prerouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook prerouting priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 counter packets <span style=color:#ae81ff>4</span> bytes <span style=color:#ae81ff>336</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=consultas-y-respuestas-dns-desde-la-lan>Consultas y respuestas DNS desde la LAN</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 udp sport <span style=color:#ae81ff>53</span> ct state established counter accept
</span></span></code></pre></div><p>Vamos a hacer una consulta utilizando el comando host , ya que no dispongo otra herramienta instalada para hacer consultas dns :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ host www.javiercd.es
</span></span><span style=display:flex><span>www.javiercd.es is an alias <span style=color:#66d9ef>for</span> javierasping.github.io.
</span></span><span style=display:flex><span>javierasping.github.io has address 185.199.111.153
</span></span><span style=display:flex><span>javierasping.github.io has address 185.199.108.153
</span></span><span style=display:flex><span>javierasping.github.io has address 185.199.109.153
</span></span><span style=display:flex><span>javierasping.github.io has address 185.199.110.153
</span></span><span style=display:flex><span>javierasping.github.io has IPv6 address 2606:50c0:8000::153
</span></span><span style=display:flex><span>javierasping.github.io has IPv6 address 2606:50c0:8001::153
</span></span><span style=display:flex><span>javierasping.github.io has IPv6 address 2606:50c0:8003::153
</span></span><span style=display:flex><span>javierasping.github.io has IPv6 address 2606:50c0:8002::153
</span></span></code></pre></div><p>Vamos a consultar los hits de las reglas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>10</span> bytes <span style=color:#ae81ff>643</span> accept
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 udp sport <span style=color:#ae81ff>53</span> ct state established counter packets <span style=color:#ae81ff>10</span> bytes <span style=color:#ae81ff>2644</span> accept
</span></span></code></pre></div><h3 id=permitimos-la-navegación-web-desde-la-lan>Permitimos la navegación web desde la LAN</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#f92672>{</span> 80,443<span style=color:#f92672>}</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#f92672>{</span> 80,443<span style=color:#f92672>}</span> ct state established counter accept
</span></span></code></pre></div><p>Para verificar este punto, necesitaremos modificar el archivo /etc/nsswitch.conf, el cual determina la prioridad de la resolución DNS. Realizaremos esta modificación para priorizar la consulta DNS al servicio de DNS de systemd, el cual está incluido en Debian y Ubuntu. Esto permitirá que las consultas se realicen primero en la propia máquina y, en caso necesario, serán enviadas al servidor DNS configurado ya que en este escenario las aplicaciones no nos resuelven si no realizamos esta modificación .</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ sudo nano /etc/nsswitch.conf 
</span></span><span style=display:flex><span>hosts:          files dns resolve <span style=color:#f92672>[</span>!UNAVAIL<span style=color:#f92672>=</span><span style=color:#66d9ef>return</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Ademas cambiaremos el servidor dns de la maquina y en lugar de ser nosotros , pondremos el del instituto :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ sudo cat /etc/resolv.conf 
</span></span><span style=display:flex><span>nameserver 172.22.0.1
</span></span></code></pre></div><p>Una vez aplicados los cambios vamos a pedir una web por el nombre de dominio , así comprobaremos el funcionamiento de los dos puntos anteriores . Pediré solo las cabeceras para que la salida sea mas legible , un código 200 seria correcto . En la parte de http nos da una redirección ya que el servidor te redirige a https :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ curl -I https://www.javiercd.es/
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span> 
</span></span><span style=display:flex><span>server: GitHub.com
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>last-modified: Sun, <span style=color:#ae81ff>25</span> Feb <span style=color:#ae81ff>2024</span> 23:03:49 GMT
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>31556952</span>
</span></span><span style=display:flex><span>etag: <span style=color:#e6db74>&#34;65dbc755-675b&#34;</span>
</span></span><span style=display:flex><span>expires: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:10:17 GMT
</span></span><span style=display:flex><span>cache-control: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>x-proxy-cache: MISS
</span></span><span style=display:flex><span>x-github-request-id: 5CD4:0E10:CBDBE5:CFBAEA:65DF0430
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>date: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:00:17 GMT
</span></span><span style=display:flex><span>via: 1.1 varnish
</span></span><span style=display:flex><span>age: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>x-served-by: cache-mad2200123-MAD
</span></span><span style=display:flex><span>x-cache: MISS
</span></span><span style=display:flex><span>x-cache-hits: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>x-timer: S1709114417.014922,VS0,VE167
</span></span><span style=display:flex><span>vary: Accept-Encoding
</span></span><span style=display:flex><span>x-fastly-request-id: e15d291bbff90bf9de58991f0f6477e4398c415d
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>26459</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>debian@lan:~$ curl -I http://www.javiercd.es/
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>301</span> Moved Permanently
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>162</span>
</span></span><span style=display:flex><span>Server: GitHub.com
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Location: https://www.javiercd.es/
</span></span><span style=display:flex><span>X-GitHub-Request-Id: 9870:0E7F:37400AD:3848DF5:65DF0425
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>Date: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:00:27 GMT
</span></span><span style=display:flex><span>Age: <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>X-Served-By: cache-mad2200100-MAD
</span></span><span style=display:flex><span>X-Cache: HIT
</span></span><span style=display:flex><span>X-Cache-Hits: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>X-Timer: S1709114427.468002,VS0,VE1
</span></span><span style=display:flex><span>Vary: Accept-Encoding
</span></span><span style=display:flex><span>X-Fastly-Request-ID: e321e34041a049f6f7c99e0693be994990da6da3
</span></span><span style=display:flex><span>X-Cache: MISS from f0
</span></span><span style=display:flex><span>X-Cache-Lookup: HIT from f0:3128
</span></span><span style=display:flex><span>Via: 1.1 varnish, 1.1 f0 <span style=color:#f92672>(</span>squid/4.6<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Connection: close
</span></span></code></pre></div><h3 id=permitimos-el-acceso-a-nuestro-servidor-web-de-la-lan-desde-el-exterior>Permitimos el acceso a nuestro servidor web de la LAN desde el exterior</h3><p>Como ya tenemos resolución dns y navegación web , podremos actualizar nuestros repositorios y instalar paquetes :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ sudo apt update -y <span style=color:#f92672>&amp;&amp;</span> sudo apt install apache2 -y 
</span></span></code></pre></div><p>Una vez instalado apache vamos a realizar la regla de DNAT :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>80</span> counter dnat to 192.168.100.10
</span></span></code></pre></div><p>Ahora tenemos que permitir en la cadena forward el trafico para permitir el DNAT . Las peticiones al servidor web y las respuestas</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>80</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>80</span> ct state established counter accept
</span></span></code></pre></div><p>Ahora vamos a comprobar que podemos acceder al servidor web :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~/Documentos/2ºASIR/SAD/cortafuegos1$ curl -I 172.22.201.120
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Date: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:24:26 GMT
</span></span><span style=display:flex><span>Server: Apache/2.4.57 <span style=color:#f92672>(</span>Debian<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Last-Modified: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:17:20 GMT
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;29cd-6126e72b03120&#34;</span>
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>10701</span>
</span></span><span style=display:flex><span>Vary: Accept-Encoding
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span></code></pre></div><p>Desde un navegador :</p><p><img src=../img/Pastedimage20240228112558.png alt></p><p>Por ultimo vamos a comprobar que las reglas involucradas tienen hits y te dejo el listado completo para que veas las reglas hasta este punto :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>20313</span> bytes <span style=color:#ae81ff>2212299</span>
</span></span><span style=display:flex><span>		iif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>11896</span> bytes <span style=color:#ae81ff>827728</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>8093</span> bytes <span style=color:#ae81ff>1321072</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>92</span> bytes <span style=color:#ae81ff>17660</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>69191</span> bytes <span style=color:#ae81ff>6011531</span>
</span></span><span style=display:flex><span>		oif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>8461</span> bytes <span style=color:#ae81ff>1953220</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>9482</span> bytes <span style=color:#ae81ff>623484</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>92</span> bytes <span style=color:#ae81ff>17660</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>42155</span> bytes <span style=color:#ae81ff>145465374</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 icmp type echo-request counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>2688</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 icmp type echo-reply counter packets <span style=color:#ae81ff>18</span> bytes <span style=color:#ae81ff>1512</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>273</span> bytes <span style=color:#ae81ff>17860</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 udp sport <span style=color:#ae81ff>53</span> ct state established counter packets <span style=color:#ae81ff>273</span> bytes <span style=color:#ae81ff>52163</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established,new counter packets <span style=color:#ae81ff>33973</span> bytes <span style=color:#ae81ff>1794576</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established counter packets <span style=color:#ae81ff>7119</span> bytes <span style=color:#ae81ff>143533481</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>80</span> ct state established,new counter packets <span style=color:#ae81ff>47</span> bytes <span style=color:#ae81ff>3905</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>80</span> ct state established counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>24161</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>table ip nat <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain prerouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook prerouting priority filter; policy accept;
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>80</span> counter packets <span style=color:#ae81ff>4</span> bytes <span style=color:#ae81ff>240</span> dnat to 192.168.100.10
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 counter packets <span style=color:#ae81ff>547</span> bytes <span style=color:#ae81ff>38852</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=ejercicios-adicionales>Ejercicios adicionales</h2><p>Debes añadir después las reglas necesarias para que se permitan las siguientes operaciones:</p><h3 id=permite-poder-hacer-conexiones-ssh-al-exterior-desde-la-máquina-cortafuegos>Permite poder hacer conexiones ssh al exterior desde la máquina cortafuegos.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state new,established  counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established  counter accept
</span></span></code></pre></div><p>Vamos a conectarnos por ssh desde la maquina cortafuegos a otra para comprobar esto :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ ssh 172.22.200.47
</span></span><span style=display:flex><span>Linux odin.javiercd.gonzalonazareno.org 6.1.0-18-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Wed Feb <span style=color:#ae81ff>28</span> 10:35:56 <span style=color:#ae81ff>2024</span> from 172.22.201.120
</span></span><span style=display:flex><span>javiercruces@odin:~$ 
</span></span></code></pre></div><p>Vamos a comprobar los hits en las reglas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset 
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>66</span> bytes <span style=color:#ae81ff>18624</span> accept
</span></span><span style=display:flex><span>oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>89</span> bytes <span style=color:#ae81ff>16572</span> accept
</span></span></code></pre></div><h3 id=permite-hacer-consultas-dns-desde-la-máquina-cortafuegos-sólo-al-servidor-8888-comprueba-que-no-puedes-hacer-un-dig-1111>Permite hacer consultas DNS desde la máquina cortafuegos sólo al servidor 8.8.8.8. Comprueba que no puedes hacer un dig @1.1.1.1.</h3><p>Vamos a añadir esta regla :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 8.8.8.8 udp dport <span style=color:#ae81ff>53</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 8.8.8.8 udp sport <span style=color:#ae81ff>53</span> ct state established counter accept
</span></span></code></pre></div><p>Ahora vamos a comprobar que a traves de la 1.1.1.1 no podemos resolver nombres pero con la 8.8.8.8 si :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ dig @1.1.1.1 www.javiercd.es
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.24-1-Debian &lt;&lt;&gt;&gt; @1.1.1.1 www.javiercd.es
</span></span><span style=display:flex><span>; <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> server found<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; no servers could be reached
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ dig @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.24-1-Debian &lt;&lt;&gt;&gt; @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>; <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> server found<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#e6db74>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#ae81ff>4046</span>
</span></span><span style=display:flex><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;www.javiercd.es.		IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>www.javiercd.es.	3600	IN	CNAME	javierasping.github.io.
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.108.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.109.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.110.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.111.153
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#ae81ff>68</span> msec
</span></span><span style=display:flex><span>;; SERVER: 8.8.8.8#53<span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>UDP<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; WHEN: Wed Feb <span style=color:#ae81ff>28</span> 11:09:05 UTC <span style=color:#ae81ff>2024</span>
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: <span style=color:#ae81ff>144</span>
</span></span></code></pre></div><p>Vamos a ver los hits de las reglas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset 
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 8.8.8.8 udp sport <span style=color:#ae81ff>53</span> ct state established counter packets <span style=color:#ae81ff>314</span> bytes <span style=color:#ae81ff>36448</span> accept
</span></span><span style=display:flex><span>oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 8.8.8.8 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>314</span> bytes <span style=color:#ae81ff>21912</span> accept
</span></span></code></pre></div><h3 id=permite-que-la-máquina-cortafuegos-pueda-navegar-por-https>Permite que la máquina cortafuegos pueda navegar por https.</h3><p>Vamos a añadir la regla :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp tcp dport <span style=color:#ae81ff>443</span> ct state new,established  counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp tcp sport <span style=color:#ae81ff>443</span>  ct state established  counter accept
</span></span></code></pre></div><p>Vamos a comprobar que pidiendo las cabeceras , que es similar a navegar podemos ver un código 200 en https :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ curl -I https://www.javiercd.es/
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span> 
</span></span><span style=display:flex><span>server: GitHub.com
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>last-modified: Sun, <span style=color:#ae81ff>25</span> Feb <span style=color:#ae81ff>2024</span> 23:03:49 GMT
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>31556952</span>
</span></span><span style=display:flex><span>etag: <span style=color:#e6db74>&#34;65dbc755-675b&#34;</span>
</span></span><span style=display:flex><span>expires: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:10:17 GMT
</span></span><span style=display:flex><span>cache-control: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>x-proxy-cache: MISS
</span></span><span style=display:flex><span>x-github-request-id: 5CD4:0E10:CBDBE5:CFBAEA:65DF0430
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>date: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 11:10:32 GMT
</span></span><span style=display:flex><span>via: 1.1 varnish
</span></span><span style=display:flex><span>age: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>x-served-by: cache-mad22033-MAD
</span></span><span style=display:flex><span>x-cache: HIT
</span></span><span style=display:flex><span>x-cache-hits: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>x-timer: S1709118632.338441,VS0,VE131
</span></span><span style=display:flex><span>vary: Accept-Encoding
</span></span><span style=display:flex><span>x-fastly-request-id: 01056938385ca0e465882fa75fd0b19d0973df62
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>26459</span>
</span></span></code></pre></div><h3 id=los-equipos-de-la-red-local-deben-poder-tener-conexión-al-exterior>Los equipos de la red local deben poder tener conexión al exterior.</h3><p>SNAT realizado anteriormente</p><h3 id=permitimos-el-ssh-desde-el-cortafuegos-a-la-lan>Permitimos el ssh desde el cortafuegos a la LAN</h3><p>Permitido por regla anterior</p><h3 id=permitimos-hacer-ping-desde-la-lan-a-la-máquina-cortafuegos>Permitimos hacer ping desde la LAN a la máquina cortafuegos.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter accept
</span></span></code></pre></div><p>Realizamos el ping desde LAN al cortafuegos</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ ping 192.168.100.2
</span></span><span style=display:flex><span>PING 192.168.100.2 <span style=color:#f92672>(</span>192.168.100.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>1.09 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>1.75 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 192.168.100.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> packets transmitted, <span style=color:#ae81ff>2</span> received, 0% packet loss, time 1002ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 1.091/1.419/1.748/0.328 ms
</span></span></code></pre></div><p>Veremos los hits para esta regla en concreto :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span></code></pre></div><h3 id=permite-realizar-conexiones-ssh-desde-los-equipos-de-la-lan>Permite realizar conexiones ssh desde los equipos de la LAN</h3><p>Vamos a hacer las reglas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span></code></pre></div><p>Vamos a conectarnos por ssh a una maquina fuera de la lan :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ ssh javiercruces@172.22.200.47
</span></span><span style=display:flex><span>Linux odin.javiercd.gonzalonazareno.org 6.1.0-18-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Wed Feb <span style=color:#ae81ff>28</span> 10:36:26 <span style=color:#ae81ff>2024</span> from 172.22.201.120
</span></span><span style=display:flex><span>javiercruces@odin:~$ 
</span></span></code></pre></div><p>Vamos a ver los hits de estas reglas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft -a list table inet filter
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>10</span> bytes <span style=color:#ae81ff>3312</span> accept <span style=color:#75715e># handle 44</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>7</span> bytes <span style=color:#ae81ff>3088</span> accept <span style=color:#75715e># handle 45</span>
</span></span></code></pre></div><h3 id=instala-un-servidor-de-correos-en-la-máquina-de-la-lan-permite-el-acceso-desde-el-exterior-y-desde-el-cortafuegos-al-servidor-de-correos-para-probarlo-puedes-ejecutar-un-telnet-al-puerto-25-tcp>Instala un servidor de correos en la máquina de la LAN. Permite el acceso desde el exterior y desde el cortafuegos al servidor de correos. Para probarlo puedes ejecutar un telnet al puerto 25 tcp.</h3><p>Con estas reglas permitimos conectarnos desde fuera de la red al servidor de correos :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>25</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>25</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Regla DNAT puerto 25 </span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>25</span> counter dnat to 192.168.100.10
</span></span></code></pre></div><p>Vamos a comprobarlo :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~/Documentos/2ºASIR/SAD/cortafuegos1$ telnet 172.22.201.120 <span style=color:#ae81ff>25</span>
</span></span><span style=display:flex><span>Trying 172.22.201.120...
</span></span><span style=display:flex><span>Connected to 172.22.201.120.
</span></span><span style=display:flex><span>Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> lan.openstacklocal ESMTP Postfix <span style=color:#f92672>(</span>Debian/GNU<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Connection closed by foreign host.
</span></span></code></pre></div><p>Vamos a ver los hits en las reglas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span><span style=color:#75715e># Reglas para permitir el trafico</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>25</span> ct state established,new counter packets <span style=color:#ae81ff>10</span> bytes <span style=color:#ae81ff>544</span> accept <span style=color:#75715e># handle 46</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>25</span> ct state established counter packets <span style=color:#ae81ff>9</span> bytes <span style=color:#ae81ff>613</span> accept
</span></span><span style=display:flex><span><span style=color:#75715e># Regla DNAT</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>25</span> counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>60</span> dnat to 192.168.100.10
</span></span></code></pre></div><h3 id=permite-hacer-conexiones-ssh-desde-exterior-a-la-lan>Permite hacer conexiones ssh desde exterior a la LAN</h3><p>Para ello voy a hacer un DNAT al puerto 2222 y a permitir ese trafico</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Reglas para permitir el trafico del DNAT</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>2222</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>2222</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Regla DNAT puerto 2222 para ssh </span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter dnat to 192.168.100.10
</span></span></code></pre></div><p>He cambiado el puerto del servicio ssh de lan al 2222 , voy a conectarme desde fuera a la LAN por ssh :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~/Documentos/2ºASIR/SAD/cortafuegos1$ ssh -p <span style=color:#ae81ff>2222</span> debian@172.22.201.120
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Linux lan 6.1.0-12-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.52-1 (2023-09-07) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Wed Feb <span style=color:#ae81ff>28</span> 14:12:18 <span style=color:#ae81ff>2024</span> from 192.168.100.2
</span></span><span style=display:flex><span>debian@lan:~$ 
</span></span></code></pre></div><p>Vamos a comprobar los hits de las reglas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Reglas para permitir el ssh 2222 desde fuera hacia la LAN</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>2222</span> ct state established,new counter packets <span style=color:#ae81ff>54</span> bytes <span style=color:#ae81ff>9784</span> accept
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>2222</span> ct state established counter packets <span style=color:#ae81ff>44</span> bytes <span style=color:#ae81ff>10494</span> accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Regla DNAT</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter packets <span style=color:#ae81ff>5</span> bytes <span style=color:#ae81ff>300</span> dnat to 192.168.100.10
</span></span></code></pre></div><h3 id=modifica-la-regla-anterior-para-que-al-acceder-desde-el-exterior-por-ssh-tengamos-que-conectar-al-puerto-2222-aunque-el-servidor-ssh-este-configurado-para-acceder-por-el-puerto-22>Modifica la regla anterior, para que al acceder desde el exterior por ssh tengamos que conectar al puerto 2222, aunque el servidor ssh este configurado para acceder por el puerto 22.</h3><p>Para esto vamos a eliminar las 3 reglas anteriores y añadiremos las siguientes :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Permitimos el trafico que ahora &#34;cambiamos&#34; el puerto con la regla DNAT de 2222 a 22</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Regla DNAT</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter dnat to 192.168.100.10
</span></span></code></pre></div><p>Ahora vamos a comprobar que podemos conectarnos desde el exterior a la LAN aunque ahora hemos cambiado el servidor ssh de LAN para que escuche en el puerto 22 :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>34</span> bytes <span style=color:#ae81ff>7868</span> accept
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>9066</span> accept
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter packets <span style=color:#ae81ff>7</span> bytes <span style=color:#ae81ff>420</span> dnat to 192.168.100.10:22
</span></span></code></pre></div><h3 id=permite-hacer-consultas-dns-desde-la-lan-sólo-al-servidor-8888-comprueba-que-no-puedes-hacer-un-dig-1111>Permite hacer consultas DNS desde la LAN sólo al servidor 8.8.8.8. Comprueba que no puedes hacer un dig @1.1.1.1.</h3><p>Vamos a borrar la regla anterior que permite las consultas DNS :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft -a list table inet filter
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>285</span> bytes <span style=color:#ae81ff>17036</span> accept <span style=color:#75715e># handle 35</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft delete rule inet filter forward handle <span style=color:#ae81ff>35</span>
</span></span></code></pre></div><p>Añadimos la regla nueva para permitir solo consultas al 8.8.8.8 :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ip daddr 8.8.8.8 counter accept
</span></span></code></pre></div><p>Vamos a comprobarlo :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ dig @1.1.1.1 www.javiercd.es
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.24-1-Debian &lt;&lt;&gt;&gt; @1.1.1.1 www.javiercd.es
</span></span><span style=display:flex><span>; <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> server found<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; no servers could be reached
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>debian@lan:~$ dig @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.24-1-Debian &lt;&lt;&gt;&gt; @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>; <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> server found<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#e6db74>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#ae81ff>59302</span>
</span></span><span style=display:flex><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;www.javiercd.es.		IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>www.javiercd.es.	3600	IN	CNAME	javierasping.github.io.
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.108.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.109.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.110.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.111.153
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#ae81ff>72</span> msec
</span></span><span style=display:flex><span>;; SERVER: 8.8.8.8#53<span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>UDP<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; WHEN: Wed Feb <span style=color:#ae81ff>28</span> 14:44:29 UTC <span style=color:#ae81ff>2024</span>
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: <span style=color:#ae81ff>144</span>
</span></span></code></pre></div><p>Vamos a ver los hits de las reglas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft -a list table inet filter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ip daddr 8.8.8.8 counter packets <span style=color:#ae81ff>3</span> bytes <span style=color:#ae81ff>218</span> accept <span style=color:#75715e># handle 53</span>
</span></span></code></pre></div><h3 id=permite-que-los-equipos-de-la-lan-puedan-navegar-por-internet-excepto-a-la-página>Permite que los equipos de la LAN puedan navegar por internet, excepto a la página <a href=https://www.realbetisbalompie.es target=_blank rel=noopener>www.realbetisbalompie.es</a></h3><p>Tenemos un problema y es que nftables solo filtra hasta el nivel de transporte , es decir por puerto . Así que no podemos leer el dominio ya que este viaja en una cabecera del nivel de aplicación .</p><p>Para prohibirlo , tendremos que bloquear esa IP en su totalidad para un determinado puerto , en mi caso van a ser el 80 y 443.</p><p>Vamos a averiguar las IPS del dominio que queremos bloquear :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ dig +short www.realbetisbalompie.es
</span></span><span style=display:flex><span>realbetisbalompie.es.
</span></span><span style=display:flex><span>51.255.76.196
</span></span></code></pre></div><p>La añadiremos al principio de la cadena en lugar de add añadimos la palabra insert :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft insert rule inet filter forward ip daddr 51.255.76.196 tcp dport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> counter drop 
</span></span></code></pre></div><p>Y ahora no podremos navegar en la pagina del maligno :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ curl -I https://www.realbetisbalompie.es/
</span></span><span style=display:flex><span>curl: <span style=color:#f92672>(</span>28<span style=color:#f92672>)</span> Failed to connect to www.realbetisbalompie.es port <span style=color:#ae81ff>443</span> after <span style=color:#ae81ff>129885</span> ms: Couldn<span style=color:#960050;background-color:#1e0010>&#39;</span>t connect to server
</span></span></code></pre></div><p>Vamos a ver los hits de la regla que nos protege del mal :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>ip daddr 51.255.76.196 tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> counter packets <span style=color:#ae81ff>7</span> bytes <span style=color:#ae81ff>420</span> drop
</span></span></code></pre></div><h2 id=hacer-las-reglas-persistentes>Hacer las reglas persistentes</h2><p>Vamos a guardar las reglas con :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rott@router-fw:/home/javiercruces# nft list ruleset &gt; /etc/nftables.conf
</span></span></code></pre></div><p>Si las queremos restaurar :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft -f /etc/nftables.conf
</span></span></code></pre></div><p>Para hacer que al reiniciar las reglas se restauren solas :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Creamos la unidad de systemd</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo cat /etc/systemd/system/nftables-persistent.service
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Unit<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Description<span style=color:#f92672>=</span>Cargar reglas de nftables al iniciar el sistema
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Service<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Type<span style=color:#f92672>=</span>oneshot
</span></span><span style=display:flex><span>ExecStart<span style=color:#f92672>=</span>/usr/sbin/nft -f /etc/nftables/nftables.rules
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Install<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>WantedBy<span style=color:#f92672>=</span>multi-user.target
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Activa el servicio para que al reiniciar se apliquen los cambios </span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo systemctl enable nftables-persistent.service
</span></span></code></pre></div><h2 id=reglas-al-final-del-ejercicio>Reglas al final del ejercicio</h2><p>Te dejo la lista de las reglas en el estado del ultimo ejercicio :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>34414</span> bytes <span style=color:#ae81ff>6500685</span>
</span></span><span style=display:flex><span>		iif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>21235</span> bytes <span style=color:#ae81ff>1526616</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>11648</span> bytes <span style=color:#ae81ff>1793088</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>92</span> bytes <span style=color:#ae81ff>17660</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>66</span> bytes <span style=color:#ae81ff>18624</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp tcp sport <span style=color:#ae81ff>443</span> ct state established counter packets <span style=color:#ae81ff>519</span> bytes <span style=color:#ae81ff>3016033</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 8.8.8.8 udp sport <span style=color:#ae81ff>53</span> ct state established counter packets <span style=color:#ae81ff>557</span> bytes <span style=color:#ae81ff>68077</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>86303</span> bytes <span style=color:#ae81ff>8331992</span>
</span></span><span style=display:flex><span>		oif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>15004</span> bytes <span style=color:#ae81ff>3534878</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>14125</span> bytes <span style=color:#ae81ff>950568</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>92</span> bytes <span style=color:#ae81ff>17660</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>89</span> bytes <span style=color:#ae81ff>16572</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 8.8.8.8 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>557</span> bytes <span style=color:#ae81ff>36254</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp tcp dport <span style=color:#ae81ff>443</span> ct state established,new counter packets <span style=color:#ae81ff>367</span> bytes <span style=color:#ae81ff>25011</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy drop;
</span></span><span style=display:flex><span>		ip daddr 51.255.76.196 tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> counter packets <span style=color:#ae81ff>7</span> bytes <span style=color:#ae81ff>420</span> drop
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>45573</span> bytes <span style=color:#ae81ff>149083811</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 icmp type echo-request counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>2688</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 icmp type echo-reply counter packets <span style=color:#ae81ff>18</span> bytes <span style=color:#ae81ff>1512</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 udp sport <span style=color:#ae81ff>53</span> ct state established counter packets <span style=color:#ae81ff>664</span> bytes <span style=color:#ae81ff>101857</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established,new counter packets <span style=color:#ae81ff>34813</span> bytes <span style=color:#ae81ff>1843071</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established counter packets <span style=color:#ae81ff>7583</span> bytes <span style=color:#ae81ff>146852066</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>80</span> ct state established,new counter packets <span style=color:#ae81ff>47</span> bytes <span style=color:#ae81ff>3905</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>80</span> ct state established counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>24161</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>72</span> bytes <span style=color:#ae81ff>18540</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>56</span> bytes <span style=color:#ae81ff>17296</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>25</span> ct state established,new counter packets <span style=color:#ae81ff>10</span> bytes <span style=color:#ae81ff>544</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>25</span> ct state established counter packets <span style=color:#ae81ff>9</span> bytes <span style=color:#ae81ff>613</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>90</span> bytes <span style=color:#ae81ff>17200</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>77</span> bytes <span style=color:#ae81ff>19296</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ip daddr 8.8.8.8 counter packets <span style=color:#ae81ff>81</span> bytes <span style=color:#ae81ff>5250</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>table ip nat <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain prerouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook prerouting priority filter; policy accept;
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>80</span> counter packets <span style=color:#ae81ff>4</span> bytes <span style=color:#ae81ff>240</span> dnat to 192.168.100.10
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>25</span> counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>60</span> dnat to 192.168.100.10
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter packets <span style=color:#ae81ff>8</span> bytes <span style=color:#ae81ff>480</span> dnat to 192.168.100.10:22
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 counter packets <span style=color:#ae81ff>916</span> bytes <span style=color:#ae81ff>61536</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Compartir en:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f&text=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Nftables%20I&via=Atlas" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f&title=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Nftables%20I" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f&title=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Nftables%20I" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Nftables%20I https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Nftables%20I&body=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/javierasping/sentinel/edit/main/content/posts/cortafuegos/nftables_uno/cortafuegos_uno.md title="Mejorar esta página" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Mejorar esta página</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Contenido</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#preparación-del-escenario>Preparación del escenario</a></li><li><a href=#reglas-del-cortafuegos>Reglas del cortafuegos</a><ul><li><a href=#permitir-ssh-hacia-el-cortafuegos>Permitir ssh hacia el cortafuegos</a></li><li><a href=#política-por-defecto-drop>Política por defecto DROP</a></li><li><a href=#snat>SNAT</a></li><li><a href=#permitimos-el-ssh-desde-el-cortafuego-a-la-lan>Permitimos el ssh desde el cortafuego a la LAN</a></li><li><a href=#permitimos-tráfico-para-la-interfaz-loopback>Permitimos tráfico para la interfaz loopback</a></li><li><a href=#peticiones-y-respuestas-protocolo-icmp>Peticiones y respuestas protocolo ICMP</a></li><li><a href=#permitir-hacer-ping-desde-la-lan>Permitir hacer ping desde la LAN</a></li><li><a href=#consultas-y-respuestas-dns-desde-la-lan>Consultas y respuestas DNS desde la LAN</a></li><li><a href=#permitimos-la-navegación-web-desde-la-lan>Permitimos la navegación web desde la LAN</a></li><li><a href=#permitimos-el-acceso-a-nuestro-servidor-web-de-la-lan-desde-el-exterior>Permitimos el acceso a nuestro servidor web de la LAN desde el exterior</a></li></ul></li><li><a href=#ejercicios-adicionales>Ejercicios adicionales</a><ul><li><a href=#permite-poder-hacer-conexiones-ssh-al-exterior-desde-la-máquina-cortafuegos>Permite poder hacer conexiones ssh al exterior desde la máquina cortafuegos.</a></li><li><a href=#permite-hacer-consultas-dns-desde-la-máquina-cortafuegos-sólo-al-servidor-8888-comprueba-que-no-puedes-hacer-un-dig-1111>Permite hacer consultas DNS desde la máquina cortafuegos sólo al servidor 8.8.8.8. Comprueba que no puedes hacer un dig @1.1.1.1.</a></li><li><a href=#permite-que-la-máquina-cortafuegos-pueda-navegar-por-https>Permite que la máquina cortafuegos pueda navegar por https.</a></li><li><a href=#los-equipos-de-la-red-local-deben-poder-tener-conexión-al-exterior>Los equipos de la red local deben poder tener conexión al exterior.</a></li><li><a href=#permitimos-el-ssh-desde-el-cortafuegos-a-la-lan>Permitimos el ssh desde el cortafuegos a la LAN</a></li><li><a href=#permitimos-hacer-ping-desde-la-lan-a-la-máquina-cortafuegos>Permitimos hacer ping desde la LAN a la máquina cortafuegos.</a></li><li><a href=#permite-realizar-conexiones-ssh-desde-los-equipos-de-la-lan>Permite realizar conexiones ssh desde los equipos de la LAN</a></li><li><a href=#instala-un-servidor-de-correos-en-la-máquina-de-la-lan-permite-el-acceso-desde-el-exterior-y-desde-el-cortafuegos-al-servidor-de-correos-para-probarlo-puedes-ejecutar-un-telnet-al-puerto-25-tcp>Instala un servidor de correos en la máquina de la LAN. Permite el acceso desde el exterior y desde el cortafuegos al servidor de correos. Para probarlo puedes ejecutar un telnet al puerto 25 tcp.</a></li><li><a href=#permite-hacer-conexiones-ssh-desde-exterior-a-la-lan>Permite hacer conexiones ssh desde exterior a la LAN</a></li><li><a href=#modifica-la-regla-anterior-para-que-al-acceder-desde-el-exterior-por-ssh-tengamos-que-conectar-al-puerto-2222-aunque-el-servidor-ssh-este-configurado-para-acceder-por-el-puerto-22>Modifica la regla anterior, para que al acceder desde el exterior por ssh tengamos que conectar al puerto 2222, aunque el servidor ssh este configurado para acceder por el puerto 22.</a></li><li><a href=#permite-hacer-consultas-dns-desde-la-lan-sólo-al-servidor-8888-comprueba-que-no-puedes-hacer-un-dig-1111>Permite hacer consultas DNS desde la LAN sólo al servidor 8.8.8.8. Comprueba que no puedes hacer un dig @1.1.1.1.</a></li><li><a href=#permite-que-los-equipos-de-la-lan-puedan-navegar-por-internet-excepto-a-la-página>Permite que los equipos de la LAN puedan navegar por internet, excepto a la página <a href=http://www.realbetisbalompie.es>www.realbetisbalompie.es</a></a></li></ul></li><li><a href=#hacer-las-reglas-persistentes>Hacer las reglas persistentes</a></li><li><a href=#reglas-al-final-del-ejercicio>Reglas al final del ejercicio</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navegación</h5><ul><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#about>Sobre mi</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#skills>Competencias</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#education>Educación</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#recent-posts>Últimas publicaciones</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#accomplishments>Certificaciones</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contacto</h5><ul><li><a href=mailto:contacto@javiercd.es target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>contacto@javiercd.es</span></a></li><li><a href=https://github.com/javierasping target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>javierasping</span></a></li><li><a href=https://www.linkedin.com/in/javiercd target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Francisco Javier Cruces Doval</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>Aviso de responsabilidad:</strong> This theme is under MIT license. So, you can use it for non-commercial, commercial, or private uses. You can modify or distribute the theme without requiring any permission from the theme author. However, the theme author does not provide any warranty or takes any liability for any issue with the theme.</p></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu_b3360284c55cf72d.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2023 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Funcionando con
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.29119cfdb8d2f06f4caaea7b9908096b5c109c5174eab5fca7e4e0efb0ffcaa0.js integrity="sha256-KRGc/bjS8G9Mqup7mQgJa1wQnFF06rX8p+Tg77D/yqA=" defer></script></body></html>