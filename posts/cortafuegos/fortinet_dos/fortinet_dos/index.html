<!doctype html><html lang=es><head><title>Implementación de un cortafuegos perimetral con Fortinet II</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.ddf4c4775d35e5bc3dd64c797b179f99eaf85cf9811e64bd08f8c44a68d0b229.css integrity="sha256-3fTEd1015bw91kx5exefmer4XPmBHmS9CPjESmjQsik="><link rel=icon type=image/png href=/images/site/avatar_hu_f10227dc088ad43a.jpg><meta property="og:title" content="Atlas"><meta property="og:type" content="website"><meta property="og:description" content="Portafolio y blog personal de Francisco Javier Cruces Doval"><meta property="og:image" content="/images/author/john.png"><meta property="og:url" content="https://www.javiercd.es"><meta name=description content="Implementación de un cortafuegos perimetral con Fortinet II"><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/masthead_hu_f10227dc088ad43a.png id=logo alt=Logo>
Atlas</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>Inicio</a></li><li class=nav-item><a class=nav-link href=/#about>Sobre mi</a></li><li class=nav-item><a class=nav-link href=/#skills>Competencias</a></li><li class=nav-item><a class=nav-link href=/#education>Educación</a></li><li class=nav-item><a class=nav-link href=/#recent-posts>Últimas publicaciones</a></li><li class=nav-item><a class=nav-link href=/#accomplishments>Certificaciones</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=languageSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><span class="fi fi-es"></span>
Español</a><div class=dropdown-menu aria-labelledby=languageSelector><a class="dropdown-item nav-link languages-item" href=/posts/cortafuegos/fortinet_dos/fortinet_dos><span class="fi fi-es"></span>
Español
</a><a class="dropdown-item nav-link languages-item" href=/en/posts/cortafuegos/fortinet_dos/fortinet_dos><span class="fi fi-gb"></span>
English</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Búsqueda data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/posts/iaw/> Aplicaciones webs</a><ul><li><a class=list-link href=/posts/iaw/lamp/ title="Instalación pila LAMP">Instalación pila LAMP</a></li><li><a class=list-link href=/posts/iaw/lemp/ title="Instalación pila LEMP">Instalación pila LEMP</a></li><li><a class=list-link href=/posts/iaw/wordpress/ title="Wordpress LAMP">Wordpress LAMP</a></li><li><a class=list-link href=/posts/iaw/wordpress_lemp/ title="Wordpress LEMP">Wordpress LEMP</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/base_de_datos/> Base de datos</a><ul><li><a class=list-link href=/posts/base_de_datos/acceso_remoto_mariadb/ title="Acceso remoto en MariaDB">Acceso remoto en MariaDB</a></li><li><a class=list-link href=/posts/base_de_datos/oracle_acceso_remoto/ title="Configuración de acceso remoto en Oracle">Configuración de acceso remoto en Oracle</a></li><li><a class=list-link href=/posts/base_de_datos/instalacion_oracle_19c_debian12/ title="Instalación de Oracle 19c bajo Debian 12">Instalación de Oracle 19c bajo Debian 12</a></li><li><a class=list-link href=/posts/base_de_datos/instalar_postgresql/ title="Instalación de PostgreSQL en Debian 12">Instalación de PostgreSQL en Debian 12</a></li><li><a class=list-link href=/posts/base_de_datos/instalar_mariadb/ title="Instalar MariaDB en Debian">Instalar MariaDB en Debian</a></li><li><a class=list-link href=/posts/base_de_datos/interconexion_de_servidores/ title="Interconexión de servidores de bases de datos">Interconexión de servidores de bases de datos</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/ci_cd/> CI/CD Jenkins</a><ul><li><a class=list-link href=/posts/ci_cd/practica_jenkins/ title="Práctica CI/CD con Jenkins">Práctica CI/CD con Jenkins</a></li><li><a class=list-link href=/posts/ci_cd/taller1_jenkins/ title="Taller 1 Corrector ortográfico de documentos markdown (test)">Taller 1 Corrector ortográfico de documentos markdown (test)</a></li><li><a class=list-link href=/posts/ci_cd/taller2_jenkins/ title="Taller 2 Comprobación de HTML5 válido y despliegue en surge.sh (test y deploy)">Taller 2 Comprobación de HTML5 válido y despliegue en surge.sh (test y deploy)</a></li><li><a class=list-link href=/posts/ci_cd/taller3_jenkins/ title="Taller 3 Integración continua de aplicación django (Test)">Taller 3 Integración continua de aplicación django (Test)</a></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/posts/cortafuegos/> Cortafuegos</a><ul class=active><li><a class=list-link href=/posts/cortafuegos/fortinet_cli/ title="Fortinet CLI">Fortinet CLI</a></li><li><a class=list-link href=/posts/cortafuegos/fortinet_uno/ title="Perimetral con Fortinet I">Perimetral con Fortinet I</a></li><li><a class="active list-link" href=/posts/cortafuegos/fortinet_dos/ title="Perimetral con Fortinet II">Perimetral con Fortinet II</a></li><li><a class=list-link href=/posts/cortafuegos/nftables_uno/ title="Perimetral con Nftables I">Perimetral con Nftables I</a></li><li><a class=list-link href=/posts/cortafuegos/nftables_dos/ title="Perimetral con Nftables II">Perimetral con Nftables II</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/docker/> Docker</a><ul><li><a class=list-link href=/posts/docker/instalar_docker_compose/ title="Instalación de Docker Compose en Ubuntu 24">Instalación de Docker Compose en Ubuntu 24</a></li><li><a class=list-link href=/posts/docker/instalar_docker_ubuntu24/ title="Instalación de Docker en Ubuntu 24">Instalación de Docker en Ubuntu 24</a></li><li><a class=list-link href=/posts/docker/taller1/ title="Taller 1 Almacenamiento y redes en Docker">Taller 1 Almacenamiento y redes en Docker</a></li><li><a class=list-link href=/posts/docker/taller2/ title="Taller 2 Escenarios multicontenedor en Docker">Taller 2 Escenarios multicontenedor en Docker</a></li><li><a class=list-link href=/posts/docker/taller3/ title="Taller 3 Creación de imágenes Docker">Taller 3 Creación de imágenes Docker</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/drivers/> Drivers Linux</a><ul><li><a class=list-link href=/posts/drivers/nvidia_optimus/ title="Como elegir que gráfica usar en mi portátil con Linux">Como elegir que gráfica usar en mi portátil con Linux</a></li><li><a class=list-link href=/posts/drivers/nvidia_driver/ title="Drivers Nvidia">Drivers Nvidia</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/redes/> Redes</a><ul><li><a class=list-link href=/posts/redes/android_gns3/ title="Android GNS3-KVM">Android GNS3-KVM</a></li><li><a class=list-link href=/posts/redes/comandos_de_supervision_de_redes/ title="Comandos de supervisión de redes">Comandos de supervisión de redes</a></li><li><a class=list-link href=/posts/redes/switches_gns3/ title="Configuración de switches en GNS3">Configuración de switches en GNS3</a></li><li><a class=list-link href=/posts/redes/enroutamiento_openstack/ title="Enrutamiento en OpenStack">Enrutamiento en OpenStack</a></li><li><a class=list-link href=/posts/redes/escenario_ipv6_basico/ title="Escenario IPv6 Básico">Escenario IPv6 Básico</a></li><li><a class=list-link href=/posts/redes/instalar_gns3_debian12/ title="Instalacion GNS3 en Debian 12">Instalacion GNS3 en Debian 12</a></li><li><a class=list-link href=/posts/redes/instalacion_wireshark_gns3/ title="Instalacion GNS3 y Wireshark">Instalacion GNS3 y Wireshark</a></li><li><a class=list-link href=/posts/redes/configuracion_de_nat/ title="NAT en Cisco y Linux">NAT en Cisco y Linux</a></li><li><a class=list-link href=/posts/redes/arp/ title="Protocolo ARP">Protocolo ARP</a></li><li><a class=list-link href=/posts/redes/tuneles_ipv6/ title="Túneles IPV6">Túneles IPV6</a></li><li><a class=list-link href=/posts/redes/underworld/ title=Underworld>Underworld</a></li><li><a class=list-link href=/posts/redes/underworld_evolution/ title="Underworld evolution">Underworld evolution</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/seguridad/> Seguridad</a><ul><li><a class=list-link href=/posts/seguridad/https_autofirmado/ title=HTTPS>HTTPS</a></li><li><a class=list-link href=/posts/seguridad/forense/ title="Informática forense">Informática forense</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/servicios/> Servicios</a><ul><li><a class=list-link href=/posts/servicios/apache/ title=Apache>Apache</a></li><li><a class=list-link href=/posts/servicios/dhcp/ title=DHCP>DHCP</a></li><li><a class=list-link href=/posts/servicios/dns/ title=DNS>DNS</a></li><li><a class=list-link href=/posts/servicios/ftp/ title=FTP>FTP</a></li><li><a class=list-link href=/posts/servicios/nat_iptables/ title="NAT con iptables">NAT con iptables</a></li><li><a class=list-link href=/posts/servicios/ssh/ title=SSH>SSH</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/> Sistemas</a><ul><li><a class=list-link href=/posts/sistemas/ad_ubuntu/ title="Active Directory en Ubuntu">Active Directory en Ubuntu</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/comandos_linux/> Comandos en Linux</a><ul><li><a class=list-link href=/posts/sistemas/comandos_linux/ejercicios_de_manejo_de_modulos/ title="Ejercicios de manejo de módulos">Ejercicios de manejo de módulos</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/ejercicios_de_modificacion_de_parametros_del_kernel/ title="Ejercicios de modificación de parámetros del kernel">Ejercicios de modificación de parámetros del kernel</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/ejercicios_gestion_de_paqueteria/ title="Ejercicios gestión de paquetería">Ejercicios gestión de paquetería</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/empaquetadores_compresores/ title="Empaquetadores y compresores">Empaquetadores y compresores</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/gestion_de_paquetes/ title="Gestión de paquetes">Gestión de paquetes</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/comandos_procesos/ title="Procesos en Linux">Procesos en Linux</a></li><li><a class=list-link href=/posts/sistemas/comandos_linux/programacion_tareas/ title="Programación de tareas">Programación de tareas</a></li></ul></li><li><a class=list-link href=/posts/sistemas/comparticion_de_directorios_en_windows/ title="Compartir recursos en Windows">Compartir recursos en Windows</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/compilaciones_linux/> Compilaciones en Linnux</a><ul><li><a class=list-link href=/posts/sistemas/compilaciones_linux/compilacion_de_un_kernel/ title="Compilación de un kernel">Compilación de un kernel</a></li><li><a class=list-link href=/posts/sistemas/compilaciones_linux/compilacion_de_un_programa_en_c_utilizando_un_makefile/ title="Compilación de un programa en C utilizando un Makefile">Compilación de un programa en C utilizando un Makefile</a></li></ul></li><li><a class=list-link href=/posts/sistemas/activacion_selinux/ title="Configuración activación de SELinux">Configuración activación de SELinux</a></li><li><a class=list-link href=/posts/sistemas/creacion_de_un_sistema_automatizado_de_instalacion/ title="Creación de un sistema automatizado de instalación">Creación de un sistema automatizado de instalación</a></li><li><a class=list-link href=/posts/sistemas/samba_debian/ title="Instalar y configurar samba en Debian">Instalar y configurar samba en Debian</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/migraciones/> Migraciones en Linnux</a><ul><li><a class=list-link href=/posts/sistemas/migraciones/eliminacion_systemd/ title="Eliminación de systemd">Eliminación de systemd</a></li><li><a class=list-link href=/posts/sistemas/migraciones/paso_de_centos_stream_8_a_centos_stream_9/ title="Paso de CentOS stream 8 a CentOS stream 9">Paso de CentOS stream 8 a CentOS stream 9</a></li><li><a class=list-link href=/posts/sistemas/migraciones/migracion_sistema_de_ficheros/ title="Sistema de ficheros">Sistema de ficheros</a></li><li><a class=list-link href=/posts/sistemas/migraciones/transformacion_instancia_cloud/ title="Transformación instancia cloud">Transformación instancia cloud</a></li></ul></li><li><a class=list-link href=/posts/sistemas/nfs_debian/ title="NFS en Debian">NFS en Debian</a></li><li><a class=list-link href=/posts/sistemas/recoleccion_logs_journald/ title="Recolección centralizada de logs journald">Recolección centralizada de logs journald</a></li><li><a class=list-link href=/posts/sistemas/ssh_windows/ title="Servicio ssh en Windows">Servicio ssh en Windows</a></li><li><a class=list-link href=/posts/sistemas/almacenamiento_servidor_independiente/ title="Storage Spaces en Windows Server">Storage Spaces en Windows Server</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/vpn/> VPN</a><ul><li><a class=list-link href=/posts/vpn/acceso_remoto_strongswang/ title="Acceso remoto Ipsec StrongSwan">Acceso remoto Ipsec StrongSwan</a></li><li><a class=list-link href=/posts/vpn/acceso_remoto_openvpn/ title="Acceso remoto OpenVPN">Acceso remoto OpenVPN</a></li><li><a class=list-link href=/posts/vpn/acceso_remoto_wireguard/ title="Acceso remoto Wireguard">Acceso remoto Wireguard</a></li><li><a class=list-link href=/posts/vpn/comparativa_ovpn_wire/ title="Comparativa OpenVPN y Wireguard">Comparativa OpenVPN y Wireguard</a></li><li><a class=list-link href=/posts/vpn/ipsec_cisco/ title="Site-to-Site IPsec Cisco">Site-to-Site IPsec Cisco</a></li><li><a class=list-link href=/posts/vpn/site_to_site_fortinet/ title="Site-to-Site IPsec Fortinet">Site-to-Site IPsec Fortinet</a></li><li><a class=list-link href=/posts/vpn/site_to_site_openvpn/ title="Site-to-Site OpenVPN">Site-to-Site OpenVPN</a></li><li><a class=list-link href=/posts/vpn/site_to_site_wireguard/ title="Site-to-Site Wireguard">Site-to-Site Wireguard</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/cortafuegos/fortinet2.png)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/john_hu_2aff0fda0501496d.png alt="Author Image"><h5 class=author-name>Francisco Javier Cruces Doval</h5><p class=text-muted>jueves, 28 de marzo de 2024 | 17 minutos</p></div><div class=title><h1>Implementación de un cortafuegos perimetral con Fortinet II</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/tags/firewall/ class="btn btn-sm btn-info">FIREWALL</a></li><li class=rounded><a href=/tags/linux/ class="btn btn-sm btn-info">LINUX</a></li><li class=rounded><a href=/tags/debian/ class="btn btn-sm btn-info">DEBIAN</a></li><li class=rounded><a href=/tags/fortinet/ class="btn btn-sm btn-info">FORTINET</a></li></ul></div><div class=post-content id=post-content><p>Ahora vamos a emular la práctica de cortafuegos II, pero en GNS3. Para ello, he transformado al cliente 1 en Odin, además he añadido a Thor y Loki como máquinas virtuales en lugar de contenedores en la red LAN. También he creado una nueva red llamada DMZ, en la cual estará la máquina Hela.</p><p>Dado que he transformado el escenario anterior en este nuevo, contamos con algunas reglas creadas anteriormente. Por lo tanto, eliminaré del enunciado aquellas que ya estén creadas, como la de hacer SSH a Odin desde el puerto 2222, pero con el servicio escuchando en el 22.</p><p>Además, ahora vamos a hacer unas reservas DHCP para tener controladas las IP de las nuevas máquinas.</p><p>Ademas como no cuento con los servicios montados en el antiguo escenario en Opsentack y para las reglas del enunciado montare lo mínimo para hacer que funcionen las reglas .</p><p>A lo largo de esta practica te explicare que por como esta montado la topologia de la red , todos de la red LAN pueden comunicarse entre sin necesidad de pasar por el cortafuegos . Así que en algunos ejercicios omitiré la parte de hacer que Loki y Thor se comuniquen con Odin. Ademas no voy a montar el servidor DNS ni LDAP ya que las reglas de DNAT son bastante sencillas y a lo largo de la practica aparecen varios ejercicios de hacer DNAT entre las distintas redes . En lugar de esto voy a añadir VPN al final de la misma ya que lo veo mas interesante que repetir las mismas reglas cambiando el servicio .</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329110607.png alt></p><h2 id=preparación-del-escenario>Preparación del escenario</h2><p>Lo primero que haré sera crear una nueva red en el puerto 3 , que corresponde a la red DMZ .</p><p>Como veras en la imagen a continuación he seleccionado que el rol sea LAN , para que me permita tener un servidor DHCP en esa red . Como es una red en la que albergara los servicios no quiero que desde esta se pueda acceder a configurar el cortafuegos así que dejare la administración desactivada .</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329160410.png alt></p><p>Ahora iré accediendo a los nuevos clientes y les cambiare el nombre de maquina y configurándolas por DHCP .</p><p>Maquina Odin , esta era anteriormente la maquina cliente 1 , solo hay que cambiarle el FQDN y el hostname :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>osboxes@odin:~$ hostname -f
</span></span><span style=display:flex><span>odin.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>osboxes@odin:~$ ip -4 a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    altname enp0s3
</span></span><span style=display:flex><span>    inet 192.168.100.2/24 brd 192.168.100.255 scope global dynamic noprefixroute ens3
</span></span><span style=display:flex><span>       valid_lft 604790sec preferred_lft 604790sec
</span></span></code></pre></div><p>Maquina Thor :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@thor:~$ hostname -f
</span></span><span style=display:flex><span>thor.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>debian@thor:~$ ip -4 a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    altname enp0s3
</span></span><span style=display:flex><span>    inet 192.168.100.4/24 brd 192.168.100.255 scope global dynamic ens3
</span></span><span style=display:flex><span>       valid_lft 604791sec preferred_lft 604791sec
</span></span><span style=display:flex><span>debian@thor:~$ 
</span></span></code></pre></div><p>Maquina Loki :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@loki:~$ hostname -f
</span></span><span style=display:flex><span>loki.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>debian@loki:~$ ip -4 a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    altname enp0s3
</span></span><span style=display:flex><span>    inet 192.168.100.3/24 brd 192.168.100.255 scope global dynamic ens3
</span></span><span style=display:flex><span>       valid_lft 604724sec preferred_lft 604724sec
</span></span></code></pre></div><p>Maquina Hela :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@hela:~$ hostname -f
</span></span><span style=display:flex><span>hela.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>debian@hela:~$ ip -4 a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    altname enp0s3
</span></span><span style=display:flex><span>    inet 192.168.200.2/24 brd 192.168.200.255 scope global dynamic ens3
</span></span><span style=display:flex><span>       valid_lft 604795sec preferred_lft 604795sec
</span></span></code></pre></div><p>Ahora vamos a hacer unas reservas en el servidor DHCP , accederemos a Dashborad > Networks > DHCP , una vez aquí le daremos clic derecho sobre cada cliente de los 4 que tenemos en el escenario y le crearemos una reserva :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329162616.png alt></p><p>Nos saldrá un menú similar a este para enlazar la dirección MAC a la IP :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329162730.png alt></p><p>Una vez hagamos esto con nuestro clientes nos indicara que tenemos la reserva hecha :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329162855.png alt></p><h2 id=reglas-del-cortafuegos>Reglas del cortafuegos</h2><p>Vamos a comenzar a crear las reglas , como dije anteriormente partimos del escenario anterior , así que algunas reglas para el funcionamiento mínimo de la red están creadas .</p><p>Te dejo una captura de como se quedaron las reglas , para que veas del estado en el que partimos :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329163530.png alt></p><p>Algunas de las siguiente reglas ya esta configurada del ejercicio anterior , como la siguiente regla &ndash;> <em>La máquina Odin tiene un servidor ssh escuchando por el puerto 22, pero al acceder desde el exterior habrá que conectar al puerto 2222</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~$ ssh osboxes@192.168.122.77 -p <span style=color:#ae81ff>2222</span>
</span></span><span style=display:flex><span>osboxes@192.168.122.77<span style=color:#960050;background-color:#1e0010>&#39;</span>s password: 
</span></span><span style=display:flex><span>Welcome to Ubuntu 22.04 LTS <span style=color:#f92672>(</span>GNU/Linux 5.15.0-25-generic x86_64<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> * Documentation:  https://help.ubuntu.com
</span></span><span style=display:flex><span> * Management:     https://landscape.canonical.com
</span></span><span style=display:flex><span> * Support:        https://ubuntu.com/advantage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>560</span> updates can be applied immediately.
</span></span><span style=display:flex><span><span style=color:#ae81ff>339</span> of these updates are standard security updates.
</span></span><span style=display:flex><span>To see these additional updates run: apt list --upgradable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Last login: Fri Mar <span style=color:#ae81ff>29</span> 11:23:44 <span style=color:#ae81ff>2024</span> from 192.168.100.1
</span></span><span style=display:flex><span>osboxes@odin:~$ hostname -f
</span></span><span style=display:flex><span>odin.javiercd.gonzalonazareno.org
</span></span></code></pre></div><p>A continuación veras que hay algunas reglas que he eliminado o modificado , ya que en el escenario actual no se pueden hacer , bien o por la topología o porque anteriormente la maquina Odin era el cortafuegos . En cualquier caso alguna he mantenido y he explicado algunas cosas adicionales .</p><h3 id=desde-thor-y-hela-se-debe-permitir-la-conexión-ssh-por-el-puerto-22-a-la-máquina-odin>Desde Thor y Hela se debe permitir la conexión ssh por el puerto 22 a la máquina Odin.</h3><p>Esta regla no la podemos realizar ya que al tener un switch de por medio interconectando los dispositivos , el trafico no pasara por el cortafuegos por lo que no podremos aplicar reglas en el cortafuego para impedir el trafico local .</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329170454.png alt></p><p>Veras que aunque cree la regla , en el cortafuegos esta no se inmutara :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329170554.png alt></p><p>Ves que por ejemplo si me conecto desde loki o desde thor puedo llegar a odin :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@loki:~$ ssh osboxes@192.168.100.2
</span></span><span style=display:flex><span>osboxes@192.168.100.2<span style=color:#960050;background-color:#1e0010>&#39;</span>s password: 
</span></span><span style=display:flex><span>Welcome to Ubuntu 22.04 LTS <span style=color:#f92672>(</span>GNU/Linux 5.15.0-25-generic x86_64<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> * Documentation:  https://help.ubuntu.com
</span></span><span style=display:flex><span> * Management:     https://landscape.canonical.com
</span></span><span style=display:flex><span> * Support:        https://ubuntu.com/advantage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>560</span> updates can be applied immediately.
</span></span><span style=display:flex><span><span style=color:#ae81ff>339</span> of these updates are standard security updates.
</span></span><span style=display:flex><span>To see these additional updates run: apt list --upgradable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Last login: Fri Mar <span style=color:#ae81ff>29</span> 11:42:43 <span style=color:#ae81ff>2024</span> from 192.168.100.3
</span></span><span style=display:flex><span>osboxes@odin:~$ 
</span></span></code></pre></div><p>Pero no llego por la regla que he creado si no por la propia topologia de la red , la regla no tiene hits :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329170725.png alt></p><p>Todo el trafico se encarga de redirigirlo el swicht .</p><h3 id=a-la-máquina-odin-se-le-puede-hacer-ping-desde-la-dmz-pero-desde-la-lan-se-le-debe-rechazar-la-conexión-reject-y-desde-el-exterior-se-rechazará-de-manera-silenciosa>A la máquina Odin se le puede hacer ping desde la DMZ, pero desde la LAN se le debe rechazar la conexión (REJECT) y desde el exterior se rechazará de manera silenciosa.</h3><p>Para permitir que desde la red DMZ podamos hacer ping hacia Odin crearemos la siguiente regla :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329171345.png alt></p><p>Vamos a comprobar que desde la DMZ podemos hacer el ping a Odin :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@hela:~$ ping 192.168.100.2 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.100.2 <span style=color:#f92672>(</span>192.168.100.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>2.38 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.100.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 2.379/2.379/2.379/0.000 ms
</span></span></code></pre></div><p>Como vemos la regla esta funcionando , así que vamos a comprobar los hits :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329171520.png alt></p><p>Por el mismo motivo que en el ejercicio anterior , desde la red LAN no podemos limitar el ping hacia Odin ya que no pasa por el cortafuegos si no por el switch .</p><p>Algo parecido nos pasara desde la WAN , al ser un ping dirigido a la IP de la interfaz este se desactiva desde la configuración de la misma , siempre se rechaza de manera silenciosa pero no da opción a elegirlo :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329172526.png alt></p><p>Una vez eliminado</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~$ ping 192.168.122.77 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.122.77 <span style=color:#f92672>(</span>192.168.122.77<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.122.77 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>0</span> received, 100% packet loss, time 0ms
</span></span></code></pre></div><h3 id=la-máquina-odin-puede-hacer-ping-a-la-lan-la-dmz-y-al-exterior>La máquina Odin puede hacer ping a la LAN, la DMZ y al exterior.</h3><p>La maquina Odin por la propia topologia puede hacerle ping a todas las maquinas de la LAN ya que el trafico hacia esta red pasa por el swicht .</p><p>Para que pueda hacer ping hacia la DMZ y a la WAN vamos a crear dos reglas :</p><p>La regla para la WAN :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329172816.png alt></p><p>La regla para la DMZ :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329172903.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># LAN --&gt; WAN</span>
</span></span><span style=display:flex><span>osboxes@odin:~$ ping 8.8.8.8 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 8.8.8.8 <span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 8.8.8.8: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>114</span> time<span style=color:#f92672>=</span>10.1 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 8.8.8.8 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 10.088/10.088/10.088/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># LAN --&gt; DMZ</span>
</span></span><span style=display:flex><span>osboxes@odin:~$ ping 192.168.200.2 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.200.2 <span style=color:#f92672>(</span>192.168.200.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.200.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>0.804 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.200.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.804/0.804/0.804/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># LAN --&gt; LAN (No interviene el cortafuegos)</span>
</span></span><span style=display:flex><span>osboxes@odin:~$ ping 192.168.100.3 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.100.3 <span style=color:#f92672>(</span>192.168.100.3<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.3: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.503 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.100.3 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.503/0.503/0.503/0.000 ms
</span></span></code></pre></div><p>Vamos a comprobar los hits de las dos reglas que acabamos de crear :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329173231.png alt></p><h3 id=desde-la-máquina-hela-se-puede-hacer-ping-y-conexión-ssh-a-las-máquinas-de-la-lan>Desde la máquina Hela se puede hacer ping y conexión ssh a las máquinas de la LAN.</h3><p>Para lograr esto creare la siguiente regla . Podríamos separarla en 2 reglas independientes para tener los contadores por separado , pero en este caso no es importante distinguir el trafico .</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329173630.png alt></p><p>Vamos a comprobar la regla , haciendo un ping a las distintas maquinas de la red LAN , ya que anteriormente había una regla para permitir todos los pings hacia Odin :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># HELA --&gt; ODIN</span>
</span></span><span style=display:flex><span>debian@hela:~$ ping 192.168.100.2 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.100.2 <span style=color:#f92672>(</span>192.168.100.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>1.10 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.100.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 1.101/1.101/1.101/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># HELA --&gt; LOKI</span>
</span></span><span style=display:flex><span>debian@hela:~$ ping 192.168.100.3 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.100.3 <span style=color:#f92672>(</span>192.168.100.3<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.3: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>1.73 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.100.3 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 1.730/1.730/1.730/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># HELA --&gt; THOR</span>
</span></span><span style=display:flex><span>debian@hela:~$ ping 192.168.100.4 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.100.4 <span style=color:#f92672>(</span>192.168.100.4<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.4: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>0.998 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.100.4 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.998/0.998/0.998/0.000 ms
</span></span></code></pre></div><p>Ahora vamos a comprobar que podemos conectarnos por ssh desde Hela a la LAN :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@hela:~$ ssh osboxes@192.168.100.2 <span style=color:#e6db74>&#39;hostname -f&#39;</span>
</span></span><span style=display:flex><span>osboxes@192.168.100.2<span style=color:#e6db74>&#39;s password: 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>odin.javiercd.gonzalonazareno.org
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>debian@hela:~$ ssh 192.168.100.3 &#39;</span>hostname -f<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>debian@192.168.100.3&#39;</span>s password: 
</span></span><span style=display:flex><span>loki.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>debian@hela:~$ ssh 192.168.100.4 <span style=color:#e6db74>&#39;hostname -f&#39;</span>
</span></span><span style=display:flex><span>debian@192.168.100.4<span style=color:#960050;background-color:#1e0010>&#39;</span>s password: 
</span></span><span style=display:flex><span>thor.javiercd.gonzalonazareno.org
</span></span></code></pre></div><p>La regla funciona correctamente , vamos a comprobar que ha subido los hits :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329174824.png alt></p><h3 id=desde-cualquier-máquina-de-la-lan-se-puede-conectar-por-ssh-a-la-máquina-hela>Desde cualquier máquina de la LAN se puede conectar por ssh a la máquina Hela.</h3><p>Para ello vamos a crear la siguiente regla :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329175356.png alt></p><p>Ahora vamos a comprobar la regla que acabamos de crear :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>osboxes@odin:~$ ssh debian@192.168.200.2 <span style=color:#e6db74>&#39;hostname -f&#39;</span>
</span></span><span style=display:flex><span>debian@192.168.200.2<span style=color:#e6db74>&#39;s password: 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>hela.javiercd.gonzalonazareno.org
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>debian@loki:~$ ssh 192.168.200.2 &#39;</span>hostname -f<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>debian@192.168.200.2&#39;</span>s password: 
</span></span><span style=display:flex><span>hela.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>debian@thor:~$ ssh 192.168.200.2 <span style=color:#e6db74>&#39;hostname -f&#39;</span>
</span></span><span style=display:flex><span>debian@192.168.200.2<span style=color:#960050;background-color:#1e0010>&#39;</span>s password: 
</span></span><span style=display:flex><span>hela.javiercd.gonzalonazareno.org
</span></span></code></pre></div><p>Vamos a comprobar que los hits de la regla han subido :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329175844.png alt></p><h3 id=configura-la-máquina-odin-para-que-las-máquinas-de-lan-y-dmz-puedan-acceder-al-exterior>Configura la máquina Odin para que las máquinas de LAN y DMZ puedan acceder al exterior.</h3><p>El SNAT en este dispositivo podemos elegir activarlo por cada regla y no en general . Si te has fijado a lo largo de la practica en todas las reglas que implica dar un salto de interfaz he marcado la casilla NAT :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329180159.png alt></p><p>Por lo que este apartado se va a ir realizando a lo largo de la practica conforme creemos las reglas .</p><h3 id=las-máquinas-de-la-lan-pueden-hacer-ping-al-exterior-y-navegar>Las máquinas de la LAN pueden hacer ping al exterior y navegar.</h3><p>Vamos a tener que crear 3 reglas :</p><ul><li>Permitir el trafico HTTP/HTTPS</li><li>Permitir las consultas DNS</li><li>Permitir hacer ping</li></ul><p>De estas tres reglas las dos primeras están creadas con anterioridad :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329184029.png alt></p><p>Por lo que solo nos queda añadir la regla del ping , que seria la siguiente :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329184222.png alt></p><p>Como tengo una versión de prueba puedo tener como máximo 10 entradas , así que voy a eliminar la que solo deja hacer ping al exterior a Odin .</p><p>Vamos a comprobar las reglas , desde un cliente de la red LAN:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>osboxes@odin:~$ dig @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.1-1ubuntu1-Ubuntu &lt;&lt;&gt;&gt; @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>; <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> server found<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#e6db74>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#ae81ff>25764</span>
</span></span><span style=display:flex><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;www.javiercd.es.		IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>www.javiercd.es.	3600	IN	CNAME	javierasping.github.io.
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.108.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.109.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.110.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.111.153
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#ae81ff>60</span> msec
</span></span><span style=display:flex><span>;; SERVER: 8.8.8.8#53<span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>UDP<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; WHEN: Fri Mar <span style=color:#ae81ff>29</span> 13:44:50 EDT <span style=color:#ae81ff>2024</span>
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: <span style=color:#ae81ff>144</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>osboxes@odin:~$ ping -c <span style=color:#ae81ff>1</span> www.javiercd.es
</span></span><span style=display:flex><span>PING javierasping.github.io <span style=color:#f92672>(</span>185.199.108.153<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from cdn-185-199-108-153.github.com <span style=color:#f92672>(</span>185.199.108.153<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>55</span> time<span style=color:#f92672>=</span>11.1 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- javierasping.github.io ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 11.111/11.111/11.111/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>osboxes@odin:~$ curl -I  https://www.javiercd.es/
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span> 
</span></span><span style=display:flex><span>server: GitHub.com
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>last-modified: Mon, <span style=color:#ae81ff>11</span> Mar <span style=color:#ae81ff>2024</span> 23:21:37 GMT
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>31556952</span>
</span></span><span style=display:flex><span>etag: <span style=color:#e6db74>&#34;65ef9201-6878&#34;</span>
</span></span><span style=display:flex><span>expires: Fri, <span style=color:#ae81ff>29</span> Mar <span style=color:#ae81ff>2024</span> 17:56:01 GMT
</span></span><span style=display:flex><span>cache-control: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>x-proxy-cache: MISS
</span></span><span style=display:flex><span>x-github-request-id: AE88:3308D5:438AA74:448F970:6606FE58
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>date: Fri, <span style=color:#ae81ff>29</span> Mar <span style=color:#ae81ff>2024</span> 17:46:01 GMT
</span></span><span style=display:flex><span>via: 1.1 varnish
</span></span><span style=display:flex><span>age: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>x-served-by: cache-mad2200143-MAD
</span></span><span style=display:flex><span>x-cache: MISS
</span></span><span style=display:flex><span>x-cache-hits: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>x-timer: S1711734362.862201,VS0,VE134
</span></span><span style=display:flex><span>vary: Accept-Encoding
</span></span><span style=display:flex><span>x-fastly-request-id: 16b6048f2b032ef4b4293c52f0ae36d19b0e0da0
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>26744</span>
</span></span></code></pre></div><p>Así quedarían nuestras tres reglas , veremos que tenemos hits en las mismas :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329184410.png alt></p><h3 id=la-máquina-hela-puede-navegar-instala-un-servidor-web-un-servidor-ftp-y-un-servidor-de-correos-si-no-los-tienes-aún>La máquina Hela puede navegar. Instala un servidor web, un servidor ftp y un servidor de correos si no los tienes aún.</h3><p>Para realizar esto es necesario tener permitido el DNS y la navegación . Para ello he creado la siguiente regla :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329184830.png alt></p><p>La he creado en una sola regla para ahorrar en el numero de las mismas , he borrado las que permitía el ping desde DMZ a LAN de ejercicios anteriores .</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@hela:~$ sudo apt install proftpd postfix apache2 -y
</span></span></code></pre></div><h3 id=configura-la-máquina-odin-para-que-los-servicios-web-y-ftp-sean-accesibles-desde-el-exterior>Configura la máquina Odin para que los servicios web y ftp sean accesibles desde el exterior.</h3><p>Para hacer el DNAT deberemos de crear 2 IPs virtuales , como hicimos en cortafuegos I .</p><p>Una para cada servicio que queramos hacer un DNAT . Para el servidor web :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329190416.png alt></p><p>Y para el servidor FTP :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329190509.png alt></p><p>Ahora vamos a crear la propia regla de DNAT para el servidor web , en la cual como destino indicamos la IP virtual que acabamos de crear :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329191130.png alt></p><p>Veremos que si accedemos a la IP del cortafuegos de la WAN accederemos al apache de Hela :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329191232.png alt></p><p>También crearemos la regla DNAT para el servidor FTP :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329191852.png alt></p><p>Vamos a comprobar el acceso al servidor ftp :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~$ ftp debian@192.168.122.77
</span></span><span style=display:flex><span>Connected to 192.168.122.77.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> ProFTPD Server <span style=color:#f92672>(</span>Debian<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>::ffff:192.168.200.2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>331</span> Password required <span style=color:#66d9ef>for</span> debian
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span><span style=color:#ae81ff>230</span> User debian logged in
</span></span><span style=display:flex><span>Remote system type is UNIX.
</span></span><span style=display:flex><span>Using binary mode to transfer files.
</span></span><span style=display:flex><span>ftp&gt;
</span></span></code></pre></div><p>Si comprobamos los hits de las reglas veremos que en ambas ha subido :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329192338.png alt></p><h3 id=el-servidor-web-y-el-servidor-ftp-deben-ser-accesibles-desde-la-lan-y-desde-el-exterior>El servidor web y el servidor ftp deben ser accesibles desde la LAN y desde el exterior.</h3><p>Para realizar este ejercicio deberemos de volver a generar las 2 IPs virtuales pero ahora indicaremos la IP de la tarjeta LAN del firewall .</p><p>Para el DNAT del servidor web :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329192709.png alt></p><p>Repetiremos lo mismo para el servicio FTP , cambiando el servicio :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329192818.png alt></p><p>Ahora crearemos las 2 reglas de DNAT para permitir el acceso desde la LAN .</p><p>Para el servidor web :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193041.png alt></p><p>Para el servidor FTP:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193132.png alt></p><p>Vamos a comprobar que podemos acceder a ambos servicios :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>osboxes@odin:~$ curl -I  http://192.168.100.1
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Date: Fri, <span style=color:#ae81ff>29</span> Mar <span style=color:#ae81ff>2024</span> 18:31:59 GMT
</span></span><span style=display:flex><span>Server: Apache/2.4.57 <span style=color:#f92672>(</span>Debian<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Last-Modified: Fri, <span style=color:#ae81ff>29</span> Mar <span style=color:#ae81ff>2024</span> 17:53:38 GMT
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;29cd-614d051d4d640&#34;</span>
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>10701</span>
</span></span><span style=display:flex><span>Vary: Accept-Encoding
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>osboxes@odin:~$ ftp debian@192.168.100.1
</span></span><span style=display:flex><span>Connected to 192.168.100.1.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> ProFTPD Server <span style=color:#f92672>(</span>Debian<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>::ffff:192.168.200.2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>331</span> Password required <span style=color:#66d9ef>for</span> debian
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span><span style=color:#ae81ff>230</span> User debian logged in
</span></span><span style=display:flex><span>Remote system type is UNIX.
</span></span><span style=display:flex><span>Using binary mode to transfer files.
</span></span></code></pre></div><p>Vamos a comprobar que han subido los hits en las reglas :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193324.png alt></p><h3 id=el-servidor-de-correos-sólo-debe-ser-accesible-desde-la-lan>El servidor de correos sólo debe ser accesible desde la LAN.</h3><p>Volvemos a repetir los mismos pasos , le crearemos una IP virtual para poder hacer la regla de DNAT :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193427.png alt></p><p>Ahora vamos a crear la regla de DNAT :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193724.png alt></p><p>Y comprobaremos que desde un PC de la LAN haciendo un telnet llegamos al servidor de correos :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>osboxes@odin:~$ telnet 192.168.100.1 <span style=color:#ae81ff>25</span>
</span></span><span style=display:flex><span>Trying 192.168.100.1...
</span></span><span style=display:flex><span>Connected to 192.168.100.1.
</span></span><span style=display:flex><span>Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> hela.javiercd.gonzalonazareno.org ESMTP Postfix <span style=color:#f92672>(</span>Debian/GNU<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>quit
</span></span><span style=display:flex><span><span style=color:#ae81ff>221</span> 2.0.0 Bye
</span></span><span style=display:flex><span>Connection closed by foreign host.
</span></span></code></pre></div><p>Veremos que el hit de la regla ha subido :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193822.png alt></p><h3 id=en-la-máquina-loki-instala-un-servidor-postgres-si-no-lo-tiene-aún-a-este-servidor-se-puede-acceder-desde-la-dmz-pero-no-desde-el-exterior>En la máquina Loki instala un servidor Postgres si no lo tiene aún. A este servidor se puede acceder desde la DMZ, pero no desde el exterior.</h3><p>Volveremos a repetir el proceso de crear una nueva IP virtual para este servicio . Ademas en este caso he tenido que crear el servicio ya que no existía .</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329195211.png alt></p><p>Vamos a crear la regla de DNAT :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329200331.png alt></p><p>Vamos a comprobar que tenemos acceso al servidor pgsql desde la red DMZ :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@hela:~$ psql -h 192.168.200.1 -U postgres -W
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span>psql <span style=color:#f92672>(</span>15.6 <span style=color:#f92672>(</span>Debian 15.6-0+deb12u1<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>SSL connection <span style=color:#f92672>(</span>protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> help.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres<span style=color:#f92672>=</span><span style=color:#75715e># \q</span>
</span></span></code></pre></div><p>Comprobaremos que la regla tiene hits :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329200721.png alt></p><h3 id=evita-ataques-dos-por-icmp-flood-limitando-a-4-el-número-de-peticiones-por-segundo-desde-una-misma-ip>Evita ataques DoS por ICMP Flood, limitando a 4 el número de peticiones por segundo desde una misma IP.</h3><p>Dentro del apartado de políticas y objetos , encontramos un apartado para crear políticas para DoS . En mi caso he creado una con los valores recomendados que da el fabricante . Y he cambiado el limite de ICMP Flood a 4 paquetes por segundo .</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329203201.png alt></p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329203221.png alt></p><p>Vamos a comprobar que nos bloquea el trafico si excedemos ese limite . Con este comando estamos enviando 3 paquetes por segundo que es inferior al limite establecido asi que no cortara ningún paquete :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@loki:~$ sudo hping3 --icmp  -i u333333 -V 192.168.100.1
</span></span><span style=display:flex><span>--- 192.168.100.1 hping statistic ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>124</span> packets transmitted, <span style=color:#ae81ff>124</span> packets received, 0% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max <span style=color:#f92672>=</span> 0.7/5.3/9.9 ms
</span></span></code></pre></div><p>Si aumentamos los de paquetes por segundos , bloqueara todos los paquetes que superen a 4 por segundo , por eso deja pasar los 4 primeros de cada segundo :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@loki:~$ sudo hping3 --icmp  -i u200000 -V 192.168.100.1
</span></span><span style=display:flex><span>--- 192.168.100.1 hping statistic ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>44</span> packets transmitted, <span style=color:#ae81ff>10</span> packets received, 78% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max <span style=color:#f92672>=</span> 4.6/5.5/6.5 ms
</span></span></code></pre></div><p>El cortafuegos ha registrado como una anomalía el trafico que ha tirado :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329224119.png alt></p><h3 id=evita-ataques-dos-por-syn-flood>Evita ataques DoS por SYN Flood.</h3><p>Con el filtro que hemos activado en el ejercicio anterior tenemos limitada las peticiones TCP a 2000 por minuto desde la misma IP para evitar este tipo de ataque . Vemos que el filtro elimina las peticiones maliciosas y no deja que el ataque tenga efecto :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@loki:~$ sudo hping3 --flood --rand-source -V 192.168.100.1
</span></span><span style=display:flex><span>using ens3, addr: 192.168.100.3, MTU: <span style=color:#ae81ff>1500</span>
</span></span><span style=display:flex><span>HPING 192.168.100.1 <span style=color:#f92672>(</span>ens3 192.168.100.1<span style=color:#f92672>)</span>: NO FLAGS are set, <span style=color:#ae81ff>40</span> headers + <span style=color:#ae81ff>0</span> data bytes
</span></span><span style=display:flex><span>hping in flood mode, no replies will be shown
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 192.168.100.1 hping statistic ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>930716</span> packets transmitted, <span style=color:#ae81ff>0</span> packets received, 100% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max <span style=color:#f92672>=</span> 0.0/0.0/0.0 ms
</span></span></code></pre></div><h3 id=evita-que-realicen-escaneos-de-puertos-a-odin>Evita que realicen escaneos de puertos a Odin.</h3><p>En lugar de hacerlo a Odin por la propia topologia vamos a hacerlo para evitar escaneos desde la WAN .</p><p>Para ello nos abrimos una terminal y lo que vamos a hacer es crear una firma de IPS para evitar los paquetes con una determinada bandera que usa un escaneo determinado . En este caso vamos a evitar el escaneo de NMAP XMAS .</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>FTG <span style=color:#75715e># config ips custom</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FTG <span style=color:#f92672>(</span>custom<span style=color:#f92672>)</span> <span style=color:#75715e># edit &#34;Block_xmas&#34;</span>
</span></span><span style=display:flex><span>new entry <span style=color:#e6db74>&#39;Block_xmas&#39;</span> added
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FTG <span style=color:#f92672>(</span>Block_xmas<span style=color:#f92672>)</span> <span style=color:#75715e># set signature &#34;F-SBID(--name &#39;Block_xmas&#39;; --protocol tcp; --flow from_client; --tcp_flags *FUP; )&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FTG <span style=color:#f92672>(</span>Block_xmas<span style=color:#f92672>)</span> <span style=color:#75715e># set action block</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FTG <span style=color:#f92672>(</span>Block_xmas<span style=color:#f92672>)</span> <span style=color:#75715e>#  end</span>
</span></span></code></pre></div><p>Una vez configurado nos aparecera la regla que hemos creado en IPs signatures :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330185917.png alt></p><p>Ahora vamos a crear una regla IPS para asociarla con esta politica de firmas :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330190210.png alt></p><p>Añadiremos en IPS signatures and filters , el nuevo filtro que hemos creado anteriormente :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330190138.png alt></p><p>A continuación en las reglas de DNAT donde queramos controlar que no sepan que puertos tenemos abiertos , asignaremos la nueva política IPS :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330190438.png alt></p><p>En mi caso vamos a probarlo para la regla DNAT de ssh :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330190507.png alt></p><p>Si lanzo el NMAP desde mi host que esta en la red WAN , vemos que el puerto 2222 que es el que esta regla tiene abierto no lo detecta :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~$ sudo nmap -sX 192.168.122.77
</span></span><span style=display:flex><span>Starting Nmap 7.93 <span style=color:#f92672>(</span> https://nmap.org <span style=color:#f92672>)</span> at 2024-03-30 19:05 CET
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#66d9ef>for</span> 192.168.122.77
</span></span><span style=display:flex><span>Host is up <span style=color:#f92672>(</span>0.00059s latency<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>All <span style=color:#ae81ff>1000</span> scanned ports on 192.168.122.77 are in ignored states.
</span></span><span style=display:flex><span>Not shown: <span style=color:#ae81ff>1000</span> open|filtered tcp ports <span style=color:#f92672>(</span>no-response<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>MAC Address: 0C:18:45:93:00:00 <span style=color:#f92672>(</span>Unknown<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Nmap <span style=color:#66d9ef>done</span>: <span style=color:#ae81ff>1</span> IP address <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> host up<span style=color:#f92672>)</span> scanned in 21.28 seconds
</span></span></code></pre></div><p>Y el propio cortafuegos nos avisara de que ha habido un escaneo de puertos que ha bloqueado , para ver esto dirígete a Log & Report > Intrusion prevention :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330191024.png alt></p><p>Podemos seleccionarlo para ver mas detalles del mismo :</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330191131.png alt>
<img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330191146.png alt></p></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Compartir en:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f&text=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Fortinet%20II&via=Atlas" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f&title=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Fortinet%20II" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f&title=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Fortinet%20II" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Fortinet%20II https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=Implementaci%c3%b3n%20de%20un%20cortafuegos%20perimetral%20con%20Fortinet%20II&body=https%3a%2f%2fwww.javiercd.es%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/javierasping/sentinel/edit/main/content/posts/cortafuegos/fortinet_dos/fortinet_dos.md title="Mejorar esta página" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Mejorar esta página</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Contenido</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#preparación-del-escenario>Preparación del escenario</a></li><li><a href=#reglas-del-cortafuegos>Reglas del cortafuegos</a><ul><li><a href=#desde-thor-y-hela-se-debe-permitir-la-conexión-ssh-por-el-puerto-22-a-la-máquina-odin>Desde Thor y Hela se debe permitir la conexión ssh por el puerto 22 a la máquina Odin.</a></li><li><a href=#a-la-máquina-odin-se-le-puede-hacer-ping-desde-la-dmz-pero-desde-la-lan-se-le-debe-rechazar-la-conexión-reject-y-desde-el-exterior-se-rechazará-de-manera-silenciosa>A la máquina Odin se le puede hacer ping desde la DMZ, pero desde la LAN se le debe rechazar la conexión (REJECT) y desde el exterior se rechazará de manera silenciosa.</a></li><li><a href=#la-máquina-odin-puede-hacer-ping-a-la-lan-la-dmz-y-al-exterior>La máquina Odin puede hacer ping a la LAN, la DMZ y al exterior.</a></li><li><a href=#desde-la-máquina-hela-se-puede-hacer-ping-y-conexión-ssh-a-las-máquinas-de-la-lan>Desde la máquina Hela se puede hacer ping y conexión ssh a las máquinas de la LAN.</a></li><li><a href=#desde-cualquier-máquina-de-la-lan-se-puede-conectar-por-ssh-a-la-máquina-hela>Desde cualquier máquina de la LAN se puede conectar por ssh a la máquina Hela.</a></li><li><a href=#configura-la-máquina-odin-para-que-las-máquinas-de-lan-y-dmz-puedan-acceder-al-exterior>Configura la máquina Odin para que las máquinas de LAN y DMZ puedan acceder al exterior.</a></li><li><a href=#las-máquinas-de-la-lan-pueden-hacer-ping-al-exterior-y-navegar>Las máquinas de la LAN pueden hacer ping al exterior y navegar.</a></li><li><a href=#la-máquina-hela-puede-navegar-instala-un-servidor-web-un-servidor-ftp-y-un-servidor-de-correos-si-no-los-tienes-aún>La máquina Hela puede navegar. Instala un servidor web, un servidor ftp y un servidor de correos si no los tienes aún.</a></li><li><a href=#configura-la-máquina-odin-para-que-los-servicios-web-y-ftp-sean-accesibles-desde-el-exterior>Configura la máquina Odin para que los servicios web y ftp sean accesibles desde el exterior.</a></li><li><a href=#el-servidor-web-y-el-servidor-ftp-deben-ser-accesibles-desde-la-lan-y-desde-el-exterior>El servidor web y el servidor ftp deben ser accesibles desde la LAN y desde el exterior.</a></li><li><a href=#el-servidor-de-correos-sólo-debe-ser-accesible-desde-la-lan>El servidor de correos sólo debe ser accesible desde la LAN.</a></li><li><a href=#en-la-máquina-loki-instala-un-servidor-postgres-si-no-lo-tiene-aún-a-este-servidor-se-puede-acceder-desde-la-dmz-pero-no-desde-el-exterior>En la máquina Loki instala un servidor Postgres si no lo tiene aún. A este servidor se puede acceder desde la DMZ, pero no desde el exterior.</a></li><li><a href=#evita-ataques-dos-por-icmp-flood-limitando-a-4-el-número-de-peticiones-por-segundo-desde-una-misma-ip>Evita ataques DoS por ICMP Flood, limitando a 4 el número de peticiones por segundo desde una misma IP.</a></li><li><a href=#evita-ataques-dos-por-syn-flood>Evita ataques DoS por SYN Flood.</a></li><li><a href=#evita-que-realicen-escaneos-de-puertos-a-odin>Evita que realicen escaneos de puertos a Odin.</a></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navegación</h5><ul><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#about>Sobre mi</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#skills>Competencias</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#education>Educación</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#recent-posts>Últimas publicaciones</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#accomplishments>Certificaciones</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contacto</h5><ul><li><a href=mailto:contacto@javiercd.es target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>contacto@javiercd.es</span></a></li><li><a href=https://github.com/javierasping target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>javierasping</span></a></li><li><a href=https://www.linkedin.com/in/javiercd target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Francisco Javier Cruces Doval</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>Aviso de responsabilidad:</strong> This theme is under MIT license. So, you can use it for non-commercial, commercial, or private uses. You can modify or distribute the theme without requiring any permission from the theme author. However, the theme author does not provide any warranty or takes any liability for any issue with the theme.</p></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu_b3360284c55cf72d.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2023 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Funcionando con
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.b6e81adc7ec7b607dcd44cb550d5ac0e8aa374ad64c95daf8eddf470660f2331.js integrity="sha256-tuga3H7Htgfc1Ey1UNWsDoqjdK1kyV2vjt30cGYPIzE=" defer></script></body></html>