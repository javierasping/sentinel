<!doctype html><html lang=es><head><title>Configuración de NAT Cisco y Linux</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.40fc48e109c6199ac2893db3e37c6449ab0909ee7da5dae161d1b66f51c63897.css integrity="sha256-QPxI4QnGGZrCiT2z43xkSasJCe59pdrhYdG2b1HGOJc="><link rel=icon type=image/png href=/images/site/avatar_hu11723030549170604370.jpg><meta property="og:url" content="https://www.javiercd.es/posts/redes/configuracion_de_nat/configuracion_de_nat/"><meta property="og:site_name" content="Atlas"><meta property="og:title" content="Configuración de NAT Cisco y Linux"><meta property="og:description" content="Enrutamiento de un escenario con direcciones publicas , configuramos SNAT y DNAT en maquinas Linux y cisco ."><meta property="og:locale" content="es"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-08T10:00:00+00:00"><meta property="article:modified_time" content="2023-09-08T10:00:00+00:00"><meta property="article:tag" content="Redes"><meta property="article:tag" content="Enrutamiento"><meta property="article:tag" content="NAT"><meta property="article:tag" content="SNAT"><meta property="article:tag" content="DNAT"><meta property="article:tag" content="CISCO"><meta name=twitter:card content="summary"><meta name=twitter:title content="Configuración de NAT Cisco y Linux"><meta name=twitter:description content="Enrutamiento de un escenario con direcciones publicas , configuramos SNAT y DNAT en maquinas Linux y cisco ."><meta name=description content="Enrutamiento de un escenario con direcciones publicas , configuramos SNAT y DNAT en maquinas Linux y cisco ."><script>theme=localStorage.getItem("darkmode:color-scheme")||"system",theme=="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/masthead_hu12155983672104127805.png id=logo alt=Logo>
Atlas</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>Inicio</a></li><li class=nav-item><a class=nav-link href=/#about>Sobre mi</a></li><li class=nav-item><a class=nav-link href=/#skills>Competencias</a></li><li class=nav-item><a class=nav-link href=/#education>Educación</a></li><li class=nav-item><a class=nav-link href=/#recent-posts>Últimas publicaciones</a></li><li class=nav-item><a class=nav-link href=/#accomplishments>Certificaciones</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/masthead_hu12155983672104127805.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/masthead_hu12155983672104127805.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Búsqueda data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/posts/iaw/> Aplicaciones webs</a><ul><li><a class=list-link href=/posts/iaw/lamp/ title="Instalación pila LAMP">Instalación pila LAMP</a></li><li><a class=list-link href=/posts/iaw/lemp/ title="Instalación pila LEMP">Instalación pila LEMP</a></li><li><a class=list-link href=/posts/iaw/wordpress/ title="Wordpress LAMP">Wordpress LAMP</a></li><li><a class=list-link href=/posts/iaw/wordpress_lemp/ title="Wordpress LEMP">Wordpress LEMP</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/cortafuegos/> Cortafuegos</a><ul><li><a class=list-link href=/posts/cortafuegos/fortinet_cli/ title="Fortinet CLI">Fortinet CLI</a></li><li><a class=list-link href=/posts/cortafuegos/fortinet_uno/ title="Perimetral con Fortinet I">Perimetral con Fortinet I</a></li><li><a class=list-link href=/posts/cortafuegos/fortinet_dos/ title="Perimetral con Fortinet II">Perimetral con Fortinet II</a></li><li><a class=list-link href=/posts/cortafuegos/nftables_uno/ title="Perimetral con Nftables I">Perimetral con Nftables I</a></li><li><a class=list-link href=/posts/cortafuegos/nftables_dos/ title="Perimetral con Nftables II">Perimetral con Nftables II</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/drivers/> Drivers Linux</a><ul><li><a class=list-link href=/posts/drivers/nvidia_optimus/ title="Como elegir que gráfica usar en mi portátil con Linux">Como elegir que gráfica usar en mi portátil con Linux</a></li><li><a class=list-link href=/posts/drivers/nvidia_driver/ title="Drivers Nvidia">Drivers Nvidia</a></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/posts/redes/> Redes</a><ul class=active><li><a class=list-link href=/posts/redes/android_gns3/ title="Android GNS3-KVM">Android GNS3-KVM</a></li><li><a class=list-link href=/posts/redes/comandos_de_supervision_de_redes/ title="Comandos de supervisión de redes">Comandos de supervisión de redes</a></li><li><a class=list-link href=/posts/redes/switches_gns3/ title="Configuración de switches en GNS3">Configuración de switches en GNS3</a></li><li><a class=list-link href=/posts/redes/enroutamiento_openstack/ title="Enrutamiento en OpenStack">Enrutamiento en OpenStack</a></li><li><a class=list-link href=/posts/redes/escenario_ipv6_basico/ title="Escenario IPv6 Básico">Escenario IPv6 Básico</a></li><li><a class=list-link href=/posts/redes/instalacion_wireshark_gns3/ title="Instalacion GNS y Wireshark">Instalacion GNS y Wireshark</a></li><li><a class="active list-link" href=/posts/redes/configuracion_de_nat/ title="NAT en Cisco y Linux">NAT en Cisco y Linux</a></li><li><a class=list-link href=/posts/redes/arp/ title="Protocolo ARP">Protocolo ARP</a></li><li><a class=list-link href=/posts/redes/tuneles_ipv6/ title="Túneles IPV6">Túneles IPV6</a></li><li><a class=list-link href=/posts/redes/underworld/ title=Underworld>Underworld</a></li><li><a class=list-link href=/posts/redes/underworld_evolution/ title="Underworld evolution">Underworld evolution</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/seguridad/> Seguridad</a><ul><li><a class=list-link href=/posts/seguridad/https_autofirmado/ title=HTTPS>HTTPS</a></li><li><a class=list-link href=/posts/seguridad/forense/ title="Informática forense">Informática forense</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/servicios/> Servicios</a><ul><li><a class=list-link href=/posts/servicios/apache/ title=Apache>Apache</a></li><li><a class=list-link href=/posts/servicios/dhcp/ title=DHCP>DHCP</a></li><li><a class=list-link href=/posts/servicios/dns/ title=DNS>DNS</a></li><li><a class=list-link href=/posts/servicios/ftp/ title=FTP>FTP</a></li><li><a class=list-link href=/posts/servicios/nat_iptables/ title="NAT con iptables">NAT con iptables</a></li><li><a class=list-link href=/posts/servicios/ssh/ title=SSH>SSH</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/sistemas/> Sistemas</a><ul><li><a class=list-link href=/posts/sistemas/ad_ubuntu/ title="Active Directory en Ubuntu">Active Directory en Ubuntu</a></li><li><a class=list-link href=/posts/sistemas/comparticion_de_directorios_en_windows/ title="Compartir recursos en Windows">Compartir recursos en Windows</a></li><li><a class=list-link href=/posts/sistemas/compilacion_de_un_kernel/ title="Compilación de un kernel">Compilación de un kernel</a></li><li><a class=list-link href=/posts/sistemas/compilacion_de_un_programa_en_c_utilizando_un_makefile/ title="Compilación de un programa en C utilizando un Makefile">Compilación de un programa en C utilizando un Makefile</a></li><li><a class=list-link href=/posts/sistemas/activacion_selinux/ title="Configuración activación de SELinux">Configuración activación de SELinux</a></li><li><a class=list-link href=/posts/sistemas/creacion_de_un_sistema_automatizado_de_instalaci%C3%B3n/ title="Creación de un sistema automatizado de instalación">Creación de un sistema automatizado de instalación</a></li><li><a class=list-link href=/posts/sistemas/ejercicios_de_manejo_de_modulos/ title="Ejercicios de manejo de módulos">Ejercicios de manejo de módulos</a></li><li><a class=list-link href=/posts/sistemas/ejercicios_de_modificacion_de_parametros_del_kernel/ title="Ejercicios de modificación de parámetros del kernel">Ejercicios de modificación de parámetros del kernel</a></li><li><a class=list-link href=/posts/sistemas/ejercicios_gestion_de_paqueteria/ title="Ejercicios gestión de paquetería">Ejercicios gestión de paquetería</a></li><li><a class=list-link href=/posts/sistemas/eliminacion_systemd/ title="Eliminación de systemd">Eliminación de systemd</a></li><li><a class=list-link href=/posts/sistemas/empaquetadores_compresores/ title="Empaquetadores y compresores">Empaquetadores y compresores</a></li><li><a class=list-link href=/posts/sistemas/gestion_de_paquetes/ title="Gestión de paquetes">Gestión de paquetes</a></li><li><a class=list-link href=/posts/sistemas/samba_debian/ title="Instalar y configurar samba en Debian">Instalar y configurar samba en Debian</a></li><li><a class=list-link href=/posts/sistemas/nfs_debian/ title="NFS en Debian">NFS en Debian</a></li><li><a class=list-link href=/posts/sistemas/paso_de_centos_stream_8_a_centos_stream_9/ title="Paso de CentOS stream 8 a CentOS stream 9">Paso de CentOS stream 8 a CentOS stream 9</a></li><li><a class=list-link href=/posts/sistemas/comandos_procesos/ title="Procesos en Linux">Procesos en Linux</a></li><li><a class=list-link href=/posts/sistemas/programacion_tareas/ title="Programación de tareas">Programación de tareas</a></li><li><a class=list-link href=/posts/sistemas/recoleccion_logs_journald/ title="Recolección centralizada de logs journald">Recolección centralizada de logs journald</a></li><li><a class=list-link href=/posts/sistemas/ssh_windows/ title="Servicio ssh en Windows">Servicio ssh en Windows</a></li><li><a class=list-link href=/posts/sistemas/migracion_sistema_de_ficheros/ title="Sistema de ficheros">Sistema de ficheros</a></li><li><a class=list-link href=/posts/sistemas/almacenamiento_servidor_independiente/ title="Storage Spaces en Windows Server">Storage Spaces en Windows Server</a></li><li><a class=list-link href=/posts/sistemas/transformaci%C3%B3n_instancia_cloud/ title="Transformación instancia cloud">Transformación instancia cloud</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/vpn/> VPN</a><ul><li><a class=list-link href=/posts/vpn/acceso_remoto_strongswang/ title="Acceso remoto Ipsec StrongSwan">Acceso remoto Ipsec StrongSwan</a></li><li><a class=list-link href=/posts/vpn/acceso_remoto_openvpn/ title="Acceso remoto OpenVPN">Acceso remoto OpenVPN</a></li><li><a class=list-link href=/posts/vpn/acceso_remoto_wireguard/ title="Acceso remoto Wireguard">Acceso remoto Wireguard</a></li><li><a class=list-link href=/posts/vpn/comparativa_ovpn_wire/ title="Comparativa OpenVPN y Wireguard">Comparativa OpenVPN y Wireguard</a></li><li><a class=list-link href=/posts/vpn/ipsec_cisco/ title="Site-to-Site IPsec Cisco">Site-to-Site IPsec Cisco</a></li><li><a class=list-link href=/posts/vpn/site_to_site_fortinet/ title="Site-to-Site IPsec Fortinet">Site-to-Site IPsec Fortinet</a></li><li><a class=list-link href=/posts/vpn/site_to_site_openvpn/ title="Site-to-Site OpenVPN">Site-to-Site OpenVPN</a></li><li><a class=list-link href=/posts/vpn/site_to_site_wireguard/ title="Site-to-Site Wireguard">Site-to-Site Wireguard</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/redes/configuracion_nat/portada.jpg)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/john_hu4933709943860921887.png alt="Author Image"><h5 class=author-name>Francisco Javier Cruces Doval</h5><p class=text-muted>viernes, 8 de septiembre de 2023 | 15 minutos</p></div><div class=title><h1>Configuración de NAT Cisco y Linux</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/tags/redes/ class="btn btn-sm btn-info">Redes</a></li><li class=rounded><a href=/tags/enrutamiento/ class="btn btn-sm btn-info">Enrutamiento</a></li><li class=rounded><a href=/tags/nat/ class="btn btn-sm btn-info">NAT</a></li><li class=rounded><a href=/tags/snat/ class="btn btn-sm btn-info">SNAT</a></li><li class=rounded><a href=/tags/dnat/ class="btn btn-sm btn-info">DNAT</a></li><li class=rounded><a href=/tags/cisco/ class="btn btn-sm btn-info">Cisco</a></li><li class=rounded><a href=/tags/linux/ class="btn btn-sm btn-info">Linux</a></li></ul></div><div class=post-content id=post-content><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")</script><p>En este artículo, exploraremos la configuración de SNAT (Source Network Address Translation) y DNAT (Destination Network Address Translation) en escenarios con direcciones públicas, haciendo uso de routers en entornos Linux y dispositivos Cisco.</p><h2 id=escenario-con-maquinas-debian>Escenario con maquinas debian</h2><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.001.jpeg></p><h3 id=preparación-del-entorno>Preparación del entorno</h3><h4 id=instalación-de-paquetes>Instalación de paquetes</h4><p>Una vez colocadas las maquinas deberemos de descargarnos apache para los servidores web , para realizar esto conectaremos ambos servidores a un switch y este a la nube NAT para disponer de acceso a internet .</p><p>Ahora actualizaremos los repositorios haciendo un apt update :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.002.png></p><p>A continuación ya podremos descargar los paquetes , para los servidores instalaremos apache :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.003.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.004.png></p><p>Y para el router de casa descargaremos el servidor DHCP :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.005.png></p><p>Al acabar la instalación saltara un código de error similar a este , esto es debido a que no hay una configuración valida en el servicio :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.006.jpeg></p><p>Por ahora ignoraremos esto y posteriormente configuraremos el servidor DHCP .</p><p>Con esto habríamos instalado todos los paquetes necesarios para instalar la practica así que podemos montar el escenario .</p><h4 id=configuración-de-las-tarjetas-de-red>Configuración de las tarjetas de red</h4><p>Nos encontraremos con un pequeño obstáculo a la hora de hacer el escenario ya que necesitamos que algunos routers tengan mas de una tarjeta de red .</p><p>Para añadir mas de una tarjeta con el dispositivo apagado y sin estar conectado a nadie , hacemos sobre el clic derecho y pulsamos sobre configure > network , y seleccionamos el numero de adaptadores que necesitamos tener en cada uno , por ejemplo para el router de casa necesito tener dos adaptadores :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.007.jpeg></p><p>Una vez hecho esto con las maquinas que necesitan mas de una tarjeta , montaremos el escenario y procederemos a configurar sus tarjetas .</p><p>Para modificar la configuración de las tarjetas de red lo haremos editando el fichero /etc/network/interfaces .Para que se aplique la configuración de las tarjetas de red que hemos realizado tenemos varias opciones .</p><p>Subir y bajar la tarjeta que hemos modificado :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.008.png></p><p>También podemos ahorrar tiempo y reiniciar el servicio de networking , esto funcionara para todas las tarjetas simultáneamente así que nos ahorrara tiempo :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.009.png></p><p>Router CASA:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.010.jpeg></p><p>Router R1:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.011.jpeg></p><p>Router ISP:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.012.jpeg></p><p>Router R2:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.013.jpeg></p><p>Así seria la relación de ips que tienen las tarjetas de red de los routers . Para aplicar esta configuración a las tarjetas de red tendremos que reiniciar la misma como indico al principio de este apartado .</p><p>Para que el escenario funcione debemos activar el bit de forwarding para estos 4 routers , en este caso lo haré de forma permanente para ello editamos el fichero /etc/sysctl.conf y descomentamos esta linea :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.014.png></p><h4 id=rutas-necesarias>Rutas necesarias</h4><p>Para mi esquema actual las rutas que necesitamos en los routers son :</p><p>Router R1:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.015.png></p><p>Router ISP:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.016.png></p><p>Router R2:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.017.png></p><p>Router CASA:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.018.png></p><h4 id=comprobación-de-conectividad>Comprobación de conectividad</h4><p>Vamos a hacer ping desde cada uno de los routers a su extremos “mas lejanos” para asegurarnos de que hemos realizado correctamente el enrutamiento .</p><p>Router R1 –> R2</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.019.png></p><p>Router R1 –> CASA</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.020.png></p><p>Router R2 –> R1</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.021.png></p><p>Router R2 –> CASA</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.022.png></p><p>Router CASA –> R1</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.023.png></p><p>Router CASA –> R2</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.024.png></p><p>Vemos que todos los dispositivos que tiene direcciónes ips publicas tienen conectividad entre si pero que pasa con los que tienen direcciónamiento privado en nuestro escenario , estos no tendrán conectividad ya que no se enrutan direcciónes privadas en los routers de internet .</p><p>Es decir si lanzamos un ping hacia una dirección privada que sea de otra red , por ejemplo del servidor1 al servidor2 este no llegara , ya que en las tablas de enrutamiento del router del ISP no existen rutas para direcciónes privadas .</p><p>Por lo que sera imposible alcanzar una red privada diferente a la que pertenezcamos .</p><p>Por ejemplo desde casa si le hacemos ping a google se lo hacemos a la dirección PUBLICA 8..8.8.8 no a la dirección privada que tiene el servidor , puede ser la 172.22.1.15</p><h3 id=configuración-del-servicio-dhcp-en-router-casa>Configuración del servicio DHCP en router CASA</h3><p>Retomando lo que habíamos hecho anteriormente en el apartado de instalación de paquetes ya hemos descargado el servidor DHCP para debian (isc-dhcp-server). Así que ahora vamos a configurarlo .</p><p>Lo primero que necesitamos hacer es decirle a nuestro servidor a través de que tarjeta de red queremos que este reparta direcciónes ip , en nuestro caso es la tarjeta ens5 .</p><p>Para ello editaremos el fichero /etc/default/isc-dhcp-server y añadiremos el nombre de la tarjeta en la sección de IPV4 :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.025.jpeg></p><p>Ahora vamos a indicarle a nuestro servidor DHCP que configuración queremos que le asigne a nuestros clientes para ello editamos el fichero /etc/dhcp/dhcpd.conf , podemos aprovechar uno de los ejemplos que vienen comentados y aplicar nuestra configuración :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.026.png></p><p>Este es un ejemplo muy sencillo de un servidor dhcp pero con esto es suficiente para nuestro escenario .</p><p>Los campos significan :</p><ul><li>subnet : dirección de red de la cual queremos repartir direcciónes ip con este servicio .</li><li>netmask : Mascara de red de la red la cual queremos configurar los dispositivos.</li><li>range: Rango de direcciónes de la cual queremos repartir ips siendo la primera la inicial y la ultima la final .</li><li>option routers: Seria la puerta de enlace de nuestra red</li><li>option broadcast-address : dirección de broadcast de nuestra red .</li></ul><p>Una vez configurado con los parámetros de nuestra red reiniciaremos el servicio :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.027.png></p><p>Y comprobaremos que el servicio esta activo :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.028.jpeg></p><p>Ahora para que los clientes puedan recibir una dirección utilizando este servicio deberemos de configurar las tarjetas de red de PC1 y PC2 de la siguiente manera :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.029.png></p><p>Reiniciamos el servicio para que esta se aplique y el servidor nos asigne automáticamente la configuración de red :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.030.png></p><p>Comprobamos que efectivamente nos ha asignado la configuración de la red :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.031.jpeg></p><p>También podemos hacer un seguimiento de a quien le hemos asignado la ip través del servidor viendo el siguiente archivo /var/lib/dhcp/dhcpd.leases el cual guarda las concesiones que hemos realizado .</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.032.png></p><p>Podemos ver cuando empieza así como a quien se le ha asignado viendo su dirección MAC.</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.033.jpeg></p><h3 id=configuración-de-nat>Configuración de NAT</h3><h4 id=router-casa>Router CASA</h4><p>Vamos a configurar el SNAT en el router de casa viendo el esquema actual la regla para hacer esto es :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.034.png></p><p>Sin embargo así se eliminaría cuando reiniciase la maquina así que en este caso voy a añadirla al /etc/network/interfaces :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.035.png></p><p>Así podemos ver que se han aplicado después de reiniciar el servicio networking :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.036.png></p><p>Vamos a comprobar que funciona la regla viendo si lanzo un ping a otra red (R1) si este cambia mi dirección IP :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.037.png></p><p>Vemos que haciendo la captura este me ha cambiado la dirección privada de la maquina por la publica del router de casa por lo que la regla de SNAT estaría funcionando correctamente .</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.038.jpeg></p><h4 id=router-r2>Router R2</h4><p>Vamos a configurar SNAT y DNAT para ello añadiré las reglas al /etc/network/interfaces :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.039.png></p><p>Reiniciamos el servicio networking y vemos si se ha aplicado :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.040.png></p><p>Comprobaremos que funciona el SNAT haciendo ping del servidor hacia fuera a una dirección publica :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.041.png></p><p>Vemos que esta funcionando correctamente la regla de SNAT :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.042.png></p><p>Ya que nos ha cambiado la dirección ip privada por la publica correspondiente al router . En los apartados posteriores probare el DNAT .</p><h4 id=router-r1>Router R1</h4><p>Para este router vamos a realizar la creación de las reglas de una forma diferente , para ella crearemos un servicio que se encargue de levantar las reglas de DNAT y SNAT cuando la maquina se reinicie para evitar añadirlas al fichero interfaces .</p><p>Las reglas de DNAT y SNAT para esta maquina son :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.043.png></p><p>Lo primero que tendremos que hacer sera crear un script con nuestras reglas , así que las volcare con el comando iptables-save > /etc/iptables/rules.v4 para volcar las reglas existentes .</p><p>Ahora crearemos un script en en el cual restauraremos las reglas que hemos volcado y lo crearemos en la siguiente ruta /usr/local/bin/ :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.044.png></p><p>Nos tendremos que asegurar que tiene permisos de ejecución :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.045.png></p><p>Crearemos un archivo de servicio de Systemd , este archivo debe tener permisos de lectura y escritura solo para root, por lo que se debe ejecutar el siguiente comando como root:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.046.png></p><p>Dentro de este añadiremos el siguiente contenido , solo tendrías que añadir la ruta donde se encuentre tu script de iptables que restaura las reglas :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.047.png></p><p>Le diremos al servicio que se inicie automáticamente al reiniciar la maquina :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.048.png></p><p>Y lo iniciamos :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.049.png></p><p>Si queremos asegurarnos de que ha realizado su cometido correctamente miraremos el estado del servicio :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.050.png></p><p>Veremos que las reglas se han añadido automáticamente :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.051.png></p><p>Comprobaremos que nos ha realizado el SNAT correctamente lanzando un ping :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.052.png></p><p>Vemos que nos ha cambiado la dirección ip privada por la publica .</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.053.png></p><h3 id=comprobación-de-navegación-y-dnat>Comprobación de navegación y DNAT</h3><p>Ahora vamos a comprobar que desde la red de casa podemos acceder a los servidores web .</p><h4 id=cliente-debian>Cliente Debian</h4><p>Desde el cliente debian podemos hacer un curl para comprobar el correcto funcionamiento del DNAT en el Router R1:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.054.jpeg></p><p>Desde el cliente debian podemos hacer un curl para comprobar el correcto funcionamiento del DNAT en el Router R2:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.055.jpeg></p><p>Ahora vamos a comprobar que pasa si ponemos la dirección privada de los distintos servidores web :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.056.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.057.png></p><p>Vemos que no podemos llegar a esa red ya que los routers de internet son incapaces de encaminarnos hacia esta red privada ya que puede haber miles de dispositivos con la misma ip :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.058.png></p><p>Tampoco recibiríamos respuesta si hiciésemos una petición web .</p><p>Si interceptamos una petición http vemos que el SNAT se realiza correctamente , cambiando la ip privada del solicitante por la publica de su router :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.059.png></p><p>Ahora voy a interceptar una petición en la que se haga DNAT para comprobar que este se realiza correctamente :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.060.png></p><p>Podemos ver que el origen es una dirección ip publica mientras que el destino es una dirección ip privada podemos ver que el DNAT se ha realizado correctamente .</p><p>Ahora voy a pinchar un Firefox y volveré a comprobar que podemos acceder a los servidores web solo usando su dirección ip publica :</p><p>Server 1 :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.061.jpeg></p><p>Server 2:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.062.jpeg></p><p>Vemos que usando dirección ip publica podemos conectarnos , sin embargo no podremos usando las direcciónes ips privada de las maquinas :</p><p>Server 1 :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.063.jpeg></p><p>Server 2 :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.064.jpeg></p><p>Funciona correctamente ya que hemos conseguido que nuestros routers Linux sean capaces de hacer SNAT y DNAT pudiendo hacer que estos “utilicen” internet y puedan acceder a los recursos de otras redes . Ya que las direcciónes privadas no se enrutan en los mismos así que si comprobamos usando estas no obtendremos ningún resultado .</p><h4 id=depuración-nat>Depuración NAT</h4><p>Para ver cuantos hits ha tenido una regla o para ver cuanta información ha “utilizado” cada regla utilizaremos el siguiente comando :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.065.jpeg></p><p>Para borrar los contadores de todas las cadenas y reglas usaremos iptables -Z :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.066.png></p><p>Si nuestra cadena tiene hits la regla estará funcionando correctamente si por el contrario esta se mantiene en 0 , la regla no se esta aplicando así que tendremos que revisarla .</p><h2 id=escenario-con-routers-cisco>Escenario con routers Cisco</h2><p>Volveremos a repetir el mismo escenario que con los routers Linux pero ahora usando routers cisco 7200.</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.067.jpeg></p><h3 id=preparación-del-entorno-1>Preparación del entorno</h3><h3 id=configuración-de-las-tarjetas-de-red-1>Configuración de las tarjetas de red</h3><p>Lo primeros que haremos sera añadirle los slots necesarios a nuestros routers ya que necesitamos 2 tarjetas de red en R1,R2 y CASA . Edemas de 3 para el router ISP .</p><p>Para los primeros le añadiremos el slot PA-FE-TX , que nos añadirá una interfaz FastEthernet:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.068.png></p><p>Mientras que para el router del ISP le añadiremos PA-2FE-TX que nos añadirá dos interfaces de red FastEthernet.</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.069.png></p><p>Ahora podemos arrancar los routers y comenzar con la configuración de las tarjetas de red . Usare las mismas direcciónes que en el escenario anterior .</p><h4 id=router-casa-1>Router CASA</h4><p>Configuramos las tarjetas de red :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.070.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.071.png></p><p>Quedando así nuestras interfaces :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.072.png></p><h4 id=router-r1-1>Router R1</h4><p>Configuramos las tarjetas de red :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.073.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.074.png></p><p>Quedando así nuestras interfaces :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.075.png></p><h4 id=router-r2-1>Router R2</h4><p>Configuramos las tarjetas de red :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.076.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.077.png></p><p>Quedando así nuestras interfaces :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.078.png></p><h4 id=router-isp>Router ISP</h4><p>Configuramos las tarjetas de red :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.079.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.080.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.081.png></p><p>Quedando así nuestras interfaces :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.082.png></p><h3 id=rutas-necesarias-1>Rutas necesarias</h3><h4 id=rutas-isp>Rutas ISP:</h4><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.083.png></p><h4 id=rutas-casa->Rutas CASA :</h4><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.084.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.085.png></p><h4 id=rutas-r2>Rutas R2:</h4><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.086.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.087.png></p><h4 id=rutas-r1>Rutas R1:</h4><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.088.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.089.png></p><p>Seria necesario únicamente que añadamos las rutas por defecto en los Routers R1 , R2 y CASA .</p><h3 id=prueba-de-conectividad>Prueba de conectividad</h3><p><strong>R1 –> R2</strong></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.090.png></p><p><strong>R1 –> CASA</strong></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.091.png></p><p><strong>R2-→ R1</strong></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.092.png></p><p><strong>R2 –> CASA</strong></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.093.png></p><p><strong>CASA –> R1</strong></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.094.png></p><p><strong>CASA –> R2</strong></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.095.png></p><p>Vemos que todos los dispositivos que tiene direcciónes ips publicas tienen conectividad entre si pero que pasa con los que tienen direcciónamiento privado en nuestro escenario , estos no tendrán conectividad ya que no se enrutan direcciónes privadas en los routers de internet .</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.096.png></p><h3 id=configuración-del-servicio-dhcp-en-router-casa-1>Configuración del servicio DHCP en router CASA</h3><p>Lo primero que haremos sera establecer el rango de IP´s excluidas del conjunto (pool) de direcciónes que podrá asignar el servicio indicando la ip inicial y final del rango, ambas incluidas:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.097.png></p><p>Ponemos un nombre al rango del servicio DHCP:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.098.png></p><p>Definimos la red a la que dará servicio de DHCP:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.099.png></p><p>Incluimos la puerta de enlace que ofrecerá el servicio :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.100.png></p><p>Con esto ya estaría configurado el servidor DHCP del router de CASA , nos salimos y guardamos los cambios . Ahora encenderemos nuestras maquinas y veremos que están recibirán automáticamente su configuración por DHCP , con el siguiente comando podemos ver las estadísticas del servicio :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.101.png></p><p>Además podemos ver las concesiones con el siguiente comando :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.102.png></p><p>Este nos sera útil para realizar un seguimiento de quien tiene asignada cada IP sin tener que ir individualmente a casa maquina .</p><h3 id=configuración-del-nat>Configuración del NAT</h3><h4 id=router-casa-2>Router CASA</h4><p>Lo primero que haremos sera crear una acl para permitir el trafico que queremos hacer SNAT :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.103.png></p><p>Le asignaremos a la interfaz interna de nuestra red esta regla :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.104.png></p><p>Ahora crearemos un pool con las ips publicas , el comando seria este no sale completo en la terminal :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip nat pool ip_publica 102.168.0.2 102.168.0.2 netmask 255.255.255.0 
</span></span></code></pre></div><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.105.png></p><p>Activamos el NAT :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.106.png></p><p>Indicamos que interfaz es de “dentro” :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.107.png></p><p>Indicamos la interfaz de “fuera”:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.108.png></p><p>El SNAT estaría funcionando , así que vamos a comprobarlo :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.109.png></p><p>Vemos que nos cambia correctamente la ip privada de nuestro host por la publica del router de casa .</p><h4 id=router-r1-2>Router R1</h4><p>Lo primero que haremos sera crear una acl para permitir el trafico que queremos hacer SNAT :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.110.png></p><p>Le asignaremos a la interfaz interna de nuestra red esta regla :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.111.png></p><p>Ahora crearemos un pool con las ips publicas , el comando seria este no sale completo en la terminal :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip nat pool ip_publica 101.168.0.2 101.168.0.2 netmask 255.255.255.0 
</span></span></code></pre></div><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.112.png></p><p>Activamos el NAT :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.113.png></p><p>Indicamos que interfaz es de “dentro” :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.114.png></p><p>Indicamos la interfaz de “fuera”:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.115.png></p><p>Y comprobaremos que se esta realizando correctamente :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.116.png></p><p>Nos cambia la ip 172.22.1.1 por la 101.168.0.2 que es la publica del router al realizar un ping , por lo que esta funcionando correctamente el SNAT.</p><p>Ahora configuraremos la regla de DNAT , la sintaxis es la siguiente :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip nat inside source static tcp ip_privada puerto ip_publica puerto
</span></span></code></pre></div><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.117.png></p><p>*Posteriormente comprobaremos que el DNAT funciona correctamente .</p><h4 id=router-r2-2>Router R2</h4><p>Lo primero que haremos sera crear una acl para permitir el trafico que queremos hacer SNAT :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.118.png></p><p>Le asignaremos a la interfaz interna de nuestra red esta regla :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.119.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.120.png></p><p>Ahora crearemos un pool con las ips publicas , el comando seria este no sale completo en la terminal :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip nat pool ip_publica 103.168.0.2 103.168.0.2 netmask 255.255.255.0 
</span></span></code></pre></div><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.121.png></p><p>Activamos el NAT :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.122.png></p><p>Indicamos que interfaz es de “dentro” :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.123.png></p><p>Indicamos la interfaz de “fuera”:</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.124.png></p><p>Y comprobaremos que se esta realizando correctamente :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.125.png></p><p>*Nos cambia la ip 10.0.0.1 por la 103.168.0.2 que es la publica del router al realizar un ping , por lo que esta funcionando correctamente el SNAT.</p><p>Ahora configuraremos la regla de DNAT , la sintaxis es la siguiente :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip nat inside source static tcp ip_privada puerto ip_publica puerto
</span></span></code></pre></div><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.126.png></p><p>*Posteriormente comprobaremos que el DNAT funciona correctamente .</p><h3 id=comprobación-de-navegación-y-dnat-1>Comprobación de navegación y DNAT</h3><p>Ahora vamos a comprobar que desde la red de casa podemos acceder a los servidores web .</p><p>Accederé usando curl desde un host de la red de casa . Primero me conectare al servidor 1 :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.127.png></p><p>Vemos que este nos responde correctamente y se aplica el DNAT , ya que ha cambiado la ip publica del router por la privada del servidor web :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.128.png></p><p>Ahora comprobaremos el servidor 2 :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.129.png></p><p>Vemos que este nos responde correctamente y se aplica el DNAT , ya que ha cambiado la ip publica del router por la privada del servidor web :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.130.png></p><p>Ahora comprobaremos que puedo acceder desde un Tiny Core con Firefox a ambos servidores :</p><p>Al servidor 1 :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.131.jpeg></p><p>Al servidor 2 :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.132.jpeg></p><p>Vemos que también podemos conectarnos ya que las reglas de NAT están funcionando correctamente .</p><p>Vamos a comprobar que ocurre si solicitamos la web a través de sus direcciónes ip privadas :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.133.png></p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.134.png></p><p>Pues que obviamente no recibimos respuesta ya que en nuestro escenario estamos simulando internet y en este no se pueden enrutar direcciónes ips privadas ya que están pueden estar repetidas en infinidad de redes .</p><h3 id=depuración-de-las-reglas-nat>Depuración de las reglas NAT</h3><p>Además para asegurarnos de que las reglas de NAT están funcionando .</p><p>El primer comando nos permite ver la tabla de traducciones de direcciónes DNAT :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.135.png></p><p>Con este comando podremos ver cuantos hits tienen nuestras reglas , si no tiene ninguno es que esta no esta funcionando salvo que nosotros hayamos inicializado este :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.136.png></p><p>Si queremos poner los contadores a cero usaremos el comando clear ip nat statistics .</p><p>Si queremos ver en tiempo real los paquetes que muestra información sobre cada paquete que traduce el router :</p><p><img src=../img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.137.png></p><p>Cuando decodifique el resultado de este comando, observe los significados de los siguientes símbolos y valores:</p><ul><li><strong>*</strong> : el asterisco junto a NAT indica que la traducción se realiza en la ruta de switching rápido. Al primer paquete en una conversación siempre se aplica el switching de procesos, que es más lento. Si existe una entrada de caché, el resto de los paquetes atraviesan la ruta de switching rápido.</li><li><strong>S</strong>: Este símbolo hace referencia a la dirección IPv4 de origen.</li><li><strong>a.b.c.d→ w.x.y.z</strong>: este valor indica que la dirección de origen a.b.c.d se traduce a w.x.y.z.</li><li><strong>d</strong>: = Este símbolo hace referencia a la dirección IPv4 de destino.</li><li><strong>[xxxx]</strong> = El valor entre corchetes es el número de identificación IPv4. Esta información puede ser útil para la depuración, ya que habilita la correlación con otros seguimientos de paquetes realizados por los analizadores de protocolos.</li></ul><h2 id=bibliografía>Bibliografía</h2><ul><li><a href=https://ccnadesdecero.es/resolver-problemas-nat-cisco/ target=_blank rel=noopener>Depuración NAT</a></li></ul></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Compartir en:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.javiercd.es%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f&text=Configuraci%c3%b3n%20de%20NAT%20Cisco%20y%20Linux&via=Atlas" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f&title=Configuraci%c3%b3n%20de%20NAT%20Cisco%20y%20Linux" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.javiercd.es%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f&title=Configuraci%c3%b3n%20de%20NAT%20Cisco%20y%20Linux" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=Configuraci%c3%b3n%20de%20NAT%20Cisco%20y%20Linux https%3a%2f%2fwww.javiercd.es%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=Configuraci%c3%b3n%20de%20NAT%20Cisco%20y%20Linux&body=https%3a%2f%2fwww.javiercd.es%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/javierasping/sentinel/edit/main/content/posts/redes/configuracion_de_nat/configuracion_de_nat.md title="Mejorar esta página" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Mejorar esta página</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Contenido</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#escenario-con-maquinas-debian>Escenario con maquinas debian</a><ul><li><a href=#preparación-del-entorno>Preparación del entorno</a><ul><li><a href=#instalación-de-paquetes>Instalación de paquetes</a></li><li><a href=#configuración-de-las-tarjetas-de-red>Configuración de las tarjetas de red</a></li><li><a href=#rutas-necesarias>Rutas necesarias</a></li><li><a href=#comprobación-de-conectividad>Comprobación de conectividad</a></li></ul></li><li><a href=#configuración-del-servicio-dhcp-en-router-casa>Configuración del servicio DHCP en router CASA</a></li><li><a href=#configuración-de-nat>Configuración de NAT</a><ul><li><a href=#router-casa>Router CASA</a></li><li><a href=#router-r2>Router R2</a></li><li><a href=#router-r1>Router R1</a></li></ul></li><li><a href=#comprobación-de-navegación-y-dnat>Comprobación de navegación y DNAT</a><ul><li><a href=#cliente-debian>Cliente Debian</a></li><li><a href=#depuración-nat>Depuración NAT</a></li></ul></li></ul></li><li><a href=#escenario-con-routers-cisco>Escenario con routers Cisco</a><ul><li><a href=#preparación-del-entorno-1>Preparación del entorno</a></li><li><a href=#configuración-de-las-tarjetas-de-red-1>Configuración de las tarjetas de red</a><ul><li><a href=#router-casa-1>Router CASA</a></li><li><a href=#router-r1-1>Router R1</a></li><li><a href=#router-r2-1>Router R2</a></li><li><a href=#router-isp>Router ISP</a></li></ul></li><li><a href=#rutas-necesarias-1>Rutas necesarias</a><ul><li><a href=#rutas-isp>Rutas ISP:</a></li><li><a href=#rutas-casa->Rutas CASA :</a></li><li><a href=#rutas-r2>Rutas R2:</a></li><li><a href=#rutas-r1>Rutas R1:</a></li></ul></li><li><a href=#prueba-de-conectividad>Prueba de conectividad</a></li><li><a href=#configuración-del-servicio-dhcp-en-router-casa-1>Configuración del servicio DHCP en router CASA</a></li><li><a href=#configuración-del-nat>Configuración del NAT</a><ul><li><a href=#router-casa-2>Router CASA</a></li><li><a href=#router-r1-2>Router R1</a></li><li><a href=#router-r2-2>Router R2</a></li></ul></li><li><a href=#comprobación-de-navegación-y-dnat-1>Comprobación de navegación y DNAT</a></li><li><a href=#depuración-de-las-reglas-nat>Depuración de las reglas NAT</a></li></ul></li><li><a href=#bibliografía>Bibliografía</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navegación</h5><ul><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#about>Sobre mi</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#skills>Competencias</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#education>Educación</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#recent-posts>Últimas publicaciones</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/#accomplishments>Certificaciones</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contacto</h5><ul><li><a href=mailto:contacto@javiercd.es target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>contacto@javiercd.es</span></a></li><li><a href=https://github.com/javierasping target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>javierasping</span></a></li><li><a href=https://www.linkedin.com/in/javiercd target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Francisco Javier Cruces Doval</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>Aviso de responsabilidad:</strong> This theme is under MIT license. So, you can use it for non-commercial, commercial, or private uses. You can modify or distribute the theme without requiring any permission from the theme author. However, the theme author does not provide any warranty or takes any liability for any issue with the theme.</p></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu16779671404603505019.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2023 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Funcionando con
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.b60f32ec760af3e99df5a780673896db9439a621fb2f9130c524bc1af0c3443a.js integrity="sha256-tg8y7HYK8+md9aeAZziW25Q5piH7L5EwxSS8GvDDRDo=" defer></script></body></html>