<!doctype html><html lang=en><head><title>NAT Cisco and Linux Configuration</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.ddf4c4775d35e5bc3dd64c797b179f99eaf85cf9811e64bd08f8c44a68d0b229.css integrity="sha256-3fTEd1015bw91kx5exefmer4XPmBHmS9CPjESmjQsik="><link rel=icon type=image/png href=/images/site/avatar_hu_f10227dc088ad43a.jpg><meta property="og:title" content="Atlas"><meta property="og:type" content="website"><meta property="og:description" content="Portfolio and personal blog of Francisco Javier Cruces Doval"><meta property="og:image" content="/images/author/john.png"><meta property="og:url" content="https://www.javiercd.es"><meta name=description content="The routing of a scenario with public addresses, we configure SNAT and DNAT in Linux and cisco machines."><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/en><img src=/images/site/masthead_hu_f10227dc088ad43a.png id=logo alt=Logo>
Atlas</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/en#home>Home</a></li><li class=nav-item><a class=nav-link href=/en#about>About Me</a></li><li class=nav-item><a class=nav-link href=/en#skills>Skills</a></li><li class=nav-item><a class=nav-link href=/en#education>Education</a></li><li class=nav-item><a class=nav-link href=/en#recent-posts>Recent Posts</a></li><li class=nav-item><a class=nav-link href=/en#accomplishments>Certifications</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/en/posts>Posts</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=languageSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><span class="fi fi-gb"></span>
English</a><div class=dropdown-menu aria-labelledby=languageSelector><a class="dropdown-item nav-link languages-item" href=/posts/redes/configuracion_de_nat/configuracion_de_nat><span class="fi fi-es"></span>
Español
</a><a class="dropdown-item nav-link languages-item" href=/en/posts/redes/configuracion_de_nat/configuracion_de_nat><span class="fi fi-gb"></span>
English</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/en/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/en/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/ci_cd/> CI / CD Jenkins</a><ul><li><a class=list-link href=/en/posts/ci_cd/practica_jenkins/ title="CI / CD practice with Jenkins">CI / CD practice with Jenkins</a></li><li><a class=list-link href=/en/posts/ci_cd/taller1_jenkins/ title="Workshop 1 Ortho-rector of markdown documents (test)">Workshop 1 Ortho-rector of markdown documents (test)</a></li><li><a class=list-link href=/en/posts/ci_cd/taller2_jenkins/ title="Workshop 2 Valid HTML5 check and surge.sh deployment (test and deploy)">Workshop 2 Valid HTML5 check and surge.sh deployment (test and deploy)</a></li><li><a class=list-link href=/en/posts/ci_cd/taller3_jenkins/ title="Workshop 3 Continuous integration of django application (Test)">Workshop 3 Continuous integration of django application (Test)</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/base_de_datos/> Database</a><ul><li><a class=list-link href=/en/posts/base_de_datos/instalar_mariadb/ title="Install MariaDB in Debian">Install MariaDB in Debian</a></li><li><a class=list-link href=/en/posts/base_de_datos/interconexion_de_servidores/ title="Interconnection of database servers">Interconnection of database servers</a></li><li><a class=list-link href=/en/posts/base_de_datos/instalacion_oracle_19c_debian12/ title="Oracle 19c installation under Debian 12">Oracle 19c installation under Debian 12</a></li><li><a class=list-link href=/en/posts/base_de_datos/instalar_postgresql/ title="PostgreSQL installation in Debian 12">PostgreSQL installation in Debian 12</a></li><li><a class=list-link href=/en/posts/base_de_datos/oracle_acceso_remoto/ title="Remote access configuration in Oracle">Remote access configuration in Oracle</a></li><li><a class=list-link href=/en/posts/base_de_datos/acceso_remoto_mariadb/ title="Remote access in MariaDB">Remote access in MariaDB</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/docker/> Docker</a><ul><li><a class=list-link href=/en/posts/docker/instalar_docker_compose/ title="Docker Compose Installation on Ubuntu 24">Docker Compose Installation on Ubuntu 24</a></li><li><a class=list-link href=/en/posts/docker/instalar_docker_ubuntu24/ title="Docker Installation on Ubuntu 24">Docker Installation on Ubuntu 24</a></li><li><a class=list-link href=/en/posts/docker/taller1/ title="Workshop 1 Storage and networks in Docker">Workshop 1 Storage and networks in Docker</a></li><li><a class=list-link href=/en/posts/docker/taller2/ title="Workshop 2 Multicontainer Scenarios in Docker">Workshop 2 Multicontainer Scenarios in Docker</a></li><li><a class=list-link href=/en/posts/docker/taller3/ title="Workshop 3 Image creation Docker">Workshop 3 Image creation Docker</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/cortafuegos/> Firewall</a><ul><li><a class=list-link href=/en/posts/cortafuegos/fortinet_cli/ title="Fortinet CLI">Fortinet CLI</a></li><li><a class=list-link href=/en/posts/cortafuegos/fortinet_uno/ title="Perimetral with Fortinet I">Perimetral with Fortinet I</a></li><li><a class=list-link href=/en/posts/cortafuegos/fortinet_dos/ title="Perimetral with Fortinet II">Perimetral with Fortinet II</a></li><li><a class=list-link href=/en/posts/cortafuegos/nftables_uno/ title="Perimetral with Nftables I">Perimetral with Nftables I</a></li><li><a class=list-link href=/en/posts/cortafuegos/nftables_dos/ title="Perimetral with Nftables II">Perimetral with Nftables II</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/drivers/> Linux Drivers</a><ul><li><a class=list-link href=/en/posts/drivers/nvidia_driver/ title="Drivers Nvidia">Drivers Nvidia</a></li><li><a class=list-link href=/en/posts/drivers/nvidia_optimus/ title="How to choose which graph to use on my laptop with Linux">How to choose which graph to use on my laptop with Linux</a></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/en/posts/redes/> Networks</a><ul class=active><li><a class=list-link href=/en/posts/redes/android_gns3/ title="Android GNS3-KVM">Android GNS3-KVM</a></li><li><a class=list-link href=/en/posts/redes/escenario_ipv6_basico/ title="Basic IPv6 scenario">Basic IPv6 scenario</a></li><li><a class=list-link href=/en/posts/redes/instalacion_wireshark_gns3/ title="GNS3 and Wireshark installation">GNS3 and Wireshark installation</a></li><li><a class=list-link href=/en/posts/redes/instalar_gns3_debian12/ title="GNS3 installation in Debian 12">GNS3 installation in Debian 12</a></li><li><a class=list-link href=/en/posts/redes/switches_gns3/ title="GNS3 switch configuration">GNS3 switch configuration</a></li><li><a class=list-link href=/en/posts/redes/tuneles_ipv6/ title="IPV6 Tunnels">IPV6 Tunnels</a></li><li><a class="active list-link" href=/en/posts/redes/configuracion_de_nat/ title="NAT in Cisco and Linux">NAT in Cisco and Linux</a></li><li><a class=list-link href=/en/posts/redes/comandos_de_supervision_de_redes/ title="Network monitoring commands">Network monitoring commands</a></li><li><a class=list-link href=/en/posts/redes/enroutamiento_openstack/ title="OpenStack routing">OpenStack routing</a></li><li><a class=list-link href=/en/posts/redes/arp/ title="Protocol ARP">Protocol ARP</a></li><li><a class=list-link href=/en/posts/redes/underworld/ title=Underworld>Underworld</a></li><li><a class=list-link href=/en/posts/redes/underworld_evolution/ title="Underworld evolution">Underworld evolution</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/seguridad/> Security</a><ul><li><a class=list-link href=/en/posts/seguridad/forense/ title="Forensic computer">Forensic computer</a></li><li><a class=list-link href=/en/posts/seguridad/https_autofirmado/ title=HTTPS>HTTPS</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/> Services</a><ul><li><a class=list-link href=/en/posts/servicios/apache/ title=Apache>Apache</a></li><li><a class=list-link href=/en/posts/servicios/dhcp/ title=DHCP>DHCP</a></li><li><a class=list-link href=/en/posts/servicios/dns/ title=DNS>DNS</a></li><li><a class=list-link href=/en/posts/servicios/ftp/ title=FTP>FTP</a></li><li><a class=list-link href=/en/posts/servicios/nat_iptables/ title="NAT with iptables">NAT with iptables</a></li><li><a class=list-link href=/en/posts/servicios/ssh/ title=SSH>SSH</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/> Systems</a><ul><li><a class=list-link href=/en/posts/sistemas/ad_ubuntu/ title="Active Directory in Ubuntu">Active Directory in Ubuntu</a></li><li><a class=list-link href=/en/posts/sistemas/recoleccion_logs_journald/ title="Centralized collection of logs journald">Centralized collection of logs journald</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/compilaciones_linux/> Compilations in LINUX</a><ul><li><a class=list-link href=/en/posts/sistemas/compilaciones_linux/compilacion_de_un_programa_en_c_utilizando_un_makefile/ title="Compilation of a C-program using a Makefile">Compilation of a C-program using a Makefile</a></li><li><a class=list-link href=/en/posts/sistemas/compilaciones_linux/compilacion_de_un_kernel/ title="Compilation of a kernel">Compilation of a kernel</a></li></ul></li><li><a class=list-link href=/en/posts/sistemas/creacion_de_un_sistema_automatizado_de_instalacion/ title="Creation of an automated installation system">Creation of an automated installation system</a></li><li><a class=list-link href=/en/posts/sistemas/samba_debian/ title="Install and configure samba in Debian">Install and configure samba in Debian</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/comandos_linux/> Linux Command</a><ul><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_de_modificacion_de_parametros_del_kernel/ title="Kernel parameter modification exercises">Kernel parameter modification exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/comandos_procesos/ title="Linux processes">Linux processes</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_de_manejo_de_modulos/ title="Module management exercises">Module management exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/gestion_de_paquetes/ title="Package management">Package management</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/empaquetadores_compresores/ title="Packaging and compressors">Packaging and compressors</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_gestion_de_paqueteria/ title="Paid management exercises">Paid management exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/programacion_tareas/ title="Task programming">Task programming</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/migraciones/> Migration in Linnux</a><ul><li><a class=list-link href=/en/posts/sistemas/migraciones/migracion_sistema_de_ficheros/ title="File system">File system</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/paso_de_centos_stream_8_a_centos_stream_9/ title="Migtation from CentOS stream 8 to CentOS stream 9">Migtation from CentOS stream 8 to CentOS stream 9</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/eliminacion_systemd/ title="Systemd elimination">Systemd elimination</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/transformacion_instancia_cloud/ title="Transformation instance cloud">Transformation instance cloud</a></li></ul></li><li><a class=list-link href=/en/posts/sistemas/nfs_debian/ title="NFS in Debian">NFS in Debian</a></li><li><a class=list-link href=/en/posts/sistemas/activacion_selinux/ title="SELinux activation configuration">SELinux activation configuration</a></li><li><a class=list-link href=/en/posts/sistemas/comparticion_de_directorios_en_windows/ title="Share resources in Windows">Share resources in Windows</a></li><li><a class=list-link href=/en/posts/sistemas/ssh_windows/ title="Ssh service in Windows">Ssh service in Windows</a></li><li><a class=list-link href=/en/posts/sistemas/almacenamiento_servidor_independiente/ title="Storage Spaces in Windows Server">Storage Spaces in Windows Server</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/vpn/> VPN</a><ul><li><a class=list-link href=/en/posts/vpn/comparativa_ovpn_wire/ title="OpenVPN and Wireguard Comparative">OpenVPN and Wireguard Comparative</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_openvpn/ title="OpenVPN remote access">OpenVPN remote access</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_strongswang/ title="Remote access Ipsec StrongSwan">Remote access Ipsec StrongSwan</a></li><li><a class=list-link href=/en/posts/vpn/ipsec_cisco/ title="Site-to-Site IPsec Cisco">Site-to-Site IPsec Cisco</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_fortinet/ title="Site-to-Site IPsec Fortinet">Site-to-Site IPsec Fortinet</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_openvpn/ title="Site-to-Site OpenVPN">Site-to-Site OpenVPN</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_wireguard/ title="Site-to-Site Wireguard">Site-to-Site Wireguard</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_wireguard/ title="Wireguard remote access">Wireguard remote access</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/iaw/> Web applications</a><ul><li><a class=list-link href=/en/posts/iaw/lamp/ title="LAMP stack installation">LAMP stack installation</a></li><li><a class=list-link href=/en/posts/iaw/lemp/ title="LEMP stack installation">LEMP stack installation</a></li><li><a class=list-link href=/en/posts/iaw/wordpress/ title="WordPress LAMP">WordPress LAMP</a></li><li><a class=list-link href=/en/posts/iaw/wordpress_lemp/ title="WordPress LEMP">WordPress LEMP</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/redes/configuracion_nat/portada.png)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/john_hu_2aff0fda0501496d.png alt="Author Image"><h5 class=author-name>Francisco Javier Cruces Doval</h5><p class=text-muted>Friday, September 8, 2023 | 14 minutes</p></div><div class=title><h1>NAT Cisco and Linux Configuration</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/en/tags/redes/ class="btn btn-sm btn-info">Redes</a></li><li class=rounded><a href=/en/tags/enrutamiento/ class="btn btn-sm btn-info">Enrutamiento</a></li><li class=rounded><a href=/en/tags/nat/ class="btn btn-sm btn-info">NAT</a></li><li class=rounded><a href=/en/tags/snat/ class="btn btn-sm btn-info">SNAT</a></li><li class=rounded><a href=/en/tags/dnat/ class="btn btn-sm btn-info">DNAT</a></li><li class=rounded><a href=/en/tags/cisco/ class="btn btn-sm btn-info">Cisco</a></li><li class=rounded><a href=/en/tags/linux/ class="btn btn-sm btn-info">Linux</a></li></ul></div><div class=post-content id=post-content><p>In this article, we will explore the configuration of SNAT (Source Network Address Translation) and DNAT (Destination Network Address Translation) in scenarios with public addresses, using routers in Linux environments and Cisco devices.</p><h3 id=scenario-with-debian-machines>Scenario with debian machines</h3><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.001.jpeg alt></p><h3 id=preparation-of-the-environment>Preparation of the environment</h3><h3 id=installation-of-packages>Installation of packages</h3><p>Once the machines are placed we must download Apache for the web servers, to do this we will connect both servers to a switch and this to the NAT cloud for Internet access.</p><p>We will now update the repositories by making an apt update:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.002.png alt></p><p>Then we can download the packages, for the servers we will install apache:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.003.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.004.png alt></p><p>And for the home router we will download the DHCP server:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.005.png alt></p><p>When the installation is finished, a similar error code will jump, because there is no valid configuration in the service:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.006.jpeg alt></p><p>For now we will ignore this and then configure the DHCP server.</p><p>With this we would have installed all the packages needed to install the practice so we can mount the stage.</p><h3 id=network-card-configuration>Network card configuration</h3><p>We will find a small obstacle in making the stage as we need some routers to have more than one network card.</p><p>To add more than one card with the device off and without being connected to anyone, we do over the right click and click on configure > network, and we select the number of adapters we need to have on each, for example for the home router I need to have two adapters:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.007.jpeg alt></p><p>Once this is done with the machines that need more than one card, we will set up the stage and proceed to set up your cards.</p><p>To modify the configuration of the network cards we will do it by editing the /etc/network/ interfaces file. To apply the configuration of the network cards we have made we have several options.</p><p>Up and down the card we have modified:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.008.png alt></p><p>We can also save time and restart the networking service, this will work for all cards simultaneously so it will save us time:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.009.png alt></p><p>Router CASA:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.010.jpeg alt></p><p>Router R1:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.011.jpeg alt></p><p>Router ISP:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.012.jpeg alt></p><p>Router R2:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.013.jpeg alt></p><p>So it would be the relationship of ips that have the routers&rsquo; network cards. To apply this configuration to the network cards we will have to restart it as indicated at the beginning of this paragraph.</p><p>For the stage to work we must activate the forwarding bit for these 4 routers, in this case I will do it permanently for it we edit the / etc / sysctl.conf file and discomment this line:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.014.png alt></p><h3 id=necessary-routes>necessary routes</h3><p>For my current scheme the routes we need in the routers are:</p><p>Router R1:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.015.png alt></p><p>Router ISP:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.016.png alt></p><p>Router R2:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.017.png alt></p><p>Router CASA:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.018.png alt></p><h3 id=connectivity-check>Connectivity check</h3><p>We will do ping from each of the routers to their &ldquo;farthest&rdquo; ends to make sure we have done the routing correctly.</p><p>Router R1 - > R2</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.019.png alt></p><p>Router R1 - > CASA</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.020.png alt></p><p>Router R2 - > R1</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.021.png alt></p><p>Router R2 - > CASA</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.022.png alt></p><p>Router CASA - > R1</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.023.png alt></p><p>Router CASA - > R2</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.024.png alt></p><p>We see that all devices that have public ips addresses have connectivity between themselves but what happens to those that have private addresses on our stage, they will not have connectivity as no private addresses are routed on the internet routers.</p><p>In other words, if we throw a ping into a private address that is from another network, for example from the service1 to the service2 it does not arrive, as there are no routes for private directions2 on the router tables of the ISP router.</p><p>So it will be impossible to reach a private network other than the one we belong to.</p><p>For example from home if we do ping a google we do it to the address PUBLIC 8.. 8.8.8 not to the private address that the server has, can be 172.22.1.2 15</p><p>DHCP service configuration in CASA router</p><p>By taking back what we had previously done in the package installation section we have already downloaded the DHCP server for debian (isch-dhcp-server). So now let&rsquo;s set it up.</p><p>The first thing we need to do is tell our server through which network card we want this to distribute directions ip, in our case is the ens5 card.</p><p>To do this we will edit the /etc/default/isch-dhcp-server file and add the card name in the IPV4 section:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.025.jpeg alt></p><p>Now let&rsquo;s tell our DHCP server that we want to be assigned to our customers for this we edit the /etc/dhcp/dhcpd.conf file, we can take advantage of one of the examples that are commented on and apply our configuration:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.026.png alt></p><p>This is a very simple example of a dhcp server but with this is enough for our stage.</p><p>The fields mean:</p><ul><li>subnet: network address from which we want to distribute ip addresses with this service.</li><li>netmask: Network mask of the network which we want to set up the devices.</li><li>range: range of addresses from which we want to distribute ips being the first the initial and the last the final.</li><li>option routers: It would be the gateway of our network</li><li>option broadcast-address: broadcast address of our network.</li></ul><p>Once configured with the parameters of our network we will restart the service:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.027.png alt></p><p>And we&rsquo;ll check that the service is active:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.028.jpeg alt></p><p>Now for customers to receive an address using this service, we will have to set the PC1 and PC2 network cards as follows:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.029.png alt></p><p>We restart the service to be applied and the server automatically assign the network configuration to us:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.030.png alt></p><p>We check that we have actually been assigned the network configuration:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.031.jpeg alt></p><p>We can also track who we have assigned the ip through the server by viewing the following file /var/lib/dhcp/dhcpd.leases which saves the concessions we have made.</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.032.png alt></p><p>We can see when it starts as well as who has been assigned by looking at their MAC address.</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.033.jpeg alt></p><h3 id=nat-configuration>NAT configuration</h3><p>Router CASA</p><p>Let&rsquo;s set up the SNAT in the home router seeing the current scheme the rule to do this is:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.034.png alt></p><p>However this would be eliminated when the machine was reinitiated so in this case I will add it to /etc/network/interfaces:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.035.png alt></p><p>So we can see that they have been applied after relaunching the network service:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.036.png alt></p><p>Let&rsquo;s check that the rule works by seeing if I launch a ping to another network (R1) if it changes my IP address:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.037.png alt></p><p>We see that by doing the capture this has changed the private address of the machine to the public of the home router so the SNAT rule would be working properly.</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.038.jpeg alt></p><p>Router R2</p><p>We will set up SNAT and DNAT to do this I will add the rules to /etc/network/interfaces:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.039.png alt></p><p>We restart the network service and see if it has been applied:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.040.png alt></p><p>We will check that the SNAT works by ping the server out to a public address:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.041.png alt></p><p>We see that the SNAT rule is working correctly:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.042.png alt></p><p>Since we have changed the private ip address to the post for the router. In the subsequent paragraphs, you will test the DNAT.</p><p>Router R1</p><p>For this router we will perform the creation of the rules in a different way, for it we will create a service to raise the rules of DNAT and SNAT when the machine is restarted to avoid adding them to the interface file.</p><p>The rules of DNAT and SNAT for this machine are:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.043.png alt></p><p>The first thing we will have to do is create a script with our rules, so volcare with the iptables-save > /etc/iptables/rules.v4 command to flip the existing rules.</p><p>We will now create a script in which we will restore the rules we have overturned and create it on the following route /usr/local/bin/:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.044.png alt></p><p>We&rsquo;ll have to make sure you have execution permits:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.045.png alt></p><p>We will create a Systemd service file, this file must have reading and writing permissions only for root, so you must run the following command as root:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.046.png alt></p><p>Within this we will add the following content, you would only have to add the route where your iptable script is found that restores the rules:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.047.png alt></p><p>We&rsquo;ll tell the service to start automatically when the machine is restarted:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.048.png alt></p><p>And we started it:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.049.png alt></p><p>If we want to make sure you have done your job properly we will look at the state of the service:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.050.png alt></p><p>We will see that the rules have been automatically added:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.051.png alt></p><p>We will check that the SNAT has performed us correctly by launching a ping:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.052.png alt></p><p>We see that our private address has been changed to the public.</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.053.png alt></p><h3 id=navigation-and-dnat-check>Navigation and DNAT check</h3><p>Now let&rsquo;s check that from the home network we can access the web servers.</p><p>Debian client</p><p>From the debian client we can make a curl to check the correct functioning of the DNAT in the Router R1:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.054.jpeg alt></p><p>From the debian client we can make a curl to check the correct functioning of the DNAT in the Router R2:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.055.jpeg alt></p><p>Now let&rsquo;s check what happens if we put the private address of the different web servers:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.056.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.057.png alt></p><p>We see that we cannot reach that network because the Internet routers are unable to move us to this private network as there may be thousands of devices with the same ip:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.058.png alt></p><p>We would not be answered if we made a web request.</p><p>If we intercept a request http we see that the SNAT is done correctly, changing the applicant&rsquo;s private ip to the publication of your router:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.059.png alt></p><p>Now I&rsquo;m going to intercept a request in which DNAT is made to check that this is done correctly:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.060.png alt></p><p>We can see that the origin is a public ip address while the destination is a private ip address we can see that the DNAT has been performed correctly.</p><p>Now I&rsquo;m going to press a Firefox and I&rsquo;ll check again that we can access the web servers just using their public ip address:</p><p>Server 1:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.061.jpeg alt></p><p>Server 2:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.062.jpeg alt></p><p>We see that using public ip address we can connect, however we cannot use the private ips addresses of the machines:</p><p>Server 1:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.063.jpeg alt></p><p>Server 2:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.064.jpeg alt></p><p>It works properly as we have managed to get our Linux routers to be able to make SNAT and DNAT by making them &ldquo;use&rdquo; the Internet and access the resources of other networks. Since private addresses are not routed in them, so if we check using them, we won&rsquo;t get any results.</p><h3 id=nat-debugging>NAT Debugging</h3><p>To see how many hits you have had a rule or to see how much information you have &ldquo;used&rdquo; each rule will use the following command:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.065.jpeg alt></p><p>To delete the counters from all the chains and rules we will use iptables -Z:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.066.png alt></p><p>If our chain has hits the rule will be working properly if on the contrary it is kept in 0, the rule is not being applied so we will have to review it.</p><h3 id=scenario-with-cisco-routers>Scenario with Cisco routers</h3><p>We will repeat the same scenario as with the Linux routers but now using cisco routers 7200.</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.067.jpeg alt></p><h3 id=preparation-of-the-environment-1>Preparation of the environment</h3><h3 id=network-card-configuration-1>Network card configuration</h3><p>The first thing we will do is add the necessary slots to our routers as we need 2 network cards in R1, R2 and CASA. Exams of 3 for the ISP router.</p><p>For the former we will add the PA-FE-TX slot, which will add a FastEthernet interface:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.068.png alt></p><p>While for the ISP router we will add PA-2FE-TX that will add two FastEthernet network interfaces.</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.069.png alt></p><p>Now we can start the routers and start with the network card settings. I&rsquo;ll use the same directions as in the previous scenario.</p><p>Router CASA</p><p>We set the network cards:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.070.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.071.png alt></p><p>So we have our interfaces:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.072.png alt></p><p>Router R1</p><p>We set the network cards:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.073.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.074.png alt></p><p>So we have our interfaces:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.075.png alt></p><p>Router R2</p><p>We set the network cards:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.076.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.077.png alt></p><p>So we have our interfaces:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.078.png alt></p><p>Router ISP</p><p>We set the network cards:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.079.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.080.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.081.png alt></p><p>So we have our interfaces:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.082.png alt></p><h3 id=necessary-routes-1>necessary routes</h3><h3 id=isp-routes>ISP routes:</h3><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.083.png alt></p><h3 id=casa-routes>CASA Routes:</h3><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.084.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.085.png alt></p><p>Rocks R2:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.086.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.087.png alt></p><p>Rites R1:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.088.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.089.png alt></p><p>It would only be necessary to add the default routes to Reters R1, R2 and CASA.</p><h3 id=connectivity-test>Connectivity test</h3><p><strong>R1 - > R2</strong></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.090.png alt></p><p><strong>R1 - > CASA</strong></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.091.png alt></p><p><strong>R2- → R1</strong></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.092.png alt></p><p><strong>R2 - > CASA</strong></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.093.png alt></p><p><strong>CASA - > R1</strong></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.094.png alt></p><p><strong>CASA - > R2</strong></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.095.png alt></p><p>We see that all devices that have public ips addresses have connectivity between themselves but what happens to those that have private addresses on our stage, they will not have connectivity as no private addresses are routed on the internet routers.</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.096.png alt></p><p>DHCP service configuration in CASA router</p><p>The first thing we will do is to establish the range of IP&rsquo;s excluded from the set (pool) of addresses that the service can assign indicating the initial and final ip of the range, both including:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.097.png alt></p><p>We name the DHCP service range:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.098.png alt></p><p>We define the network to which DHCP will serve:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.099.png alt></p><p>We include the link door that the service will offer:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.100.png alt></p><p>With this the DHCP server of the CASA router would already be configured, we went out and saved the changes. We will now turn on our machines and see that they are will automatically receive their DHCP configuration, with the following command we can see the service statistics:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.101.png alt></p><p>We can also see the concessions with the following command:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.102.png alt></p><p>This will be useful for us to track who has assigned each IP without having to go individually home machine.</p><h3 id=nat-configuration-1>NAT configuration</h3><p>Router CASA</p><p>The first thing we will do is create an acl to allow the traffic we want to do SNAT:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.103.png alt></p><p>We will assign to the internal interface of our network this rule:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.104.png alt></p><p>Now we will create a pool with public ips, the command would be this does not come full in the terminal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip nat pool ip_publica 102.168.0.2 102.168.0.2 netmask 255.255.255.0 
</span></span></code></pre></div><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.105.png alt></p><p>We activate the NAT:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.106.png alt></p><p>We indicate that interface is &ldquo;inside&rdquo;:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.107.png alt></p><p>We indicate the &ldquo;out&rdquo; interface:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.108.png alt></p><p>The SNAT would be working, so let&rsquo;s check it out:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.109.png alt></p><p>We see that it changes the private ip of our host to the public of the home router.</p><p>Router R1</p><p>The first thing we will do is create an acl to allow the traffic we want to do SNAT:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.110.png alt></p><p>We will assign to the internal interface of our network this rule:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.111.png alt></p><p>Now we will create a pool with public ips, the command would be this does not come full in the terminal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip nat pool ip_publica 101.168.0.2 101.168.0.2 netmask 255.255.255.0 
</span></span></code></pre></div><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.112.png alt></p><p>We activate the NAT:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.113.png alt></p><p>We indicate that interface is &ldquo;inside&rdquo;:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.114.png alt></p><p>We indicate the &ldquo;out&rdquo; interface:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.115.png alt></p><p>And we&rsquo;ll check that it&rsquo;s being done correctly:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.116.png alt></p><p>We change the ip 172.22.1.1 to the 101.168.0.2 which is published by the router when performing a ping, so the SNAT is working properly.</p><p>We will now set the DNAT rule, the syntax is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip nat inside source static tcp ip_privada puerto ip_publica puerto
</span></span></code></pre></div><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.117.png alt></p><ul><li>We will then check that the DNAT works properly.</li></ul><p>Router R2</p><p>The first thing we will do is create an acl to allow the traffic we want to do SNAT:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.118.png alt></p><p>We will assign to the internal interface of our network this rule:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.119.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.120.png alt></p><p>Now we will create a pool with public ips, the command would be this does not come full in the terminal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip nat pool ip_publica 103.168.0.2 103.168.0.2 netmask 255.255.255.0 
</span></span></code></pre></div><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.121.png alt></p><p>We activate the NAT:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.122.png alt></p><p>We indicate that interface is &ldquo;inside&rdquo;:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.123.png alt></p><p>We indicate the &ldquo;out&rdquo; interface:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.124.png alt></p><p>And we&rsquo;ll check that it&rsquo;s being done correctly:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.125.png alt></p><ul><li>We change the ip 10.0.0.1 to the 103.168.0.2 which is published by the router when performing a ping, so the SNAT is working properly.</li></ul><p>We will now set the DNAT rule, the syntax is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip nat inside source static tcp ip_privada puerto ip_publica puerto
</span></span></code></pre></div><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.126.png alt></p><ul><li>We will then check that the DNAT works properly.</li></ul><h3 id=navigation-and-dnat-check-1>Navigation and DNAT check</h3><p>Now let&rsquo;s check that from the home network we can access the web servers.</p><p>I&rsquo;ll access using curl from a home network host. First I&rsquo;ll connect to server 1:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.127.png alt></p><p>We see that it responds correctly and the DNAT is applied, as it has changed the public ip of the router to the private web server:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.128.png alt></p><p>Now we&rsquo;ll check server 2:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.129.png alt></p><p>We see that it responds correctly and the DNAT is applied, as it has changed the public ip of the router to the private web server:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.130.png alt></p><p>We will now check that I can access both servers from a Tiny Core with Firefox:</p><p>To server 1:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.131.jpeg alt></p><p>To server 2:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.132.jpeg alt></p><p>We see that we can also connect as NAT rules are working properly.</p><p>Let&rsquo;s check what happens if we request the web through your private ip addresses:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.133.png alt></p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.134.png alt></p><p>Well, obviously we don&rsquo;t get an answer because in our stage we&rsquo;re simulating the Internet and in this one can&rsquo;t routtle private ips directions as they are can be repeated in infinity of networks.</p><h3 id=debugging-nat-rules>Debugging NAT rules</h3><p>Also to make sure NAT rules are working.</p><p>The first command allows us to view the DNAT address translation table:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.135.png alt></p><p>With this command we can see how many hits have our rules, if it has none, it&rsquo;s not working unless we have initialized this:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.136.png alt></p><p>If we want to put the counters to zero we will use the clear command ip nat statistics.</p><p>If we want to see in real time the packages that show information about each package that translates the router:</p><p><img src=/redes/configuracion_de_nat/img/Aspose.Words.5d96acd8-9177-4bad-9621-78ead201ec37.137.png alt></p><p>When decode the result of this command, observe the meanings of the following symbols and values:</p><p>-<strong>*</strong>: the asterisk next to NAT indicates that the translation is done on the fast switching route. The first package in a conversation always applies process switching, which is slower. If there is a cache input, the rest of the packages cross the fast switching route.
-<strong>S</strong>: This symbol refers to the original IPv4 address.
-<strong>a.b.c.d → w.x.y.z</strong>: this value indicates that the address of origin a.b.c.d is translated to w.x.y.z.
-<strong>d</strong>: = This symbol refers to the target IPv4 address.
-<strong>[xxxx]</strong>= The value in square brackets is the IPv4 identification number. This information may be useful for debugging, as it enables correlation with other package follow-up by protocol analysers.</p><h2 id=bibliography>Bibliography</h2><ul><li><a href=https://ccnadesdecero.es/solve-problems-nat-cisco/ target=_blank rel=noopener>NAT Depuration</a></li></ul></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f&text=NAT%20Cisco%20and%20Linux%20Configuration&via=Atlas" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f&title=NAT%20Cisco%20and%20Linux%20Configuration" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f&title=NAT%20Cisco%20and%20Linux%20Configuration" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=NAT%20Cisco%20and%20Linux%20Configuration https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=NAT%20Cisco%20and%20Linux%20Configuration&body=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fredes%2fconfiguracion_de_nat%2fconfiguracion_de_nat%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/javierasping/sentinel/edit/main/content/posts/redes/configuracion_de_nat/configuracion_de_nat.en.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#scenario-with-debian-machines>Scenario with debian machines</a></li><li><a href=#preparation-of-the-environment>Preparation of the environment</a></li><li><a href=#installation-of-packages>Installation of packages</a></li><li><a href=#network-card-configuration>Network card configuration</a></li><li><a href=#necessary-routes>necessary routes</a></li><li><a href=#connectivity-check>Connectivity check</a></li><li><a href=#nat-configuration>NAT configuration</a></li><li><a href=#navigation-and-dnat-check>Navigation and DNAT check</a></li><li><a href=#nat-debugging>NAT Debugging</a></li><li><a href=#scenario-with-cisco-routers>Scenario with Cisco routers</a></li><li><a href=#preparation-of-the-environment-1>Preparation of the environment</a></li><li><a href=#network-card-configuration-1>Network card configuration</a></li><li><a href=#necessary-routes-1>necessary routes</a></li><li><a href=#isp-routes>ISP routes:</a></li><li><a href=#casa-routes>CASA Routes:</a></li><li><a href=#connectivity-test>Connectivity test</a></li><li><a href=#nat-configuration-1>NAT configuration</a></li><li><a href=#navigation-and-dnat-check-1>Navigation and DNAT check</a></li><li><a href=#debugging-nat-rules>Debugging NAT rules</a></li></ul></li><li><a href=#bibliography>Bibliography</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#about>About Me</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#accomplishments>Certifications</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:contacto@javiercd.es target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>contacto@javiercd.es</span></a></li><li><a href=https://github.com/javierasping target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>javierasping</span></a></li><li><a href=https://www.linkedin.com/in/javiercd target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Francisco Javier Cruces Doval</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>Liability Notice:</strong> This theme is under MIT license. So, you can use it for non-commercial, commercial, or private uses. You can modify or distribute the theme without requiring any permission from the theme author. However, the theme author does not provide any warranty or takes any liability for any issue with the theme.</p></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu_b3360284c55cf72d.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2023 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.29119cfdb8d2f06f4caaea7b9908096b5c109c5174eab5fca7e4e0efb0ffcaa0.js integrity="sha256-KRGc/bjS8G9Mqup7mQgJa1wQnFF06rX8p+Tg77D/yqA=" defer></script></body></html>