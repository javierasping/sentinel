<!doctype html><html lang=en><head><title>Implementation of a perimeter firewall with Fortinet II</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.ddf4c4775d35e5bc3dd64c797b179f99eaf85cf9811e64bd08f8c44a68d0b229.css integrity="sha256-3fTEd1015bw91kx5exefmer4XPmBHmS9CPjESmjQsik="><link rel=icon type=image/png href=/images/site/avatar_hu_f10227dc088ad43a.jpg><meta property="og:title" content="Atlas"><meta property="og:type" content="website"><meta property="og:description" content="Portfolio and personal blog of Francisco Javier Cruces Doval"><meta property="og:image" content="/images/author/john.png"><meta property="og:url" content="https://www.javiercd.es"><meta name=description content="Implementation of a perimeter firewall with Fortinet II"><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/en><img src=/images/site/masthead_hu_f10227dc088ad43a.png id=logo alt=Logo>
Atlas</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/en#home>Home</a></li><li class=nav-item><a class=nav-link href=/en#about>About Me</a></li><li class=nav-item><a class=nav-link href=/en#skills>Skills</a></li><li class=nav-item><a class=nav-link href=/en#education>Education</a></li><li class=nav-item><a class=nav-link href=/en#recent-posts>Recent Posts</a></li><li class=nav-item><a class=nav-link href=/en#accomplishments>Certifications</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/en/posts>Posts</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=languageSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><span class="fi fi-gb"></span>
English</a><div class=dropdown-menu aria-labelledby=languageSelector><a class="dropdown-item nav-link languages-item" href=/posts/cortafuegos/fortinet_dos/fortinet_dos><span class="fi fi-es"></span>
Espa√±ol
</a><a class="dropdown-item nav-link languages-item" href=/en/posts/cortafuegos/fortinet_dos/fortinet_dos><span class="fi fi-gb"></span>
English</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/en/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/en/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/ci_cd/> CI / CD Jenkins</a><ul><li><a class=list-link href=/en/posts/ci_cd/practica_jenkins/ title="CI / CD practice with Jenkins">CI / CD practice with Jenkins</a></li><li><a class=list-link href=/en/posts/ci_cd/taller1_jenkins/ title="Workshop 1 Ortho-rector of markdown documents (test)">Workshop 1 Ortho-rector of markdown documents (test)</a></li><li><a class=list-link href=/en/posts/ci_cd/taller2_jenkins/ title="Workshop 2 Valid HTML5 check and surge.sh deployment (test and deploy)">Workshop 2 Valid HTML5 check and surge.sh deployment (test and deploy)</a></li><li><a class=list-link href=/en/posts/ci_cd/taller3_jenkins/ title="Workshop 3 Continuous integration of django application (Test)">Workshop 3 Continuous integration of django application (Test)</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/base_de_datos/> Database</a><ul><li><a class=list-link href=/en/posts/base_de_datos/instalar_mariadb/ title="Install MariaDB in Debian">Install MariaDB in Debian</a></li><li><a class=list-link href=/en/posts/base_de_datos/interconexion_de_servidores/ title="Interconnection of database servers">Interconnection of database servers</a></li><li><a class=list-link href=/en/posts/base_de_datos/instalacion_oracle_19c_debian12/ title="Oracle 19c installation under Debian 12">Oracle 19c installation under Debian 12</a></li><li><a class=list-link href=/en/posts/base_de_datos/instalar_postgresql/ title="PostgreSQL installation in Debian 12">PostgreSQL installation in Debian 12</a></li><li><a class=list-link href=/en/posts/base_de_datos/oracle_acceso_remoto/ title="Remote access configuration in Oracle">Remote access configuration in Oracle</a></li><li><a class=list-link href=/en/posts/base_de_datos/acceso_remoto_mariadb/ title="Remote access in MariaDB">Remote access in MariaDB</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/docker/> Docker</a><ul><li><a class=list-link href=/en/posts/docker/instalar_docker_compose/ title="Docker Compose Installation on Ubuntu 24">Docker Compose Installation on Ubuntu 24</a></li><li><a class=list-link href=/en/posts/docker/instalar_docker_ubuntu24/ title="Docker Installation on Ubuntu 24">Docker Installation on Ubuntu 24</a></li><li><a class=list-link href=/en/posts/docker/taller1/ title="Workshop 1 Storage and networks in Docker">Workshop 1 Storage and networks in Docker</a></li><li><a class=list-link href=/en/posts/docker/taller2/ title="Workshop 2 Multicontainer Scenarios in Docker">Workshop 2 Multicontainer Scenarios in Docker</a></li><li><a class=list-link href=/en/posts/docker/taller3/ title="Workshop 3 Image creation Docker">Workshop 3 Image creation Docker</a></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/en/posts/cortafuegos/> Firewall</a><ul class=active><li><a class=list-link href=/en/posts/cortafuegos/fortinet_cli/ title="Fortinet CLI">Fortinet CLI</a></li><li><a class=list-link href=/en/posts/cortafuegos/fortinet_uno/ title="Perimetral with Fortinet I">Perimetral with Fortinet I</a></li><li><a class="active list-link" href=/en/posts/cortafuegos/fortinet_dos/ title="Perimetral with Fortinet II">Perimetral with Fortinet II</a></li><li><a class=list-link href=/en/posts/cortafuegos/nftables_uno/ title="Perimetral with Nftables I">Perimetral with Nftables I</a></li><li><a class=list-link href=/en/posts/cortafuegos/nftables_dos/ title="Perimetral with Nftables II">Perimetral with Nftables II</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/drivers/> Linux Drivers</a><ul><li><a class=list-link href=/en/posts/drivers/nvidia_driver/ title="Drivers Nvidia">Drivers Nvidia</a></li><li><a class=list-link href=/en/posts/drivers/nvidia_optimus/ title="How to choose which graph to use on my laptop with Linux">How to choose which graph to use on my laptop with Linux</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/redes/> Networks</a><ul><li><a class=list-link href=/en/posts/redes/android_gns3/ title="Android GNS3-KVM">Android GNS3-KVM</a></li><li><a class=list-link href=/en/posts/redes/escenario_ipv6_basico/ title="Basic IPv6 scenario">Basic IPv6 scenario</a></li><li><a class=list-link href=/en/posts/redes/instalacion_wireshark_gns3/ title="GNS3 and Wireshark installation">GNS3 and Wireshark installation</a></li><li><a class=list-link href=/en/posts/redes/instalar_gns3_debian12/ title="GNS3 installation in Debian 12">GNS3 installation in Debian 12</a></li><li><a class=list-link href=/en/posts/redes/switches_gns3/ title="GNS3 switch configuration">GNS3 switch configuration</a></li><li><a class=list-link href=/en/posts/redes/tuneles_ipv6/ title="IPV6 Tunnels">IPV6 Tunnels</a></li><li><a class=list-link href=/en/posts/redes/configuracion_de_nat/ title="NAT in Cisco and Linux">NAT in Cisco and Linux</a></li><li><a class=list-link href=/en/posts/redes/comandos_de_supervision_de_redes/ title="Network monitoring commands">Network monitoring commands</a></li><li><a class=list-link href=/en/posts/redes/enroutamiento_openstack/ title="OpenStack routing">OpenStack routing</a></li><li><a class=list-link href=/en/posts/redes/arp/ title="Protocol ARP">Protocol ARP</a></li><li><a class=list-link href=/en/posts/redes/underworld/ title=Underworld>Underworld</a></li><li><a class=list-link href=/en/posts/redes/underworld_evolution/ title="Underworld evolution">Underworld evolution</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/observabilidad/> Observability</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/observabilidad/metricas/> Metrics</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/observabilidad/metricas/prometheus/> Prometheus</a><ul><li><a class=list-link href=/en/posts/observabilidad/metricas/prometheus/instalacion_basica_docker_compose/ title="Installation of Prometheus with Docker Compose and Node Exporter on Debian 12">Installation of Prometheus with Docker Compose and Node Exporter on Debian 12</a></li></ul></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/seguridad/> Security</a><ul><li><a class=list-link href=/en/posts/seguridad/forense/ title="Forensic computer">Forensic computer</a></li><li><a class=list-link href=/en/posts/seguridad/https_autofirmado/ title=HTTPS>HTTPS</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/> Services</a><ul><li><a class=list-link href=/en/posts/servicios/apache/ title=Apache>Apache</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/dhcp/> DHCP</a><ul><li><a class=list-link href=/en/posts/servicios/dhcp/instalacion_y_configuracion_de_un_servidor_dhcp_en_linux/ title="Installation and Configuration of a DHCP Server on Linux">Installation and Configuration of a DHCP Server on Linux</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/dns/> DNS</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/dns/bind9/> BIND9</a><ul><li><a class=list-link href=/en/posts/servicios/dns/bind9/dns_esclavo/ title="Configuring a Slave DNS Server with BIND9">Configuring a Slave DNS Server with BIND9</a></li><li><a class=list-link href=/en/posts/servicios/dns/bind9/instalacion_basica/ title="Installation and Configuration of BIND9 on Linux">Installation and Configuration of BIND9 on Linux</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/dns/dnsmasq/> DNSMASQ</a><ul><li><a class=list-link href=/en/posts/servicios/dns/dnsmasq/instalacion_basica/ title="Local Server with DNSMasq">Local Server with DNSMasq</a></li></ul></li></ul></li><li><a class=list-link href=/en/posts/servicios/ftp/ title=FTP>FTP</a></li><li><a class=list-link href=/en/posts/servicios/nat_iptables/ title="NAT with iptables">NAT with iptables</a></li><li><a class=list-link href=/en/posts/servicios/ssh/ title=SSH>SSH</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/> Systems</a><ul><li><a class=list-link href=/en/posts/sistemas/ad_ubuntu/ title="Active Directory in Ubuntu">Active Directory in Ubuntu</a></li><li><a class=list-link href=/en/posts/sistemas/recoleccion_logs_journald/ title="Centralized collection of logs journald">Centralized collection of logs journald</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/compilaciones_linux/> Compilations in LINUX</a><ul><li><a class=list-link href=/en/posts/sistemas/compilaciones_linux/compilacion_de_un_programa_en_c_utilizando_un_makefile/ title="Compilation of a C-program using a Makefile">Compilation of a C-program using a Makefile</a></li><li><a class=list-link href=/en/posts/sistemas/compilaciones_linux/compilacion_de_un_kernel/ title="Compilation of a kernel">Compilation of a kernel</a></li></ul></li><li><a class=list-link href=/en/posts/sistemas/creacion_de_un_sistema_automatizado_de_instalacion/ title="Creation of an automated installation system">Creation of an automated installation system</a></li><li><a class=list-link href=/en/posts/sistemas/samba_debian/ title="Install and configure samba in Debian">Install and configure samba in Debian</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/comandos_linux/> Linux Command</a><ul><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_de_modificacion_de_parametros_del_kernel/ title="Kernel parameter modification exercises">Kernel parameter modification exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/comandos_procesos/ title="Linux processes">Linux processes</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_de_manejo_de_modulos/ title="Module management exercises">Module management exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/gestion_de_paquetes/ title="Package management">Package management</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/empaquetadores_compresores/ title="Packaging and compressors">Packaging and compressors</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_gestion_de_paqueteria/ title="Paid management exercises">Paid management exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/programacion_tareas/ title="Task programming">Task programming</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/migraciones/> Migration in Linnux</a><ul><li><a class=list-link href=/en/posts/sistemas/migraciones/migracion_sistema_de_ficheros/ title="File system">File system</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/paso_de_centos_stream_8_a_centos_stream_9/ title="Migtation from CentOS stream 8 to CentOS stream 9">Migtation from CentOS stream 8 to CentOS stream 9</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/eliminacion_systemd/ title="Systemd elimination">Systemd elimination</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/transformacion_instancia_cloud/ title="Transformation instance cloud">Transformation instance cloud</a></li></ul></li><li><a class=list-link href=/en/posts/sistemas/nfs_debian/ title="NFS in Debian">NFS in Debian</a></li><li><a class=list-link href=/en/posts/sistemas/activacion_selinux/ title="SELinux activation configuration">SELinux activation configuration</a></li><li><a class=list-link href=/en/posts/sistemas/comparticion_de_directorios_en_windows/ title="Share resources in Windows">Share resources in Windows</a></li><li><a class=list-link href=/en/posts/sistemas/ssh_windows/ title="Ssh service in Windows">Ssh service in Windows</a></li><li><a class=list-link href=/en/posts/sistemas/almacenamiento_servidor_independiente/ title="Storage Spaces in Windows Server">Storage Spaces in Windows Server</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/vpn/> VPN</a><ul><li><a class=list-link href=/en/posts/vpn/comparativa_ovpn_wire/ title="OpenVPN and Wireguard Comparative">OpenVPN and Wireguard Comparative</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_openvpn/ title="OpenVPN remote access">OpenVPN remote access</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_strongswang/ title="Remote access Ipsec StrongSwan">Remote access Ipsec StrongSwan</a></li><li><a class=list-link href=/en/posts/vpn/ipsec_cisco/ title="Site-to-Site IPsec Cisco">Site-to-Site IPsec Cisco</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_fortinet/ title="Site-to-Site IPsec Fortinet">Site-to-Site IPsec Fortinet</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_openvpn/ title="Site-to-Site OpenVPN">Site-to-Site OpenVPN</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_wireguard/ title="Site-to-Site Wireguard">Site-to-Site Wireguard</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_wireguard/ title="Wireguard remote access">Wireguard remote access</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/iaw/> Web applications</a><ul><li><a class=list-link href=/en/posts/iaw/lamp/ title="LAMP stack installation">LAMP stack installation</a></li><li><a class=list-link href=/en/posts/iaw/lemp/ title="LEMP stack installation">LEMP stack installation</a></li><li><a class=list-link href=/en/posts/iaw/wordpress/ title="WordPress LAMP">WordPress LAMP</a></li><li><a class=list-link href=/en/posts/iaw/wordpress_lemp/ title="WordPress LEMP">WordPress LEMP</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/cortafuegos/fortinet2.png)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/john_hu_2aff0fda0501496d.png alt="Author Image"><h5 class=author-name>Francisco Javier Cruces Doval</h5><p class=text-muted>Thursday, March 28, 2024 | 16 minutes</p></div><div class=title><h1>Implementation of a perimeter firewall with Fortinet II</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/en/tags/firewall/ class="btn btn-sm btn-info">FIREWALL</a></li><li class=rounded><a href=/en/tags/linux/ class="btn btn-sm btn-info">LINUX</a></li><li class=rounded><a href=/en/tags/debian/ class="btn btn-sm btn-info">DEBIAN</a></li><li class=rounded><a href=/en/tags/fortinet/ class="btn btn-sm btn-info">FORTINET</a></li></ul></div><div class=post-content id=post-content><p>Now let&rsquo;s emulate firewall practice II, but on GNS3. To this end, I have transformed client 1 into Odin, and added Thor and Loki as virtual machines instead of containers on the LAN network. I have also created a new network called DMZ, in which will be the Hela machine.</p><p>Since I have transformed the previous scenario into this new one, we have some rules created earlier. Therefore, I will remove from the statement those that are already created, such as making SSH to Odin from port 2222, but with the service listening in the 22.</p><p>In addition, we are now going to make DHCP reservations to have the IP of the new machines controlled.</p><p>In addition to not counting on the services mounted on the old stage in Opsentack and for the rules of the enunciation I will mount the minimum to make the rules work.</p><p>Throughout this practice I will explain to you that by how the topology of the network is mounted, all of the LAN network can communicate with each other without the need to pass through the firewall. So in some exercises I&rsquo;ll skip the part about making Loki and Thor communicate with Odin. In addition I will not mount the DNS or LDAP server as the rules of DNAT are quite simple and along the practice several exercises of doing DNAT between the different networks appear. Instead I will add VPN at the end of it as I see it more interesting than repeating the same rules by changing the service.</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329110607.png alt></p><h3 id=stage-preparation>Stage preparation</h3><p>The first thing I will do is create a new network in port 3, which corresponds to the DMZ network.</p><p>As you will see in the image below I have selected the role to be LAN, to allow me to have a DHCP server on that network. As it is a network in which the services are housed, I don&rsquo;t want you to be able to access the firewall from this one, so I&rsquo;ll leave the administration off.</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329160410.png alt></p><p>Now I&rsquo;ll go access the new customers and change their machine name and set them up by DHCP.</p><p>Odin machine, this was previously client machine 1, you just need to change the FQDN and the hostel:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>osboxes@odin:~$ hostname -f
</span></span><span style=display:flex><span>odin.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>osboxes@odin:~$ ip -4 a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    altname enp0s3
</span></span><span style=display:flex><span>    inet 192.168.100.2/24 brd 192.168.100.255 scope global dynamic noprefixroute ens3
</span></span><span style=display:flex><span>       valid_lft 604790sec preferred_lft 604790sec
</span></span></code></pre></div><p>Thor machine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@thor:~$ hostname -f
</span></span><span style=display:flex><span>thor.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>debian@thor:~$ ip -4 a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    altname enp0s3
</span></span><span style=display:flex><span>    inet 192.168.100.4/24 brd 192.168.100.255 scope global dynamic ens3
</span></span><span style=display:flex><span>       valid_lft 604791sec preferred_lft 604791sec
</span></span><span style=display:flex><span>debian@thor:~$ 
</span></span></code></pre></div><p>Loki machine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@loki:~$ hostname -f
</span></span><span style=display:flex><span>loki.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>debian@loki:~$ ip -4 a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    altname enp0s3
</span></span><span style=display:flex><span>    inet 192.168.100.3/24 brd 192.168.100.255 scope global dynamic ens3
</span></span><span style=display:flex><span>       valid_lft 604724sec preferred_lft 604724sec
</span></span></code></pre></div><p>Hela machine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@hela:~$ hostname -f
</span></span><span style=display:flex><span>hela.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>debian@hela:~$ ip -4 a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    altname enp0s3
</span></span><span style=display:flex><span>    inet 192.168.200.2/24 brd 192.168.200.255 scope global dynamic ens3
</span></span><span style=display:flex><span>       valid_lft 604795sec preferred_lft 604795sec
</span></span></code></pre></div><p>Now we will make a reservation on the DHCP server, we will access Dashborad > Networks > DHCP, once here we will right click on each client of the 4 we have on the stage and create a reservation:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329162616.png alt></p><p>We will have a similar menu to this to link the MAC address to the IP:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329162730.png alt></p><p>Once we do this with our customers will tell us that we have the reservation made:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329162855.png alt></p><h3 id=firewall-rules>Firewall rules</h3><p>We&rsquo;re going to start creating the rules, as I said earlier we started from the previous stage, so some rules for the minimum operation of the network are created.</p><p>I&rsquo;ll leave you a capture of how the rules stayed, so you can see the state we&rsquo;re going to:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329163530.png alt></p><p>Some of the following rules are already set from the previous exercise, such as the following rule &ndash; > * The Odin machine has a ssh server listening to port 22, but when you access from the outside you will have to connect to port 2222 *</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~$ ssh osboxes@192.168.122.77 -p <span style=color:#ae81ff>2222</span>
</span></span><span style=display:flex><span>osboxes@192.168.122.77<span style=color:#960050;background-color:#1e0010>&#39;</span>s password: 
</span></span><span style=display:flex><span>Welcome to Ubuntu 22.04 LTS <span style=color:#f92672>(</span>GNU/Linux 5.15.0-25-generic x86_64<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> * Documentation:  https://help.ubuntu.com
</span></span><span style=display:flex><span> * Management:     https://landscape.canonical.com
</span></span><span style=display:flex><span> * Support:        https://ubuntu.com/advantage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>560</span> updates can be applied immediately.
</span></span><span style=display:flex><span><span style=color:#ae81ff>339</span> of these updates are standard security updates.
</span></span><span style=display:flex><span>To see these additional updates run: apt list --upgradable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Last login: Fri Mar <span style=color:#ae81ff>29</span> 11:23:44 <span style=color:#ae81ff>2024</span> from 192.168.100.1
</span></span><span style=display:flex><span>osboxes@odin:~$ hostname -f
</span></span><span style=display:flex><span>odin.javiercd.gonzalonazareno.org
</span></span></code></pre></div><p>Next you will see that there are some rules that I have removed or modified, as in the current scenario they cannot be done either by topology or because previously the Odin machine was the firewall. In any case I have maintained and explained some additional things.</p><h3 id=from-thor-and-hela-you-should-allow-the-ssh-connection-by-port-22-to-the-odin-machine>From Thor and Hela you should allow the ssh connection by port 22 to the Odin machine.</h3><p>This rule cannot be realized because by having a switch by interconnecting the devices, the traffic does not pass through the firewall so we cannot apply rules in the firewall to prevent local traffic.</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329170454.png alt></p><p>You see, even if he believes the rule, in the firewall, this one will not be immutated:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329170554.png alt></p><p>You see that for example if I connect from loki or thor I can get to odin:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@loki:~$ ssh osboxes@192.168.100.2
</span></span><span style=display:flex><span>osboxes@192.168.100.2<span style=color:#960050;background-color:#1e0010>&#39;</span>s password: 
</span></span><span style=display:flex><span>Welcome to Ubuntu 22.04 LTS <span style=color:#f92672>(</span>GNU/Linux 5.15.0-25-generic x86_64<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> * Documentation:  https://help.ubuntu.com
</span></span><span style=display:flex><span> * Management:     https://landscape.canonical.com
</span></span><span style=display:flex><span> * Support:        https://ubuntu.com/advantage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>560</span> updates can be applied immediately.
</span></span><span style=display:flex><span><span style=color:#ae81ff>339</span> of these updates are standard security updates.
</span></span><span style=display:flex><span>To see these additional updates run: apt list --upgradable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Last login: Fri Mar <span style=color:#ae81ff>29</span> 11:42:43 <span style=color:#ae81ff>2024</span> from 192.168.100.3
</span></span><span style=display:flex><span>osboxes@odin:~$ 
</span></span></code></pre></div><p>But I don&rsquo;t get it by the rule I&rsquo;ve created if not by the topology of the network itself, the rule has no hits:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329170725.png alt></p><p>The whole traffic is in charge of redirecting the swicht.</p><h3 id=the-odin-machine-can-be-ping-from-the-dmz-but-from-the-lan-the-connection-reject-must-be-rejected-and-from-the-outside-will-be-rejected-silently>The Odin machine can be ping from the DMZ, but from the LAN the connection (REJECT) must be rejected and from the outside will be rejected silently.</h3><p>To allow the DMZ network to do ping to Odin we will create the following rule:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329171345.png alt></p><p>Let&rsquo;s check that from the DMZ we can do the ping to Odin:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@hela:~$ ping 192.168.100.2 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.100.2 <span style=color:#f92672>(</span>192.168.100.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>2.38 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.100.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 2.379/2.379/2.379/0.000 ms
</span></span></code></pre></div><p>As we see the rule is working, so let&rsquo;s check the hits:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329171520.png alt></p><p>For the same reason as in the previous exercise, from the LAN network we cannot limit the ping to Odin as it does not pass through the firewall but through the switch.</p><p>Something similar happened to us from the WAN, as it is a ping directed to the IP of the interface this is disabled from the configuration of the interface, it is always rejected silently but does not give choice to choose it:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329172526.png alt></p><p>Once removed</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~$ ping 192.168.122.77 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.122.77 <span style=color:#f92672>(</span>192.168.122.77<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.122.77 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>0</span> received, 100% packet loss, time 0ms
</span></span></code></pre></div><h3 id=the-odin-machine-can-do-ping-to-the-lan-the-dmz-and-the-outside>The Odin machine can do ping to the LAN, the DMZ and the outside.</h3><p>The Odin machine by the topology itself can do ping to all the machines on the LAN as the traffic to this network passes through the swicht.</p><p>So that I can do ping to the DMZ and the WAN we&rsquo;ll create two rules:</p><p>The rule for the WAN:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329172816.png alt></p><p>The rule for DMZ:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329172903.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#LAN --&gt; WAN</span>
</span></span><span style=display:flex><span>osboxes@odin:~$ ping 8.8.8.8 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 8.8.8.8 <span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 8.8.8.8: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>114</span> time<span style=color:#f92672>=</span>10.1 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 8.8.8.8 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 10.088/10.088/10.088/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#LAN --&gt; DMZ</span>
</span></span><span style=display:flex><span>osboxes@odin:~$ ping 192.168.200.2 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.200.2 <span style=color:#f92672>(</span>192.168.200.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.200.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>0.804 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.200.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.804/0.804/0.804/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#LAN --&gt; LAN (No interviene el cortafuegos)</span>
</span></span><span style=display:flex><span>osboxes@odin:~$ ping 192.168.100.3 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.100.3 <span style=color:#f92672>(</span>192.168.100.3<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.3: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.503 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.100.3 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.503/0.503/0.503/0.000 ms
</span></span></code></pre></div><p>Let&rsquo;s check the hits of the two rules we just created:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329173231.png alt></p><h3 id=from-the-hela-machine-you-can-make-ping-and-ssh-connection-to-lan-machines>From the Hela machine you can make ping and ssh connection to LAN machines.</h3><p>To achieve this I will create the following rule. We could separate it into 2 separate rules to have the counters separately, but in this case it is not important to distinguish traffic.</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329173630.png alt></p><p>We will check the rule, doing a ping to the different machines of the LAN network, since previously there was a rule to allow all pings to Odin:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#HELA --&gt; ODIN</span>
</span></span><span style=display:flex><span>debian@hela:~$ ping 192.168.100.2 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.100.2 <span style=color:#f92672>(</span>192.168.100.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>1.10 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.100.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 1.101/1.101/1.101/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#HELA --&gt; LOKI</span>
</span></span><span style=display:flex><span>debian@hela:~$ ping 192.168.100.3 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.100.3 <span style=color:#f92672>(</span>192.168.100.3<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.3: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>1.73 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.100.3 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 1.730/1.730/1.730/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#HELA --&gt; THOR</span>
</span></span><span style=display:flex><span>debian@hela:~$ ping 192.168.100.4 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.100.4 <span style=color:#f92672>(</span>192.168.100.4<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.4: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>0.998 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.100.4 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.998/0.998/0.998/0.000 ms
</span></span></code></pre></div><p>Now let&rsquo;s check that we can connect by ssh from Hela to the LAN:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@hela:~$ ssh osboxes@192.168.100.2 <span style=color:#e6db74>&#39;hostname -f&#39;</span>
</span></span><span style=display:flex><span>osboxes@192.168.100.2<span style=color:#e6db74>&#39;s password: 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>odin.javiercd.gonzalonazareno.org
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>debian@hela:~$ ssh 192.168.100.3 &#39;</span>hostname -f<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>debian@192.168.100.3&#39;</span>s password: 
</span></span><span style=display:flex><span>loki.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>debian@hela:~$ ssh 192.168.100.4 <span style=color:#e6db74>&#39;hostname -f&#39;</span>
</span></span><span style=display:flex><span>debian@192.168.100.4<span style=color:#960050;background-color:#1e0010>&#39;</span>s password: 
</span></span><span style=display:flex><span>thor.javiercd.gonzalonazareno.org
</span></span></code></pre></div><p>The rule works properly, let&rsquo;s check that you&rsquo;ve uploaded the hits:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329174824.png alt></p><h3 id=from-any-lan-machine-you-can-connect-ssh-to-the-hela-machine>From any LAN machine you can connect ssh to the hela machine.</h3><p>For this we will create the following rule:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329175356.png alt></p><p>Now let&rsquo;s check the rule we just created:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>osboxes@odin:~$ ssh debian@192.168.200.2 <span style=color:#e6db74>&#39;hostname -f&#39;</span>
</span></span><span style=display:flex><span>debian@192.168.200.2<span style=color:#e6db74>&#39;s password: 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>hela.javiercd.gonzalonazareno.org
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>debian@loki:~$ ssh 192.168.200.2 &#39;</span>hostname -f<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>debian@192.168.200.2&#39;</span>s password: 
</span></span><span style=display:flex><span>hela.javiercd.gonzalonazareno.org
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>debian@thor:~$ ssh 192.168.200.2 <span style=color:#e6db74>&#39;hostname -f&#39;</span>
</span></span><span style=display:flex><span>debian@192.168.200.2<span style=color:#960050;background-color:#1e0010>&#39;</span>s password: 
</span></span><span style=display:flex><span>hela.javiercd.gonzalonazareno.org
</span></span></code></pre></div><p>Let&rsquo;s check that the rule hits have gone up:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329175844.png alt></p><h3 id=configure-the-odin-machine-so-that-lan-and-dmz-machines-can-access-the-outside>Configure the Odin machine so that LAN and DMZ machines can access the outside.</h3><p>The SNAT on this device can choose to activate it for each rule and not in general. If you have noticed throughout the practice all the rules that involve taking an interface jump I have marked the NAT box:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329180159.png alt></p><p>So this section is going to be done throughout practice as we create the rules.</p><h3 id=lan-machines-can-do-ping-outside-and-navigate>LAN machines can do ping outside and navigate.</h3><p>We&rsquo;re gonna have to create 3 rules:</p><ul><li>Allow HTTP / HTTPS traffic</li><li>Allow DNS queries</li><li>Allow to do ping</li></ul><p>Of these three rules the first two are previously created:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329184029.png alt></p><p>So we only have to add the ping rule, which would be the following:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329184222.png alt></p><p>Since I have a trial version I can have at most 10 entries, so I&rsquo;m going to remove the one that just lets Odin go outside.</p><p>Let&rsquo;s check the rules, from a LAN client:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>osboxes@odin:~$ dig @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.1-1ubuntu1-Ubuntu &lt;&lt;&gt;&gt; @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>; <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> server found<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#e6db74>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#ae81ff>25764</span>
</span></span><span style=display:flex><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;www.javiercd.es.		IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>www.javiercd.es.	3600	IN	CNAME	javierasping.github.io.
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.108.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.109.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.110.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.111.153
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#ae81ff>60</span> msec
</span></span><span style=display:flex><span>;; SERVER: 8.8.8.8#53<span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>UDP<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; WHEN: Fri Mar <span style=color:#ae81ff>29</span> 13:44:50 EDT <span style=color:#ae81ff>2024</span>
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: <span style=color:#ae81ff>144</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>osboxes@odin:~$ ping -c <span style=color:#ae81ff>1</span> www.javiercd.es
</span></span><span style=display:flex><span>PING javierasping.github.io <span style=color:#f92672>(</span>185.199.108.153<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from cdn-185-199-108-153.github.com <span style=color:#f92672>(</span>185.199.108.153<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>55</span> time<span style=color:#f92672>=</span>11.1 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- javierasping.github.io ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 11.111/11.111/11.111/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>osboxes@odin:~$ curl -I  https://www.javiercd.es/
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span> 
</span></span><span style=display:flex><span>server: GitHub.com
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>last-modified: Mon, <span style=color:#ae81ff>11</span> Mar <span style=color:#ae81ff>2024</span> 23:21:37 GMT
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>31556952</span>
</span></span><span style=display:flex><span>etag: <span style=color:#e6db74>&#34;65ef9201-6878&#34;</span>
</span></span><span style=display:flex><span>expires: Fri, <span style=color:#ae81ff>29</span> Mar <span style=color:#ae81ff>2024</span> 17:56:01 GMT
</span></span><span style=display:flex><span>cache-control: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>x-proxy-cache: MISS
</span></span><span style=display:flex><span>x-github-request-id: AE88:3308D5:438AA74:448F970:6606FE58
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>date: Fri, <span style=color:#ae81ff>29</span> Mar <span style=color:#ae81ff>2024</span> 17:46:01 GMT
</span></span><span style=display:flex><span>via: 1.1 varnish
</span></span><span style=display:flex><span>age: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>x-served-by: cache-mad2200143-MAD
</span></span><span style=display:flex><span>x-cache: MISS
</span></span><span style=display:flex><span>x-cache-hits: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>x-timer: S1711734362.862201,VS0,VE134
</span></span><span style=display:flex><span>vary: Accept-Encoding
</span></span><span style=display:flex><span>x-fastly-request-id: 16b6048f2b032ef4b4293c52f0ae36d19b0e0da0
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>26744</span>
</span></span></code></pre></div><p>So would our three rules, we&rsquo;ll see that we have hits on them:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329184410.png alt></p><h3 id=the-hela-machine-can-sail-install-a-web-server-a-ftp-server-and-a-post-server-if-you-dont-have-them-yet>The hela machine can sail. Install a web server, a ftp server and a post server if you don&rsquo;t have them yet.</h3><p>To do this it is necessary to have allowed DNS and navigation. To this end, I have created the following rule:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329184830.png alt></p><p>I have created it in a single rule to save on the number of them, I have deleted those that allowed ping from DMZ to LAN from previous exercises.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@hela:~$ sudo apt install proftpd postfix apache2 -y
</span></span></code></pre></div><h3 id=configure-the-odin-machine-to-make-web-and-ftp-services-accessible-from-the-outside>Configure the Odin machine to make web and ftp services accessible from the outside.</h3><p>To do the DNAT we must create 2 virtual PIs, as we did in firewalls I.</p><p>One for every service we want to do a DNAT. For the web server:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329190416.png alt></p><p>And for the FTP server:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329190509.png alt></p><p>Now we are going to create the very DNAT rule for the web server, in which as a destination we indicate the virtual IP that we just created:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329191130.png alt></p><p>We will see that if we access the WAN firewall IP we will access the Hela Apache:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329191232.png alt></p><p>We will also create the DNAT rule for the FTP server:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329191852.png alt></p><p>Let&rsquo;s check access to the ftp server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~$ ftp debian@192.168.122.77
</span></span><span style=display:flex><span>Connected to 192.168.122.77.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> ProFTPD Server <span style=color:#f92672>(</span>Debian<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>::ffff:192.168.200.2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>331</span> Password required <span style=color:#66d9ef>for</span> debian
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span><span style=color:#ae81ff>230</span> User debian logged in
</span></span><span style=display:flex><span>Remote system type is UNIX.
</span></span><span style=display:flex><span>Using binary mode to transfer files.
</span></span><span style=display:flex><span>ftp&gt;
</span></span></code></pre></div><p>If we check the rules&rsquo; hits, we&rsquo;ll see that both of them have gone up:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329192338.png alt></p><h3 id=the-web-server-and-the-ftp-server-must-be-accessible-from-the-lan-and-from-the-outside>The web server and the ftp server must be accessible from the LAN and from the outside.</h3><p>To perform this exercise we will have to regenerate the 2 virtual IPs but now we will indicate the IP of the LAN card of the firewall.</p><p>For the DNAT of the web server:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329192709.png alt></p><p>We will repeat the same for the FTP service, changing the service:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329192818.png alt></p><p>We will now create the two DNAT rules to allow access from the LAN.</p><p>For the web server:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193041.png alt></p><p>For the FTP server:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193132.png alt></p><p>Let&rsquo;s check that we can access both services:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>osboxes@odin:~$ curl -I  http://192.168.100.1
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Date: Fri, <span style=color:#ae81ff>29</span> Mar <span style=color:#ae81ff>2024</span> 18:31:59 GMT
</span></span><span style=display:flex><span>Server: Apache/2.4.57 <span style=color:#f92672>(</span>Debian<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Last-Modified: Fri, <span style=color:#ae81ff>29</span> Mar <span style=color:#ae81ff>2024</span> 17:53:38 GMT
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;29cd-614d051d4d640&#34;</span>
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>10701</span>
</span></span><span style=display:flex><span>Vary: Accept-Encoding
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>osboxes@odin:~$ ftp debian@192.168.100.1
</span></span><span style=display:flex><span>Connected to 192.168.100.1.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> ProFTPD Server <span style=color:#f92672>(</span>Debian<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>::ffff:192.168.200.2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>331</span> Password required <span style=color:#66d9ef>for</span> debian
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span><span style=color:#ae81ff>230</span> User debian logged in
</span></span><span style=display:flex><span>Remote system type is UNIX.
</span></span><span style=display:flex><span>Using binary mode to transfer files.
</span></span></code></pre></div><p>Let&rsquo;s check that the hits are up in the rules:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193324.png alt></p><h3 id=the-post-server-should-only-be-accessible-from-the-lan>The post server should only be accessible from the LAN.</h3><p>We repeat the same steps, we will create a virtual IP to make the DNAT rule:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193427.png alt></p><p>Now let&rsquo;s create the DNAT rule:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193724.png alt></p><p>And we&rsquo;ll check that from a LAN PC doing a telnet we get to the post server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>osboxes@odin:~$ telnet 192.168.100.1 <span style=color:#ae81ff>25</span>
</span></span><span style=display:flex><span>Trying 192.168.100.1...
</span></span><span style=display:flex><span>Connected to 192.168.100.1.
</span></span><span style=display:flex><span>Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> hela.javiercd.gonzalonazareno.org ESMTP Postfix <span style=color:#f92672>(</span>Debian/GNU<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>quit
</span></span><span style=display:flex><span><span style=color:#ae81ff>221</span> 2.0.0 Bye
</span></span><span style=display:flex><span>Connection closed by foreign host.
</span></span></code></pre></div><p>We&rsquo;ll see that the hit of the rule has gone up:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329193822.png alt></p><h3 id=in-the-loki-machine-you-install-a-postgres-server-if-you-dont-have-it-yet-this-server-can-be-accessed-from-the-dmz-but-not-from-the-outside>In the Loki machine you install a Postgres server if you don&rsquo;t have it yet. This server can be accessed from the DMZ, but not from the outside.</h3><p>We will repeat the process of creating a new virtual IP for this service. In addition in this case I have had to create the service as it did not exist.</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329195211.png alt></p><p>Let&rsquo;s create the DNAT rule:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329200331.png alt></p><p>Let&rsquo;s check that we have access to the pgsql server from the DMZ network:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@hela:~$ psql -h 192.168.200.1 -U postgres -W
</span></span><span style=display:flex><span>Password: 
</span></span><span style=display:flex><span>psql <span style=color:#f92672>(</span>15.6 <span style=color:#f92672>(</span>Debian 15.6-0+deb12u1<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>SSL connection <span style=color:#f92672>(</span>protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> help.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres<span style=color:#f92672>=</span><span style=color:#75715e># \q</span>
</span></span></code></pre></div><p>We&rsquo;ll check that the rule has hits:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329200721.png alt></p><h2 id=-avoid-dos-attacks-by-icmp-flood-limiting-the-number-of-requests-per-second-to-4-from-the-same-ip># Avoid DoS attacks by ICMP Flood, limiting the number of requests per second to 4 from the same IP.</h2><p>Within the policy and object section, we find a section to create policies for DoS. In my case I have created one with the recommended values given by the manufacturer. And I&rsquo;ve changed the ICMP Flood limit to 4 packages per second.</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329203201.png alt></p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329203221.png alt></p><p>Let&rsquo;s check that traffic blocks us if we get over that limit. With this command we are sending 3 packages per second that is less than the established limit so do not cut any packages:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@loki:~$ sudo hping3 --icmp  -i u333333 -V 192.168.100.1
</span></span><span style=display:flex><span>--- 192.168.100.1 hping statistic ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>124</span> packets transmitted, <span style=color:#ae81ff>124</span> packets received, 0% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max <span style=color:#f92672>=</span> 0.7/5.3/9.9 ms
</span></span></code></pre></div><p>If we increase the packages per second, it will block all the packages that exceed 4 per second, so it will pass the first 4 of each second:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@loki:~$ sudo hping3 --icmp  -i u200000 -V 192.168.100.1
</span></span><span style=display:flex><span>--- 192.168.100.1 hping statistic ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>44</span> packets transmitted, <span style=color:#ae81ff>10</span> packets received, 78% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max <span style=color:#f92672>=</span> 4.6/5.5/6.5 ms
</span></span></code></pre></div><p>The firewall has recorded as an anomaly the traffic that has dropped:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240329224119.png alt></p><p>Avoid DoS attacks by SYN Flood.</p><p>With the filter we have activated in the previous exercise we have limited TCP requests to 2000 per minute from the same IP to avoid this type of attack. We see that the filter eliminates malicious requests and does not allow the attack to have effect:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@loki:~$ sudo hping3 --flood --rand-source -V 192.168.100.1
</span></span><span style=display:flex><span>using ens3, addr: 192.168.100.3, MTU: <span style=color:#ae81ff>1500</span>
</span></span><span style=display:flex><span>HPING 192.168.100.1 <span style=color:#f92672>(</span>ens3 192.168.100.1<span style=color:#f92672>)</span>: NO FLAGS are set, <span style=color:#ae81ff>40</span> headers + <span style=color:#ae81ff>0</span> data bytes
</span></span><span style=display:flex><span>hping in flood mode, no replies will be shown
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 192.168.100.1 hping statistic ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>930716</span> packets transmitted, <span style=color:#ae81ff>0</span> packets received, 100% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max <span style=color:#f92672>=</span> 0.0/0.0/0.0 ms
</span></span></code></pre></div><h3 id=it-prevents-them-from-doing-port-scans-to-odin>It prevents them from doing port scans to Odin.</h3><p>Instead of doing it to Odin by the topology itself, we&rsquo;re going to do it to avoid scanning from the WAN.</p><p>For this we open a terminal and what we are going to do is create a signature of IPS to avoid packages with a certain flag using a given scan. In this case we will avoid scanning NMAP XMAS.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>FTG <span style=color:#75715e># config ips custom</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FTG <span style=color:#f92672>(</span>custom<span style=color:#f92672>)</span> <span style=color:#75715e># edit &#34;Block_xmas&#34;</span>
</span></span><span style=display:flex><span>new entry <span style=color:#e6db74>&#39;Block_xmas&#39;</span> added
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FTG <span style=color:#f92672>(</span>Block_xmas<span style=color:#f92672>)</span> <span style=color:#75715e># set signature &#34;F-SBID(--name &#39;Block_xmas&#39;; --protocol tcp; --flow from_client; --tcp_flags *FUP; )&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FTG <span style=color:#f92672>(</span>Block_xmas<span style=color:#f92672>)</span> <span style=color:#75715e># set action block</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FTG <span style=color:#f92672>(</span>Block_xmas<span style=color:#f92672>)</span> <span style=color:#75715e>#  end</span>
</span></span></code></pre></div><p>Once configured, we will see the rule that we have created in PIs signs:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330185917.png alt></p><p>Now we&rsquo;re going to create an IPS rule to associate it with this signature policy:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330190210.png alt></p><p>We will add in IPS signs and filters, the new filter we have created before:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330190138.png alt></p><p>Next in the DNAT rules where we want to control that do not know which ports we have open, we will assign the new IPS policy:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330190438.png alt></p><p>In my case we&rsquo;re going to try it for the DNAT rule of ssh:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330190507.png alt></p><p>If I launch the NMAP from my host that is on the WAN network, we see that the 2222 port that this rule has open does not detect it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~$ sudo nmap -sX 192.168.122.77
</span></span><span style=display:flex><span>Starting Nmap 7.93 <span style=color:#f92672>(</span> https://nmap.org <span style=color:#f92672>)</span> at 2024-03-30 19:05 CET
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#66d9ef>for</span> 192.168.122.77
</span></span><span style=display:flex><span>Host is up <span style=color:#f92672>(</span>0.00059s latency<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>All <span style=color:#ae81ff>1000</span> scanned ports on 192.168.122.77 are in ignored states.
</span></span><span style=display:flex><span>Not shown: <span style=color:#ae81ff>1000</span> open|filtered tcp ports <span style=color:#f92672>(</span>no-response<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>MAC Address: 0C:18:45:93:00:00 <span style=color:#f92672>(</span>Unknown<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Nmap <span style=color:#66d9ef>done</span>: <span style=color:#ae81ff>1</span> IP address <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> host up<span style=color:#f92672>)</span> scanned in 21.28 seconds
</span></span></code></pre></div><p>And the firewall itself will warn us that there has been a port scan that has blocked, to see this go to Log & Report > Intrusion prevention:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330191024.png alt></p><p>We can select it for more details:</p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330191131.png alt></p><p><img src=/cortafuegos/fortinet_dos/img/Pastedimage20240330191146.png alt></p></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f&text=Implementation%20of%20a%20perimeter%20firewall%20with%20Fortinet%20II&via=Atlas" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f&title=Implementation%20of%20a%20perimeter%20firewall%20with%20Fortinet%20II" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f&title=Implementation%20of%20a%20perimeter%20firewall%20with%20Fortinet%20II" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=Implementation%20of%20a%20perimeter%20firewall%20with%20Fortinet%20II https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=Implementation%20of%20a%20perimeter%20firewall%20with%20Fortinet%20II&body=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2ffortinet_dos%2ffortinet_dos%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/javierasping/sentinel/edit/main/content/posts/cortafuegos/fortinet_dos/fortinet_dos.en.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#stage-preparation>Stage preparation</a></li><li><a href=#firewall-rules>Firewall rules</a></li><li><a href=#from-thor-and-hela-you-should-allow-the-ssh-connection-by-port-22-to-the-odin-machine>From Thor and Hela you should allow the ssh connection by port 22 to the Odin machine.</a></li><li><a href=#the-odin-machine-can-be-ping-from-the-dmz-but-from-the-lan-the-connection-reject-must-be-rejected-and-from-the-outside-will-be-rejected-silently>The Odin machine can be ping from the DMZ, but from the LAN the connection (REJECT) must be rejected and from the outside will be rejected silently.</a></li><li><a href=#the-odin-machine-can-do-ping-to-the-lan-the-dmz-and-the-outside>The Odin machine can do ping to the LAN, the DMZ and the outside.</a></li><li><a href=#from-the-hela-machine-you-can-make-ping-and-ssh-connection-to-lan-machines>From the Hela machine you can make ping and ssh connection to LAN machines.</a></li><li><a href=#from-any-lan-machine-you-can-connect-ssh-to-the-hela-machine>From any LAN machine you can connect ssh to the hela machine.</a></li><li><a href=#configure-the-odin-machine-so-that-lan-and-dmz-machines-can-access-the-outside>Configure the Odin machine so that LAN and DMZ machines can access the outside.</a></li><li><a href=#lan-machines-can-do-ping-outside-and-navigate>LAN machines can do ping outside and navigate.</a></li><li><a href=#the-hela-machine-can-sail-install-a-web-server-a-ftp-server-and-a-post-server-if-you-dont-have-them-yet>The hela machine can sail. Install a web server, a ftp server and a post server if you don&rsquo;t have them yet.</a></li><li><a href=#configure-the-odin-machine-to-make-web-and-ftp-services-accessible-from-the-outside>Configure the Odin machine to make web and ftp services accessible from the outside.</a></li><li><a href=#the-web-server-and-the-ftp-server-must-be-accessible-from-the-lan-and-from-the-outside>The web server and the ftp server must be accessible from the LAN and from the outside.</a></li><li><a href=#the-post-server-should-only-be-accessible-from-the-lan>The post server should only be accessible from the LAN.</a></li><li><a href=#in-the-loki-machine-you-install-a-postgres-server-if-you-dont-have-it-yet-this-server-can-be-accessed-from-the-dmz-but-not-from-the-outside>In the Loki machine you install a Postgres server if you don&rsquo;t have it yet. This server can be accessed from the DMZ, but not from the outside.</a></li></ul></li><li><a href=#-avoid-dos-attacks-by-icmp-flood-limiting-the-number-of-requests-per-second-to-4-from-the-same-ip># Avoid DoS attacks by ICMP Flood, limiting the number of requests per second to 4 from the same IP.</a><ul><li><a href=#it-prevents-them-from-doing-port-scans-to-odin>It prevents them from doing port scans to Odin.</a></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#about>About Me</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#accomplishments>Certifications</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:contacto@javiercd.es target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>contacto@javiercd.es</span></a></li><li><a href=https://github.com/javierasping target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>javierasping</span></a></li><li><a href=https://www.linkedin.com/in/javiercd target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Francisco Javier Cruces Doval</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>Liability Notice:</strong> This theme is under MIT license. So, you can use it for non-commercial, commercial, or private uses. You can modify or distribute the theme without requiring any permission from the theme author. However, the theme author does not provide any warranty or takes any liability for any issue with the theme.</p></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu_b3360284c55cf72d.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">¬© 2023 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.29119cfdb8d2f06f4caaea7b9908096b5c109c5174eab5fca7e4e0efb0ffcaa0.js integrity="sha256-KRGc/bjS8G9Mqup7mQgJa1wQnFF06rX8p+Tg77D/yqA=" defer></script></body></html>