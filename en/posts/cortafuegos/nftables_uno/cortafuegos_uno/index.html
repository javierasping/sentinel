<!doctype html><html lang=en><head><title>Implementation of a perimeter firewall with Nftables I</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.ddf4c4775d35e5bc3dd64c797b179f99eaf85cf9811e64bd08f8c44a68d0b229.css integrity="sha256-3fTEd1015bw91kx5exefmer4XPmBHmS9CPjESmjQsik="><link rel=icon type=image/png href=/images/site/avatar_hu_f10227dc088ad43a.jpg><meta property="og:url" content="https://www.javiercd.es/en/posts/cortafuegos/nftables_uno/cortafuegos_uno/"><meta property="og:site_name" content="Atlas"><meta property="og:title" content="Implementation of a perimeter firewall with Nftables I"><meta property="og:description" content="Implementation of a perimeter firewall with Nftables"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-28T10:00:00+00:00"><meta property="article:modified_time" content="2024-03-28T10:00:00+00:00"><meta property="article:tag" content="FIREWALL"><meta property="article:tag" content="LINUX"><meta property="article:tag" content="DEBIAN"><meta property="article:tag" content="NFTABLES"><meta name=twitter:card content="summary"><meta name=twitter:title content="Implementation of a perimeter firewall with Nftables I"><meta name=twitter:description content="Implementation of a perimeter firewall with Nftables"><meta name=description content="Implementation of a perimeter firewall with Nftables"><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script>theme=localStorage.getItem("darkmode:color-scheme")||"system",theme=="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/en><img src=/images/site/masthead_hu_f10227dc088ad43a.png id=logo alt=Logo>
Atlas</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/en#home>Home</a></li><li class=nav-item><a class=nav-link href=/en#about>About Me</a></li><li class=nav-item><a class=nav-link href=/en#skills>Skills</a></li><li class=nav-item><a class=nav-link href=/en#education>Education</a></li><li class=nav-item><a class=nav-link href=/en#recent-posts>Recent Posts</a></li><li class=nav-item><a class=nav-link href=/en#accomplishments>Certifications</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/en/posts>Posts</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=languageSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><span class="flag-icon flag-icon-gb"></span>
English</a><div class=dropdown-menu aria-labelledby=languageSelector><a class="dropdown-item nav-link languages-item" href=/posts/cortafuegos/nftables_uno/cortafuegos_uno><span class="flag-icon flag-icon-es"></span>
Espa√±ol
</a><a class="dropdown-item nav-link languages-item" href=/en/posts/cortafuegos/nftables_uno/cortafuegos_uno><span class="flag-icon flag-icon-gb"></span>
English</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/en/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/en/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/ci_cd/> CI / CD Jenkins</a><ul><li><a class=list-link href=/en/posts/ci_cd/practica_jenkins/ title="CI / CD practice with Jenkins">CI / CD practice with Jenkins</a></li><li><a class=list-link href=/en/posts/ci_cd/taller1_jenkins/ title="Workshop 1 Ortho-rector of markdown documents (test)">Workshop 1 Ortho-rector of markdown documents (test)</a></li><li><a class=list-link href=/en/posts/ci_cd/taller2_jenkins/ title="Workshop 2 Valid HTML5 check and surge.sh deployment (test and deploy)">Workshop 2 Valid HTML5 check and surge.sh deployment (test and deploy)</a></li><li><a class=list-link href=/en/posts/ci_cd/taller3_jenkins/ title="Workshop 3 Continuous integration of django application (Test)">Workshop 3 Continuous integration of django application (Test)</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/base_de_datos/> Database</a><ul><li><a class=list-link href=/en/posts/base_de_datos/instalar_mariadb/ title="Install MariaDB in Debian">Install MariaDB in Debian</a></li><li><a class=list-link href=/en/posts/base_de_datos/interconexion_de_servidores/ title="Interconnection of database servers">Interconnection of database servers</a></li><li><a class=list-link href=/en/posts/base_de_datos/instalacion_oracle_19c_debian12/ title="Oracle 19c installation under Debian 12">Oracle 19c installation under Debian 12</a></li><li><a class=list-link href=/en/posts/base_de_datos/instalar_postgresql/ title="PostgreSQL installation in Debian 12">PostgreSQL installation in Debian 12</a></li><li><a class=list-link href=/en/posts/base_de_datos/oracle_acceso_remoto/ title="Remote access configuration in Oracle">Remote access configuration in Oracle</a></li><li><a class=list-link href=/en/posts/base_de_datos/acceso_remoto_mariadb/ title="Remote access in MariaDB">Remote access in MariaDB</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/docker/> Docker</a><ul><li><a class=list-link href=/en/posts/docker/taller1/ title="Workshop 1 Storage and networks in Docker">Workshop 1 Storage and networks in Docker</a></li><li><a class=list-link href=/en/posts/docker/taller2/ title="Workshop 2 Multicontainer Scenarios in Docker">Workshop 2 Multicontainer Scenarios in Docker</a></li><li><a class=list-link href=/en/posts/docker/taller3/ title="Workshop 3 Image creation Docker">Workshop 3 Image creation Docker</a></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/en/posts/cortafuegos/> Firewall</a><ul class=active><li><a class=list-link href=/en/posts/cortafuegos/fortinet_cli/ title="Fortinet CLI">Fortinet CLI</a></li><li><a class=list-link href=/en/posts/cortafuegos/fortinet_uno/ title="Perimetral with Fortinet I">Perimetral with Fortinet I</a></li><li><a class=list-link href=/en/posts/cortafuegos/fortinet_dos/ title="Perimetral with Fortinet II">Perimetral with Fortinet II</a></li><li><a class="active list-link" href=/en/posts/cortafuegos/nftables_uno/ title="Perimetral with Nftables I">Perimetral with Nftables I</a></li><li><a class=list-link href=/en/posts/cortafuegos/nftables_dos/ title="Perimetral with Nftables II">Perimetral with Nftables II</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/drivers/> Linux Drivers</a><ul><li><a class=list-link href=/en/posts/drivers/nvidia_driver/ title="Drivers Nvidia">Drivers Nvidia</a></li><li><a class=list-link href=/en/posts/drivers/nvidia_optimus/ title="How to choose which graph to use on my laptop with Linux">How to choose which graph to use on my laptop with Linux</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/redes/> Networks</a><ul><li><a class=list-link href=/en/posts/redes/android_gns3/ title="Android GNS3-KVM">Android GNS3-KVM</a></li><li><a class=list-link href=/en/posts/redes/escenario_ipv6_basico/ title="Basic IPv6 scenario">Basic IPv6 scenario</a></li><li><a class=list-link href=/en/posts/redes/instalacion_wireshark_gns3/ title="GNS3 and Wireshark installation">GNS3 and Wireshark installation</a></li><li><a class=list-link href=/en/posts/redes/instalar_gns3_debian12/ title="GNS3 installation in Debian 12">GNS3 installation in Debian 12</a></li><li><a class=list-link href=/en/posts/redes/switches_gns3/ title="GNS3 switch configuration">GNS3 switch configuration</a></li><li><a class=list-link href=/en/posts/redes/tuneles_ipv6/ title="IPV6 Tunnels">IPV6 Tunnels</a></li><li><a class=list-link href=/en/posts/redes/configuracion_de_nat/ title="NAT in Cisco and Linux">NAT in Cisco and Linux</a></li><li><a class=list-link href=/en/posts/redes/comandos_de_supervision_de_redes/ title="Network monitoring commands">Network monitoring commands</a></li><li><a class=list-link href=/en/posts/redes/enroutamiento_openstack/ title="OpenStack routing">OpenStack routing</a></li><li><a class=list-link href=/en/posts/redes/arp/ title="Protocol ARP">Protocol ARP</a></li><li><a class=list-link href=/en/posts/redes/underworld/ title=Underworld>Underworld</a></li><li><a class=list-link href=/en/posts/redes/underworld_evolution/ title="Underworld evolution">Underworld evolution</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/seguridad/> Security</a><ul><li><a class=list-link href=/en/posts/seguridad/forense/ title="Forensic computer">Forensic computer</a></li><li><a class=list-link href=/en/posts/seguridad/https_autofirmado/ title=HTTPS>HTTPS</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/> Services</a><ul><li><a class=list-link href=/en/posts/servicios/apache/ title=Apache>Apache</a></li><li><a class=list-link href=/en/posts/servicios/dhcp/ title=DHCP>DHCP</a></li><li><a class=list-link href=/en/posts/servicios/dns/ title=DNS>DNS</a></li><li><a class=list-link href=/en/posts/servicios/ftp/ title=FTP>FTP</a></li><li><a class=list-link href=/en/posts/servicios/nat_iptables/ title="NAT with iptables">NAT with iptables</a></li><li><a class=list-link href=/en/posts/servicios/ssh/ title=SSH>SSH</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/> Systems</a><ul><li><a class=list-link href=/en/posts/sistemas/ad_ubuntu/ title="Active Directory in Ubuntu">Active Directory in Ubuntu</a></li><li><a class=list-link href=/en/posts/sistemas/recoleccion_logs_journald/ title="Centralized collection of logs journald">Centralized collection of logs journald</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/compilaciones_linux/> Compilations in LINUX</a><ul><li><a class=list-link href=/en/posts/sistemas/compilaciones_linux/compilacion_de_un_programa_en_c_utilizando_un_makefile/ title="Compilation of a C-program using a Makefile">Compilation of a C-program using a Makefile</a></li><li><a class=list-link href=/en/posts/sistemas/compilaciones_linux/compilacion_de_un_kernel/ title="Compilation of a kernel">Compilation of a kernel</a></li></ul></li><li><a class=list-link href=/en/posts/sistemas/creacion_de_un_sistema_automatizado_de_instalacion/ title="Creation of an automated installation system">Creation of an automated installation system</a></li><li><a class=list-link href=/en/posts/sistemas/samba_debian/ title="Install and configure samba in Debian">Install and configure samba in Debian</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/comandos_linux/> Linux Command</a><ul><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_de_modificacion_de_parametros_del_kernel/ title="Kernel parameter modification exercises">Kernel parameter modification exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/comandos_procesos/ title="Linux processes">Linux processes</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_de_manejo_de_modulos/ title="Module management exercises">Module management exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/gestion_de_paquetes/ title="Package management">Package management</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/empaquetadores_compresores/ title="Packaging and compressors">Packaging and compressors</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_gestion_de_paqueteria/ title="Paid management exercises">Paid management exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/programacion_tareas/ title="Task programming">Task programming</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/migraciones/> Migration in Linnux</a><ul><li><a class=list-link href=/en/posts/sistemas/migraciones/migracion_sistema_de_ficheros/ title="File system">File system</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/paso_de_centos_stream_8_a_centos_stream_9/ title="Migtation from CentOS stream 8 to CentOS stream 9">Migtation from CentOS stream 8 to CentOS stream 9</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/eliminacion_systemd/ title="Systemd elimination">Systemd elimination</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/transformacion_instancia_cloud/ title="Transformation instance cloud">Transformation instance cloud</a></li></ul></li><li><a class=list-link href=/en/posts/sistemas/nfs_debian/ title="NFS in Debian">NFS in Debian</a></li><li><a class=list-link href=/en/posts/sistemas/activacion_selinux/ title="SELinux activation configuration">SELinux activation configuration</a></li><li><a class=list-link href=/en/posts/sistemas/comparticion_de_directorios_en_windows/ title="Share resources in Windows">Share resources in Windows</a></li><li><a class=list-link href=/en/posts/sistemas/ssh_windows/ title="Ssh service in Windows">Ssh service in Windows</a></li><li><a class=list-link href=/en/posts/sistemas/almacenamiento_servidor_independiente/ title="Storage Spaces in Windows Server">Storage Spaces in Windows Server</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/vpn/> VPN</a><ul><li><a class=list-link href=/en/posts/vpn/comparativa_ovpn_wire/ title="OpenVPN and Wireguard Comparative">OpenVPN and Wireguard Comparative</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_openvpn/ title="OpenVPN remote access">OpenVPN remote access</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_strongswang/ title="Remote access Ipsec StrongSwan">Remote access Ipsec StrongSwan</a></li><li><a class=list-link href=/en/posts/vpn/ipsec_cisco/ title="Site-to-Site IPsec Cisco">Site-to-Site IPsec Cisco</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_fortinet/ title="Site-to-Site IPsec Fortinet">Site-to-Site IPsec Fortinet</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_openvpn/ title="Site-to-Site OpenVPN">Site-to-Site OpenVPN</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_wireguard/ title="Site-to-Site Wireguard">Site-to-Site Wireguard</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_wireguard/ title="Wireguard remote access">Wireguard remote access</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/iaw/> Web applications</a><ul><li><a class=list-link href=/en/posts/iaw/lamp/ title="LAMP stack installation">LAMP stack installation</a></li><li><a class=list-link href=/en/posts/iaw/lemp/ title="LEMP stack installation">LEMP stack installation</a></li><li><a class=list-link href=/en/posts/iaw/wordpress/ title="WordPress LAMP">WordPress LAMP</a></li><li><a class=list-link href=/en/posts/iaw/wordpress_lemp/ title="WordPress LEMP">WordPress LEMP</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/cortafuegos/nftables1.png)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/john_hu_2aff0fda0501496d.png alt="Author Image"><h5 class=author-name>Francisco Javier Cruces Doval</h5><p class=text-muted>Thursday, March 28, 2024 | 27 minutes</p></div><div class=title><h1>Implementation of a perimeter firewall with Nftables I</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/en/tags/firewall/ class="btn btn-sm btn-info">FIREWALL</a></li><li class=rounded><a href=/en/tags/linux/ class="btn btn-sm btn-info">LINUX</a></li><li class=rounded><a href=/en/tags/debian/ class="btn btn-sm btn-info">DEBIAN</a></li><li class=rounded><a href=/en/tags/nftables/ class="btn btn-sm btn-info">NFTABLES</a></li></ul></div><div class=post-content id=post-content><p>In this post on a Debian machine scenario, we will apply rules with Nfables to match the traffic that goes into and out of our network, trying to imitate a scenario.</p><blockquote><p>[NOTE]
To deploy the stage to perform these exercises you will need to deploy the .yaml file you will find in the link to the next paragraph. This will be in charge of deploying 2 machines one that will make firewall and one that will simulate a client that will be connected to the first machine to simulate a local network.</p></blockquote><p>With NFTABLES it does the exercise of the <a href=https://fp.josedomingo.org/seguridad/u03/perimetral_iptables.html target=_blank rel=noopener>https://fp.josedomingo.org/seguridad/u03/perimetral_iptables.html</a> by documenting the operating tests performed.</p><h3 id=stage-preparation>Stage preparation</h3><p>The first thing we&rsquo;ll do is activate the forwarding bit. To do this, we will edit the file &lsquo;/ etc / sysctl.conf&rsquo; using the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nano /etc/sysctl.conf 
</span></span><span style=display:flex><span><span style=color:#75715e>#Descomentamos la linea</span>
</span></span><span style=display:flex><span>net.ipv4.ip_forward<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Then we will apply the changes using the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo sysctl -p
</span></span><span style=display:flex><span>net.ipv4.ip_forward <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Now we&rsquo;ll add the filter table:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add table inet filter
</span></span></code></pre></div><p>We can see the tables created:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list tables
</span></span><span style=display:flex><span>table inet filter
</span></span></code></pre></div><p>Create the chains for the input and output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Cadena de &#34;entrada&#34;</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add chain inet filter input <span style=color:#f92672>{</span> type filter hook input priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Cadena de &#34;salida&#34;</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add chain inet filter output <span style=color:#f92672>{</span> type filter hook output priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Cadena forward , peticiones que atraviesen :</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add chain inet filter forward <span style=color:#f92672>{</span> type filter hook forward priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>We will now see that these three chains have been created:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list chains
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=firewall-rules>Firewall rules</h3><h2 id=allow-ssh-to-the-firewall>Allow ssh to the firewall</h2><p>Now let&rsquo;s allow the ssh to the router-fw machine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iif ens3 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oif ens3 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span></code></pre></div><h3 id=default-policy-drop>Default policy DROP</h3><p>Now let&rsquo;s put the default DROP policy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft chain inet filter input <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft chain inet filter output <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft chain inet filter forward <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>We will check that with the new policy we can connect by ssh and we have not lost the connection, seeing that we have hits in the rules.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>174</span> bytes <span style=color:#ae81ff>11824</span>
</span></span><span style=display:flex><span>		iif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>129</span> bytes <span style=color:#ae81ff>8252</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>169</span> bytes <span style=color:#ae81ff>31232</span>
</span></span><span style=display:flex><span>		oif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>85</span> bytes <span style=color:#ae81ff>22632</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=snat>SNAT</h3><p>We make SNAT so LAN teams can access the outside.</p><p>This will require us to create the NAT table and its chains. As we can see, we have indicated less priority in the posttrouting chain (the lower the number, the higher the priority) for the rules of that chain to be executed after the pre-routing rules.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Creamos la tabla NAT</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add table nat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Cadena para el DNAT</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add chain nat prerouting <span style=color:#f92672>{</span> type nat hook prerouting priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Cadena para el SNAT</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add chain nat postrouting <span style=color:#f92672>{</span> type nat hook postrouting priority <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Now let&rsquo;s let SNAT do to the LAN network:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 counter masquerade
</span></span></code></pre></div><h3 id=we-allowed-the-ssh-from-the-firecut-to-the-lan>We allowed the ssh from the firecut to the LAN</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span></code></pre></div><p>Now that we can connect by ssh to our LAN machine, let&rsquo;s check the two above rules.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ ssh debian@192.168.100.10
</span></span><span style=display:flex><span>Linux lan 6.1.0-12-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.52-1 (2023-09-07) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Tue Feb <span style=color:#ae81ff>27</span> 18:31:10 <span style=color:#ae81ff>2024</span> from 192.168.100.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>debian@lan:~$ ping 1.1.1.1
</span></span><span style=display:flex><span>PING 1.1.1.1 <span style=color:#f92672>(</span>1.1.1.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 1.1.1.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> packets transmitted, <span style=color:#ae81ff>0</span> received, 100% packet loss, time 1002ms
</span></span></code></pre></div><p>We will see that we can connect by ssh, however the ping is not allowed but I have done so that the SNAT rule has hits.</p><p>Let&rsquo;s see that the rules have hits:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>621</span> bytes <span style=color:#ae81ff>63636</span>
</span></span><span style=display:flex><span>		iif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>493</span> bytes <span style=color:#ae81ff>41948</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>81</span> bytes <span style=color:#ae81ff>17628</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>1231</span> bytes <span style=color:#ae81ff>141120</span>
</span></span><span style=display:flex><span>		oif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>349</span> bytes <span style=color:#ae81ff>68222</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>103</span> bytes <span style=color:#ae81ff>17420</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>4</span> bytes <span style=color:#ae81ff>336</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>table ip nat <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain prerouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook prerouting priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>As we can see the SNAT has hits, so the rule is working, but since we don&rsquo;t let it through the firewall these won&rsquo;t go out.</p><h3 id=we-allow-traffic-for-the-loopback-interface>We allow traffic for the loopback interface</h3><p>We add the rules, to allow traffic to the loopback interface:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept    
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept
</span></span></code></pre></div><p>We check that we have connectivity:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ ping 127.0.0.1
</span></span><span style=display:flex><span>PING 127.0.0.1 <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 127.0.0.1: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.205 ms
</span></span></code></pre></div><p>Let&rsquo;s see the rule hits:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset | grep lo
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span></code></pre></div><h2 id=petitions-and-responses-protocol-icmp>Petitions and responses protocol ICMP</h2><p>We will allow the router-fw machine to accept ICMP requests and that I sent the answer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter accept
</span></span></code></pre></div><p>I do ping from my machine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~/Documentos/2¬∫ASIR/SAD/cortafuegos1$ ping 172.22.201.120 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 172.22.201.120 <span style=color:#f92672>(</span>172.22.201.120<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 172.22.201.120: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>61</span> time<span style=color:#f92672>=</span>85.4 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 172.22.201.120 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 85.403/85.403/85.403/0.000 ms
</span></span></code></pre></div><h3 id=allow-to-do-ping-from-the-lan>Allow to do ping from the LAN</h3><p>Let&rsquo;s let you do ping from the LAN:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 icmp type echo-request counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 icmp type echo-reply counter accept
</span></span></code></pre></div><p>Let&rsquo;s check it out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ ping 1.1.1.1
</span></span><span style=display:flex><span>PING 1.1.1.1 <span style=color:#f92672>(</span>1.1.1.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 1.1.1.1: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span> time<span style=color:#f92672>=</span>40.8 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 1.1.1.1: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span> time<span style=color:#f92672>=</span>40.8 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 1.1.1.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> packets transmitted, <span style=color:#ae81ff>2</span> received, 0% packet loss, time 1002ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 40.821/40.834/40.848/0.013 ms
</span></span></code></pre></div><p>Let&rsquo;s see the rule hits, plus with this we can check the SNAT rule:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>2637</span> bytes <span style=color:#ae81ff>213636</span>
</span></span><span style=display:flex><span>		iif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>2346</span> bytes <span style=color:#ae81ff>172928</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>225</span> bytes <span style=color:#ae81ff>32812</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>4656</span> bytes <span style=color:#ae81ff>697080</span>
</span></span><span style=display:flex><span>		oif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>1618</span> bytes <span style=color:#ae81ff>477018</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>291</span> bytes <span style=color:#ae81ff>30252</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>31</span> bytes <span style=color:#ae81ff>2604</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 icmp type echo-request counter packets <span style=color:#ae81ff>12</span> bytes <span style=color:#ae81ff>1008</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 icmp type echo-reply counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>table ip nat <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain prerouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook prerouting priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 counter packets <span style=color:#ae81ff>4</span> bytes <span style=color:#ae81ff>336</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=dns-consultations-and-responses-from-the-lan>DNS consultations and responses from the LAN</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 udp sport <span style=color:#ae81ff>53</span> ct state established counter accept
</span></span></code></pre></div><p>We will do a query using the host command, as I do not have another tool installed to do dns consultations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ host www.javiercd.es
</span></span><span style=display:flex><span>www.javiercd.es is an alias <span style=color:#66d9ef>for</span> javierasping.github.io.
</span></span><span style=display:flex><span>javierasping.github.io has address 185.199.111.153
</span></span><span style=display:flex><span>javierasping.github.io has address 185.199.108.153
</span></span><span style=display:flex><span>javierasping.github.io has address 185.199.109.153
</span></span><span style=display:flex><span>javierasping.github.io has address 185.199.110.153
</span></span><span style=display:flex><span>javierasping.github.io has IPv6 address 2606:50c0:8000::153
</span></span><span style=display:flex><span>javierasping.github.io has IPv6 address 2606:50c0:8001::153
</span></span><span style=display:flex><span>javierasping.github.io has IPv6 address 2606:50c0:8003::153
</span></span><span style=display:flex><span>javierasping.github.io has IPv6 address 2606:50c0:8002::153
</span></span></code></pre></div><p>Let&rsquo;s check the hits of the rules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>10</span> bytes <span style=color:#ae81ff>643</span> accept
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 udp sport <span style=color:#ae81ff>53</span> ct state established counter packets <span style=color:#ae81ff>10</span> bytes <span style=color:#ae81ff>2644</span> accept
</span></span></code></pre></div><h3 id=we-allow-web-navigation-from-the-lan>We allow web navigation from the LAN</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#f92672>{</span> 80,443<span style=color:#f92672>}</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#f92672>{</span> 80,443<span style=color:#f92672>}</span> ct state established counter accept
</span></span></code></pre></div><p>To verify this point, we will need to modify the / etc / nsSwitch.conf file, which determines the priority of DNS resolution. We will make this modification to prioritize DNS consultation to the system DNS service, which is included in Debian and Ubuntu. This will allow the queries to be carried out first on the machine itself and, if necessary, will be sent to the configured DNS server as in this scenario the applications do not solve us if we do not make this modification.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ sudo nano /etc/nsswitch.conf 
</span></span><span style=display:flex><span>hosts:          files dns resolve <span style=color:#f92672>[</span>!UNAVAIL<span style=color:#f92672>=</span><span style=color:#66d9ef>return</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>We&rsquo;ll also change the machine&rsquo;s dns server and instead of us, we&rsquo;ll put the high school server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ sudo cat /etc/resolv.conf 
</span></span><span style=display:flex><span>nameserver 172.22.0.1
</span></span></code></pre></div><p>Once the changes are applied, we will order a web by the domain name, so we will check the operation of the two above points. I&rsquo;ll just order the headers to make the output more legible, a code 200 would be correct. In the part of http gives us a redirection as the server redirects you to https:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ curl -I https://www.javiercd.es/
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span> 
</span></span><span style=display:flex><span>server: GitHub.com
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>last-modified: Sun, <span style=color:#ae81ff>25</span> Feb <span style=color:#ae81ff>2024</span> 23:03:49 GMT
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>31556952</span>
</span></span><span style=display:flex><span>etag: <span style=color:#e6db74>&#34;65dbc755-675b&#34;</span>
</span></span><span style=display:flex><span>expires: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:10:17 GMT
</span></span><span style=display:flex><span>cache-control: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>x-proxy-cache: MISS
</span></span><span style=display:flex><span>x-github-request-id: 5CD4:0E10:CBDBE5:CFBAEA:65DF0430
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>date: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:00:17 GMT
</span></span><span style=display:flex><span>via: 1.1 varnish
</span></span><span style=display:flex><span>age: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>x-served-by: cache-mad2200123-MAD
</span></span><span style=display:flex><span>x-cache: MISS
</span></span><span style=display:flex><span>x-cache-hits: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>x-timer: S1709114417.014922,VS0,VE167
</span></span><span style=display:flex><span>vary: Accept-Encoding
</span></span><span style=display:flex><span>x-fastly-request-id: e15d291bbff90bf9de58991f0f6477e4398c415d
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>26459</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>debian@lan:~$ curl -I http://www.javiercd.es/
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>301</span> Moved Permanently
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>162</span>
</span></span><span style=display:flex><span>Server: GitHub.com
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Location: https://www.javiercd.es/
</span></span><span style=display:flex><span>X-GitHub-Request-Id: 9870:0E7F:37400AD:3848DF5:65DF0425
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>Date: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:00:27 GMT
</span></span><span style=display:flex><span>Age: <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>X-Served-By: cache-mad2200100-MAD
</span></span><span style=display:flex><span>X-Cache: HIT
</span></span><span style=display:flex><span>X-Cache-Hits: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>X-Timer: S1709114427.468002,VS0,VE1
</span></span><span style=display:flex><span>Vary: Accept-Encoding
</span></span><span style=display:flex><span>X-Fastly-Request-ID: e321e34041a049f6f7c99e0693be994990da6da3
</span></span><span style=display:flex><span>X-Cache: MISS from f0
</span></span><span style=display:flex><span>X-Cache-Lookup: HIT from f0:3128
</span></span><span style=display:flex><span>Via: 1.1 varnish, 1.1 f0 <span style=color:#f92672>(</span>squid/4.6<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Connection: close
</span></span></code></pre></div><h3 id=we-allow-access-to-our-lan-web-server-from-the-outside>We allow access to our LAN web server from the outside</h3><p>As we already have dns resolution and web navigation, we can update our repositories and install packages:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ sudo apt update -y <span style=color:#f92672>&amp;&amp;</span> sudo apt install apache2 -y 
</span></span></code></pre></div><p>Once apache is installed we will perform the DNAT rule:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>80</span> counter dnat to 192.168.100.10
</span></span></code></pre></div><p>Now we have to allow on the forward chain the traffic to allow the DNAT. Requests to the web server and answers</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>80</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>80</span> ct state established counter accept
</span></span></code></pre></div><p>Now let&rsquo;s check that we can access the web server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~/Documentos/2¬∫ASIR/SAD/cortafuegos1$ curl -I 172.22.201.120
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Date: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:24:26 GMT
</span></span><span style=display:flex><span>Server: Apache/2.4.57 <span style=color:#f92672>(</span>Debian<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Last-Modified: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:17:20 GMT
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;29cd-6126e72b03120&#34;</span>
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>10701</span>
</span></span><span style=display:flex><span>Vary: Accept-Encoding
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span></code></pre></div><p>From a browser:</p><p><img src=/cortafuegos/nftables_uno/img/Pastedimage20240228112558.png alt></p><p>Finally let&rsquo;s check that the rules involved have hits and I&rsquo;ll leave you the full list to see the rules up to this point:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>20313</span> bytes <span style=color:#ae81ff>2212299</span>
</span></span><span style=display:flex><span>		iif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>11896</span> bytes <span style=color:#ae81ff>827728</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>8093</span> bytes <span style=color:#ae81ff>1321072</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>92</span> bytes <span style=color:#ae81ff>17660</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>69191</span> bytes <span style=color:#ae81ff>6011531</span>
</span></span><span style=display:flex><span>		oif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>8461</span> bytes <span style=color:#ae81ff>1953220</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>9482</span> bytes <span style=color:#ae81ff>623484</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>92</span> bytes <span style=color:#ae81ff>17660</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>42155</span> bytes <span style=color:#ae81ff>145465374</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 icmp type echo-request counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>2688</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 icmp type echo-reply counter packets <span style=color:#ae81ff>18</span> bytes <span style=color:#ae81ff>1512</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>273</span> bytes <span style=color:#ae81ff>17860</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 udp sport <span style=color:#ae81ff>53</span> ct state established counter packets <span style=color:#ae81ff>273</span> bytes <span style=color:#ae81ff>52163</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established,new counter packets <span style=color:#ae81ff>33973</span> bytes <span style=color:#ae81ff>1794576</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established counter packets <span style=color:#ae81ff>7119</span> bytes <span style=color:#ae81ff>143533481</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>80</span> ct state established,new counter packets <span style=color:#ae81ff>47</span> bytes <span style=color:#ae81ff>3905</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>80</span> ct state established counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>24161</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>table ip nat <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain prerouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook prerouting priority filter; policy accept;
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>80</span> counter packets <span style=color:#ae81ff>4</span> bytes <span style=color:#ae81ff>240</span> dnat to 192.168.100.10
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 counter packets <span style=color:#ae81ff>547</span> bytes <span style=color:#ae81ff>38852</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=additional-exercises>Additional exercises</h2><p>You must then add the necessary rules to allow the following operations:</p><h3 id=it-allows-to-make-ssh-connections-to-the-outside-from-the-firewall-machine>It allows to make ssh connections to the outside from the firewall machine.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state new,established  counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established  counter accept
</span></span></code></pre></div><p>We&rsquo;re gonna connect by ssh from the firewall machine to another to check this out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ ssh 172.22.200.47
</span></span><span style=display:flex><span>Linux odin.javiercd.gonzalonazareno.org 6.1.0-18-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Wed Feb <span style=color:#ae81ff>28</span> 10:35:56 <span style=color:#ae81ff>2024</span> from 172.22.201.120
</span></span><span style=display:flex><span>javiercruces@odin:~$ 
</span></span></code></pre></div><p>Let&rsquo;s check the hits in the rules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset 
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>66</span> bytes <span style=color:#ae81ff>18624</span> accept
</span></span><span style=display:flex><span>oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>89</span> bytes <span style=color:#ae81ff>16572</span> accept
</span></span></code></pre></div><h3 id=it-allows-dns-queries-from-the-firewall-machine-only-to-the-8888-server-check-that-you-cant-make-a-dig--1111>It allows DNS queries from the firewall machine only to the 8.8.8.8 server. Check that you can&rsquo;t make a dig @ 1.1.1.1.</h3><p>Let&rsquo;s add this rule:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 8.8.8.8 udp dport <span style=color:#ae81ff>53</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 8.8.8.8 udp sport <span style=color:#ae81ff>53</span> ct state established counter accept
</span></span></code></pre></div><p>Now let&rsquo;s check that through 1.1.1.1 we can&rsquo;t solve names but with 8.8.8.8 if:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ dig @1.1.1.1 www.javiercd.es
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.24-1-Debian &lt;&lt;&gt;&gt; @1.1.1.1 www.javiercd.es
</span></span><span style=display:flex><span>; <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> server found<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; no servers could be reached
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ dig @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.24-1-Debian &lt;&lt;&gt;&gt; @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>; <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> server found<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#e6db74>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#ae81ff>4046</span>
</span></span><span style=display:flex><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;www.javiercd.es.		IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>www.javiercd.es.	3600	IN	CNAME	javierasping.github.io.
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.108.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.109.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.110.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.111.153
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#ae81ff>68</span> msec
</span></span><span style=display:flex><span>;; SERVER: 8.8.8.8#53<span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>UDP<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; WHEN: Wed Feb <span style=color:#ae81ff>28</span> 11:09:05 UTC <span style=color:#ae81ff>2024</span>
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: <span style=color:#ae81ff>144</span>
</span></span></code></pre></div><p>Let&rsquo;s see the hits of the rules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset 
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 8.8.8.8 udp sport <span style=color:#ae81ff>53</span> ct state established counter packets <span style=color:#ae81ff>314</span> bytes <span style=color:#ae81ff>36448</span> accept
</span></span><span style=display:flex><span>oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 8.8.8.8 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>314</span> bytes <span style=color:#ae81ff>21912</span> accept
</span></span></code></pre></div><h3 id=it-allows-the-firewall-machine-to-navigate-through-https>It allows the firewall machine to navigate through https.</h3><p>Let&rsquo;s add the rule:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp tcp dport <span style=color:#ae81ff>443</span> ct state new,established  counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp tcp sport <span style=color:#ae81ff>443</span>  ct state established  counter accept
</span></span></code></pre></div><p>Let&rsquo;s check that by asking the headers, which is similar to browsing we can see a code 200 in https:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ curl -I https://www.javiercd.es/
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span> 
</span></span><span style=display:flex><span>server: GitHub.com
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>last-modified: Sun, <span style=color:#ae81ff>25</span> Feb <span style=color:#ae81ff>2024</span> 23:03:49 GMT
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>31556952</span>
</span></span><span style=display:flex><span>etag: <span style=color:#e6db74>&#34;65dbc755-675b&#34;</span>
</span></span><span style=display:flex><span>expires: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 10:10:17 GMT
</span></span><span style=display:flex><span>cache-control: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>x-proxy-cache: MISS
</span></span><span style=display:flex><span>x-github-request-id: 5CD4:0E10:CBDBE5:CFBAEA:65DF0430
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>date: Wed, <span style=color:#ae81ff>28</span> Feb <span style=color:#ae81ff>2024</span> 11:10:32 GMT
</span></span><span style=display:flex><span>via: 1.1 varnish
</span></span><span style=display:flex><span>age: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>x-served-by: cache-mad22033-MAD
</span></span><span style=display:flex><span>x-cache: HIT
</span></span><span style=display:flex><span>x-cache-hits: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>x-timer: S1709118632.338441,VS0,VE131
</span></span><span style=display:flex><span>vary: Accept-Encoding
</span></span><span style=display:flex><span>x-fastly-request-id: 01056938385ca0e465882fa75fd0b19d0973df62
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>26459</span>
</span></span></code></pre></div><h3 id=local-network-equipment-should-be-able-to-have-an-external-connection>Local network equipment should be able to have an external connection.</h3><p>previously performed SNAT</p><h3 id=we-allowed-the-ssh-from-the-firewall-to-the-lan>We allowed the ssh from the firewall to the LAN</h3><p>Permitted by previous rule</p><h3 id=we-allowed-to-do-ping-from-the-lan-to-the-firewall-machine>We allowed to do ping from the LAN to the firewall machine.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter accept
</span></span></code></pre></div><p>We do the ping from LAN to firewall</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ ping 192.168.100.2
</span></span><span style=display:flex><span>PING 192.168.100.2 <span style=color:#f92672>(</span>192.168.100.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>1.09 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.100.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>1.75 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 192.168.100.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> packets transmitted, <span style=color:#ae81ff>2</span> received, 0% packet loss, time 1002ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 1.091/1.419/1.748/0.328 ms
</span></span></code></pre></div><p>We&rsquo;ll see the hits for this particular rule:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span></code></pre></div><h3 id=allows-to-make-ssh-connections-from-lan-equipment>Allows to make ssh connections from LAN equipment</h3><p>Let&rsquo;s make the rules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span></code></pre></div><p>We&rsquo;re going to connect by ssh to a machine outside the lan:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ ssh javiercruces@172.22.200.47
</span></span><span style=display:flex><span>Linux odin.javiercd.gonzalonazareno.org 6.1.0-18-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Wed Feb <span style=color:#ae81ff>28</span> 10:36:26 <span style=color:#ae81ff>2024</span> from 172.22.201.120
</span></span><span style=display:flex><span>javiercruces@odin:~$ 
</span></span></code></pre></div><p>Let&rsquo;s see the hits of these rules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft -a list table inet filter
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>10</span> bytes <span style=color:#ae81ff>3312</span> accept <span style=color:#75715e># handle 44</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>7</span> bytes <span style=color:#ae81ff>3088</span> accept <span style=color:#75715e># handle 45</span>
</span></span></code></pre></div><h3 id=install-a-post-server-on-the-lan-machine-it-allows-access-from-the-outside-and-from-the-firewall-to-the-post-server-to-prove-it-you-can-run-a-telnet-to-port-25-tcp>Install a post server on the LAN machine. It allows access from the outside and from the firewall to the post server. To prove it you can run a telnet to port 25 tcp.</h3><p>With these rules we allow to connect from outside the network to the post server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>25</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>25</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Regla DNAT puerto 25</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>25</span> counter dnat to 192.168.100.10
</span></span></code></pre></div><p>Let&rsquo;s check it out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~/Documentos/2¬∫ASIR/SAD/cortafuegos1$ telnet 172.22.201.120 <span style=color:#ae81ff>25</span>
</span></span><span style=display:flex><span>Trying 172.22.201.120...
</span></span><span style=display:flex><span>Connected to 172.22.201.120.
</span></span><span style=display:flex><span>Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> lan.openstacklocal ESMTP Postfix <span style=color:#f92672>(</span>Debian/GNU<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Connection closed by foreign host.
</span></span></code></pre></div><p>Let&rsquo;s see the hits in the rules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span><span style=color:#75715e>#Reglas para permitir el trafico</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>25</span> ct state established,new counter packets <span style=color:#ae81ff>10</span> bytes <span style=color:#ae81ff>544</span> accept <span style=color:#75715e># handle 46</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>25</span> ct state established counter packets <span style=color:#ae81ff>9</span> bytes <span style=color:#ae81ff>613</span> accept
</span></span><span style=display:flex><span><span style=color:#75715e>#Regla DNAT</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>25</span> counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>60</span> dnat to 192.168.100.10
</span></span></code></pre></div><h3 id=allows-to-make-ssh-connections-from-outside-to-the-lan>Allows to make ssh connections from outside to the LAN</h3><p>For this I will do a DNAT to port 2222 and allow that traffic</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Reglas para permitir el trafico del DNAT</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>2222</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>2222</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Regla DNAT puerto 2222 para ssh</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter dnat to 192.168.100.10
</span></span></code></pre></div><p>I have changed the port of the service ssh of lan to 2222, I will connect from outside to the LAN by ssh:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~/Documentos/2¬∫ASIR/SAD/cortafuegos1$ ssh -p <span style=color:#ae81ff>2222</span> debian@172.22.201.120
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Linux lan 6.1.0-12-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.52-1 (2023-09-07) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Wed Feb <span style=color:#ae81ff>28</span> 14:12:18 <span style=color:#ae81ff>2024</span> from 192.168.100.2
</span></span><span style=display:flex><span>debian@lan:~$ 
</span></span></code></pre></div><p>Let&rsquo;s check the hits of the rules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Reglas para permitir el ssh 2222 desde fuera hacia la LAN</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>2222</span> ct state established,new counter packets <span style=color:#ae81ff>54</span> bytes <span style=color:#ae81ff>9784</span> accept
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>2222</span> ct state established counter packets <span style=color:#ae81ff>44</span> bytes <span style=color:#ae81ff>10494</span> accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Regla DNAT</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter packets <span style=color:#ae81ff>5</span> bytes <span style=color:#ae81ff>300</span> dnat to 192.168.100.10
</span></span></code></pre></div><h3 id=modifies-the-above-rule-so-that-when-we-access-from-the-outside-by-ssh-we-have-to-connect-to-port-2222-although-the-ssh-server-is-configured-to-access-by-port-22>Modifies the above rule, so that when we access from the outside by ssh we have to connect to port 2222, although the ssh server is configured to access by port 22.</h3><p>For this we will remove the 3 above rules and add the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Permitimos el trafico que ahora &#34;cambiamos&#34; el puerto con la regla DNAT de 2222 a 22</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Regla DNAT</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter dnat to 192.168.100.10
</span></span></code></pre></div><p>Now let&rsquo;s check that we can connect from the outside to the LAN although we have now changed the LAN ssh server to listen in port 22:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>34</span> bytes <span style=color:#ae81ff>7868</span> accept
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>9066</span> accept
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter packets <span style=color:#ae81ff>7</span> bytes <span style=color:#ae81ff>420</span> dnat to 192.168.100.10:22
</span></span></code></pre></div><h3 id=it-allows-dns-queries-from-the-lan-only-to-the-8888-server-check-that-you-cant-make-a-dig--1111>It allows DNS queries from the LAN only to the 8.8.8.8 server. Check that you can&rsquo;t make a dig @ 1.1.1.1.</h3><p>We will delete the previous rule that allows DNS queries:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft -a list table inet filter
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>285</span> bytes <span style=color:#ae81ff>17036</span> accept <span style=color:#75715e># handle 35</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft delete rule inet filter forward handle <span style=color:#ae81ff>35</span>
</span></span></code></pre></div><p>We add the new rule to allow only consultations to 8.8.8:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ip daddr 8.8.8.8 counter accept
</span></span></code></pre></div><p>Let&rsquo;s check it out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ dig @1.1.1.1 www.javiercd.es
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>;; communications error to 1.1.1.1#53: timed out
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.24-1-Debian &lt;&lt;&gt;&gt; @1.1.1.1 www.javiercd.es
</span></span><span style=display:flex><span>; <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> server found<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; no servers could be reached
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>debian@lan:~$ dig @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.18.24-1-Debian &lt;&lt;&gt;&gt; @8.8.8.8 www.javiercd.es
</span></span><span style=display:flex><span>; <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> server found<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#e6db74>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#ae81ff>59302</span>
</span></span><span style=display:flex><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;www.javiercd.es.		IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>www.javiercd.es.	3600	IN	CNAME	javierasping.github.io.
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.108.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.109.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.110.153
</span></span><span style=display:flex><span>javierasping.github.io.	3600	IN	A	185.199.111.153
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#ae81ff>72</span> msec
</span></span><span style=display:flex><span>;; SERVER: 8.8.8.8#53<span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>UDP<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; WHEN: Wed Feb <span style=color:#ae81ff>28</span> 14:44:29 UTC <span style=color:#ae81ff>2024</span>
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: <span style=color:#ae81ff>144</span>
</span></span></code></pre></div><p>Let&rsquo;s see the hits of the rules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft -a list table inet filter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ip daddr 8.8.8.8 counter packets <span style=color:#ae81ff>3</span> bytes <span style=color:#ae81ff>218</span> accept <span style=color:#75715e># handle 53</span>
</span></span></code></pre></div><h3 id=allows-lan-equipment-to-browse-the-internet-except-for-the--page>Allows LAN equipment to browse the Internet, except for the <a href=https://www.realbetisbalompie.es target=_blank rel=noopener>www.realbetisbalompie.es</a> page</h3><p>We have a problem and it is that nfables only filters up to the level of transport, that is by port. So we can&rsquo;t read the domain as it travels in a header of the application level.</p><p>To ban it, we will have to block that IP in its entirety for a given port, in my case it will be 80 and 443.</p><p>Let&rsquo;s find out the domain IPS we want to block:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ dig +short www.realbetisbalompie.es
</span></span><span style=display:flex><span>realbetisbalompie.es.
</span></span><span style=display:flex><span>51.255.76.196
</span></span></code></pre></div><p>We will add it to the beginning of the chain instead of add the word insert:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft insert rule inet filter forward ip daddr 51.255.76.196 tcp dport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> counter drop 
</span></span></code></pre></div><p>And now we won&rsquo;t be able to navigate the evil one&rsquo;s page:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debian@lan:~$ curl -I https://www.realbetisbalompie.es/
</span></span><span style=display:flex><span>curl: <span style=color:#f92672>(</span>28<span style=color:#f92672>)</span> Failed to connect to www.realbetisbalompie.es port <span style=color:#ae81ff>443</span> after <span style=color:#ae81ff>129885</span> ms: Couldn<span style=color:#960050;background-color:#1e0010>&#39;</span>t connect to server
</span></span></code></pre></div><p>Let&rsquo;s see the hits of the rule that protects us from evil:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>ip daddr 51.255.76.196 tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> counter packets <span style=color:#ae81ff>7</span> bytes <span style=color:#ae81ff>420</span> drop
</span></span></code></pre></div><h3 id=make-the-rules-persistent>Make the rules persistent</h3><p>Let&rsquo;s save the rules with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rott@router-fw:/home/javiercruces# nft list ruleset &gt; /etc/nftables.conf
</span></span></code></pre></div><p>If we want to restore them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft -f /etc/nftables.conf
</span></span></code></pre></div><p>To make the rules restart alone:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Creamos la unidad de systemd</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo cat /etc/systemd/system/nftables-persistent.service
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Unit<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Description<span style=color:#f92672>=</span>Cargar reglas de nftables al iniciar el sistema
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Service<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Type<span style=color:#f92672>=</span>oneshot
</span></span><span style=display:flex><span>ExecStart<span style=color:#f92672>=</span>/usr/sbin/nft -f /etc/nftables/nftables.rules
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Install<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>WantedBy<span style=color:#f92672>=</span>multi-user.target
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Activa el servicio para que al reiniciar se apliquen los cambios</span>
</span></span><span style=display:flex><span>javiercruces@router-fw:~$ sudo systemctl enable nftables-persistent.service
</span></span></code></pre></div><h3 id=rules-at-the-end-of-the-year>Rules at the end of the year</h3><p>I&rsquo;ll leave you the list of rules in the state of last exercise:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@router-fw:~$ sudo nft list ruleset
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>34414</span> bytes <span style=color:#ae81ff>6500685</span>
</span></span><span style=display:flex><span>		iif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>21235</span> bytes <span style=color:#ae81ff>1526616</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>11648</span> bytes <span style=color:#ae81ff>1793088</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>92</span> bytes <span style=color:#ae81ff>17660</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>66</span> bytes <span style=color:#ae81ff>18624</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp tcp sport <span style=color:#ae81ff>443</span> ct state established counter packets <span style=color:#ae81ff>519</span> bytes <span style=color:#ae81ff>3016033</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 8.8.8.8 udp sport <span style=color:#ae81ff>53</span> ct state established counter packets <span style=color:#ae81ff>557</span> bytes <span style=color:#ae81ff>68077</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>86303</span> bytes <span style=color:#ae81ff>8331992</span>
</span></span><span style=display:flex><span>		oif <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>15004</span> bytes <span style=color:#ae81ff>3534878</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>14125</span> bytes <span style=color:#ae81ff>950568</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>92</span> bytes <span style=color:#ae81ff>17660</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>89</span> bytes <span style=color:#ae81ff>16572</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 8.8.8.8 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>557</span> bytes <span style=color:#ae81ff>36254</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp tcp dport <span style=color:#ae81ff>443</span> ct state established,new counter packets <span style=color:#ae81ff>367</span> bytes <span style=color:#ae81ff>25011</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy drop;
</span></span><span style=display:flex><span>		ip daddr 51.255.76.196 tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> counter packets <span style=color:#ae81ff>7</span> bytes <span style=color:#ae81ff>420</span> drop
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>45573</span> bytes <span style=color:#ae81ff>149083811</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 icmp type echo-request counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>2688</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 icmp type echo-reply counter packets <span style=color:#ae81ff>18</span> bytes <span style=color:#ae81ff>1512</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 udp sport <span style=color:#ae81ff>53</span> ct state established counter packets <span style=color:#ae81ff>664</span> bytes <span style=color:#ae81ff>101857</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established,new counter packets <span style=color:#ae81ff>34813</span> bytes <span style=color:#ae81ff>1843071</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established counter packets <span style=color:#ae81ff>7583</span> bytes <span style=color:#ae81ff>146852066</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>80</span> ct state established,new counter packets <span style=color:#ae81ff>47</span> bytes <span style=color:#ae81ff>3905</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>80</span> ct state established counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>24161</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol tcp ip saddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>72</span> bytes <span style=color:#ae81ff>18540</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp ip daddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>56</span> bytes <span style=color:#ae81ff>17296</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>25</span> ct state established,new counter packets <span style=color:#ae81ff>10</span> bytes <span style=color:#ae81ff>544</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>25</span> ct state established counter packets <span style=color:#ae81ff>9</span> bytes <span style=color:#ae81ff>613</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip daddr 192.168.100.0/24 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>90</span> bytes <span style=color:#ae81ff>17200</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>77</span> bytes <span style=color:#ae81ff>19296</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 udp dport <span style=color:#ae81ff>53</span> ip daddr 8.8.8.8 counter packets <span style=color:#ae81ff>81</span> bytes <span style=color:#ae81ff>5250</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>table ip nat <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain prerouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook prerouting priority filter; policy accept;
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>80</span> counter packets <span style=color:#ae81ff>4</span> bytes <span style=color:#ae81ff>240</span> dnat to 192.168.100.10
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>25</span> counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>60</span> dnat to 192.168.100.10
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter packets <span style=color:#ae81ff>8</span> bytes <span style=color:#ae81ff>480</span> dnat to 192.168.100.10:22
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.100.0/24 counter packets <span style=color:#ae81ff>916</span> bytes <span style=color:#ae81ff>61536</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f&text=Implementation%20of%20a%20perimeter%20firewall%20with%20Nftables%20I&via=Atlas" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f&title=Implementation%20of%20a%20perimeter%20firewall%20with%20Nftables%20I" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f&title=Implementation%20of%20a%20perimeter%20firewall%20with%20Nftables%20I" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=Implementation%20of%20a%20perimeter%20firewall%20with%20Nftables%20I https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=Implementation%20of%20a%20perimeter%20firewall%20with%20Nftables%20I&body=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_uno%2fcortafuegos_uno%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/javierasping/sentinel/edit/main/content/posts/cortafuegos/nftables_uno/cortafuegos_uno.en.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#stage-preparation>Stage preparation</a></li><li><a href=#firewall-rules>Firewall rules</a></li></ul></li><li><a href=#allow-ssh-to-the-firewall>Allow ssh to the firewall</a><ul><li><a href=#default-policy-drop>Default policy DROP</a></li><li><a href=#snat>SNAT</a></li><li><a href=#we-allowed-the-ssh-from-the-firecut-to-the-lan>We allowed the ssh from the firecut to the LAN</a></li><li><a href=#we-allow-traffic-for-the-loopback-interface>We allow traffic for the loopback interface</a></li></ul></li><li><a href=#petitions-and-responses-protocol-icmp>Petitions and responses protocol ICMP</a><ul><li><a href=#allow-to-do-ping-from-the-lan>Allow to do ping from the LAN</a></li></ul></li><li><a href=#dns-consultations-and-responses-from-the-lan>DNS consultations and responses from the LAN</a><ul><li><a href=#we-allow-web-navigation-from-the-lan>We allow web navigation from the LAN</a></li><li><a href=#we-allow-access-to-our-lan-web-server-from-the-outside>We allow access to our LAN web server from the outside</a></li></ul></li><li><a href=#additional-exercises>Additional exercises</a><ul><li><a href=#it-allows-to-make-ssh-connections-to-the-outside-from-the-firewall-machine>It allows to make ssh connections to the outside from the firewall machine.</a></li><li><a href=#it-allows-dns-queries-from-the-firewall-machine-only-to-the-8888-server-check-that-you-cant-make-a-dig--1111>It allows DNS queries from the firewall machine only to the 8.8.8.8 server. Check that you can&rsquo;t make a dig @ 1.1.1.1.</a></li><li><a href=#it-allows-the-firewall-machine-to-navigate-through-https>It allows the firewall machine to navigate through https.</a></li><li><a href=#local-network-equipment-should-be-able-to-have-an-external-connection>Local network equipment should be able to have an external connection.</a></li><li><a href=#we-allowed-the-ssh-from-the-firewall-to-the-lan>We allowed the ssh from the firewall to the LAN</a></li><li><a href=#we-allowed-to-do-ping-from-the-lan-to-the-firewall-machine>We allowed to do ping from the LAN to the firewall machine.</a></li><li><a href=#allows-to-make-ssh-connections-from-lan-equipment>Allows to make ssh connections from LAN equipment</a></li><li><a href=#install-a-post-server-on-the-lan-machine-it-allows-access-from-the-outside-and-from-the-firewall-to-the-post-server-to-prove-it-you-can-run-a-telnet-to-port-25-tcp>Install a post server on the LAN machine. It allows access from the outside and from the firewall to the post server. To prove it you can run a telnet to port 25 tcp.</a></li><li><a href=#allows-to-make-ssh-connections-from-outside-to-the-lan>Allows to make ssh connections from outside to the LAN</a></li><li><a href=#modifies-the-above-rule-so-that-when-we-access-from-the-outside-by-ssh-we-have-to-connect-to-port-2222-although-the-ssh-server-is-configured-to-access-by-port-22>Modifies the above rule, so that when we access from the outside by ssh we have to connect to port 2222, although the ssh server is configured to access by port 22.</a></li><li><a href=#it-allows-dns-queries-from-the-lan-only-to-the-8888-server-check-that-you-cant-make-a-dig--1111>It allows DNS queries from the LAN only to the 8.8.8.8 server. Check that you can&rsquo;t make a dig @ 1.1.1.1.</a></li><li><a href=#allows-lan-equipment-to-browse-the-internet-except-for-the--page>Allows LAN equipment to browse the Internet, except for the <a href=http://www.realbetisbalompie.es>www.realbetisbalompie.es</a> page</a></li><li><a href=#make-the-rules-persistent>Make the rules persistent</a></li><li><a href=#rules-at-the-end-of-the-year>Rules at the end of the year</a></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#about>About Me</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#accomplishments>Certifications</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:contacto@javiercd.es target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>contacto@javiercd.es</span></a></li><li><a href=https://github.com/javierasping target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>javierasping</span></a></li><li><a href=https://www.linkedin.com/in/javiercd target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Francisco Javier Cruces Doval</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>Liability Notice:</strong> This theme is under MIT license. So, you can use it for non-commercial, commercial, or private uses. You can modify or distribute the theme without requiring any permission from the theme author. However, the theme author does not provide any warranty or takes any liability for any issue with the theme.</p></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu_b3360284c55cf72d.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">¬© 2023 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.b6e81adc7ec7b607dcd44cb550d5ac0e8aa374ad64c95daf8eddf470660f2331.js integrity="sha256-tuga3H7Htgfc1Ey1UNWsDoqjdK1kyV2vjt30cGYPIzE=" defer></script></body></html>