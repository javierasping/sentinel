<!doctype html><html lang=en><head><title>Implementation of a perimeter firewall with Nftables II</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.ddf4c4775d35e5bc3dd64c797b179f99eaf85cf9811e64bd08f8c44a68d0b229.css integrity="sha256-3fTEd1015bw91kx5exefmer4XPmBHmS9CPjESmjQsik="><link rel=icon type=image/png href=/images/site/avatar_hu_f10227dc088ad43a.jpg><meta property="og:title" content="Atlas"><meta property="og:type" content="website"><meta property="og:description" content="Portfolio and personal blog of Francisco Javier Cruces Doval"><meta property="og:image" content="/images/author/john.png"><meta property="og:url" content="https://www.javiercd.es"><meta name=description content="Implementation of a perimeter firewall with Nftables II"><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-GVDYVWJLRH"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GVDYVWJLRH")}</script><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/en><img src=/images/site/masthead_hu_f10227dc088ad43a.png id=logo alt=Logo>
Atlas</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/en#home>Home</a></li><li class=nav-item><a class=nav-link href=/en#about>About Me</a></li><li class=nav-item><a class=nav-link href=/en#skills>Skills</a></li><li class=nav-item><a class=nav-link href=/en#education>Education</a></li><li class=nav-item><a class=nav-link href=/en#recent-posts>Recent Posts</a></li><li class=nav-item><a class=nav-link href=/en#accomplishments>Certifications</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/en/posts>Posts</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=languageSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><span class="fi fi-gb"></span>
English</a><div class=dropdown-menu aria-labelledby=languageSelector><a class="dropdown-item nav-link languages-item" href=/posts/cortafuegos/nftables_dos/cortafuegos_dos><span class="fi fi-es"></span>
Español
</a><a class="dropdown-item nav-link languages-item" href=/en/posts/cortafuegos/nftables_dos/cortafuegos_dos><span class="fi fi-gb"></span>
English</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/masthead_hu_f10227dc088ad43a.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/en/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/en/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/ci_cd/> CI / CD Jenkins</a><ul><li><a class=list-link href=/en/posts/ci_cd/practica_jenkins/ title="CI / CD practice with Jenkins">CI / CD practice with Jenkins</a></li><li><a class=list-link href=/en/posts/ci_cd/taller1_jenkins/ title="Workshop 1 Ortho-rector of markdown documents (test)">Workshop 1 Ortho-rector of markdown documents (test)</a></li><li><a class=list-link href=/en/posts/ci_cd/taller2_jenkins/ title="Workshop 2 Valid HTML5 check and surge.sh deployment (test and deploy)">Workshop 2 Valid HTML5 check and surge.sh deployment (test and deploy)</a></li><li><a class=list-link href=/en/posts/ci_cd/taller3_jenkins/ title="Workshop 3 Continuous integration of django application (Test)">Workshop 3 Continuous integration of django application (Test)</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/base_de_datos/> Database</a><ul><li><a class=list-link href=/en/posts/base_de_datos/instalar_mariadb/ title="Install MariaDB in Debian">Install MariaDB in Debian</a></li><li><a class=list-link href=/en/posts/base_de_datos/interconexion_de_servidores/ title="Interconnection of database servers">Interconnection of database servers</a></li><li><a class=list-link href=/en/posts/base_de_datos/instalacion_oracle_19c_debian12/ title="Oracle 19c installation under Debian 12">Oracle 19c installation under Debian 12</a></li><li><a class=list-link href=/en/posts/base_de_datos/instalar_postgresql/ title="PostgreSQL installation in Debian 12">PostgreSQL installation in Debian 12</a></li><li><a class=list-link href=/en/posts/base_de_datos/oracle_acceso_remoto/ title="Remote access configuration in Oracle">Remote access configuration in Oracle</a></li><li><a class=list-link href=/en/posts/base_de_datos/acceso_remoto_mariadb/ title="Remote access in MariaDB">Remote access in MariaDB</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/docker/> Docker</a><ul><li><a class=list-link href=/en/posts/docker/instalar_docker_compose/ title="Docker Compose Installation on Ubuntu 24">Docker Compose Installation on Ubuntu 24</a></li><li><a class=list-link href=/en/posts/docker/instalar_docker_ubuntu24/ title="Docker Installation on Ubuntu 24">Docker Installation on Ubuntu 24</a></li><li><a class=list-link href=/en/posts/docker/taller1/ title="Workshop 1 Storage and networks in Docker">Workshop 1 Storage and networks in Docker</a></li><li><a class=list-link href=/en/posts/docker/taller2/ title="Workshop 2 Multicontainer Scenarios in Docker">Workshop 2 Multicontainer Scenarios in Docker</a></li><li><a class=list-link href=/en/posts/docker/taller3/ title="Workshop 3 Image creation Docker">Workshop 3 Image creation Docker</a></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/en/posts/cortafuegos/> Firewall</a><ul class=active><li><a class=list-link href=/en/posts/cortafuegos/fortinet_cli/ title="Fortinet CLI">Fortinet CLI</a></li><li><a class=list-link href=/en/posts/cortafuegos/fortinet_uno/ title="Perimetral with Fortinet I">Perimetral with Fortinet I</a></li><li><a class=list-link href=/en/posts/cortafuegos/fortinet_dos/ title="Perimetral with Fortinet II">Perimetral with Fortinet II</a></li><li><a class=list-link href=/en/posts/cortafuegos/nftables_uno/ title="Perimetral with Nftables I">Perimetral with Nftables I</a></li><li><a class="active list-link" href=/en/posts/cortafuegos/nftables_dos/ title="Perimetral with Nftables II">Perimetral with Nftables II</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/drivers/> Linux Drivers</a><ul><li><a class=list-link href=/en/posts/drivers/nvidia_driver/ title="Drivers Nvidia">Drivers Nvidia</a></li><li><a class=list-link href=/en/posts/drivers/nvidia_optimus/ title="How to choose which graph to use on my laptop with Linux">How to choose which graph to use on my laptop with Linux</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/redes/> Networks</a><ul><li><a class=list-link href=/en/posts/redes/android_gns3/ title="Android GNS3-KVM">Android GNS3-KVM</a></li><li><a class=list-link href=/en/posts/redes/escenario_ipv6_basico/ title="Basic IPv6 scenario">Basic IPv6 scenario</a></li><li><a class=list-link href=/en/posts/redes/instalacion_wireshark_gns3/ title="GNS3 and Wireshark installation">GNS3 and Wireshark installation</a></li><li><a class=list-link href=/en/posts/redes/instalar_gns3_debian12/ title="GNS3 installation in Debian 12">GNS3 installation in Debian 12</a></li><li><a class=list-link href=/en/posts/redes/switches_gns3/ title="GNS3 switch configuration">GNS3 switch configuration</a></li><li><a class=list-link href=/en/posts/redes/tuneles_ipv6/ title="IPV6 Tunnels">IPV6 Tunnels</a></li><li><a class=list-link href=/en/posts/redes/configuracion_de_nat/ title="NAT in Cisco and Linux">NAT in Cisco and Linux</a></li><li><a class=list-link href=/en/posts/redes/comandos_de_supervision_de_redes/ title="Network monitoring commands">Network monitoring commands</a></li><li><a class=list-link href=/en/posts/redes/enroutamiento_openstack/ title="OpenStack routing">OpenStack routing</a></li><li><a class=list-link href=/en/posts/redes/arp/ title="Protocol ARP">Protocol ARP</a></li><li><a class=list-link href=/en/posts/redes/underworld/ title=Underworld>Underworld</a></li><li><a class=list-link href=/en/posts/redes/underworld_evolution/ title="Underworld evolution">Underworld evolution</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/seguridad/> Security</a><ul><li><a class=list-link href=/en/posts/seguridad/forense/ title="Forensic computer">Forensic computer</a></li><li><a class=list-link href=/en/posts/seguridad/https_autofirmado/ title=HTTPS>HTTPS</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/> Services</a><ul><li><a class=list-link href=/en/posts/servicios/apache/ title=Apache>Apache</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/dhcp/> DHCP</a><ul><li><a class=list-link href=/en/posts/servicios/dhcp/instalacion_y_configuracion_de_un_servidor_dhcp_en_linux/ title="Installation and Configuration of a DHCP Server on Linux">Installation and Configuration of a DHCP Server on Linux</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/dns/> DNS</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/dns/bind9/> BIND9</a><ul><li><a class=list-link href=/en/posts/servicios/dns/bind9/dns_esclavo/ title="Configuring a Slave DNS Server with BIND9">Configuring a Slave DNS Server with BIND9</a></li><li><a class=list-link href=/en/posts/servicios/dns/bind9/instalacion_basica/ title="Installation and Configuration of BIND9 on Linux">Installation and Configuration of BIND9 on Linux</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/servicios/dns/dnsmasq/> DNSMASQ</a><ul><li><a class=list-link href=/en/posts/servicios/dns/dnsmasq/instalacion_basica/ title="Local Server with DNSMasq">Local Server with DNSMasq</a></li></ul></li></ul></li><li><a class=list-link href=/en/posts/servicios/ftp/ title=FTP>FTP</a></li><li><a class=list-link href=/en/posts/servicios/nat_iptables/ title="NAT with iptables">NAT with iptables</a></li><li><a class=list-link href=/en/posts/servicios/ssh/ title=SSH>SSH</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/> Systems</a><ul><li><a class=list-link href=/en/posts/sistemas/ad_ubuntu/ title="Active Directory in Ubuntu">Active Directory in Ubuntu</a></li><li><a class=list-link href=/en/posts/sistemas/recoleccion_logs_journald/ title="Centralized collection of logs journald">Centralized collection of logs journald</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/compilaciones_linux/> Compilations in LINUX</a><ul><li><a class=list-link href=/en/posts/sistemas/compilaciones_linux/compilacion_de_un_programa_en_c_utilizando_un_makefile/ title="Compilation of a C-program using a Makefile">Compilation of a C-program using a Makefile</a></li><li><a class=list-link href=/en/posts/sistemas/compilaciones_linux/compilacion_de_un_kernel/ title="Compilation of a kernel">Compilation of a kernel</a></li></ul></li><li><a class=list-link href=/en/posts/sistemas/creacion_de_un_sistema_automatizado_de_instalacion/ title="Creation of an automated installation system">Creation of an automated installation system</a></li><li><a class=list-link href=/en/posts/sistemas/samba_debian/ title="Install and configure samba in Debian">Install and configure samba in Debian</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/comandos_linux/> Linux Command</a><ul><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_de_modificacion_de_parametros_del_kernel/ title="Kernel parameter modification exercises">Kernel parameter modification exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/comandos_procesos/ title="Linux processes">Linux processes</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_de_manejo_de_modulos/ title="Module management exercises">Module management exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/gestion_de_paquetes/ title="Package management">Package management</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/empaquetadores_compresores/ title="Packaging and compressors">Packaging and compressors</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/ejercicios_gestion_de_paqueteria/ title="Paid management exercises">Paid management exercises</a></li><li><a class=list-link href=/en/posts/sistemas/comandos_linux/programacion_tareas/ title="Task programming">Task programming</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/sistemas/migraciones/> Migration in Linnux</a><ul><li><a class=list-link href=/en/posts/sistemas/migraciones/migracion_sistema_de_ficheros/ title="File system">File system</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/paso_de_centos_stream_8_a_centos_stream_9/ title="Migtation from CentOS stream 8 to CentOS stream 9">Migtation from CentOS stream 8 to CentOS stream 9</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/eliminacion_systemd/ title="Systemd elimination">Systemd elimination</a></li><li><a class=list-link href=/en/posts/sistemas/migraciones/transformacion_instancia_cloud/ title="Transformation instance cloud">Transformation instance cloud</a></li></ul></li><li><a class=list-link href=/en/posts/sistemas/nfs_debian/ title="NFS in Debian">NFS in Debian</a></li><li><a class=list-link href=/en/posts/sistemas/activacion_selinux/ title="SELinux activation configuration">SELinux activation configuration</a></li><li><a class=list-link href=/en/posts/sistemas/comparticion_de_directorios_en_windows/ title="Share resources in Windows">Share resources in Windows</a></li><li><a class=list-link href=/en/posts/sistemas/ssh_windows/ title="Ssh service in Windows">Ssh service in Windows</a></li><li><a class=list-link href=/en/posts/sistemas/almacenamiento_servidor_independiente/ title="Storage Spaces in Windows Server">Storage Spaces in Windows Server</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/vpn/> VPN</a><ul><li><a class=list-link href=/en/posts/vpn/comparativa_ovpn_wire/ title="OpenVPN and Wireguard Comparative">OpenVPN and Wireguard Comparative</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_openvpn/ title="OpenVPN remote access">OpenVPN remote access</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_strongswang/ title="Remote access Ipsec StrongSwan">Remote access Ipsec StrongSwan</a></li><li><a class=list-link href=/en/posts/vpn/ipsec_cisco/ title="Site-to-Site IPsec Cisco">Site-to-Site IPsec Cisco</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_fortinet/ title="Site-to-Site IPsec Fortinet">Site-to-Site IPsec Fortinet</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_openvpn/ title="Site-to-Site OpenVPN">Site-to-Site OpenVPN</a></li><li><a class=list-link href=/en/posts/vpn/site_to_site_wireguard/ title="Site-to-Site Wireguard">Site-to-Site Wireguard</a></li><li><a class=list-link href=/en/posts/vpn/acceso_remoto_wireguard/ title="Wireguard remote access">Wireguard remote access</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/en/posts/iaw/> Web applications</a><ul><li><a class=list-link href=/en/posts/iaw/lamp/ title="LAMP stack installation">LAMP stack installation</a></li><li><a class=list-link href=/en/posts/iaw/lemp/ title="LEMP stack installation">LEMP stack installation</a></li><li><a class=list-link href=/en/posts/iaw/wordpress/ title="WordPress LAMP">WordPress LAMP</a></li><li><a class=list-link href=/en/posts/iaw/wordpress_lemp/ title="WordPress LEMP">WordPress LEMP</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/cortafuegos/nftables2.png)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/john_hu_2aff0fda0501496d.png alt="Author Image"><h5 class=author-name>Francisco Javier Cruces Doval</h5><p class=text-muted>Thursday, March 28, 2024 | 42 minutes</p></div><div class=title><h1>Implementation of a perimeter firewall with Nftables II</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/en/tags/firewall/ class="btn btn-sm btn-info">FIREWALL</a></li><li class=rounded><a href=/en/tags/linux/ class="btn btn-sm btn-info">LINUX</a></li><li class=rounded><a href=/en/tags/debian/ class="btn btn-sm btn-info">DEBIAN</a></li><li class=rounded><a href=/en/tags/nftables/ class="btn btn-sm btn-info">NFTABLES</a></li></ul></div><div class=post-content id=post-content><p>On the stage created in the service module with the Odin (Router), Hela (DMZ), Loki and Thor (LAN) machines and using nftables, it sets up a perimeter firewall on the Odin machine so that the stage continues to function completely taking into account the following points:</p><p>• The creation of different chains for each traffic flow (from LAN to the outside, from LAN to DMZ, etc.) will be valued.
• Default DROP policy for all chains.
• You can use the extensions that we create appropriate, but at least you should follow the connection when necessary.
• We must implement the firewall to work after a machine reboot.
• You must show proof of operation of all rules.</p><p>In order not to make the practice too long, I will show you the hits of the rules at the end, as well as the complete script of the rules. Since I will only put in every exercise the rules that intervene and a check of it.</p><h3 id=ride-the-stage-with-nftables>Ride the stage with Nftables</h3><p>I&rsquo;m gonna remove iptables and we&rsquo;re gonna move on to Nfables so we don&rsquo;t lose any stage functionality.</p><p>The first thing is to create the tables and chains:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft add table inet filter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter input <span style=color:#f92672>{</span> type filter hook input priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter output <span style=color:#f92672>{</span> type filter hook output priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter WAN_LAN <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter WAN_DMZ <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter LAN_WAN <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter LAN_DMZ <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter DMZ_LAN <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain inet filter DMZ_WAN <span style=color:#f92672>{</span> type filter hook forward priority 0<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>So would our chains created:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft list chains
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain WAN_LAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain WAN_DMZ <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain LAN_WAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain DMZ_LAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain LAN_DMZ <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	chain DMZ_WAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter; policy accept;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>The LAN network corresponds to the network of the containers 192.168.0.0 / 24.
The DMZ network corresponds to the helium network 172.16.0.0 / 16.</p><p>We continue to create the NAT table to be able to configure the SNAT and the DNAT, since these are usually a small number of rules I will not create different chains:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Creamos la tabla NAT</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add table nat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Cadena para el DNAT</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain nat prerouting <span style=color:#f92672>{</span> type nat hook prerouting priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Cadena para el SNAT</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo nft add chain nat postrouting <span style=color:#f92672>{</span> type nat hook postrouting priority <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=-snat-rules># SNAT rules</h2><p>Once this is done I will create the rules of SNAT so that our customers can go online on the LAN and DMZ network:</p><p>My network card that&rsquo;s facing the outside is the ens4.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Regla SNAT para LAN</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter masquerade
</span></span><span style=display:flex><span><span style=color:#75715e>#Regla SNAT para DMZ</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> iffname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.0/16 counter masquerade
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter snat to 172.22.200.47
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.0/16 counter snat to 172.22.200.47
</span></span></code></pre></div><p>Let&rsquo;s check that customers already have access to the Internet, currently the default policy is ACCEPT.</p><p>Check for SNAT in Hela:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ ping www.javiercd.es -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING javierasping.github.io <span style=color:#f92672>(</span>185.199.109.153<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from cdn-185-199-109-153.github.com <span style=color:#f92672>(</span>185.199.109.153<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span> time<span style=color:#f92672>=</span>39.4 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- javierasping.github.io ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 39.439/39.439/39.439/0.000 ms
</span></span></code></pre></div><p>Verification of SNAT in Thor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@thor:~$ ping www.javiercd.es -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING javierasping.github.io <span style=color:#f92672>(</span>185.199.108.153<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from cdn-185-199-108-153.github.com <span style=color:#f92672>(</span>185.199.108.153<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span> time<span style=color:#f92672>=</span>38.1 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- javierasping.github.io ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 38.138/38.138/38.138/0.000 ms
</span></span></code></pre></div><p>Verification of SNAT in Loki:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@loki:~$ ping www.javiercd.es -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING javierasping.github.io <span style=color:#f92672>(</span>185.199.111.153<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from cdn-185-199-111-153.github.com <span style=color:#f92672>(</span>185.199.111.153<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span> time<span style=color:#f92672>=</span>37.7 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- javierasping.github.io ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 37.667/37.667/37.667/0.000 ms
</span></span></code></pre></div><p>Finally we will make sure that the rule receives hits:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft list ruleset
</span></span><span style=display:flex><span><span style=color:#75715e>#Salida del comando recortada</span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.0/16 counter packets <span style=color:#ae81ff>11</span> bytes <span style=color:#ae81ff>868</span> masquerade
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter packets <span style=color:#ae81ff>122</span> bytes <span style=color:#ae81ff>10594</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=-dnat-rules># DNAT rules</h2><p>The previous rules we had were as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo iptables -L -t nat
</span></span><span style=display:flex><span>Chain PREROUTING <span style=color:#f92672>(</span>policy ACCEPT<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>target     prot opt source               destination         
</span></span><span style=display:flex><span>DNAT       tcp  --  anywhere             anywhere             tcp dpt:http to:172.16.0.200
</span></span><span style=display:flex><span>DNAT       udp  --  anywhere             anywhere             udp dpt:domain to:192.168.0.2
</span></span><span style=display:flex><span>DNAT       tcp  --  anywhere             anywhere             tcp dpt:smtp to:192.168.0.3
</span></span><span style=display:flex><span>DNAT       tcp  --  anywhere             anywhere             tcp dpt:mysql to:192.168.0.3
</span></span></code></pre></div><p>So let&rsquo;s move them to nftables:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Para un wordpress que hay en hela</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>80</span> counter dnat to 172.16.0.200
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Para hacer consultas DNS a thor</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting udp dport <span style=color:#ae81ff>53</span> counter dnat to 192.168.0.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Para poder recibir correos en loki</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>25</span> counter dnat to 192.168.0.3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Para acceder desde fuera a un mysql que hay en loki</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>3306</span> counter dnat to 192.168.0.3
</span></span></code></pre></div><p>Now let&rsquo;s add a series of rules to allow the previous traffic and the rest of the stage preparation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#PERMITIR USO DE ODIN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Permitir consultas DNS de odin a thor (DNSSERVER)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Permitir tráfico HTTP y HTTPS en odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp dport <span style=color:#f92672>{</span> 80,443 <span style=color:#f92672>}</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp sport <span style=color:#f92672>{</span> 80,443 <span style=color:#f92672>}</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Permitir conexiones SSH por el puerto 2222</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter dnat to 192.168.0.1:22
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Permitir conexiones SSH de odin a hela</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.0/16 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.0/16 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Permitir conexiones ssh de odin a thor y loki</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.0/24 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Reglas perimetrales</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Permitir consultas DNS desde br-intra hacia ens4 , necesario para el forward del dns (ESTA REGLA SOLO ME FUNCIONA SI ESTA EN LA MISMA CADENA)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_WAN iifname &#34;br-intra2&#34; oifname &#34;ens4&#34; udp dport 53 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_DMZ iifname &#34;ens4&#34; oifname &#34;br-intra2&#34; udp sport 53 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Permitir consultas dns desde LAN a DMZ (hela --&gt; thor) (ESTA REGLA SOLO ME FUNCIONA SI ESTA EN LA MISMA CADENA)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; udp dport 53 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; udp sport 53 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Reglas para permitir trafico a wordpress en hela</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Regla para hacer consultas DNS a thor (Permitir DNAT)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 udp dport <span style=color:#ae81ff>53</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.2 udp sport <span style=color:#ae81ff>53</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Regla para recibir e enviar correos en loki</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Permitir a hela usar el servidor LDAP</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter LAN_DMZ iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> tcp dport <span style=color:#ae81ff>389</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_LAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>389</span> counter accept
</span></span></code></pre></div><h2 id=exercises>Exercises</h2><p>The firewall must meet at least these rules:</p><h3 id=the-odin-machine-has-a-ssh-server-listening-to-port-22-but-when-you-access-from-the-outside-you-will-have-to-connect-to-port-2222>The Odin machine has a ssh server listening to port 22, but when you access from the outside you will have to connect to port 2222.</h3><p>To perform this exercise I will do a DNAT to the DMZ interface of odin which is the 192.168.0.1, so I will connect to that interface by ssh. After that we must allow this traffic that goes from the ens4 to the ens3.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Permitimos el trafico que ahora &#34;cambiamos&#34; el puerto con la regla DNAT de 2222 a 22 hacia odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span><span style=color:#75715e>#Regla DNAT</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter dnat to 192.168.0.1:22
</span></span></code></pre></div><p>I will put the default DROP policy once I reach this point:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nft chain inet filter input <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter output <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter WAN_LAN <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter WAN_DMZ <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter LAN_WAN <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter DMZ_LAN <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter LAN_DMZ <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft chain inet filter DMZ_WAN <span style=color:#f92672>{</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>And let&rsquo;s check that the connection works by port 2222:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@HPOMEN15:~$ ssh 172.22.200.47 -p <span style=color:#ae81ff>2222</span>
</span></span><span style=display:flex><span>Linux odin.javiercd.gonzalonazareno.org 6.1.0-18-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Sat Mar  <span style=color:#ae81ff>9</span> 13:49:09 <span style=color:#ae81ff>2024</span> from 172.29.0.58
</span></span><span style=display:flex><span>javiercruces@odin:~$ 
</span></span></code></pre></div><p>We checked the hits in the rules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft list ruleset
</span></span><span style=display:flex><span><span style=color:#75715e>#IMPUT</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>241918</span> bytes <span style=color:#ae81ff>13788652</span> accept
</span></span><span style=display:flex><span><span style=color:#75715e>#OUTPUT</span>
</span></span><span style=display:flex><span>oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>355383</span> bytes <span style=color:#ae81ff>210012030</span> accept
</span></span><span style=display:flex><span><span style=color:#75715e>#DNAT</span>
</span></span><span style=display:flex><span>iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter packets <span style=color:#ae81ff>5</span> bytes <span style=color:#ae81ff>300</span> dnat to 192.168.0.1:22
</span></span></code></pre></div><h3 id=from-thor-and-hela-you-should-allow-the-ssh-connection-by-port-22-to-the-odin-machine>From Thor and Hela you should allow the ssh connection by port 22 to the Odin machine.</h3><p>To be able to check these rules I will allow ssh connections from Odin to both DMZ and LAN networks</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Permitir conexiones ssh de odin a hela</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.0/16 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.0/16 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Permitir conexiones ssh de odin a thor y loki</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.0/24 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Permitir conexion ssh desde hela a odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Permitir conexion ssh desde thor a odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.2 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span></code></pre></div><p>Let&rsquo;s check the two above rules by connecting to Odin by ssh from these two customers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Hela --&gt; Odin</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ ssh 172.16.0.200 -A
</span></span><span style=display:flex><span>Last login: Sat Mar  <span style=color:#ae81ff>9</span> 19:02:49 <span style=color:#ae81ff>2024</span> from 172.16.0.1
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ ssh 172.16.0.1
</span></span><span style=display:flex><span>Linux odin.javiercd.gonzalonazareno.org 6.1.0-18-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Sat Mar  <span style=color:#ae81ff>9</span> 19:49:28 <span style=color:#ae81ff>2024</span> from 192.168.0.2
</span></span><span style=display:flex><span>javiercruces@odin:~$ 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Thor --&gt; Odin</span>
</span></span><span style=display:flex><span>javiercruces@thor:~$ ssh 192.168.0.1
</span></span><span style=display:flex><span>Linux odin.javiercd.gonzalonazareno.org 6.1.0-18-amd64 <span style=color:#75715e>#1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Sat Mar  <span style=color:#ae81ff>9</span> 19:46:12 <span style=color:#ae81ff>2024</span> from 192.168.0.2
</span></span><span style=display:flex><span>javiercruces@odin:~$ 
</span></span></code></pre></div><p>I&rsquo;ll leave you the rule hits at the end of practice.</p><h3 id=the-odin-machine-must-be-allowed-traffic-for-the-loopback-interface>The Odin machine must be allowed traffic for the loopback interface.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept    
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept
</span></span></code></pre></div><p>Check:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ ping 127.0.0.1 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 127.0.0.1 <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 127.0.0.1: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.100 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 127.0.0.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.100/0.100/0.100/0.000 ms
</span></span></code></pre></div><h3 id=the-odin-machine-can-be-ping-from-the-dmz-but-from-the-lan-the-connection-reject-must-be-rejected-and-from-the-outside-will-be-rejected-silently>The Odin machine can be ping from the DMZ, but from the LAN the connection (REJECT) must be rejected and from the outside will be rejected silently.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#DMZ</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol icmp icmp type echo-reply counter accept
</span></span><span style=display:flex><span><span style=color:#75715e>#Las siguientes 2 reglas , no funcionaran como esperamos ya que hacen lo mismo que la politica por defecto , ademas no se permite este trafico .</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#LAN</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp counter reject
</span></span><span style=display:flex><span><span style=color:#75715e>#Exterior</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp counter drop
</span></span></code></pre></div><p>Let&rsquo;s check these rules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#LAN Thor a odin</span>
</span></span><span style=display:flex><span>javiercruces@thor:~$ ping 192.168.0.1
</span></span><span style=display:flex><span>PING 192.168.0.1 <span style=color:#f92672>(</span>192.168.0.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>From 192.168.0.1 icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> Destination Port Unreachable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#DMZ , Hela --&gt; Odin</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ ping 172.16.0.1 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 172.16.0.1 <span style=color:#f92672>(</span>172.16.0.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 172.16.0.1: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.471 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 172.16.0.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.471/0.471/0.471/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Exterior a odin</span>
</span></span><span style=display:flex><span>javiercruces@HPOMEN15:~$ ping 172.22.200.47
</span></span><span style=display:flex><span>PING 172.22.200.47 <span style=color:#f92672>(</span>172.22.200.47<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 172.22.200.47 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>419</span> packets transmitted, <span style=color:#ae81ff>0</span> received, 100% packet loss, time 428036ms
</span></span></code></pre></div><p>At the end of the practice I&rsquo;ll leave you all the hits of the rules.</p><h3 id=the-odin-machine-can-do-ping-to-the-lan-the-dmz-and-the-outside>The Odin machine can do ping to the LAN, the DMZ and the outside.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#PERMITIR PING A DMZ</span>
</span></span><span style=display:flex><span>sudo nft insert rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft insert rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PERMITIR PING A EXTERIOR</span>
</span></span><span style=display:flex><span>sudo nft insert rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft insert rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PERMITIR PING A LAN</span>
</span></span><span style=display:flex><span>sudo nft insert rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft insert rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-reply counter accept
</span></span></code></pre></div><p>Check:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ ping 8.8.8.8 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 8.8.8.8 <span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 8.8.8.8: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>116</span> time<span style=color:#f92672>=</span>8.70 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 8.8.8.8 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 8.701/8.701/8.701/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ ping 192.168.0.2 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 192.168.0.2 <span style=color:#f92672>(</span>192.168.0.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>6.030 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 192.168.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.030/0.030/0.030/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ ping 172.16.0.200 -c <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>PING 172.16.0.200 <span style=color:#f92672>(</span>172.16.0.200<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 172.16.0.200: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>59.1 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 172.16.0.200 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 59.052/59.052/59.052/0.000 ms
</span></span></code></pre></div><h3 id=from-the-hela-machine-you-can-make-ping-and-ssh-connection-to-lan-machines>From the Hela machine you can make ping and ssh connection to LAN machines.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>##Si no estan en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 ip protocol icmp icmp type echo-request counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 ip protocol icmp icmp type echo-reply counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp dport 22 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp sport 22 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 ip protocol icmp icmp type echo-reply counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter accept
</span></span></code></pre></div><p>Check:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ ping 192.168.0.2
</span></span><span style=display:flex><span>PING 192.168.0.2 <span style=color:#f92672>(</span>192.168.0.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 192.168.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>63</span> time<span style=color:#f92672>=</span>0.596 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 192.168.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.596/0.596/0.596/0.000 ms
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ ssh  192.168.0.2
</span></span><span style=display:flex><span>Welcome to Ubuntu 22.04.3 LTS <span style=color:#f92672>(</span>GNU/Linux 6.1.0-18-amd64 x86_64<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> * Documentation:  https://help.ubuntu.com
</span></span><span style=display:flex><span> * Management:     https://landscape.canonical.com
</span></span><span style=display:flex><span> * Support:        https://ubuntu.com/advantage
</span></span><span style=display:flex><span>Last login: Sun Mar <span style=color:#ae81ff>10</span> 14:52:57 <span style=color:#ae81ff>2024</span> from 192.168.0.1
</span></span><span style=display:flex><span>javiercruces@thor:~$ 
</span></span></code></pre></div><h3 id=from-any-lan-machine-you-can-connect-ssh-to-the-hela-machine>From any LAN machine you can connect ssh to the hela machine.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>##Si no esta en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 22 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 22 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter accept
</span></span></code></pre></div><p>Check:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@thor:~$ ssh 172.16.0.200
</span></span><span style=display:flex><span>Last login: Sun Mar <span style=color:#ae81ff>10</span> 14:53:12 <span style=color:#ae81ff>2024</span> from 192.168.0.2
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>javiercruces@hela ~<span style=color:#f92672>]</span>$ 
</span></span></code></pre></div><h3 id=configure-the-odin-machine-so-that-lan-and-dmz-machines-can-access-the-outside>Configure the Odin machine so that LAN and DMZ machines can access the outside.</h3><p>These rules were already indicated.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter masquerade
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.0/16 counter masquerade
</span></span></code></pre></div><h3 id=lan-machines-can-do-ping-outside-and-navigate>LAN machines can do ping outside and navigate.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Las máquinas de la LAN pueden hacer ping al exterior y navegar.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Si no estan en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_WAN iifname &#34;br-intra2&#34; oifname &#34;ens4&#34; ip protocol icmp icmp type echo-request counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_LAN iifname &#34;ens4&#34; oifname &#34;br-intra2&#34; ip protocol icmp icmp type echo-reply counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp icmp type echo-reply counter accept
</span></span></code></pre></div><p>Check:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@thor:~$ curl -I https://www.javiercd.es
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span> 
</span></span><span style=display:flex><span>server: GitHub.com
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>last-modified: Sat, <span style=color:#ae81ff>02</span> Mar <span style=color:#ae81ff>2024</span> 10:17:01 GMT
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>31556952</span>
</span></span><span style=display:flex><span>etag: <span style=color:#e6db74>&#34;65e2fc9d-675b&#34;</span>
</span></span><span style=display:flex><span>expires: Sun, <span style=color:#ae81ff>10</span> Mar <span style=color:#ae81ff>2024</span> 15:35:43 GMT
</span></span><span style=display:flex><span>cache-control: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>x-proxy-cache: MISS
</span></span><span style=display:flex><span>x-github-request-id: E24C:3800B1:1881E48:18E9A93:65EDD0F7
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>date: Sun, <span style=color:#ae81ff>10</span> Mar <span style=color:#ae81ff>2024</span> 19:14:10 GMT
</span></span><span style=display:flex><span>via: 1.1 varnish
</span></span><span style=display:flex><span>age: <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>x-served-by: cache-mad22083-MAD
</span></span><span style=display:flex><span>x-cache: HIT
</span></span><span style=display:flex><span>x-cache-hits: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>x-timer: S1710098050.166466,VS0,VE2
</span></span><span style=display:flex><span>vary: Accept-Encoding
</span></span><span style=display:flex><span>x-fastly-request-id: 0c6c80bbef19370976aadfc6988441c5a36beccc
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>26459</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@thor:~$ ping 8.8.8.8
</span></span><span style=display:flex><span>PING 8.8.8.8 <span style=color:#f92672>(</span>8.8.8.8<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 8.8.8.8: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>110</span> time<span style=color:#f92672>=</span>38.5 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 8.8.8.8 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 38.451/38.451/38.451/0.000 ms
</span></span></code></pre></div><h3 id=the-hela-machine-can-sail-install-a-web-server-a-ftp-server-and-a-post-server-if-you-dont-have-them-yet>The hela machine can sail. Install a web server, a ftp server and a post server if you don&rsquo;t have them yet.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#La máquina Hela puede navegar. Instala un servidor web, un servidor ftp y un servidor de correos si no los tienes aún.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Hela ya tiene permitido hacer consultas dns a thor</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span></code></pre></div><p>I check that I can navigate:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@hela javiercruces<span style=color:#f92672>]</span><span style=color:#75715e># curl -I https://www.javiercd.es/</span>
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span> 
</span></span><span style=display:flex><span>server: GitHub.com
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>last-modified: Sat, <span style=color:#ae81ff>02</span> Mar <span style=color:#ae81ff>2024</span> 10:17:01 GMT
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>strict-transport-security: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>31556952</span>
</span></span><span style=display:flex><span>etag: <span style=color:#e6db74>&#34;65e2fc9d-675b&#34;</span>
</span></span><span style=display:flex><span>expires: Sun, <span style=color:#ae81ff>10</span> Mar <span style=color:#ae81ff>2024</span> 15:35:43 GMT
</span></span><span style=display:flex><span>cache-control: max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>x-proxy-cache: MISS
</span></span><span style=display:flex><span>x-github-request-id: E24C:3800B1:1881E48:18E9A93:65EDD0F7
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>date: Sun, <span style=color:#ae81ff>10</span> Mar <span style=color:#ae81ff>2024</span> 19:13:17 GMT
</span></span><span style=display:flex><span>via: 1.1 varnish
</span></span><span style=display:flex><span>age: <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>x-served-by: cache-mad22067-MAD
</span></span><span style=display:flex><span>x-cache: HIT
</span></span><span style=display:flex><span>x-cache-hits: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>x-timer: S1710097997.474757,VS0,VE2
</span></span><span style=display:flex><span>vary: Accept-Encoding
</span></span><span style=display:flex><span>x-fastly-request-id: 2d2811893898abf05bebd96c6bd5a09ed7abfe5b
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>26459</span>
</span></span></code></pre></div><p>I understand you want me to install these 3 hela services. On our stage it is the other machines that house these services.</p><h3 id=configure-the-odin-machine-to-make-web-and-ftp-services-accessible-from-the-outside>Configure the Odin machine to make web and ftp services accessible from the outside.</h3><p>The web server is already previously configured in the migration of the scenario.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>21</span> counter dnat to 172.16.0.200
</span></span><span style=display:flex><span><span style=color:#75715e>#No funcionan en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_DMZ iifname &#34;ens4&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 21 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_WAN iifname &#34;ens3&#34; oifname &#34;ens4&#34; ip saddr 172.16.0.200 tcp sport 21 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter accept
</span></span></code></pre></div><h3 id=the-web-server-and-the-ftp-server-must-be-accessible-from-the-lan-and-from-the-outside>The web server and the ftp server must be accessible from the LAN and from the outside.</h3><p>The FTP server is on the LAN so it&rsquo;s already accessible, I&rsquo;m gonna make it accessible from the DMZ. From the outside, both are already accessible.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>##No funcionan las reglass en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 21 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 21 ct state established,related counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 80 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 80 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter accept
</span></span></code></pre></div><p>Access from DMZ to LAN:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@thor:~$ curl 172.16.0.200
</span></span><span style=display:flex><span>&lt;!DOCTYPE html&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>javiercruces@thor:~$ ftp 172.16.0.200
</span></span><span style=display:flex><span>Connected to 172.16.0.200.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> <span style=color:#f92672>(</span>vsFTPd 3.0.5<span style=color:#f92672>)</span>
</span></span></code></pre></div><h3 id=the-post-server-should-only-be-accessible-from-the-lan>The post server should only be accessible from the LAN.</h3><p>We comment on the lines of stage preparation that allow access to the scenario and add:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#No funciona en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip daddr 192.168.0.3 tcp dport 25 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip saddr 192.168.0.3 tcp sport 25 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter accept
</span></span></code></pre></div><p>Let&rsquo;s access the:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@hela javiercruces<span style=color:#f92672>]</span><span style=color:#75715e># telnet 192.168.0.3 25</span>
</span></span><span style=display:flex><span>Trying 192.168.0.3...
</span></span><span style=display:flex><span>Connected to 192.168.0.3.
</span></span><span style=display:flex><span>Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.
</span></span><span style=display:flex><span><span style=color:#ae81ff>220</span> loki.javiercd.gonzalonazareno.org ESMTP Postfix <span style=color:#f92672>(</span>Ubuntu<span style=color:#f92672>)</span>
</span></span></code></pre></div><h3 id=in-the-loki-machine-you-install-a-postgres-server-if-you-dont-have-it-yet-this-server-can-be-accessed-from-the-dmz-but-not-from-the-outside>In the Loki machine you install a Postgres server if you don&rsquo;t have it yet. This server can be accessed from the DMZ, but not from the outside.</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#no funciona en cadenas distintas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip daddr 192.168.0.3 tcp dport 5432 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip saddr 192.168.0.3 tcp sport 5432 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>5432</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>5432</span> ct state established,related counter accept
</span></span></code></pre></div><p>We access the postwree server from hela:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@hela javiercruces<span style=color:#f92672>]</span><span style=color:#75715e># psql -h 192.168.0.3 -U postgres</span>
</span></span><span style=display:flex><span>Password <span style=color:#66d9ef>for</span> user postgres: 
</span></span><span style=display:flex><span>psql <span style=color:#f92672>(</span>13.14, server 14.11 <span style=color:#f92672>(</span>Ubuntu 14.11-0ubuntu0.22.04.1<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>WARNING: psql major version 13, server major version 14.
</span></span><span style=display:flex><span>         Some psql features might not work.
</span></span><span style=display:flex><span>SSL connection <span style=color:#f92672>(</span>protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> help.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres<span style=color:#f92672>=</span><span style=color:#75715e># </span>
</span></span></code></pre></div><h2 id=-avoid-dos-attacks-by-icmp-flood-limiting-the-number-of-requests-per-second-to-4-from-the-same-ip># Avoid DoS attacks by ICMP Flood, limiting the number of requests per second to 4 from the same IP.</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nft insert rule inet filter input icmp type echo-request limit rate 1/second burst <span style=color:#ae81ff>4</span> packets counter drop
</span></span></code></pre></div><p>If we make a flood attack, this will cut the traffic:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@hela javiercruces<span style=color:#f92672>]</span><span style=color:#75715e># hping3 --icmp --flood --rand-source 172.16.0.1 </span>
</span></span><span style=display:flex><span>HPING 172.16.0.1 <span style=color:#f92672>(</span>eth0 172.16.0.1<span style=color:#f92672>)</span>: icmp mode set, <span style=color:#ae81ff>28</span> headers + <span style=color:#ae81ff>0</span> data bytes
</span></span><span style=display:flex><span>hping in flood mode, no replies will be shown
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>icmp type echo-request limit rate 1/second burst <span style=color:#ae81ff>4</span> packets counter packets <span style=color:#ae81ff>46</span> bytes <span style=color:#ae81ff>2128</span> drop
</span></span></code></pre></div><p>Avoid DoS attacks by SYN Flood.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Evita ataques DoS por SYN Flood.</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input tcp flags <span style=color:#ae81ff>\&amp;</span> <span style=color:#e6db74>&#39;(fin|syn|rst|ack) == syn&#39;</span> counter limit rate over 25/second drop
</span></span></code></pre></div><p>If we test the attack:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@hela javiercruces<span style=color:#f92672>]</span><span style=color:#75715e># hping3  --flood --rand-source 172.16.0.1 </span>
</span></span><span style=display:flex><span>HPING 172.16.0.1 <span style=color:#f92672>(</span>eth0 172.16.0.1<span style=color:#f92672>)</span>: NO FLAGS are set, <span style=color:#ae81ff>40</span> headers + <span style=color:#ae81ff>0</span> data bytes
</span></span><span style=display:flex><span>hping in flood mode, no replies will be shown
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 172.16.0.1 hping statistic ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1267916</span> packets transmitted, <span style=color:#ae81ff>0</span> packets received, 100% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max <span style=color:#f92672>=</span> 0.0/0.0/0.0 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>icmp type echo-request limit rate 1/second burst <span style=color:#ae81ff>4</span> packets counter packets <span style=color:#ae81ff>31</span> bytes <span style=color:#ae81ff>2492</span> drop
</span></span></code></pre></div><h2 id=script-with-all-the-rules>Script with all the rules</h2><p>I&rsquo;ll leave you here the script I used during practice.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Crear estructura de tablas</span>
</span></span><span style=display:flex><span>sudo nft delete table inet filter
</span></span><span style=display:flex><span>sudo nft delete table ip nat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Añadir tabla filter y sus cadenas</span>
</span></span><span style=display:flex><span>sudo nft add table inet filter
</span></span><span style=display:flex><span>sudo nft add chain inet filter forward <span style=color:#f92672>{</span> type filter hook forward priority 10<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy drop<span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter input <span style=color:#f92672>{</span> type filter hook input priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter output <span style=color:#f92672>{</span> type filter hook output priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy drop <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter WAN_LAN <span style=color:#f92672>{</span> type filter hook forward priority 1<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter WAN_DMZ <span style=color:#f92672>{</span> type filter hook forward priority 2<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter LAN_WAN <span style=color:#f92672>{</span> type filter hook forward priority 3<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter LAN_DMZ <span style=color:#f92672>{</span> type filter hook forward priority 4<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter DMZ_LAN <span style=color:#f92672>{</span> type filter hook forward priority 5<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain inet filter DMZ_WAN <span style=color:#f92672>{</span> type filter hook forward priority 6<span style=color:#ae81ff>\;</span> counter <span style=color:#ae81ff>\;</span> policy accept <span style=color:#ae81ff>\;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Añadir Tabla NAT y sus cadenas :</span>
</span></span><span style=display:flex><span>sudo nft add table ip nat
</span></span><span style=display:flex><span>sudo nft add chain ip nat prerouting <span style=color:#f92672>{</span> type nat hook prerouting priority <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add chain ip nat postrouting <span style=color:#f92672>{</span> type nat hook postrouting priority <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Reglas para mantener el escenario de clase anterior con IPTABLES</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Reglas SNAT</span>
</span></span><span style=display:flex><span><span style=color:#75715e>###Regla SNAT para LAN</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter masquerade
</span></span><span style=display:flex><span><span style=color:#75715e>###Regla SNAT para DMZ</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat postrouting oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.0/16 counter masquerade
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Reglas DNAT</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Para un wordpress que hay en hela</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>80</span> counter dnat to 172.16.0.200
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Para hacer consultas DNS a thor</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule ip nat prerouting udp dport 53 counter dnat to 192.168.0.2</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr <span style=color:#f92672>{</span> 172.22.0.0/16, 172.19.0.0/16 <span style=color:#f92672>}</span> udp dport <span style=color:#ae81ff>53</span> counter dnat to 192.168.0.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Para poder recibir correos en loki</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>25</span> counter dnat to 192.168.0.3
</span></span><span style=display:flex><span><span style=color:#75715e>#Para acceder desde fuera a un mysql que hay en loki</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>3306</span> counter dnat to 192.168.0.3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PERMITIR USO DE ODIN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Permitir consultas DNS de odin a thor (DNSSERVER)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Permitir tráfico HTTP y HTTPS en odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp dport <span style=color:#f92672>{</span> 80,443 <span style=color:#f92672>}</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp sport <span style=color:#f92672>{</span> 80,443 <span style=color:#f92672>}</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Permitir conexiones SSH por el puerto 2222</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter dnat to 192.168.0.1:22
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Permitir conexiones SSH de odin a hela</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.0/16 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.0/16 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Permitir conexiones ssh de odin a thor y loki</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.0/24 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Reglas perimetrales</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Permitir consultas DNS desde br-intra hacia ens4 , necesario para el forward del dns (ESTA REGLA SOLO ME FUNCIONA SI ESTA EN LA MISMA CADENA)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Permitir consultas dns desde LAN a DMZ (hela --&gt; thor) (ESTA REGLA SOLO ME FUNCIONA SI ESTA EN LA MISMA CADENA)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter LAN_DMZ iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_LAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Reglas para permitir trafico a wordpress en hela</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Regla para hacer consultas DNS a thor (Permitir DNAT)</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter WAN_DMZ iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 udp dport <span style=color:#ae81ff>53</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_WAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.2 udp sport <span style=color:#ae81ff>53</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Regla para recibir e enviar correos en loki</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#No funcionan en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_DMZ iifname &#34;ens4&#34; oifname &#34;br-intra2&#34; ip daddr 192.168.0.3 tcp dport 25 ct state new,established counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_WAN iifname &#34;br-intra2&#34; oifname &#34;ens4&#34; ip saddr 192.168.0.3 tcp sport 25 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Permitir a hela usar el servidor LDAP</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter LAN_DMZ iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> tcp dport <span style=color:#ae81ff>389</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter DMZ_LAN iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>389</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Ejercicios practica</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Permitir conexiones SSH por el puerto 2222</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule ip nat prerouting iifname &#34;ens4&#34; tcp dport 2222 counter dnat to 192.168.0.1:22</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter output oifname &#34;ens4&#34; tcp sport 22 ct state established counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter input iifname &#34;ens4&#34; tcp dport 22 ct state new,established counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Desde Thor y Hela se debe permitir la conexión ssh por el puerto 22 a la máquina Odin.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Permitir conexion ssh desde hela a odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span><span style=color:#75715e>##Permitir conexion ssh desde thor a odin</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.2 tcp dport <span style=color:#ae81ff>22</span> ct state new,established counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 tcp sport <span style=color:#ae81ff>22</span> ct state established counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#La máquina Odin debe tener permitido el tráfico para la interfaz loopback.</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#A la máquina Odin se le puede hacer ping desde la DMZ, pero desde la LAN se le debe rechazar la conexión (REJECT) y desde el exterior se rechazará de manera silenciosa.</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp icmp type echo-reply counter accept
</span></span><span style=display:flex><span><span style=color:#75715e>##Denegar la conexion desde LAN REJECT</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp counter reject
</span></span><span style=display:flex><span><span style=color:#75715e>##Denegar de manera silenciosa desde EXTERIOR</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp counter drop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#La máquina Odin puede hacer ping a la LAN, la DMZ y al exterior.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##LAN</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span><span style=color:#75715e>##EXTERIOR</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span><span style=color:#75715e>##DMZ</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter output oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter input iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-reply counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>####Desde la máquina Hela se puede hacer ping y conexión ssh a las máquinas de la LAN.</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 ip protocol icmp icmp type echo-reply counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Si no estan en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 ip protocol icmp icmp type echo-request counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 ip protocol icmp icmp type echo-reply counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp dport 22 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp sport 22 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Desde cualquier máquina de la LAN se puede conectar por ssh a la máquina Hela.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Si no esta en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 22 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 22 counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Configura la máquina Odin para que las máquinas de LAN y DMZ puedan acceder al exterior.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##SNAT hecho anteriormente</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Las máquinas de la LAN pueden hacer ping al exterior y navegar.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##Si no estan en la cadena forward no funciona</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_WAN iifname &#34;br-intra2&#34; oifname &#34;ens4&#34; ip protocol icmp icmp type echo-request counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_LAN iifname &#34;ens4&#34; oifname &#34;br-intra2&#34; ip protocol icmp icmp type echo-reply counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol icmp icmp type echo-request counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp icmp type echo-reply counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> tcp sport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#La máquina Hela puede navegar. Instala un servidor web, un servidor ftp y un servidor de correos si no los tienes aún.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Hela ya tiene permitido hacer consultas dns a thor</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#f92672>{</span>80, 443<span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#### Configura la máquina Odin para que los servicios web y ftp sean accesibles desde el exterior.</span>
</span></span><span style=display:flex><span>sudo nft add rule ip nat prerouting tcp dport <span style=color:#ae81ff>21</span> counter dnat to 172.16.0.200
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#No funcionan en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter WAN_DMZ iifname &#34;ens4&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 21 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_WAN iifname &#34;ens3&#34; oifname &#34;ens4&#34; ip saddr 172.16.0.200 tcp sport 21 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#### El servidor web y el servidor ftp deben ser accesibles desde la LAN y desde el exterior.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##No funcionan las reglass en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 21 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 21 ct state established,related counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip daddr 172.16.0.200 tcp dport 80 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip saddr 172.16.0.200 tcp sport 80 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#### El servidor de correos sólo debe ser accesible desde la LAN.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#no funciona en cadenas separadas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip daddr 192.168.0.3 tcp dport 25 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip saddr 192.168.0.3 tcp sport 25 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#### En la máquina Loki instala un servidor Postgres si no lo tiene aún. A este servidor se puede acceder desde la DMZ, pero no desde el exterior.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#no funciona en cadenas distintas</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter LAN_DMZ iifname &#34;ens3&#34; oifname &#34;br-intra2&#34; ip daddr 192.168.0.3 tcp dport 5432 ct state { new, established } counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter DMZ_LAN iifname &#34;br-intra2&#34; oifname &#34;ens3&#34; ip saddr 192.168.0.3 tcp sport 5432 ct state established,related counter accept</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>5432</span> ct state <span style=color:#f92672>{</span> new, established <span style=color:#f92672>}</span> counter accept
</span></span><span style=display:flex><span>sudo nft add rule inet filter forward iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>5432</span> ct state established,related counter accept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#### Evita ataques DoS por ICMP Flood, limitando a 4 el número de peticiones por segundo desde una misma IP.</span>
</span></span><span style=display:flex><span>sudo nft insert rule inet filter input icmp type echo-request limit rate 1/second burst <span style=color:#ae81ff>4</span> packets counter drop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#### Evita ataques DoS por SYN Flood.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft insert rule inet filter input tcp flags \&amp; &#39;(fin|syn|rst|ack) == syn&#39; counter limit rate over 25/second drop</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>####Evita que realicen escaneos de puertos a Odin.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft insert rule inet filter input tcp flags &amp; (fin|syn|rst|ack) == (syn) counter drop</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter output udp dport 53 counter accept</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo nft add rule inet filter input udp sport 53 counter accept</span>
</span></span></code></pre></div><h3 id=rules>Rules</h3><p>Every time I have executed the script the rules lose the counters but so would the scheme with all the rules at the end of the practice:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft list ruleset  
</span></span><span style=display:flex><span>table inet filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain forward <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 10; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>107</span> bytes <span style=color:#ae81ff>8505</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>107</span> bytes <span style=color:#ae81ff>93423</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>11</span> bytes <span style=color:#ae81ff>758</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>11</span> bytes <span style=color:#ae81ff>1818</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state established,new counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 ip protocol icmp icmp type echo-request counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 ip protocol icmp icmp type echo-reply counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>168</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>160</span> bytes <span style=color:#ae81ff>16502</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>100</span> bytes <span style=color:#ae81ff>15086</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>30</span> bytes <span style=color:#ae81ff>6041</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>23</span> bytes <span style=color:#ae81ff>5213</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol icmp icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp icmp type echo-reply counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>16</span> bytes <span style=color:#ae81ff>1666</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> tcp sport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>17</span> bytes <span style=color:#ae81ff>4947</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>32</span> bytes <span style=color:#ae81ff>3332</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>34</span> bytes <span style=color:#ae81ff>9903</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>21</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>21</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>18</span> bytes <span style=color:#ae81ff>1064</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter packets <span style=color:#ae81ff>14</span> bytes <span style=color:#ae81ff>1348</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>25</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>25</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.3 tcp dport <span style=color:#ae81ff>5432</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 192.168.0.3 tcp sport <span style=color:#ae81ff>5432</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook input priority filter; policy drop;
</span></span><span style=display:flex><span>		icmp type echo-request limit rate 1/second burst <span style=color:#ae81ff>4</span> packets counter packets <span style=color:#ae81ff>13</span> bytes <span style=color:#ae81ff>1092</span> drop
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>1490</span> bytes <span style=color:#ae81ff>141906</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>18</span> bytes <span style=color:#ae81ff>2352</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp sport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established counter packets <span style=color:#ae81ff>17</span> bytes <span style=color:#ae81ff>13286</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>965</span> bytes <span style=color:#ae81ff>70084</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.0/16 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter packets <span style=color:#ae81ff>356</span> bytes <span style=color:#ae81ff>39980</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.0/24 tcp sport <span style=color:#ae81ff>22</span> ct state established,related counter packets <span style=color:#ae81ff>131</span> bytes <span style=color:#ae81ff>15952</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr 172.16.0.200 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip saddr 192.168.0.2 tcp dport <span style=color:#ae81ff>22</span> ct state established,new counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp icmp type echo-request counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip protocol icmp counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> reject with icmp port-unreachable
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> drop
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-reply counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook output priority filter; policy drop;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>1404</span> bytes <span style=color:#ae81ff>207511</span>
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>18</span> bytes <span style=color:#ae81ff>1304</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip protocol tcp tcp dport <span style=color:#f92672>{</span> 80, <span style=color:#ae81ff>443</span> <span style=color:#f92672>}</span> ct state established,new counter packets <span style=color:#ae81ff>19</span> bytes <span style=color:#ae81ff>7331</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>577</span> bytes <span style=color:#ae81ff>142596</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.0/16 tcp dport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>547</span> bytes <span style=color:#ae81ff>38208</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.0/24 tcp dport <span style=color:#ae81ff>22</span> counter packets <span style=color:#ae81ff>194</span> bytes <span style=color:#ae81ff>14400</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 tcp sport <span style=color:#ae81ff>22</span> ct state established counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>12</span> bytes <span style=color:#ae81ff>1008</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip protocol icmp icmp type echo-reply counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens3&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> icmp type echo-request counter packets <span style=color:#ae81ff>1</span> bytes <span style=color:#ae81ff>84</span> accept
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;lo&#34;</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain WAN_LAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 1; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain WAN_DMZ <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 2; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>107</span> bytes <span style=color:#ae81ff>93423</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip daddr 172.16.0.200 tcp dport <span style=color:#ae81ff>80</span> ct state <span style=color:#f92672>{</span> established, new <span style=color:#f92672>}</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> ip daddr 192.168.0.2 udp dport <span style=color:#ae81ff>53</span> ct state established,new counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain LAN_WAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 3; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain LAN_DMZ <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 4; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>11</span> bytes <span style=color:#ae81ff>758</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> tcp dport <span style=color:#ae81ff>389</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain DMZ_LAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 5; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> udp sport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>11</span> bytes <span style=color:#ae81ff>1818</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens3&#34;</span> tcp sport <span style=color:#ae81ff>389</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain DMZ_WAN <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type filter hook forward priority filter + 6; policy accept;
</span></span><span style=display:flex><span>		counter packets <span style=color:#ae81ff>711</span> bytes <span style=color:#ae81ff>171730</span>
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>107</span> bytes <span style=color:#ae81ff>8505</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.200 tcp sport <span style=color:#ae81ff>80</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;br-intra2&#34;</span> oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.2 udp sport <span style=color:#ae81ff>53</span> ct state established,related counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> accept
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>table ip nat <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	chain prerouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook prerouting priority filter; policy accept;
</span></span><span style=display:flex><span>		tcp dport <span style=color:#ae81ff>80</span> counter packets <span style=color:#ae81ff>8</span> bytes <span style=color:#ae81ff>480</span> dnat to 172.16.0.200
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens3&#34;</span> ip saddr <span style=color:#f92672>{</span> 172.19.0.0/16, 172.22.0.0/16 <span style=color:#f92672>}</span> udp dport <span style=color:#ae81ff>53</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> dnat to 192.168.0.2
</span></span><span style=display:flex><span>		tcp dport <span style=color:#ae81ff>25</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> dnat to 192.168.0.3
</span></span><span style=display:flex><span>		tcp dport <span style=color:#ae81ff>3306</span> counter packets <span style=color:#ae81ff>12</span> bytes <span style=color:#ae81ff>720</span> dnat to 192.168.0.3
</span></span><span style=display:flex><span>		iifname <span style=color:#e6db74>&#34;ens4&#34;</span> tcp dport <span style=color:#ae81ff>2222</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> dnat to 192.168.0.1:22
</span></span><span style=display:flex><span>		tcp dport <span style=color:#ae81ff>21</span> counter packets <span style=color:#ae81ff>0</span> bytes <span style=color:#ae81ff>0</span> dnat to 172.16.0.200
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	chain postrouting <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 192.168.0.0/24 counter packets <span style=color:#ae81ff>109</span> bytes <span style=color:#ae81ff>8649</span> masquerade
</span></span><span style=display:flex><span>		oifname <span style=color:#e6db74>&#34;ens4&#34;</span> ip saddr 172.16.0.0/16 counter packets <span style=color:#ae81ff>2</span> bytes <span style=color:#ae81ff>120</span> masquerade
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=make-the-rules-persistent>Make the rules persistent</h3><p>Let&rsquo;s save the rules with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@odin:/home/javiercruces# nft list ruleset &gt; /etc/nftables.conf
</span></span></code></pre></div><p>If we want to restore them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>javiercruces@odin:~$ sudo nft -f /etc/nftables.conf
</span></span></code></pre></div><p>To make the rules restart alone:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#Creamos la unidad de systemd</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo cat /etc/systemd/system/nftables-persistent.service
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Unit<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Description<span style=color:#f92672>=</span>Cargar reglas de nftables al iniciar el sistema
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Service<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Type<span style=color:#f92672>=</span>oneshot
</span></span><span style=display:flex><span>ExecStart<span style=color:#f92672>=</span>/usr/sbin/nft -f /etc/nftables/nftables.rules
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Install<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>WantedBy<span style=color:#f92672>=</span>multi-user.target
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Activa el servicio para que al reiniciar se apliquen los cambios</span>
</span></span><span style=display:flex><span>javiercruces@odin:~$ sudo systemctl enable nftables-persistent.service
</span></span></code></pre></div></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f&text=Implementation%20of%20a%20perimeter%20firewall%20with%20Nftables%20II&via=Atlas" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f&title=Implementation%20of%20a%20perimeter%20firewall%20with%20Nftables%20II" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f&title=Implementation%20of%20a%20perimeter%20firewall%20with%20Nftables%20II" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=Implementation%20of%20a%20perimeter%20firewall%20with%20Nftables%20II https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=Implementation%20of%20a%20perimeter%20firewall%20with%20Nftables%20II&body=https%3a%2f%2fwww.javiercd.es%2fen%2fposts%2fcortafuegos%2fnftables_dos%2fcortafuegos_dos%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/javierasping/sentinel/edit/main/content/posts/cortafuegos/nftables_dos/cortafuegos_dos.en.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#ride-the-stage-with-nftables>Ride the stage with Nftables</a></li></ul></li><li><a href=#-snat-rules># SNAT rules</a></li><li><a href=#-dnat-rules># DNAT rules</a></li><li><a href=#exercises>Exercises</a><ul><li><a href=#the-odin-machine-has-a-ssh-server-listening-to-port-22-but-when-you-access-from-the-outside-you-will-have-to-connect-to-port-2222>The Odin machine has a ssh server listening to port 22, but when you access from the outside you will have to connect to port 2222.</a></li><li><a href=#from-thor-and-hela-you-should-allow-the-ssh-connection-by-port-22-to-the-odin-machine>From Thor and Hela you should allow the ssh connection by port 22 to the Odin machine.</a></li><li><a href=#the-odin-machine-must-be-allowed-traffic-for-the-loopback-interface>The Odin machine must be allowed traffic for the loopback interface.</a></li><li><a href=#the-odin-machine-can-be-ping-from-the-dmz-but-from-the-lan-the-connection-reject-must-be-rejected-and-from-the-outside-will-be-rejected-silently>The Odin machine can be ping from the DMZ, but from the LAN the connection (REJECT) must be rejected and from the outside will be rejected silently.</a></li><li><a href=#the-odin-machine-can-do-ping-to-the-lan-the-dmz-and-the-outside>The Odin machine can do ping to the LAN, the DMZ and the outside.</a></li><li><a href=#from-the-hela-machine-you-can-make-ping-and-ssh-connection-to-lan-machines>From the Hela machine you can make ping and ssh connection to LAN machines.</a></li><li><a href=#from-any-lan-machine-you-can-connect-ssh-to-the-hela-machine>From any LAN machine you can connect ssh to the hela machine.</a></li><li><a href=#configure-the-odin-machine-so-that-lan-and-dmz-machines-can-access-the-outside>Configure the Odin machine so that LAN and DMZ machines can access the outside.</a></li><li><a href=#lan-machines-can-do-ping-outside-and-navigate>LAN machines can do ping outside and navigate.</a></li><li><a href=#the-hela-machine-can-sail-install-a-web-server-a-ftp-server-and-a-post-server-if-you-dont-have-them-yet>The hela machine can sail. Install a web server, a ftp server and a post server if you don&rsquo;t have them yet.</a></li><li><a href=#configure-the-odin-machine-to-make-web-and-ftp-services-accessible-from-the-outside>Configure the Odin machine to make web and ftp services accessible from the outside.</a></li><li><a href=#the-web-server-and-the-ftp-server-must-be-accessible-from-the-lan-and-from-the-outside>The web server and the ftp server must be accessible from the LAN and from the outside.</a></li><li><a href=#the-post-server-should-only-be-accessible-from-the-lan>The post server should only be accessible from the LAN.</a></li><li><a href=#in-the-loki-machine-you-install-a-postgres-server-if-you-dont-have-it-yet-this-server-can-be-accessed-from-the-dmz-but-not-from-the-outside>In the Loki machine you install a Postgres server if you don&rsquo;t have it yet. This server can be accessed from the DMZ, but not from the outside.</a></li></ul></li><li><a href=#-avoid-dos-attacks-by-icmp-flood-limiting-the-number-of-requests-per-second-to-4-from-the-same-ip># Avoid DoS attacks by ICMP Flood, limiting the number of requests per second to 4 from the same IP.</a></li><li><a href=#script-with-all-the-rules>Script with all the rules</a><ul><li><a href=#rules>Rules</a></li><li><a href=#make-the-rules-persistent>Make the rules persistent</a></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#about>About Me</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=https://www.javiercd.es/en/#accomplishments>Certifications</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:contacto@javiercd.es target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>contacto@javiercd.es</span></a></li><li><a href=https://github.com/javierasping target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>javierasping</span></a></li><li><a href=https://www.linkedin.com/in/javiercd target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Francisco Javier Cruces Doval</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>Liability Notice:</strong> This theme is under MIT license. So, you can use it for non-commercial, commercial, or private uses. You can modify or distribute the theme without requiring any permission from the theme author. However, the theme author does not provide any warranty or takes any liability for any issue with the theme.</p></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu_b3360284c55cf72d.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2023 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.29119cfdb8d2f06f4caaea7b9908096b5c109c5174eab5fca7e4e0efb0ffcaa0.js integrity="sha256-KRGc/bjS8G9Mqup7mQgJa1wQnFF06rX8p+Tg77D/yqA=" defer></script></body></html>